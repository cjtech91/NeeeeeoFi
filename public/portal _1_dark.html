<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoFi Client</title>
    <style>
        :root {
            --primary: #3498db; /* Blue */
            --success: #2ecc71; /* Green */
            --danger: #e74c3c; /* Red */
            --purple: #9b59b6; /* Purple */
            --bg: #121212; /* Dark Background */
            --text: #e0e0e0; /* Light Text */
            --text-muted: #a0a0a0; /* Muted Text */
            --white: #1e1e1e; /* Dark Container */
            --shadow: 0 8px 30px rgba(0,0,0,0.5); /* Stronger Shadow */
            --radius: 20px; /* More rounded card */
            --btn-radius: 50px; /* Pill buttons */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center vertically */
            align-items: center;
            padding: 10px;
        }

        .developer-footer {
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .container {
            width: 100%;
            max-width: 360px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            text-align: center;
            padding-bottom: 10px;
        }

        .portal-banner {
            width: 100%;
            height: 190px;
            position: relative;
            overflow: hidden;
            display: block;
            background: var(--white);
            /* border-bottom: 1px solid rgba(0,0,0,0.06); */
        }

        .portal-banner::after {
            display: none;
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.00) 0%, rgba(0,0,0,0.22) 100%);
            pointer-events: none;
            z-index: 2;
        }

        .portal-banner-media {
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .portal-banner-media img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transform: scale(1.03);
            transition: opacity 900ms ease, transform 4500ms ease;
            will-change: opacity, transform;
        }

        .portal-banner-media img.active {
            opacity: 1;
            transform: scale(1.00);
        }

        .portal-status-pill {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 38px;
            height: 38px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 3;
        }

        .portal-status-pill svg {
            width: 36px;
            height: 36px;
            display: none;
        }

        .portal-status-pill.connected {
            color: var(--success);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.18), 0 0 18px rgba(46, 204, 113, 0.55);
        }

        .portal-status-pill.disconnected {
            color: var(--text-muted);
            box-shadow: 0 0 0 3px rgba(99, 110, 114, 0.18), 0 0 18px rgba(99, 110, 114, 0.45);
        }

        .portal-status-pill.paused {
            color: #f39c12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.18), 0 0 18px rgba(243, 156, 18, 0.55);
        }

        .portal-status-pill.connected #status-icon-connected,
        .portal-status-pill.disconnected #status-icon-disconnected,
        .portal-status-pill.paused #status-icon-paused {
            display: block;
            filter: drop-shadow(0 0 10px currentColor);
        }

        /* Header Status */
        .status-header {
            padding: 4px 12px 4px;
            background: var(--white);
            /* border-bottom: 1px solid #f1f2f6; */
        }
        
        .status-icon {
            width: 42px;
            height: 42px;
            fill: var(--success);
            margin-top: 0;
            margin-bottom: 4px;
        }

        .status-text {
            font-size: 1.12rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-top: 0;
        }

        .status-text.disconnected {
            color: var(--text-muted);
        }

        .status-text.connected {
            color: var(--success);
        }

        .status-text.paused {
            color: #f39c12;
        }

        /* Info Row */
        .info-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--primary);
            margin-top: 5px;
            font-weight: 500;
        }

        .info-row-compact {
            justify-content: center;
            gap: 12px;
            margin: 6px 0 0;
            font-size: 0.78rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        /* Credit & Timer */
        .main-display {
            padding: 10px 12px 12px;
        }

        .credit-label {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-value {
            font-size: clamp(3.0rem, 10vw, 4.0rem);
            font-weight: 700;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
            margin: 5px 0;
            white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0,0,0,0.25);
        }

        .timer-value.long {
            font-size: clamp(2.4rem, 8vw, 3.2rem);
        }

        .code-display {
            font-size: 0.78rem;
            font-weight: 700;
            color: #e67e22; /* Orange for code */
            margin-bottom: 2px;
        }

        /* Device Trigger (Pill) */
        .device-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #2c2c2c;
            border: 1px solid #444;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: var(--text-muted);
            width: 100%;
            max-width: 180px;
            margin: 0 auto;
        }

        .device-trigger:hover {
            background: #333;
            border-color: #555;
        }

        /* Buttons */
        .actions {
            padding: 8px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--btn-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-insert {
            background: var(--success);
        }

        .btn-rates {
            background: var(--primary);
        }

        .btn-points {
            background: var(--purple);
        }

        .btn-pause {
            background: var(--danger);
        }

        .btn-free-time {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            box-shadow: none;
            border-radius: var(--btn-radius);
            margin-top: 5px;
            padding: 4px 10px;
            font-size: 0.75rem;
            width: fit-content;
            display: inline-block;
        }
        
        /* Code Display */
        .code-display-block {
            text-align: center;
            font-weight: 700;
            color: #e67e22; /* Orange */
            font-size: 1rem;
            margin: 5px 0 10px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .points-badge {
            color: #e67e22; /* Match Code Orange */
            background: transparent;
            padding: 0;
            margin-left: 8px;
            font-weight: 700;
        }

        /* Voucher Input */
        .voucher-section {
            padding: 10px 16px;
            margin-top: 5px;
        }

        .voucher-input-wrapper {
            position: relative;
            width: 100%;
        }

        .voucher-input {
            width: 100%;
            padding: 10px 14px;
            padding-right: 100px; /* Space for button */
            border: 1px solid #444;
            border-radius: 50px;
            font-size: 0.95rem;
            outline: none;
            background: #2c2c2c;
            color: var(--text);
            height: 50px;
        }

        .btn-submit {
            position: absolute;
            right: 5px;
            top: 5px;
            bottom: 5px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 16px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        .coin-countdown {
            margin: 10px 0 0;
        }

        .coin-countdown-bar {
            width: 100%;
            height: 10px;
            background: #444;
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        .coin-countdown-fill {
            height: 100%;
            width: 100%;
            background: var(--primary);
            transition: width 0.2s linear;
        }

        .coin-countdown-text {
            margin-top: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: var(--white);
            color: var(--text);
            padding: 20px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 320px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* Loading Overlay with Bouncing Logo */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.35);
            z-index: 3000;
        }
        .loading-logo {
            width: 96px;
            height: auto;
            animation: bounce 1s ease-in-out infinite;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.55));
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        /* Rates List in Modal */
        .rate-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .rate-header {
            display: grid;
            grid-template-columns: 0.8fr 1.0fr 1.1fr 0.9fr;
            border-bottom: 1px solid #444;
            background: #2c3e50;
        }

        .rate-header-col {
            padding: 8px 6px;
            text-align: center;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #bdc3c7;
            font-weight: 600;
        }

        .rate-header-col:not(:last-child) {
            border-right: 1px solid #444;
        }

        .rate-item {
            display: grid;
            grid-template-columns: 0.8fr 1.0fr 1.1fr 0.9fr;
            border-bottom: 1px solid #333;
            background: var(--white);
        }

        .rate-col {
            padding: 8px 6px;
            text-align: center;
            font-size: 0.85rem;
        }

        .rate-col:not(:last-child) {
            border-right: 1px solid #333;
        }

        .rate-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .rate-price { font-weight: 700; color: var(--success); }
        .rate-time { color: var(--text-muted); }

        /* Point Rate Item Specifics */
        .point-rate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px; /* Reduced height */
            border-bottom: 1px solid #333;
            background: var(--white);
        }

        .point-rate-item .rate-amount {
            font-weight: 700;
            color: #9b59b6;
            flex: 0 0 70px; /* Fixed width */
            text-align: left;
        }

        .point-rate-item .rate-details {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .point-rate-item .btn-redeem {
            padding: 6px 12px !important; /* Force smaller padding */
            width: auto !important;
            font-size: 0.85rem !important;
            border-radius: 4px;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: 90%;
            max-width: 350px;
        }

        .toast {
            background: #333;
            color: #fff;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid #f39c12; }

        .toast-icon {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-message {
            font-size: 0.95rem;
            font-weight: 600;
            color: #fff;
            line-height: 1.4;
        }

        .toast.hiding {
            animation: slideOutUp 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }

        @keyframes slideInDown {
            from { transform: translateY(-20px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes slideOutUp {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-20px) scale(0.9); opacity: 0; }
        }
        /* Chat Widget */
        .chat-widget-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            display: none;
            transition: transform 0.2s;
        }
        .chat-widget-btn:hover {
            transform: scale(1.1);
        }
        .chat-widget-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .chat-widget-box {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #333;
            /* Animation */
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .chat-widget-box.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .chat-widget-header {
            background: var(--primary);
            color: white;
            padding: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-widget-header .close-btn {
            cursor: pointer;
            font-size: 1.2rem;
        }
        .chat-widget-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chat-widget-input {
            padding: 10px;
            border-top: 1px solid #333;
            display: flex;
            gap: 5px;
            background: var(--white);
        }
        .chat-widget-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            outline: none;
            background: #2c2c2c;
            color: var(--text);
        }
        .chat-widget-input button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        @keyframes msgSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-msg {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            word-wrap: break-word;
            animation: msgSlideUp 0.3s ease-out forwards;
        }
        .chat-msg.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .chat-msg.received {
            align-self: flex-start;
            background: #444;
            color: #fff;
            border-bottom-left-radius: 2px;
        }
        .chat-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        /* Device Selection Modal */
        .device-list {
            max-height: 250px;
            overflow-y: auto;
            text-align: left;
            margin-top: 10px;
        }
        .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        .device-item:hover {
            background: #333;
        }
        .device-item:last-child {
            border-bottom: none;
        }
        .device-item.active {
            background: rgba(52, 152, 219, 0.2);
            color: var(--primary);
            font-weight: 600;
        }
        .device-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .device-status-dot.online { background: var(--success); box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2); }
        .device-status-dot.offline { background: var(--text-muted); opacity: 0.5; }

        /* Coin Animation */
        .coin-animation-container {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }

        .coin-slot {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            background: #2d3436;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .coin-slot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 2px;
            background: #000;
            border-radius: 2px;
        }

        .coin {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: #f1c40f;
            border: 2px solid #f39c12;
            border-radius: 50%;
            box-shadow: inset 0 0 0 2px #f1c40f, inset 0 0 0 3px #f39c12;
            animation: insertCoin 1.5s infinite ease-in-out;
            z-index: 1;
        }
        
        .coin::before {
            content: '₱';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            color: #d35400;
        }

        @keyframes insertCoin {
            0% {
                top: -20px;
                opacity: 0;
                transform: translateX(-50%) rotateY(0deg);
            }
            20% {
                opacity: 1;
            }
            60% {
                top: 25px; /* Just above slot */
                transform: translateX(-50%) rotateY(180deg);
                opacity: 1;
            }
            80% {
                top: 35px; /* Inside slot */
                opacity: 0;
            }
            100% {
                top: 35px;
                opacity: 0;
            }
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body>



    <div class="container">
        <div class="portal-banner" id="portal-banner">
            <div class="portal-banner-media" id="portal-banner-media"></div>
            <div class="portal-status-pill disconnected" id="portal-status-pill">
                <svg id="status-icon-connected" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 18c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-4.24-3.76a6 6 0 0 1 8.48 0l-1.41 1.41a4 4 0 0 0-5.66 0l-1.41-1.41zm-2.83-2.83a10 10 0 0 1 14.14 0l-1.41 1.41a8 8 0 0 0-11.32 0l-1.41-1.41z"/>
                </svg>
                <svg id="status-icon-disconnected" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm3.54 13.54-1.41 1.41L12 13.41l-2.12 2.12-1.41-1.41L10.59 12 8.46 9.88l1.41-1.41L12 10.59l2.12-2.12 1.41 1.41L13.41 12l2.13 2.12z"/>
                </svg>
                <svg id="status-icon-paused" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-3 6h2v8h-2zm4 0h2v8h-2z"/>
                </svg>
            </div>
        </div>
        <!-- Header -->
        <div class="status-header">
            <div class="status-text" id="status-text">Connected</div>
        </div>

        <!-- Main Display -->
        <div class="main-display">
            <div id="ticker-container" style="display: none; width: 100%; overflow: hidden; margin-bottom: 10px;">
                <div id="ticker-text" style="white-space: nowrap; animation: ticker-scroll 15s linear infinite; display: inline-block; color: var(--primary); font-weight: 600;"></div>
            </div>
            <div class="credit-label">Unclaimed Credit: <span id="coin-display">₱0.00</span></div>
            <div class="info-row info-row-compact">
                <span>IP: <span id="ip-display">...</span></span>
                <span>MAC: <span id="mac-display">...</span></span>
            </div>
            
            <div class="code-display-block">
                <span id="code-display">-</span>
            </div>
            
            <div class="timer-value" id="time-display">00:00:00</div>
            
            <div id="vendo-selection-container" style="margin-top: 15px; margin-bottom: 5px; display: flex; flex-direction: column; align-items: center;">
                <!-- Moved Free Time Button -->
                <button class="btn btn-free-time" id="free-time-widget" onclick="claimFreeTime()" style="display:none; margin-bottom: 5px;">Free Time</button>
                
                <div class="device-trigger" onclick="openDeviceModal()">
                    <svg style="width:18px; height:18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 6h16v10H4z" rx="2"/>
                        <path d="M8 20h8M12 16v4"/>
                    </svg>
                    <span id="selected-device-name">Main Vendo</span>
                    <svg style="width:14px; height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Action Grid -->
        <div class="actions">
            <button class="btn btn-insert" id="btn-insert" onclick="startCoinMode()">Insert Coins</button>
            <button class="btn btn-pause" id="btn-pause" onclick="togglePause()" style="display:none;">Pause Time</button>
            <button class="btn btn-rates" onclick="showRates()">Wifi Rates</button>
            <button class="btn btn-points" id="btn-points" onclick="showPointRates()" style="display:none;">Redeem Points</button>
        </div>

        <!-- Voucher Input (Inline) -->
        <div class="voucher-section">
            <div class="voucher-input-wrapper">
                <input type="text" class="voucher-input" id="voucher-input-main" placeholder="Enter Voucher Code..." oninput="this.value=this.value.toUpperCase()" style="text-transform:uppercase;" autocapitalize="characters">
                <button class="btn-submit" onclick="redeemVoucherMain()">Submit</button>
            </div>
        </div>
        
        <!-- Hidden elements for compatibility -->
        <div style="display:none;" id="voucher-mac-display"></div>
    </div>

    <div class="developer-footer">POWERED BY CJTECH</div>

    <!-- Device Selection Modal -->
    <div id="device-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Select Device</div>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Choose a vendo machine to insert coins.</p>
            <div id="device-list" class="device-list">
                <!-- Device items populated via JS -->
            </div>
            <button class="btn btn-rates" style="margin-top: 15px; background: #95a5a6;" onclick="closeDeviceModal()">Cancel</button>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Coin Modal -->
    <div id="coin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="coin-modal-title">Insert Coins Now</div>
            <p id="coin-modal-desc" style="margin-bottom:15px; color:var(--text-muted);">Please insert coins into the slot.</p>
            <div class="coin-animation-container">
                <div class="coin"></div>
                <div class="coin-slot"></div>
            </div>
            <div style="font-size:2rem; font-weight:bold; color:var(--success); margin-bottom:20px;" id="modal-coin-amount">₱0.00</div>
            <div style="font-size:1rem; font-weight:600; color:var(--text); margin-bottom:20px;" id="modal-coin-time">Equivalent Time: 0 Min</div>
            <div class="coin-countdown">
                <div class="coin-countdown-bar">
                    <div class="coin-countdown-fill" id="coin-countdown-fill"></div>
                </div>
                <div class="coin-countdown-text" id="coin-countdown-text">Auto close in 60s</div>
            </div>
            <button class="btn btn-rates" onclick="closeCoinModal()">I'm Done</button>
        </div>
    </div>

    <!-- Rates Modal -->
    <div id="rates-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">WiFi Rates</div>
            <div class="rate-list" id="rates-list">
                <!-- Rates loaded here -->
            </div>
            <button class="btn btn-rates" style="margin-top:15px;" onclick="closeModal('rates-modal')">Close</button>
        </div>
    </div>

    <!-- Point Rates Modal -->
    <div id="point-rates-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Redeem Points</div>
            <div style="text-align:center; margin-bottom:10px;">
                Balance: <span id="modal-points-balance" style="font-weight:bold; color:#9b59b6;">0</span> pts
            </div>
            <div class="rate-list" id="point-rates-list">
                <!-- Rates loaded here -->
            </div>
            <button class="btn btn-rates" style="margin-top:15px; background:#95a5a6;" onclick="closeModal('point-rates-modal')">Close</button>
        </div>
    </div>

    <audio id="coin-beep" src="/beed.mp3" preload="auto"></audio>

    <!-- Announcement Modal -->
    <div id="announcement-modal" class="modal" style="display:none; opacity:0; transition: opacity 0.3s ease;">
        <div class="modal-content" style="transform: scale(0.9); transition: transform 0.3s ease; position: relative; padding-bottom: 50px;">
            <div class="modal-title" id="announcement-title">Announcement</div>
            <p id="announcement-message" style="margin-bottom:0; color:var(--text); white-space: pre-wrap; text-align: left; max-height: 300px; overflow-y: auto;"></p>
            <div onclick="closeAnnouncement()" style="position: absolute; bottom: 15px; left: 0; width: 100%; text-align: center; cursor: pointer; color: var(--text); font-weight: 500;">Close</div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <img src="neologo.png" alt="Loading" class="loading-logo" />
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // State
        const socket = io();
        let currentUser = null;
        let isInserting = false;
        let coinAmount = 0;
        let hasRedirected = false; // Prevent infinite redirect loops
        let coinCountdownInterval = null;
        let coinCountdownSeconds = 0;
        let coinCountdownMaxSeconds = 60;
        let coinBeepAudio = null;
        let coinBeepContext = null;
        let selectedVendoMode = 'auto';
        let selectedVendoId = localStorage.getItem('vendo_target') || 'hardware';
        let portalConfig = {};

        // Device ID Management (Persistent Session)
        function getOrCreateDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                // Check cookies
                const match = document.cookie.match(new RegExp('(^| )client_id=([^;]+)'));
                if (match) {
                    deviceId = match[2];
                } else {
                    // Generate new UUID
                    deviceId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
                localStorage.setItem('device_id', deviceId);
            }
            // Sync to cookie for server access
            document.cookie = `client_id=${deviceId}; path=/; max-age=31536000`; // 1 year
            return deviceId;
        }

        const deviceId = getOrCreateDeviceId();


        function setPortalStatus(state) {
            const pill = document.getElementById('portal-status-pill');
            if (pill) pill.className = `portal-status-pill ${state}`;
        }

        let slideshowIntervalId = null;

        async function loadPortalConfig() {
            try {
                const res = await fetch('/api/portal/config?t=' + Date.now());
                const config = await res.json();
                portalConfig = config;
                
                // Apply Styles
                const root = document.documentElement;

                // Ticker Settings
                const tickerContainer = document.getElementById('ticker-container');
                const tickerText = document.getElementById('ticker-text');
                if (tickerContainer && tickerText) {
                    if (config.ticker_enabled) {
                        tickerContainer.style.display = 'block';
                        tickerText.textContent = config.ticker_text || 'Thank you for choosing our piso wifi hotspot services!';
                    } else {
                        tickerContainer.style.display = 'none';
                    }
                }
                if (config.container_max_width) {
                    const container = document.querySelector('.container');
                    if (container) container.style.maxWidth = `${config.container_max_width}px`;
                }
                
                if (config.banner_height !== undefined) {
                    const banner = document.getElementById('portal-banner');
                    if (banner) {
                        if (config.banner_height === 0 || config.banner_height === '0') {
                            banner.style.display = 'none';
                        } else {
                            banner.style.height = `${config.banner_height}px`;
                            banner.style.display = 'block';
                        }
                    }
                }

                if (config.status_icon_container_size) {
                    const pill = document.getElementById('portal-status-pill');
                    if (pill) {
                        pill.style.width = `${config.status_icon_container_size}px`;
                        pill.style.height = `${config.status_icon_container_size}px`;
                    }
                }

                if (config.icon_size) {
                    const icons = document.querySelectorAll('.portal-status-pill svg');
                    icons.forEach(icon => {
                        icon.style.width = `${config.icon_size}px`;
                        icon.style.height = `${config.icon_size}px`;
                    });
                }

                // Hide Voucher Code
                if (config.hide_voucher_code) {
                    const codeDisplay = document.querySelector('.code-display');
                    if (codeDisplay) codeDisplay.style.display = 'none';
                }

                // Banner Logic
                if (config.banner_mode === 'slideshow' && config.slideshow_images && config.slideshow_images.length > 0) {
                    initSlideshow(config.slideshow_images, config.slideshow_interval);
                } else {
                    const bannerFile = config.use_default_banner ? (config.default_banner_file || 'op-banner.png') : config.banner_filename;
                    initPortalBanner(config.banner_version, bannerFile);
                }

                // Footer Logic
                const footer = document.querySelector('.developer-footer');
                if (footer) {
                    if (config.footer_text) {
                        footer.style.display = 'block';
                        if (config.footer_link) {
                            footer.innerHTML = `<a href="${config.footer_link}" target="_blank" style="color: inherit; text-decoration: none; border-bottom: 1px dotted currentColor;">${config.footer_text}</a>`;
                        } else {
                            footer.textContent = config.footer_text;
                        }
                    } else {
                        // Restore default if empty
                        footer.style.display = 'block';
                        footer.textContent = 'POWERED BY CJTECH';
                    }
                }

                // Announcement
                if (typeof showAnnouncement === 'function') {
                    showAnnouncement();
                }

            } catch (e) {
                console.error("Failed to load portal config", e);
                initPortalBanner(Date.now(), 'op-banner.png'); // Fallback
            }
        }

        function initSlideshow(images, interval) {
            const mediaEl = document.getElementById('portal-banner-media');
            if (!mediaEl) return;

            // Stop existing interval if any
            if (slideshowIntervalId) {
                clearInterval(slideshowIntervalId);
                slideshowIntervalId = null;
            }
            
            mediaEl.innerHTML = '';
            
            // Preload and append images
            images.forEach((imgName, index) => {
                const el = document.createElement('img');
                el.src = `/slideshow/${imgName}`;
                el.alt = 'Slide ' + (index + 1);
                if (index === 0) el.classList.add('active');
                mediaEl.appendChild(el);
            });

            if (images.length > 1) {
                let currentIndex = 0;
                const slideTime = interval || 3000;
                
                slideshowIntervalId = setInterval(() => {
                    const imgs = mediaEl.querySelectorAll('img');
                    if (imgs.length === 0) return;
                    
                    imgs[currentIndex].classList.remove('active');
                    currentIndex = (currentIndex + 1) % imgs.length;
                    imgs[currentIndex].classList.add('active');
                }, slideTime);
            }
        }

        function initPortalBanner(version, filename) {
            const mediaEl = document.getElementById('portal-banner-media');
            if (!mediaEl) return;

            // Stop existing interval if any
            if (slideshowIntervalId) {
                clearInterval(slideshowIntervalId);
                slideshowIntervalId = null;
            }

            const file = filename || 'op-banner.png';
            const stamp = version || Date.now();
            
            // Clear existing
            mediaEl.innerHTML = '';

            const el = document.createElement('img');
            el.src = `${file}?v=${stamp}`;
            el.alt = 'Portal banner';
            el.classList.add('active');
            mediaEl.appendChild(el);
        }

        function initCoinBeep() {
            if (!coinBeepAudio) coinBeepAudio = document.getElementById('coin-beep');
            if (coinBeepAudio) coinBeepAudio.volume = 0.5;
            if (!coinBeepContext && window.AudioContext) coinBeepContext = new window.AudioContext();
            if (coinBeepContext && coinBeepContext.state === 'suspended') {
                coinBeepContext.resume().catch(() => {});
            }
            if (coinBeepAudio) {
                try {
                    const p = coinBeepAudio.play();
                    if (p && p.then) {
                        p.then(() => {
                            coinBeepAudio.pause();
                            coinBeepAudio.currentTime = 0;
                        }).catch(() => {});
                    } else {
                        coinBeepAudio.pause();
                        coinBeepAudio.currentTime = 0;
                    }
                } catch (e) {}
            }
        }

        function playCoinBeepOsc() {
            if (!coinBeepContext) return;
            if (coinBeepContext.state === 'suspended') {
                coinBeepContext.resume().catch(() => {});
            }
            const o = coinBeepContext.createOscillator();
            const g = coinBeepContext.createGain();
            g.gain.value = 0.05;
            o.frequency.value = 880;
            o.connect(g);
            g.connect(coinBeepContext.destination);
            o.start();
            o.stop(coinBeepContext.currentTime + 0.06);
        }

        function playCoinBeep() {
            if (!isInserting) return;
            if (!coinBeepAudio) coinBeepAudio = document.getElementById('coin-beep');
            if (coinBeepAudio) {
                try {
                    coinBeepAudio.currentTime = 0;
                    const p = coinBeepAudio.play();
                    if (p && p.catch) p.catch(() => playCoinBeepOsc());
                } catch (e) {
                    playCoinBeepOsc();
                }
                return;
            }
            playCoinBeepOsc();
        }

        function stopCoinCountdown() {
            if (coinCountdownInterval) {
                clearInterval(coinCountdownInterval);
                coinCountdownInterval = null;
            }
        }

        function renderCoinCountdown() {
            const fill = document.getElementById('coin-countdown-fill');
            const text = document.getElementById('coin-countdown-text');
            const max = Math.max(1, Number(coinCountdownMaxSeconds) || 1);
            const cur = Math.max(0, Number(coinCountdownSeconds) || 0);
            const pct = Math.max(0, Math.min(100, (cur / max) * 100));

            if (fill) fill.style.width = pct + '%';
            if (text) text.textContent = `Auto close in ${cur}s`;
        }

        function startCoinCountdown(seconds, maxSeconds) {
            stopCoinCountdown();
            coinCountdownSeconds = Math.max(0, Number(seconds) || 0);
            coinCountdownMaxSeconds = Math.max(1, Number(maxSeconds) || coinCountdownSeconds || 1);
            renderCoinCountdown();
            playCoinBeep();

            coinCountdownInterval = setInterval(() => {
                playCoinBeep();
                coinCountdownSeconds = Math.max(0, (Number(coinCountdownSeconds) || 0) - 1);
                renderCoinCountdown();
                if (coinCountdownSeconds <= 0) {
                    stopCoinCountdown();
                    closeCoinModal();
                }
            }, 1000);
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'; // Info icon
            
            if (type === 'success') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            } else if (type === 'error') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else if (type === 'warning') {
                icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            }

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                    if (container.children.length === 0) container.remove();
                });
            }, 3500);
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPortalConfig();
            updateStatus().then(() => {
                // After initial status check, try auto-restore if needed
                initAutoRestore();
            });
            fetchRates(); // Pre-load rates
            setInterval(updateStatus, 1000);
            
            // Local timer
            setInterval(() => {
                if (currentUser && currentUser.time_remaining > 0 && !currentUser.is_paused) {
                    currentUser.time_remaining--;
                    updateTimer(currentUser.time_remaining);
                } else if (currentUser && currentUser.time_remaining <= 0) {
                    updateTimer(0);
                }
            }, 1000);
        });

        // Auto-Restore Logic (Cache Code & Endorse to New Connection)
        function initAutoRestore() {
            const cachedCode = localStorage.getItem('session_code');
            if (!cachedCode) return;

            // If we are disconnected or have no time, try to restore
            if (!currentUser || currentUser.time_remaining <= 0) {
                console.log('Attempting Auto-Restore with code:', cachedCode);
                
                // Visual feedback
                const statusText = document.getElementById('status-text');
                if (statusText) statusText.textContent = 'Restoring Session...';

                fetch('/api/session/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: cachedCode })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        console.log('Auto-Restore Success');
                        updateStatus(); // Refresh UI
                    } else {
                        console.warn('Auto-Restore Failed:', result.error);
                        // If code is invalid, clear it so we don't loop forever
                        if (result.error === 'Invalid Session Code') {
                            localStorage.removeItem('session_code');
                        }
                    }
                })
                .catch(err => console.error('Auto-Restore Error:', err));
            }
        }

        function formatMinutes(minutes) {
            const m = Number(minutes) || 0;
            if (m <= 0) return '0 Min';
            if (m < 60) return `${m} Min`;
            const h = Math.floor(m / 60);
            const rem = m % 60;
            if (h >= 24 && rem === 0) {
                const d = Math.floor(h / 24);
                return `${d} Day${d > 1 ? 's' : ''}`;
            }
            return `${h} Hr${h > 1 ? 's' : ''}${rem > 0 ? ' ' + rem + ' Min' : ''}`;
        }

        socket.on('coin_pending_update', (data) => {
            if (!isInserting || !currentUser || !currentUser.mac) return;
            if ((currentUser.mac || '').toLowerCase() !== (data.mac || '').toLowerCase()) return;

            coinAmount = Number(data.amount) || 0;
            document.getElementById('modal-coin-amount').textContent = `₱${coinAmount.toFixed(2)}`;
            document.getElementById('coin-display').textContent = `₱${coinAmount.toFixed(2)}`;
            document.getElementById('modal-coin-time').textContent = `Equivalent Time: ${formatMinutes(data.minutes)}`;
            startCoinCountdown(30, 30);
        });

        socket.on('user_code_generated', (data) => {
            if (currentUser && currentUser.mac === data.mac) {
                currentUser.session_code = data.code;
                const codeSpan = document.getElementById('code-display');
                if (codeSpan) codeSpan.textContent = data.code;
                
                // Also update visibility immediately to avoid waiting for next tick
                const codeDisplayContainer = codeSpan ? codeSpan.parentElement : document.querySelector('.code-display');
                if (codeDisplayContainer) {
                    if (portalConfig.hide_voucher_code !== true) {
                        codeDisplayContainer.style.display = 'flex';
                    } else {
                        codeDisplayContainer.style.display = 'none';
                    }
                }
            }
        });

        socket.on('coin_finalized', (data) => {
            if (currentUser && currentUser.mac === data.mac) {
                closeModal('coin-modal');
                stopCoinCountdown();
                updateStatus();
            }
        });

        // Functions
        // Device Modal Functions
        function openDeviceModal() {
            const modal = document.getElementById('device-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeDeviceModal() {
            const modal = document.getElementById('device-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 200);
        }

        function selectDevice(id, name) {
            selectedVendoId = id;
            localStorage.setItem('vendo_target', id);
            const nameEl = document.getElementById('selected-device-name');
            if (nameEl) nameEl.textContent = name;
            renderDeviceList(lastKnownDevices);
            updateFreeTimeWidgetVisibility();
            closeDeviceModal();
            showToast(`Selected: ${name}`, 'success');
        }

        let lastKnownDevices = [];

        function renderDeviceList(devices) {
            const listEl = document.getElementById('device-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            lastKnownDevices = devices; // Cache for re-rendering

            // Always add Hardware (Main Vendo) first
            const hardwareItem = document.createElement('div');
            hardwareItem.className = `device-item ${selectedVendoId === 'hardware' ? 'active' : ''}`;
            hardwareItem.onclick = () => selectDevice('hardware', 'Main Vendo');
            hardwareItem.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <svg style="width:18px; height:18px; fill:currentColor;" viewBox="0 0 24 24"><path d="M4 6h16v10H4z" fill="none" stroke="currentColor" stroke-width="2" rx="2"/><path d="M8 20h8M12 16v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    <span>Main Vendo</span>
                </div>
                <span class="device-status-dot online"></span>
            `;
            listEl.appendChild(hardwareItem);

            // Add other devices
            if (devices && devices.length > 0) {
                devices.forEach(d => {
                    // Prevent duplicate Main Vendo if it exists in the list
                    if (d.id === 'hardware') return;

                    const isSelected = selectedVendoId === d.id;
                    const item = document.createElement('div');
                    item.className = `device-item ${isSelected ? 'active' : ''}`;
                    item.onclick = () => selectDevice(d.id, d.name || d.id);
                    
                    const statusClass = d.status === 'online' ? 'online' : 'offline';
                    
                    item.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                             <svg style="width:18px; height:18px; fill:currentColor;" viewBox="0 0 24 24"><path d="M12 2a9 9 0 0 1 9 9c0 4.97-4.03 9-9 9s-9-4.03-9-9 9-4.03 9-9zm0 2c-3.87 0-7 3.13-7 7s3.13 7 7 7 7-3.13 7-7-3.13-7-7-7z" opacity="0.5"/><circle cx="12" cy="12" r="5"/></svg>
                            <span>${d.name || d.id}</span>
                        </div>
                        <span class="device-status-dot ${statusClass}"></span>
                    `;
                    listEl.appendChild(item);
                });
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status?t=' + Date.now());
                const data = await res.json();
                currentUser = data;
                const lastIp = localStorage.getItem('last_ip') || '';
                const lastMac = localStorage.getItem('last_mac') || '';

                // Cache Code for Auto-Restore
                if (data.session_code) {
                    localStorage.setItem('session_code', data.session_code);
                }

                const ipToShow = data.ip || lastIp || 'Unknown';
                const macToShow = data.mac || lastMac || 'Unknown';
                document.getElementById('ip-display').textContent = ipToShow;
                document.getElementById('mac-display').textContent = macToShow;
                if (data.ip) localStorage.setItem('last_ip', data.ip);
                if (data.mac) localStorage.setItem('last_mac', data.mac);
                
                const macForChat = data.mac || lastMac;
                if (window.initChatWithId && typeof deviceId !== 'undefined') {
                    window.initChatWithId(deviceId);
                } else if (macForChat && window.initChatWithMac) {
                    window.initChatWithMac(macForChat);
                }

                const codeSpan = document.getElementById('code-display');
                const codeDisplayContainer = codeSpan ? codeSpan.parentElement : document.querySelector('.code-display');
                
                if (data.session_code && codeSpan) {
                    let html = `<span>${data.session_code}</span>`;
                    // Points Display
                    const points = data.points_balance || 0;
                    if (points > 0) {
                         html += `<span class="points-badge">Points:${points}</span>`;
                    }
                    codeSpan.innerHTML = html;
                }

                // Update Points Button Visibility
                const btnPoints = document.getElementById('btn-points');
                if (btnPoints) {
                    btnPoints.style.display = 'inline-block';
                }

                if (codeDisplayContainer) {
                    // Only show if we have a code AND it is NOT hidden by config
                    // We check explicit true for hide_voucher_code to be safe, but undefined/null/false means show
                    if (data.session_code && portalConfig.hide_voucher_code !== true) {
                        codeDisplayContainer.style.display = 'flex';
                    } else {
                        codeDisplayContainer.style.display = 'none';
                    }
                }
                
                document.getElementById('coin-display').textContent = `₱${Number(data.pending_amount || 0).toFixed(2)}`;
                const insertBtn = document.getElementById('btn-insert');
                if (insertBtn) insertBtn.textContent = (Number(data.time_remaining) > 0) ? 'Extend Time' : 'Insert Coins';

                // Pass MAC to hidden element for legacy compatibility if needed
                const hiddenMac = document.getElementById('voucher-mac-display');
                if (hiddenMac) hiddenMac.textContent = macToShow !== 'Unknown' ? macToShow : '';

                const vendoModeLabel = document.getElementById('vendo-mode-label');
                const deviceContainer = document.getElementById('vendo-device-container');

                selectedVendoMode = (data.vendo_mode || 'auto').toLowerCase();
                if (selectedVendoMode !== 'auto' && selectedVendoMode !== 'manual') selectedVendoMode = 'auto';

                if (vendoModeLabel) {
                    vendoModeLabel.textContent = selectedVendoMode === 'manual' ? 'Manual' : 'Automatic';
                }

                if (deviceContainer) deviceContainer.style.display = 'block';

                // Update Device List
                const available = Array.isArray(data.available_vendos) ? data.available_vendos : [];
                
                const mappedDevices = available.map(v => ({
                    id: v.id,
                    name: v.name,
                    status: (v.is_online !== false) ? 'online' : 'offline',
                    hasFreeTime: !!v.has_free_time,
                    isLocal: !!v.is_local
                }));

                // Auto-select local vendo
                // Auto-select local vendo logic
                if (selectedVendoMode === 'auto') {
                    const localVendo = mappedDevices.find(d => d.isLocal);
                    
                    if (localVendo && localVendo.status === 'online') {
                         // Case 1: Local Online Vendo found -> Select it
                         if (selectedVendoId !== localVendo.id) {
                             console.log('Auto-selecting local vendo:', localVendo.name);
                             selectDevice(localVendo.id, localVendo.name);
                         }
                    } else {
                         // Case 2: No local vendo OR Local vendo is offline -> Fallback to Main Vendo
                         // Only force fallback if we are NOT already on Main Vendo
                         if (selectedVendoId !== 'hardware') {
                             console.log('No active local vendo, defaulting to Main Vendo');
                             selectDevice('hardware', 'Main Vendo');
                         }
                    }
                }
                
                renderDeviceList(mappedDevices);

                // Update Trigger Text
                let selectedName = 'Main Vendo';
                if (selectedVendoId !== 'hardware') {
                    const found = mappedDevices.find(d => d.id === selectedVendoId);
                    if (found) {
                        selectedName = found.name || found.id;
                    } else {
                        // If selected ID not found (e.g. disconnected), maybe keep showing ID or revert
                        selectedName = selectedVendoId;
                    }
                }
                const triggerNameEl = document.getElementById('selected-device-name');
                if (triggerNameEl) triggerNameEl.textContent = selectedName;

                if (data.time_remaining > 0) {
                    updateTimer(data.time_remaining);
                    const pauseBtn = document.getElementById('btn-pause');
                    const statusText = document.getElementById('status-text');
                    
                    if (data.is_paused) {
                        statusText.textContent = 'PAUSED';
                        statusText.className = 'status-text paused';
                        setPortalStatus('paused');
                        pauseBtn.textContent = 'Resume Time';
                        pauseBtn.style.background = '#f39c12';
                        hasRedirected = false; // Reset so we redirect again on resume
                    } else if (data.is_connected) {
                        statusText.textContent = 'Connected';
                        statusText.className = 'status-text connected';
                        setPortalStatus('connected');
                        pauseBtn.textContent = 'Pause Time';
                        pauseBtn.style.background = 'var(--danger)';
                        
                        // Auto-Redirect Logic
                        // If we have time, are not paused, and haven't redirected yet (or just finished inserting coins)
                        if (!hasRedirected && !isInserting) {
                            attemptAutoRedirect();
                        }
                    } else {
                        statusText.textContent = 'Disconnected';
                        statusText.className = 'status-text disconnected';
                        setPortalStatus('disconnected');
                        pauseBtn.textContent = 'Pause Time';
                        pauseBtn.style.background = 'var(--danger)';
                        hasRedirected = false;
                    }
                    pauseBtn.style.display = 'block';
                } else {
                    updateTimer(0);
                    const st = document.getElementById('status-text');
                    if (st) {
                        st.textContent = 'Disconnected';
                        st.className = 'status-text disconnected';
                    }
                    setPortalStatus('disconnected');
                    document.getElementById('btn-pause').style.display = 'none';
                    hasRedirected = false; // Reset redirect flag when disconnected
                }

                updateFreeTimeWidgetVisibility();
            } catch(e) { console.error(e); }
        }

        function updateFreeTimeWidgetVisibility() {
            const widget = document.getElementById('free-time-widget');
            if (!widget) return;
            const enabledGlobal = portalConfig && portalConfig.free_time_widget_enabled;
            let selectedHasFreeTime = false;
            if (selectedVendoId && Array.isArray(lastKnownDevices)) {
                const dev = lastKnownDevices.find(d => d.id === selectedVendoId);
                if (dev && dev.hasFreeTime) selectedHasFreeTime = true;
            }
            const enabled = enabledGlobal || selectedHasFreeTime;
            const hasTime = currentUser && Number(currentUser.time_remaining) > 0;
            if (enabled && !hasTime) {
                widget.style.display = 'block';
            } else {
                widget.style.display = 'none';
            }
        }

        async function claimFreeTime() {
            const btn = document.getElementById('free-time-widget');
            if (!btn) return;
            if (btn.disabled) return;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Please wait...';
            try {
                const payload = {};
                if (currentUser && currentUser.mac_address) {
                    payload.mac = currentUser.mac_address;
                }
                if (selectedVendoId) {
                    payload.targetDeviceId = selectedVendoId;
                }
                const res = await fetch('/api/claim-free-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data && data.success) {
                    showToast('Free time claimed. Checking remaining time...', 'success');
                    btn.style.display = 'none';
                    await updateStatus();
                } else {
                    const msg = data && data.error ? data.error : 'Failed to claim free time';
                    showToast(msg, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Error claiming free time', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function attemptAutoRedirect() {
            if (window.checkInternetInterval) return;

            hasRedirected = true;
            console.log('Attempting auto-redirect with connectivity check...');
            
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = 'Verifying Connection...';
                statusText.className = 'status-text connected';
            }
            setPortalStatus('connected');
            
            let attempts = 0;
            const maxAttempts = 15;

            const checkInternet = () => {
                attempts++;
                const img = new Image();
                img.src = 'http://www.gstatic.com/webp/gallery/1.jpg?t=' + Date.now();
                
                img.onload = function() {
                    console.log('Internet connectivity confirmed.');
                    if (window.checkInternetInterval) clearInterval(window.checkInternetInterval);
                    window.checkInternetInterval = null;

                    if (statusText) statusText.textContent = 'Connected! Redirecting...';
                    
                    setTimeout(() => {
                        window.location.href = 'http://connectivitycheck.gstatic.com/generate_204';
                    }, 500);
                };
                
                img.onerror = function() {
                    console.log('Internet check failed (Attempt ' + attempts + ')');
                    if (attempts >= maxAttempts) {
                        if (window.checkInternetInterval) clearInterval(window.checkInternetInterval);
                        window.checkInternetInterval = null;
                        if (statusText) statusText.textContent = 'Connected';
                        console.log('Max attempts reached. Staying on portal.');
                    }
                };
            };

            checkInternet();
            window.checkInternetInterval = setInterval(checkInternet, 1000);
        }

        function updateTimer(seconds) {
            if (seconds < 0) seconds = 0;
            const timeEl = document.getElementById('time-display');
            if (seconds >= 86400) {
                const d = Math.floor(seconds / 86400);
                const rem = seconds % 86400;
                const h = Math.floor(rem / 3600).toString().padStart(2, '0');
                const m = Math.floor((rem % 3600) / 60).toString().padStart(2, '0');
                const s = (rem % 60).toString().padStart(2, '0');
                if (timeEl) {
                    timeEl.classList.add('long');
                    timeEl.textContent = `${d}d ${h}:${m}:${s}`;
                }
                return;
            }
            if (timeEl) timeEl.classList.remove('long');
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            if (timeEl) timeEl.textContent = `${h}:${m}:${s}`;
        }

        function startCoinMode() {
            // Check Server First!
            fetch('/api/coin/start', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    deviceId,
                    targetDeviceId: selectedVendoId,
                    selectionMode: 'manual' 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                     isInserting = true;
                     coinAmount = 0;
                     initCoinBeep();
                     const isExtend = !!(currentUser && Number(currentUser.time_remaining) > 0);
                     const titleEl = document.getElementById('coin-modal-title');
                     const descEl = document.getElementById('coin-modal-desc');
                     if (titleEl) titleEl.textContent = isExtend ? 'Extend Time' : 'Insert Coins Now';
                     if (descEl) descEl.textContent = isExtend ? 'Insert coins to extend your remaining time.' : 'Please insert coins into the slot.';
                     document.getElementById('modal-coin-amount').textContent = '₱0.00';
                     document.getElementById('modal-coin-time').textContent = 'Equivalent Time: 0 Min';
                     document.getElementById('coin-display').textContent = `₱${Number((currentUser && currentUser.pending_amount) || 0).toFixed(2)}`;
                     openModal('coin-modal');
                     startCoinCountdown(60, 60);
                } else {
                     showToast(data.error || 'Failed to start coin session', 'error');
                }
            })
            .catch(e => {
                console.error(e);
                showToast('Connection Error', 'error');
            });
        }

        async function closeCoinModal() {
            isInserting = false;
            stopCoinCountdown();
            try {
                const res = await fetch('/api/coin/done', { method: 'POST' });
                // Optimistic UI update to ensure button flips immediately
                if (res.ok) {
                    if (currentUser) currentUser.is_paused = 0;
                    const btn = document.getElementById('btn-pause');
                    if (btn) {
                        btn.textContent = 'Pause Time';
                        btn.style.background = 'var(--danger)';
                        btn.style.display = 'block';
                    }
                    const st = document.getElementById('status-text');
                    if (st) {
                        st.textContent = 'Connected';
                        st.className = 'status-text connected';
                    }
                }
            } catch (e) {}
            closeModal('coin-modal');
            await updateStatus();
            
            // Aggressive Resume Loop (3 attempts)
            // Force auto-resume if still paused after coin insertion
            for (let i = 0; i < 3; i++) {
                if (currentUser && currentUser.is_paused) {
                    console.log(`[Auto-Resume] Attempt ${i+1}: Force resuming user...`);
                    try {
                        await fetch('/api/session/resume?t=' + Date.now(), { method: 'POST' });
                        await updateStatus();
                    } catch(e) { console.error(e); }
                    await new Promise(r => setTimeout(r, 500));
                } else {
                    break; // Already active
                }
            }
        }

        async function togglePause() {
            if (!currentUser) return;
            const action = currentUser.is_paused ? 'resume' : 'pause';
            try {
                const ipEl = document.getElementById('ip-display');
                const macEl = document.getElementById('mac-display');
                const curIp = (ipEl && ipEl.textContent && ipEl.textContent !== 'Unknown' && ipEl.textContent !== '...') ? ipEl.textContent : '';
                const curMac = (macEl && macEl.textContent && macEl.textContent !== 'Unknown' && macEl.textContent !== '...') ? macEl.textContent : '';
                if (curIp) localStorage.setItem('last_ip', curIp);
                if (curMac) localStorage.setItem('last_mac', curMac);
            } catch (e) {}
            try {
                await fetch(`/api/session/${action}`, { method: 'POST' });
                updateStatus();
            } catch(e) {}
        }

        async function showRates() {
            // Re-fetch rates just in case
            await fetchRates(); 
            openModal('rates-modal');
        }

        function showPointRates() {
            const balance = currentUser ? (currentUser.points_balance || 0) : 0;
            // Allow viewing rates even with 0 balance
            document.getElementById('modal-points-balance').innerText = balance;
            openModal('point-rates-modal');
            fetchPointRates();
        }

        async function fetchPointRates() {
            try {
                const res = await fetch('/api/point-rates');
                const rates = await res.json();
                const container = document.getElementById('point-rates-list');
                container.innerHTML = '';
                
                if (rates.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No point rates available.</div>';
                    return;
                }

                const balance = currentUser ? (currentUser.points_balance || 0) : 0;

                rates.forEach(rate => {
                    const el = document.createElement('div');
                    el.className = 'point-rate-item';
                    const canAfford = balance >= rate.points;
                    
                    // Calculate Duration H M S
                    const totalSeconds = rate.duration !== undefined ? rate.duration : (rate.minutes * 60);
                    const h = Math.floor(totalSeconds / 3600);
                    const m = Math.floor((totalSeconds % 3600) / 60);
                    const s = totalSeconds % 60;
                    let durationText = '';
                    if (h > 0) durationText += `${h}h `;
                    if (m > 0) durationText += `${m}m `;
                    if (s > 0 || durationText === '') durationText += `${s}s`;
                    
                    el.style.opacity = canAfford ? '1' : '0.6';
                    
                    el.innerHTML = `
                        <div class="rate-amount">${rate.points} Pts</div>
                        <div class="rate-details">
                            <div style="font-weight:bold; color:#2c3e50;">${durationText}</div>
                            <div style="font-size:0.8rem; color:#7f8c8d;">${rate.description || 'No description'}</div>
                        </div>
                        <button class="btn btn-rates btn-redeem" style="background: ${canAfford ? '#9b59b6' : '#95a5a6'};" 
                            ${canAfford ? `onclick="window.redeemPoints(${rate.points})"` : 'disabled'}>
                            ${canAfford ? 'Redeem' : 'Need Pts'}
                        </button>
                    `;
                    container.appendChild(el);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function redeemPoints(points) {
            console.log('redeemPoints called with:', points);
            if (!confirm('Redeem this promo?')) return;
            
            try {
                const res = await fetch('/api/points/redeem', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ points: points })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Redemption successful!', 'success');
                    closeModal('point-rates-modal');
                    updateStatus();
                } else {
                    showToast(data.error || 'Redemption failed', 'error');
                }
            } catch (e) {
                console.error('Error redeeming points:', e);
                showToast('Error redeeming points', 'error');
            }
        }
        
        // Expose to window to ensure onclick works
        window.redeemPoints = redeemPoints;
        window.showPointRates = showPointRates;
        window.fetchPointRates = fetchPointRates;




        async function fetchRates() {
            try {
                let url = '/api/rates';
                if (selectedVendoMode === 'manual' && selectedVendoId) {
                    url += `?device=${encodeURIComponent(selectedVendoId)}`;
                }
                const res = await fetch(url);
                const rates = await res.json();
                const list = document.getElementById('rates-list');
                
                if (rates.length === 0) {
                    list.innerHTML = '<div style="padding:10px;">No rates configured.</div>';
                    return;
                }

                const headerHtml = `
                    <div class="rate-header">
                        <div class="rate-header-col">Rate</div>
                        <div class="rate-header-col">Time</div>
                        <div class="rate-header-col">Speed</div>
                        <div class="rate-header-col">Type</div>
                    </div>
                `;

                const rowsHtml = rates.map(r => {
                    let d = r.minutes + ' Mins';
                    if (r.minutes >= 60) {
                        const h = Math.floor(r.minutes / 60);
                        const m = r.minutes % 60;
                        d = `${h} Hr${h>1?'s':''}${m>0 ? ' '+m+' Min' : ''}`;
                    }
                    const formatSpeed = (kbps) => {
                        if (!kbps) return null;
                        if (kbps >= 1024) {
                            return Math.round(kbps / 1024) + 'M';
                        }
                        return kbps + 'K';
                    };
                    const ul = formatSpeed(r.upload_speed);
                    const dl = formatSpeed(r.download_speed);
                    const type = typeof r.is_pausable !== 'undefined' ? (r.is_pausable ? 'Pausable' : 'Consumable') : '';
                    const speedText = ul && dl ? `${ul}/${dl}` : 'N/A';
                    return `
                        <div class="rate-item">
                            <div class="rate-col rate-price">₱${r.amount}</div>
                            <div class="rate-col rate-time">${d}</div>
                            <div class="rate-col">${speedText}</div>
                            <div class="rate-col">${type}</div>
                        </div>
                    `;
                }).join('');

                list.innerHTML = headerHtml + rowsHtml;
            } catch(e) {}
        }

        async function redeemVoucherMain() {
            const codeInput = document.getElementById('voucher-input-main');
            const code = codeInput.value.trim().toUpperCase();
            const mac = document.getElementById('mac-display').textContent;

            if (!code) return showToast('Please enter a voucher code', 'warning');

            const btn = document.querySelector('.btn-submit');
            const originalText = btn.textContent;
            btn.textContent = '...';
            btn.disabled = true;

            try {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'flex';
                const res = await fetch('/api/voucher/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code, 
                        mac: mac !== 'Unknown' && mac !== '...' ? mac : undefined 
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showToast('Success! Added Time.', 'success');
                    codeInput.value = '';
                    updateStatus();
                } else {
                    // Try Session Restore as fallback
                    try {
                        const loginRes = await fetch('/api/session/restore', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code })
                        });
                        const loginResult = await loginRes.json();
                        
                        if (loginResult.success) {
                             showToast('Session Resumed!', 'success');
                             codeInput.value = '';
                             updateStatus();
                        } else {
                             // Show original voucher error
                             showToast('Error: ' + (result.error || 'Invalid voucher or code'), 'error');
                        }
                    } catch(e) {
                         showToast('Error: ' + (result.error || 'Invalid voucher'), 'error');
                    }
                }
            } catch (e) {
                showToast('Connection failed.', 'error');
            } finally {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'none';
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Helpers
        function openModal(id) {
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 200);
            
            if (id === 'coin-modal') {
                isInserting = false;
                stopCoinCountdown();
            }
        }

        function showAnnouncement() {
            if (!portalConfig || !portalConfig.announcement_enabled) return;
            
            const title = portalConfig.announcement_title || 'Announcement';
            const message = portalConfig.announcement_message || '';
            
            if (!message) return;

            const titleEl = document.getElementById('announcement-title');
            const messageEl = document.getElementById('announcement-message');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            
            const modal = document.getElementById('announcement-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Trigger reflow
                modal.offsetHeight;
                modal.style.opacity = '1';
                const content = modal.querySelector('.modal-content');
                if (content) content.style.transform = 'scale(1)';
            }
        }

        function closeAnnouncement() {
            const modal = document.getElementById('announcement-modal');
            if (modal) {
                modal.style.opacity = '0';
                const content = modal.querySelector('.modal-content');
                if (content) content.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // Close on outside tap for announcement
        const announcementModal = document.getElementById('announcement-modal');
        if (announcementModal) {
            announcementModal.addEventListener('click', (e) => {
                if (e.target === announcementModal) {
                    closeAnnouncement();
                    e.stopPropagation();
                }
            });
        }

        function ensureLicenseBanner() {
            let banner = document.getElementById('portal-license-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'portal-license-banner';
                banner.style.position = 'fixed';
                banner.style.top = '0';
                banner.style.left = '0';
                banner.style.right = '0';
                banner.style.zIndex = '3000';
                banner.style.display = 'none';
                banner.style.padding = '10px 14px';
                banner.style.background = '#c0392b';
                banner.style.color = '#fff';
                banner.style.fontWeight = '600';
                banner.style.textAlign = 'center';
                banner.textContent = 'System expired or restricted. Please contact the administrator.';
                document.body.appendChild(banner);
            }
            return banner;
        }

        async function checkLicenseState() {
            try {
                const res = await fetch('/api/license/status?t=' + Date.now());
                const data = await res.json();
                const banner = ensureLicenseBanner();
                const lic = data.license || {};
                const invalid = !data.isValid || lic.type === 'RESTRICTED';
                banner.style.display = invalid ? 'block' : 'none';
            } catch (e) {}
        }

        // Close outside click
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        }
    </script>
    <!-- Chat Widget -->
    <div id="chat-widget-btn" class="chat-widget-btn" onclick="toggleChat()">
        <div id="chat-unread-badge" class="chat-unread-badge"></div>
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    </div>

    <div id="chat-widget-box" class="chat-widget-box">
        <div class="chat-widget-header">
            <span>Support Chat</span>
            <span class="close-btn" onclick="toggleChat()">&times;</span>
        </div>
        <div id="chat-messages" class="chat-widget-messages">
            <div style="text-align:center; color:#999; font-size:0.8rem; margin-top:20px;">Connecting...</div>
        </div>
        <div class="chat-widget-input">
            <input type="text" id="chat-input" placeholder="Type a message..." disabled>
            <button id="chat-send-btn" onclick="sendChatMessage()" disabled>→</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Chat Logic ---
        let chatSocket = null;
        let chatEnabled = false;
        let chatId = null; 
        let isChatOpen = false;

        function initChatWithId(id) {
            const isNewId = chatId !== id;
            chatId = id;
            
            if (typeof io !== 'undefined' && !chatSocket) {
                chatSocket = io();
                
                chatSocket.on('connect', () => {
                    console.log('Chat Connected');
                    chatSocket.emit('join_chat', { id: chatId });
                });

                chatSocket.on('chat_status', (data) => {
                    chatEnabled = data.enabled;
                    const btn = document.getElementById('chat-widget-btn');
                    const box = document.getElementById('chat-widget-box');
                    if (chatEnabled) {
                        btn.style.display = 'flex';
                        // Restore badge
                        const stored = localStorage.getItem('chat_unread_count');
                        if (stored && parseInt(stored) > 0) {
                             const badge = document.getElementById('chat-unread-badge');
                             badge.style.display = 'flex';
                             badge.textContent = stored;
                        }
                    } else {
                        btn.style.display = 'none';
                        box.style.display = 'none';
                        isChatOpen = false;
                    }
                });

                chatSocket.on('chat_history', (messages) => {
                    const container = document.getElementById('chat-messages');
                    container.innerHTML = '';
                    messages.forEach(msg => appendMessage(msg));
                    scrollToBottom();
                    enableInput();
                });

                chatSocket.on('new_message', (msg) => {
                    appendMessage({
                        message: msg.message,
                        is_from_admin: msg.sender === 'admin',
                        timestamp: msg.timestamp
                    });
                    
                    if (msg.sender === 'admin') {
                        if (!isChatOpen) {
                            showUnreadBadge();
                        }
                    }
                    scrollToBottom();
                });
            } else if (chatSocket && chatSocket.connected && isNewId) {
                chatSocket.emit('join_chat', { id: chatId });
            }
        }

        function toggleChat() {
            if (!chatEnabled) return;
            const box = document.getElementById('chat-widget-box');
            const badge = document.getElementById('chat-unread-badge');
            
            isChatOpen = !isChatOpen;
            
            if (isChatOpen) {
                box.classList.add('open');
                badge.style.display = 'none';
                badge.textContent = '';
                localStorage.setItem('chat_unread_count', '0');
                scrollToBottom();
                // Focus after animation
                setTimeout(() => document.getElementById('chat-input').focus(), 300);
            } else {
                box.classList.remove('open');
            }
        }

        function showUnreadBadge() {
            const badge = document.getElementById('chat-unread-badge');
            badge.style.display = 'flex';
            const count = parseInt(badge.textContent || '0') + 1;
            badge.textContent = count;
            localStorage.setItem('chat_unread_count', count.toString());
        }

        function enableInput() {
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
        }

        function appendMessage(msg) {
            const container = document.getElementById('chat-messages');
            if (container.textContent.includes('Connecting...')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            const isMe = !msg.is_from_admin;
            const d = msg.timestamp ? new Date(msg.timestamp) : new Date();
            const ts = d.toLocaleString([], {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.className = `chat-msg ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                <div>${msg.message}</div>
                <div style="font-size:11px; opacity:0.8; margin-top:2px;">${ts}</div>
            `;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }
        }

        function sendChatMessage() {
            if (!chatSocket || !chatEnabled) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            chatSocket.emit('send_message', {
                id: chatId,
                message: message
            });
            
            input.value = '';
            input.focus();
            setTimeout(() => input.focus(), 10);
        }

        document.getElementById('chat-input').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Prevent send button from stealing focus on mobile
        const sendBtn = document.getElementById('chat-send-btn');
        const handleSendClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            sendChatMessage();
        };
        // Use mousedown for desktop/mouse
        sendBtn.addEventListener('mousedown', handleSendClick);
        // Use touchstart for mobile to trigger immediately and prevent focus loss
        sendBtn.addEventListener('touchstart', handleSendClick, {passive: false});
        
        window.initChatWithId = initChatWithId;
        window.initChatWithMac = function(mac) {
            if (typeof deviceId !== 'undefined') {
                initChatWithId(deviceId);
            }
        };
        document.addEventListener('DOMContentLoaded', () => {
            checkLicenseState();
            setInterval(checkLicenseState, 10000);
        });
    </script>
</body>
</html>
