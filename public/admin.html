<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoFi</title>
    <!-- Try Local Chart.js only - Removed CDN fallback to prevent offline blocking -->
    <script src="/js/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Optional: Add simple placeholder if Chart is missing
        if (typeof Chart === 'undefined') {
             console.warn('Chart.js not found locally. Charts will be disabled.');
        }




        // Helper for display
        function formatDuration(totalMinutes) {
            const d = Math.floor(totalMinutes / 1440);
            const h = Math.floor((totalMinutes % 1440) / 60);
            const m = totalMinutes % 60;
            const parts = [];
            if (d > 0) parts.push(d + 'd');
            if (h > 0) parts.push(h + 'h');
            if (m > 0 || parts.length === 0) parts.push(m + 'm');
            return parts.join(' ');
        }

        // --- Rates Management ---
        async function loadRatesData() {
            try {
                const res = await fetch('/api/admin/rates');
                const rates = await res.json();
                const tbody = document.querySelector('#rates-table tbody');
                tbody.innerHTML = '';

                if (rates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No rates configured</td></tr>';
                    return;
                }

                rates.forEach(rate => {
                    const tr = document.createElement('tr');
                    // Check if speed is stored in kbps and display in Mbps if suitable
                    const uploadMbps = (rate.upload_speed >= 1024) ? (rate.upload_speed / 1024).toFixed(1) + ' Mbps' : rate.upload_speed + ' Kbps';
                    const downloadMbps = (rate.download_speed >= 1024) ? (rate.download_speed / 1024).toFixed(1) + ' Mbps' : rate.download_speed + ' Kbps';
                    
                    tr.innerHTML = `
                        <td>₱${rate.amount}</td>
                        <td>${formatDuration(rate.minutes)}</td>
                        <td>${uploadMbps} / ${downloadMbps}</td>
                        <td>${rate.is_pausable ? '<span class="badge bg-success">Pausable</span>' : '<span class="badge bg-secondary">Continuous</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteRate(${rate.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Error loading rates:', e);
            }
        }

        function openRateModal(rate) {
            const modal = document.getElementById('rate-modal');
            const idInput = document.getElementById('rate-id');
            const amountInput = document.getElementById('rate-amount');
            const daysInput = document.getElementById('rate-days');
            const hoursInput = document.getElementById('rate-hours');
            const minutesInput = document.getElementById('rate-minutes');
            const ulInput = document.getElementById('rate-ul');
            const dlInput = document.getElementById('rate-dl');
            const pausableInput = document.getElementById('rate-pausable');

            if (rate && typeof rate === 'object') {
                idInput.value = rate.id || '';
                amountInput.value = rate.amount != null ? rate.amount : '';

                const totalMinutes = parseInt(rate.minutes, 10) || 0;
                const d = Math.floor(totalMinutes / 1440);
                const h = Math.floor((totalMinutes % 1440) / 60);
                const m = totalMinutes % 60;
                daysInput.value = d;
                hoursInput.value = h;
                minutesInput.value = m;

                const upKbps = Number(rate.upload_speed) || 5120;
                const downKbps = Number(rate.download_speed) || 5120;
                ulInput.value = (upKbps / 1024).toFixed(1);
                dlInput.value = (downKbps / 1024).toFixed(1);

                pausableInput.checked = !!rate.is_pausable;
            } else {
                idInput.value = '';
                amountInput.value = '';
                daysInput.value = 0;
                hoursInput.value = 0;
                minutesInput.value = 15;
                ulInput.value = 5;
                dlInput.value = 5;
                pausableInput.checked = true;
            }

            modal.style.display = 'flex';
        }

        function closeRateModal() {
            document.getElementById('rate-modal').style.display = 'none';
        }

        async function saveRate() {
            const amount = document.getElementById('rate-amount').value;
            
            const days = parseInt(document.getElementById('rate-days').value) || 0;
            const hours = parseInt(document.getElementById('rate-hours').value) || 0;
            const minutes = parseInt(document.getElementById('rate-minutes').value) || 0;
            const totalMinutes = (days * 1440) + (hours * 60) + minutes;

            const uploadMbps = parseFloat(document.getElementById('rate-ul').value);
            const downloadMbps = parseFloat(document.getElementById('rate-dl').value);
            const isPausable = document.getElementById('rate-pausable').checked;

            if (!amount || totalMinutes <= 0 || !uploadMbps || !downloadMbps) {
                alert('Please fill in all fields. Duration must be greater than 0.');
                return;
            }

            const data = {
                amount: parseInt(amount),
                minutes: totalMinutes,
                upload_speed: Math.round(uploadMbps * 1024),
                download_speed: Math.round(downloadMbps * 1024),
                is_pausable: isPausable ? 1 : 0
            };

            try {
                const res = await fetch('/api/admin/rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeRateModal();
                    loadRatesData();
                    try {
                        if (currentSubVendoDeviceId) {
                            populateSubVendoDeviceRates(currentSubVendoDeviceId);
                        }
                    } catch (e) {}
                    alert('Rate saved successfully');
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.error);
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save rate');
            }
        }

        // --- Devices Management ---
        async function loadDevicesData() {
            try {
                const res = await fetch('/api/admin/devices');
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                
                const devices = await res.json();
                if (!Array.isArray(devices)) return;

                const tbody = document.querySelector('#devices-table tbody');
                tbody.innerHTML = '';

                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No devices found</td></tr>';
                    return;
                }

                devices.forEach(dev => {
                    const tr = document.createElement('tr');
                    
                    // Status Badge
                    let statusBadge = '<span class="badge bg-secondary">Offline</span>';
                    
                    if (dev.is_paused) {
                        statusBadge = '<span class="badge bg-warning">Paused</span>';
                    } else if (dev.is_connected) {
                        statusBadge = '<span class="badge bg-success">Connected</span>';
                    }

                    tr.innerHTML = `
                        <td>${dev.mac_address}</td>
                        <td>${(dev.ip_address || 'N/A').replace('::ffff:', '')}</td>
                        <td>${dev.hostname || dev.name || 'Unknown'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="disconnectDevice(${dev.id})">Disconnect</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Error loading devices:', e);
            }
        }

        async function disconnectDevice(id) {
            if (!await showConfirm('Are you sure you want to disconnect and remove this device?', true)) return;
            try {
                const res = await fetch(`/api/admin/devices/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadDevicesData();
                } else {
                    alert('Failed to disconnect device');
                }
            } catch (e) {
                console.error(e);
                alert('Error disconnecting device');
            }
        }

        async function deleteRate(id) {
            if (!await showConfirm('Are you sure you want to delete this rate?', true)) return;

            try {
                const res = await fetch(`/api/admin/rates/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadRatesData();
                } else {
                    alert('Failed to delete rate');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting rate');
            }
        }
        // --- QoS Logic ---
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function loadQoSUsers() {
            fetch('/api/admin/dashboard')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#qos-users-table tbody');
                    tbody.innerHTML = '';
                    if (!data.active_sessions || data.active_sessions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No active users</td></tr>';
                        return;
                    }
                    
                    data.active_sessions.forEach(user => {
                        const tr = document.createElement('tr');
                        // Rate is in Mbps, convert to readable
                        // Traffic is in bytes
                        const dlRate = (user.rate_down || 0).toFixed(2) + ' Mbps';
                        const ulRate = (user.rate_up || 0).toFixed(2) + ' Mbps';
                        const dlTotal = formatBytes(user.traffic_down || 0);
                        const ulTotal = formatBytes(user.traffic_up || 0);

                        tr.innerHTML = `
                            <td>${user.ip}</td>
                            <td>${user.mac}</td>
                            <td>
                                <div style="font-weight:600; color:var(--gauge-6);">${dlRate}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">Total: ${dlTotal}</div>
                            </td>
                            <td>
                                <div style="font-weight:600; color:var(--gauge-2);">${ulRate}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">Total: ${ulTotal}</div>
                            </td>
                            <td>
                                <div><small>DL:</small> ${(user.speed_limit_down / 1024).toFixed(2)} Mbps</div>
                                <div><small>UL:</small> ${(user.speed_limit_up / 1024).toFixed(2)} Mbps</div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editQosLimit('${user.ip}', ${(user.speed_limit_down / 1024).toFixed(2)}, ${(user.speed_limit_up / 1024).toFixed(2)})">Edit Limit</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        let currentQosIp = null;
        function editQosLimit(ip, dl, ul) {
            currentQosIp = ip;
            document.getElementById('qos-modal-ip').textContent = `User IP: ${ip}`;
            document.getElementById('qos-edit-dl').value = dl;
            document.getElementById('qos-edit-ul').value = ul;
            document.getElementById('qos-limit-modal').style.display = 'flex';
        }

        function saveQosLimit() {
            const dl = document.getElementById('qos-edit-dl').value;
            const ul = document.getElementById('qos-edit-ul').value;
            if (!currentQosIp) return;

            const dlKbps = Math.floor(parseFloat(dl) * 1024);
            const ulKbps = Math.floor(parseFloat(ul) * 1024);

            fetch('/api/admin/qos/limit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: currentQosIp, download_speed: dlKbps, upload_speed: ulKbps })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('qos-limit-modal').style.display = 'none';
                    loadQoSUsers(); // Refresh list
                    alert('Limit updated successfully');
                } else {
                    alert(data.error || 'Failed to set limit');
                }
            });
        }

        const qosDescriptions = {
            'gaming': '<strong>Gaming / Low-Latency Focused</strong><br>AI-driven prioritization for competitive gaming. Minimizes jitter (<5ms) and protects against lag spikes using micro-burst protection. Ideal for gamers and streamers.',
            'family': '<strong>Family / Household Management</strong><br>Balances bandwidth across all users. Ensures fair sharing for video calls, streaming, and browsing. Includes priority ladders for parents vs kids.',
            'enterprise': '<strong>Enterprise / Business Critical</strong><br>Guaranteed performance for VoIP, Teams, and mission-critical apps. Uses strict slicing to ensure reliability even during heavy load.',
            'green': '<strong>Green / Sustainable Angle</strong><br>Optimizes network for energy efficiency. Delays non-critical background tasks during high-load/high-carbon periods while keeping real-time apps smooth.'
        };

        function updateQoSDescription() {
            const mode = document.getElementById('qos-mode-select').value;
            let html = qosDescriptions[mode];
            
            if (mode === 'gaming') {
                html += '<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">' +
                        '<button class="btn btn-danger" style="background:var(--danger); border:none;" onclick="triggerRageMode()">ðŸ”¥ Activate Rage Mode (5m)</button>' +
                        '<p style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">Temporarily boosts all gaming traffic to absolute priority. Use when you experience lag spikes.</p>' +
                        '</div>';
            } else if (mode === 'green') {
                 html += '<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:15px;">' +
                        '<div style="text-align:center;"><div style="font-size:1.2rem; font-weight:bold; color:var(--status-active);">12.4g</div><div style="font-size:0.8rem; color:var(--text-muted);">COâ‚‚ Saved Today</div></div>' +
                        '<div style="text-align:center;"><div style="font-size:1.2rem; font-weight:bold; color:var(--status-active);">142Wh</div><div style="font-size:0.8rem; color:var(--text-muted);">Energy Saved</div></div>' +
                        '</div>';
            }
            
            document.getElementById('qos-mode-desc').innerHTML = html;
        }

        async function triggerRageMode() {
            if(!await showConfirm("Activate Rage Mode? This will prioritize gaming traffic over everything else for 5 minutes.")) return;
            try {
                const res = await fetch('/api/admin/qos/rage', { method: 'POST' });
                const data = await res.json();
                if(data.success) alert("ðŸ”¥ Rage Mode Activated! You have 5 minutes of god-mode priority.");
                else alert("Failed to activate Rage Mode");
            } catch(e) { console.error(e); }
        }

        async function loadQoSMode() {
             try {
                const res = await fetch('/api/admin/qos/config');
                const config = await res.json();
                if(config.qos_mode) {
                    document.getElementById('qos-mode-select').value = config.qos_mode;
                }
                updateQoSDescription();
            } catch(e) { console.error(e); }
        }

        async function saveQoSMode() {
            const mode = document.getElementById('qos-mode-select').value;
             try {
                const res = await fetch('/api/admin/qos/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ qos_mode: mode })
                });
                if(res.ok) alert('QoS Mode Updated');
                else alert('Failed to update QoS Mode');
            } catch(e) { console.error(e); alert('Error saving mode'); }
        }
        // --- Security & Maintenance ---
        async function loadSecurityCredentials() {
            try {
                const res = await fetch('/api/admin/security/credentials');
                const data = await res.json();
                
                if (data.username) {
                    document.getElementById('admin-username').value = data.username;
                }
                if (data.security_question) {
                    document.getElementById('admin-security-question').value = data.security_question;
                }
                if (data.security_answer) {
                    document.getElementById('admin-security-answer').value = data.security_answer;
                }
            } catch (e) {
                console.error("Failed to load security credentials", e);
            }
        }

        function togglePasswordVisibility(inputId, btnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            
            const eyeOpen = `<svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            const eyeClosed = `<svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;

            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = eyeClosed;
            } else {
                input.type = 'password';
                btn.innerHTML = eyeOpen;
            }
        }

        async function updateCredentials(e) {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const confirm = document.getElementById('admin-confirm-password').value;
            const security_question = document.getElementById('admin-security-question').value;
            const security_answer = document.getElementById('admin-security-answer').value;

            if (password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            try {
                const res = await fetch('/api/admin/security/credentials', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password, security_question, security_answer })
                });
                
                if (res.ok) {
                    await showConfirm("Credentials updated successfully. Please login again.", false, "Success");
                    logout(true);
                } else {
                    const data = await res.json();
                    alert("Error: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("Failed to update credentials");
            }
        }

        async function rebootSystem() {
            if (!await showConfirm("Are you sure you want to REBOOT the system?", true)) return;
            try {
                const res = await fetch('/api/admin/system/reboot', { method: 'POST' });
                if (res.ok) {
                    alert("System is rebooting. Please wait about 60 seconds before refreshing.");
                } else {
                    alert("Failed to initiate reboot");
                }
            } catch (e) {
                alert("Error sending reboot command");
            }
        }

        async function downloadBackup() {
            if (!await showConfirm("Generate and download app data backup?", true)) return;
            try {
                const res = await fetch('/api/admin/system/backup');
                if (!res.ok) {
                    let message = "Failed to generate backup";
                    try {
                        const data = await res.json();
                        if (data && data.error) {
                            message = data.error;
                        }
                    } catch (err) {}
                    alert(message);
                    return;
                }

                const blob = await res.blob();
                let filename = "pisowifi-backup.sqlite";
                const disposition = res.headers.get('Content-Disposition') || res.headers.get('content-disposition');
                if (disposition) {
                    const match = disposition.match(/filename="?([^"]+)"?/i);
                    if (match && match[1]) {
                        filename = match[1];
                    }
                }

                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                window.URL.revokeObjectURL(url);
            } catch (e) {
                alert("Error generating backup: " + e.message);
            }
        }

        async function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.sqlite,application/octet-stream';

            input.onchange = async (event) => {
                const file = event.target.files && event.target.files[0];
                if (!file) return;

                if (!await showConfirm("Restore from this backup? This will overwrite current data.", true)) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const backup = reader.result;
                        const res = await fetch('/api/admin/system/restore', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ backup })
                        });

                        if (res.ok) {
                            alert('Restore completed. It is recommended to REBOOT the system.');
                        } else {
                            let message = 'Failed to restore from backup';
                            try {
                                const data = await res.json();
                                if (data && data.error) {
                                    message = data.error;
                                }
                            } catch (err) {}
                            alert(message);
                        }
                    } catch (e) {
                        alert('Error restoring backup: ' + e.message);
                    }
                };
                reader.readAsDataURL(file);
            };

            input.click();
        }

        async function factoryReset() {
            const code = await showPrompt("Type 'RESET' to confirm factory reset. This will delete all data!", "Type RESET here", "Factory Reset");
            if (code !== 'RESET') return;
            
            try {
                const res = await fetch('/api/admin/system/reset', { method: 'POST' });
                if (res.ok) {
                    await showConfirm("Factory reset complete. System will now restart.", false, "Success");
                    // Reload or logout
                    location.reload();
                } else {
                    alert("Failed to factory reset");
                }
            } catch (e) {
                alert("Error performing factory reset");
            }
        }

        async function upgradeSystem(type) {
            if (!await showConfirm(`Start ${type} system upgrade? System may be offline for a few minutes.`, true)) return;
            try {
                const res = await fetch('/api/admin/system/upgrade', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type })
                });
                if (res.ok) {
                    alert("Upgrade initiated. Check logs or wait for system restart.");
                } else {
                    alert("Failed to start upgrade");
                }
            } catch (e) {
                alert("Error starting upgrade");
            }
        }

        function createUpdatePackage() {
            window.location.href = '/api/admin/system/create-update';
        }

        async function uploadUpdatePackage() {
            const fileInput = document.getElementById('update-file-input');
            const file = fileInput.files[0];
            if (!file) return;

            if (!await showConfirm('Are you sure you want to upload and apply this update package? The system will restart.', true)) {
                fileInput.value = '';
                return;
            }

            // Convert to Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Data = reader.result.split(',')[1];
                
                // Show loading
                alert("Uploading and applying update... Please wait.");
                
                try {
                    const res = await fetch('/api/admin/system/apply-update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileData: base64Data })
                    });
                    
                    if (res.ok) {
                        alert("Update applied successfully! System is restarting...");
                        setTimeout(() => location.reload(), 5000);
                    } else {
                        const err = await res.json();
                        alert("Update failed: " + err.error);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Update failed: " + e.message);
                } finally {
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert("Failed to read file");
                fileInput.value = '';
            };
        }

        async function verifyConfiguration() {
            const modal = document.getElementById('verify-modal');
            const content = document.getElementById('verify-results');
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spin" style="width:30px; height:30px; border:3px solid var(--border); border-top:3px solid var(--info); border-radius:50%; margin:0 auto 10px;"></div>Running system checks...</div>';

            try {
                const res = await fetch('/api/admin/system/verify');
                const data = await res.json();
                
                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += `<thead><tr style="background: var(--table-header-bg); text-align:left;">
                    <th style="padding:10px;">
                        <span style="display:inline-flex;align-items:center;gap:6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                            <span>Category</span>
                        </span>
                    </th>
                    <th style="padding:10px;">
                        <span style="display:inline-flex;align-items:center;gap:6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            <span>Status</span>
                        </span>
                    </th>
                    <th style="padding:10px;">
                        <span style="display:inline-flex;align-items:center;gap:6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                            <span>Message</span>
                        </span>
                    </th>
                </tr></thead><tbody>`;
                
                data.checks.forEach(check => {
                    let color = 'var(--text-muted)';
                    let icon = 'â€¢';
                    if (check.status === 'success') { color = 'var(--status-active)'; icon = 'âœ”'; }
                    else if (check.status === 'warning') { color = 'var(--warning)'; icon = 'âš '; }
                    else if (check.status === 'error') { color = 'var(--status-expired)'; icon = 'âœ–'; }
                    else if (check.status === 'info') { color = 'var(--info)'; icon = 'â„¹'; }
                    
                    html += `<tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:10px; font-weight:600;">${check.category}</td>
                        <td style="padding:10px; color:${color}; font-weight:bold;">${icon} ${check.status.toUpperCase()}</td>
                        <td style="padding:10px;">${check.message}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += `<div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted); text-align:right;">Checked at: ${new Date(data.timestamp).toLocaleString()}</div>`;
                
                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = `<div style="color:var(--danger); text-align:center; padding:20px;">Error running checks: ${e.message}</div>`;
            }
        }

        // --- Chat System ---
        let chatSocket = null;
        let currentChatMac = null;
        let currentChatType = 'hotspot';

        function setChatType(type) {
            currentChatType = type;
            
            // Update buttons
            const btnHotspot = document.getElementById('chat-type-hotspot');
            const btnPppoe = document.getElementById('chat-type-pppoe');
            
            if (btnHotspot && btnPppoe) {
                btnHotspot.className = type === 'hotspot' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';
                btnPppoe.className = type === 'pppoe' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';
            }
            
            // Clear current chat view
            currentChatMac = null;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-current-user').textContent = 'Select a conversation';
            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            
            // Reload list
            loadConversations();
        }

        function updateChatStatus(connected) {
            const indicator = document.getElementById('chat-status-indicator');
            const dot = indicator.querySelector('.status-dot');
            const text = indicator.querySelector('.status-text');
            
            indicator.style.display = 'flex';
            if (connected) {
                dot.style.background = 'var(--status-active)';
                text.textContent = 'Connected';
            } else {
                dot.style.background = 'var(--status-expired)';
                text.textContent = 'Disconnected';
            }
        }

        function initChatSocket() {
            if (chatSocket) return;
            
            // Connect to root namespace
            // Note: Socket.io client script must be loaded
            if (typeof io === 'undefined') {
                console.error("Socket.io not loaded");
                return;
            }

            chatSocket = io({
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });

            chatSocket.on('connect', () => {
                console.log('Admin Chat Connected');
                updateChatStatus(true);
                if (currentChatMac) {
                    chatSocket.emit('admin_join_chat', { mac: currentChatMac });
                }
            });

            chatSocket.on('disconnect', () => {
                console.log('Admin Chat Disconnected');
                updateChatStatus(false);
            });
            
            chatSocket.on('connect_error', (err) => {
                console.log('Chat connection error:', err);
                updateChatStatus(false);
            });

            // Listen for new messages from users (Global broadcast)
            chatSocket.on('admin_new_message', (data) => {
                // data: { mac, sender: 'user', message, timestamp, unread_count }
                
                // If viewing this conversation, append message
                if (currentChatMac === data.mac) {
                    appendChatMessage({
                        message: data.message,
                        timestamp: data.timestamp,
                        is_from_admin: 0 
                    });
                    // Mark as read
                    fetch(`/api/admin/chat/history/${data.mac}`);
                }
                
                // Refresh list
                loadConversations();
            });

            // Listen for messages in the room (including my own echo if I joined)
            chatSocket.on('new_message', (data) => {
                // Ignore own messages or handle duplicates
            });
        }


        async function loadConversations() {
            try {
                const res = await fetch(`/api/admin/chat/conversations?type=${currentChatType}`);
                const conversations = await res.json();
                
                const list = document.getElementById('chat-list');
                list.innerHTML = '';

                if (!Array.isArray(conversations) || conversations.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color: var(--text-muted);">No conversations yet.</div>';
                    return;
                }

                const byKey = new Map();
                conversations.forEach(c => {
                    const mac = c.sender_mac;
                    const key = c.user_code || c.client_id || mac;
                    const unread = Number(c.unread_count || 0);
                    const ts = c.timestamp ? new Date(c.timestamp).getTime() : 0;
                    const existing = byKey.get(key);
                    if (!existing) {
                        byKey.set(key, {
                            key,
                            sender_mac: mac,
                            user_code: c.user_code,
                            client_id: c.client_id,
                            message: c.message,
                            timestamp: c.timestamp,
                            unread_count: unread
                        });
                    } else {
                        const existingTs = existing.timestamp ? new Date(existing.timestamp).getTime() : 0;
                        if (ts > existingTs) {
                            existing.sender_mac = mac;
                            existing.message = c.message;
                            existing.timestamp = c.timestamp;
                        }
                        existing.unread_count = Number(existing.unread_count || 0) + unread;
                    }
                });

                const uniqueConversations = Array.from(byKey.values()).sort((a, b) => {
                    const ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                    const tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                    return tb - ta;
                });

                uniqueConversations.forEach(c => {
                    const mac = c.sender_mac;
                    const displayName = c.user_code ? `ID: ${c.user_code}` : (c.client_id ? `Dev: ${c.client_id.substring(0,8)}...` : mac);
                    
                    const div = document.createElement('div');
                    div.className = `chat-item ${currentChatMac === mac ? 'active' : ''} ${c.unread_count > 0 ? 'unread' : ''}`;
                    div.dataset.chatKey = mac;
                    div.dataset.chatLabel = displayName;
                    div.onclick = () => selectConversation(mac, displayName);
                    
                    const time = c.timestamp ? new Date(c.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const unreadHtml = c.unread_count > 0 ? `<span class="chat-badge">${c.unread_count}</span>` : '';
                    const preview = c.message || '<i>No messages</i>';
                    
                    div.innerHTML = `
                        <div class="chat-item-header">
                            <span class="chat-mac" style="${c.unread_count > 0 ? 'font-weight:800; color:var(--text-main);' : ''}">${displayName}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-preview">
                            ${preview}
                        </div>
                        ${unreadHtml}
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error("Load conversations error", e);
            }
        }

        function toggleChatSidebar() {
            const sidebar = document.getElementById('chat-sidebar');
            sidebar.classList.toggle('hidden');
        }

        async function selectConversation(mac, label) {
            currentChatMac = mac;
            localStorage.setItem('admin_chat_active_mac', mac);
            
            // Auto-hide sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('chat-sidebar').classList.add('hidden');
            }
            
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            document.getElementById('chat-current-user').textContent = `Chat with ${label || mac}`;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
            document.getElementById('chat-input').focus();
            
            // Join the room
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('admin_join_chat', { mac: mac });
            }

            // Load History
            await loadChatHistory(mac);
            
            // Refresh list to clear unread
            loadConversations();
        }

        async function loadChatHistory(mac) {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Loading history...</div>';
            
            try {
                const res = await fetch(`/api/admin/chat/history/${mac}`, { credentials: 'include' });
                if (res.status === 401) return location.reload();
                const messages = await res.json();
                
                container.innerHTML = '';
                if (messages.length === 0) {
                     container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No messages yet. Start chatting!</div>';
                } else {
                    messages.forEach(msg => appendChatMessage(msg));
                }
                scrollToBottom();
            } catch (e) {
                container.innerHTML = '<div style="text-align:center; color:var(--danger);">Failed to load history</div>';
            }
        }

        function appendChatMessage(msg) {
            const container = document.getElementById('chat-messages');
            // Remove "No messages" placeholder if exists
            if (container.textContent.includes('No messages yet') || container.textContent.includes('Loading history')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            // Check if msg is from admin or user
            const isMe = msg.is_from_admin == 1; 
            
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                ${msg.message}
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }
        }

        async function sendAdminMessage() {
            if (!currentChatMac) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Check socket connection
            if (!chatSocket || !chatSocket.connected) {
                // Try to reconnect if socket exists but disconnected
                if (chatSocket) {
                     console.log("Socket disconnected. Attempting to reconnect...");
                     chatSocket.connect();
                     // Give it a moment? No, better to show status.
                } else {
                     initChatSocket();
                }
                
                // If still not connected immediately, we can't send.
                // But let's check again in 500ms? 
                // For now, show alert.
                alert('Chat is currently disconnected. Please wait for reconnection (check status indicator).');
                return;
            }
            
            // Emit via socket
            chatSocket.emit('admin_send_message', {
                mac: currentChatMac,
                message: message
            });
            
            // Optimistically append
            appendChatMessage({
                message: message,
                is_from_admin: 1,
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            input.focus();
        }

        // Initialize socket and event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
             // Chat Input Listener
             const chatInput = document.getElementById('chat-input');
             if (chatInput) {
                 chatInput.addEventListener('keypress', function (e) {
                     if (e.key === 'Enter') {
                         sendAdminMessage();
                     }
                 });
             }
             
             const sendBtn = document.getElementById('chat-send-btn');
            if (sendBtn) {
                const handleSendClick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sendAdminMessage();
                };
                sendBtn.addEventListener('mousedown', handleSendClick);
                sendBtn.addEventListener('touchstart', handleSendClick, {passive: false});
            }
             
         });

        // --- Sub Vendo Functions ---

        async function loadSubVendoConfig() {
            try {
                const res = await fetch('/api/admin/subvendo/key');
                if (res.status === 401) return location.reload();
                const data = await res.json();
                document.getElementById('subvendo-key').value = data.key || '';
                try {
                    const wRes = await fetch('/api/admin/subvendo/free-time-widget');
                    if (wRes.status === 401) return location.reload();
                    const wData = await wRes.json();
                    const toggle = document.getElementById('subvendo-free-time-widget-toggle');
                    if (toggle) toggle.checked = !!wData.enabled;
                } catch (e) {}
                try {
                    const sRes = await fetch('/api/admin/settings');
                    if (sRes.status === 401) return location.reload();
                    const settings = await sRes.json();
                    const enabledRaw = settings.main_free_time_enabled;
                    const enabled = enabledRaw === '1' || enabledRaw === 1 || enabledRaw === true || enabledRaw === 'true';
                    const enabledEl = document.getElementById('main-free-enabled');
                    const hEl = document.getElementById('main-free-h');
                    const mEl = document.getElementById('main-free-m');
                    const sEl = document.getElementById('main-free-s');
                    const dlEl = document.getElementById('main-free-dl');
                    const ulEl = document.getElementById('main-free-ul');
                    const reclaimEl = document.getElementById('main-free-reclaim');
                    const vlanEl = document.getElementById('main-free-vlan');
                    if (enabledEl) enabledEl.checked = enabled;
                    const totalSeconds = Number(settings.main_free_time_seconds || 0);
                    if (Number.isFinite(totalSeconds) && totalSeconds > 0) {
                        const h = Math.floor(totalSeconds / 3600);
                        const m = Math.floor((totalSeconds % 3600) / 60);
                        const s = totalSeconds % 60;
                        if (hEl) hEl.value = h || '';
                        if (mEl) mEl.value = m || '';
                        if (sEl) sEl.value = s || '';
                    } else {
                        if (hEl) hEl.value = '';
                        if (mEl) mEl.value = '';
                        if (sEl) sEl.value = '';
                    }
                    if (dlEl) {
                        const dlKbps = Number(settings.main_free_time_download_speed || 0);
                        if (Number.isFinite(dlKbps) && dlKbps > 0) {
                            dlEl.value = (dlKbps / 1024);
                        } else {
                            dlEl.value = '';
                        }
                    }
                    if (ulEl) {
                        const ulKbps = Number(settings.main_free_time_upload_speed || 0);
                        if (Number.isFinite(ulKbps) && ulKbps > 0) {
                            ulEl.value = (ulKbps / 1024);
                        } else {
                            ulEl.value = '';
                        }
                    }
                    if (reclaimEl) reclaimEl.value = settings.main_free_time_reclaim_days || '';
                    if (vlanEl) vlanEl.value = settings.main_free_time_vlan || '';
                } catch (e) {}
            } catch (e) {
                console.error("Failed to load sub vendo config", e);
            }
        }

        async function saveSubVendoKey() {
            const key = document.getElementById('subvendo-key').value;
            try {
                const res = await fetch('/api/admin/subvendo/key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Sub Vendo Key Saved');
                } else {
                    alert('Error saving key');
                }
            } catch (e) {
                console.error("Failed to save sub vendo key", e);
                alert('Error saving key');
            }
        }

        async function toggleSubVendoFreeTimeWidget(el) {
            const enabled = !!(el && el.checked);
            try {
                const res = await fetch('/api/admin/subvendo/free-time-widget', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled })
                });
                const data = await res.json();
                if (!data || !data.success) {
                    alert('Failed to update Free Time widget setting');
                }
            } catch (e) {
                console.error("Failed to update free time widget", e);
                alert('Error updating Free Time widget setting');
            }
        }

        async function saveMainFreeTimeConfig() {
            const enabledEl = document.getElementById('main-free-enabled');
            const hEl = document.getElementById('main-free-h');
            const mEl = document.getElementById('main-free-m');
            const sEl = document.getElementById('main-free-s');
            const dlEl = document.getElementById('main-free-dl');
            const ulEl = document.getElementById('main-free-ul');
            const reclaimEl = document.getElementById('main-free-reclaim');
            const vlanEl = document.getElementById('main-free-vlan');
            const payload = {};
            if (enabledEl && enabledEl.checked) {
                payload.main_free_time_enabled = '1';
            } else {
                payload.main_free_time_enabled = '0';
            }
            const h = hEl ? Number(hEl.value) || 0 : 0;
            const m = mEl ? Number(mEl.value) || 0 : 0;
            const s = sEl ? Number(sEl.value) || 0 : 0;
            const totalSeconds = (h * 3600) + (m * 60) + s;
            payload.main_free_time_seconds = String(totalSeconds);
            const dlMbps = dlEl ? Number(dlEl.value) || 0 : 0;
            const ulMbps = ulEl ? Number(ulEl.value) || 0 : 0;
            if (dlMbps > 0) {
                payload.main_free_time_download_speed = String(Math.round(dlMbps * 1024));
            } else {
                payload.main_free_time_download_speed = '';
            }
            if (ulMbps > 0) {
                payload.main_free_time_upload_speed = String(Math.round(ulMbps * 1024));
            } else {
                payload.main_free_time_upload_speed = '';
            }
            if (reclaimEl) {
                payload.main_free_time_reclaim_days = reclaimEl.value || '';
            }
            if (vlanEl) {
                payload.main_free_time_vlan = vlanEl.value || '';
            }
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    alert('Main Vendo Free Time Saved');
                    const modal = document.getElementById('main-free-time-modal');
                    if(modal) modal.style.display = 'none';
                    loadSubVendoDevices(); // Refresh to update badge
                } else {
                    alert('Failed to save Main Vendo Free Time');
                }
            } catch (e) {
                console.error("Failed to save main free time", e);
                alert('Error saving Main Vendo Free Time');
            }
        }

        function openMainVendoRatesConfig() {
            const modal = document.getElementById('main-rates-modal');
            if(modal) {
                modal.style.display = 'flex';
                // Reload rates to ensure they are up to date
                if(typeof loadRatesData === 'function') loadRatesData();
            }
        }

        function openMainVendoFreeTimeConfig() {
            const modal = document.getElementById('main-free-time-modal');
            if(modal) {
                modal.style.display = 'flex';
                if(typeof loadSubVendoConfig === 'function') loadSubVendoConfig();
            }
        }

        async function loadSubVendoDevices() {
            try {
                const res = await fetch('/api/admin/subvendo/devices');
                if (res.status === 401) return location.reload();
                const devices = await res.json();
                window.subVendoDevicesCache = Array.isArray(devices) ? devices : [];
                const tbody = document.querySelector('#subvendo-devices-table tbody');
                const list = document.getElementById('subvendo-devices-list');
                tbody.innerHTML = '';
                if (list) list.innerHTML = '';
                
                // --- Add Main Vendo Row ---
                const mainFreeEnabled = document.getElementById('main-free-enabled')?.checked;
                const mainFreeH = Number(document.getElementById('main-free-h')?.value||0);
                const mainFreeM = Number(document.getElementById('main-free-m')?.value||0);
                const mainFreeS = Number(document.getElementById('main-free-s')?.value||0);
                const mainFreeSeconds = (mainFreeH * 3600) + (mainFreeM * 60) + mainFreeS;
                const hasMainFree = mainFreeEnabled && mainFreeSeconds > 0;
                const mainFreeBadge = hasMainFree ? '<span style="margin-left:2px; padding:2px 8px; font-size:0.7rem; border-radius:999px; background: var(--info); color: white; display:inline-flex; align-items:center; justify-content:center; text-align:center;">Free Time</span>' : '';

                const mainTr = document.createElement('tr');
                mainTr.style.background = 'var(--bg-body)';
                mainTr.innerHTML = `
                    <td style="display:flex; align-items:center;">
                        <span style="display:inline-block; width:8px; height:8px; background: var(--status-active); border-radius:50%; margin-right:6px;" title="Online"></span>
                        <span style="font-weight:bold;">Main Vendo</span>${mainFreeBadge}
                    </td>
                    <td style="font-family:monospace;">---</td>
                    <td><span class="status-badge status-active">ACTIVE</span></td>
                    <td><span style="color: var(--status-active); font-weight:bold;">Online Now</span></td>
                    <td>
                        <button class="btn-icon" onclick="openMainVendoRatesConfig()" title="Edit Rates">
                            <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/></svg>
                        </button>
                        <button class="btn-icon" onclick="openMainVendoFreeTimeConfig()" title="Free Time Config" style="color:var(--info);">
                            <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(mainTr);
                
                if (list) {
                     const mainCard = document.createElement('div');
                     mainCard.className = 'device-card';
                     mainCard.style.background = 'var(--bg-body)';
                     mainCard.innerHTML = `
                         <div class="device-card-header">
                             <div class="device-name">
                                 <span style="display:inline-block; width:8px; height:8px; background: var(--status-active); border-radius:50%; margin-right:6px;" title="Online"></span>
                                 <span>Main Vendo</span>${mainFreeBadge}
                             </div>
                             <div class="device-id">---</div>
                         </div>
                         <div class="device-meta">
                             <span class="status-badge status-active">ACTIVE</span>
                             <span style="color: var(--status-active); font-weight:bold;">Online Now</span>
                         </div>
                         <div class="device-actions">
                             <button class="btn btn-sm" onclick="openMainVendoRatesConfig()" style="background:var(--warning); color:white;">Rates</button>
                             <button class="btn btn-sm" onclick="openMainVendoFreeTimeConfig()" style="background: var(--info); color:white;">Free Time</button>
                         </div>
                     `;
                     list.appendChild(mainCard);
                }

                if (devices.length === 0) {
                    const noDevTr = document.createElement('tr');
                    noDevTr.innerHTML = '<td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">No ESP8266 devices registered</td>';
                    tbody.appendChild(noDevTr);
                    if (list) {
                         const msg = document.createElement('div');
                         msg.style.textAlign = 'center';
                         msg.style.padding = '12px';
                         msg.style.color = 'var(--text-muted)';
                         msg.textContent = 'No ESP8266 devices registered';
                         list.appendChild(msg);
                    }
                } else {
                    devices.forEach(device => {
                        const tr = document.createElement('tr');
                        const isOnline = device.online;
                        const statusDot = isOnline 
                            ? '<span style="display:inline-block; width:8px; height:8px; background: var(--status-active); border-radius:50%; margin-right:6px;" title="Online"></span>' 
                            : '<span style="display:inline-block; width:8px; height:8px; background: var(--status-expired); border-radius:50%; margin-right:6px;" title="Offline"></span>';
                        const hasFree = (Number(device.free_time_seconds || 0) > 0) && !!device.free_time_enabled;
                        const freeBadge = hasFree ? '<span style="margin-left:2px; padding:2px 8px; font-size:0.7rem; border-radius:999px; background: var(--info); color: white; display:inline-flex; align-items:center; justify-content:center; text-align:center;">Free Time</span>' : '';
                        
                        tr.innerHTML = `
                            <td style="display:flex; align-items:center;">${statusDot}<span>${device.name || '-'}</span>${freeBadge}</td>
                            <td style="font-family:monospace;">${device.device_id}</td>
                            <td><span class="status-badge ${device.status === 'active' ? 'status-active' : 'status-inactive'}">${device.status}</span></td>
                            <td>${isOnline ? '<span style="color: var(--status-active); font-weight:bold;">Online Now</span>' : (device.last_active_at ? new Date(device.last_active_at).toLocaleString() : 'Never')}</td>
                            <td>
                                <button class="btn-icon" onclick="openSubVendoDeviceSettings(${device.id})" title="Settings">
                                    <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 8a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"/></svg>
                                </button>
                                <button class="btn-icon" onclick="openSubVendoFreeTimeConfig(${device.id})" title="Free Time Config" style="color:var(--info);">
                                    <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                </button>
                                <button class="btn-icon delete" onclick="deleteSubVendoDevice(${device.id})">
                                    <svg style="width:16px;height:16px;fill:currentColor;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                        
                        if (list) {
                            const card = document.createElement('div');
                            card.className = 'device-card';
                            const lastActive = isOnline ? '<span style="color: var(--status-active); font-weight:bold;">Online Now</span>' : (device.last_active_at ? new Date(device.last_active_at).toLocaleString() : 'Never');
                            const statusBadgeClass = device.status === 'active' ? 'status-active' : 'status-inactive';
                            const hasFreeCard = (Number(device.free_time_seconds || 0) > 0) && !!device.free_time_enabled;
                            const freeBadgeCard = hasFreeCard ? '<span style="margin-left:2px; padding:2px 8px; font-size:0.7rem; border-radius:999px; background: var(--info); color: white; display:inline-flex; align-items:center; justify-content:center; text-align:center;">Free Time</span>' : '';
                            card.innerHTML = `
                                <div class="device-card-header">
                                    <div class="device-name">${statusDot}<span>${device.name || '-'}</span>${freeBadgeCard}</div>
                                    <div class="device-id">${device.device_id}</div>
                                </div>
                                <div class="device-meta">
                                    <span class="status-badge ${statusBadgeClass}">${device.status}</span>
                                    <span>${lastActive}</span>
                                </div>
                                <div class="device-actions">
                                    <button class="btn btn-sm" onclick="openSubVendoDeviceSettings(${device.id})" style="background:var(--warning); color:white;">Settings</button>
                                    <button class="btn btn-sm" onclick="openSubVendoFreeTimeConfig(${device.id})" style="background: var(--info); color:white;">Free Time</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSubVendoDevice(${device.id})">Delete</button>
                                </div>
                            `;
                            list.appendChild(card);
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load sub vendo devices", e);
            }
        }

        async function loadSubVendoWaitingList() {
            try {
                const res = await fetch('/api/admin/subvendo/waiting');
                if (res.status === 401) return location.reload();
                const list = await res.json();
                
                const card = document.getElementById('subvendo-waiting-card');
                const badge = document.getElementById('waiting-count');
                const tbody = document.querySelector('#subvendo-waiting-table tbody');
                
                if (list.length > 0) {
                    if(badge) {
                        badge.textContent = list.length;
                        badge.style.display = 'inline-block';
                    }
                    if(tbody) {
                        tbody.innerHTML = '';
                        list.forEach(device => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${device.device_id}</td>
                                <td>${device.ip_address || 'Unknown'}</td>
                                <td>${device.name || 'New Device'}</td>
                                <td>${new Date(device.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="approveSubVendo(${device.id})">Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="declineSubVendo(${device.id})">Decline</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                } else {
                    if(badge) badge.style.display = 'none';
                    if(tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No pending devices</td></tr>';
                }
            } catch (e) {
                console.error("Failed to load sub vendo waiting list", e);
            }
        }

        async function approveSubVendo(id) {
            if (!confirm('Are you sure you want to approve this device?')) return;
            try {
                const res = await fetch('/api/admin/subvendo/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Device approved successfully');
                    loadSubVendoWaitingList();
                    loadSubVendoDevices();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Failed to approve device');
            }
        }

        async function declineSubVendo(id) {
            if (!confirm('Are you sure you want to decline and remove this device from the waiting list?')) return;
            try {
                const res = await fetch('/api/admin/subvendo/decline', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Device declined successfully');
                    loadSubVendoWaitingList();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Failed to decline device');
            }
        }

        async function coinsOut(id, name, amount) {
            if (amount <= 0) {
                if (!confirm(`Device ${name} has no recorded un-out sales. Do you want to reset the counter anyway?`)) return;
            } else {
                if (!confirm(`Confirm Coins Out for ${name}?\nAmount: ₱${amount}`)) return;
            }

            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}/coins-out`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('Coins Out Successful!');
                    loadSubVendoDevices();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error performing coins out');
                console.error(e);
            }
        }

        let currentSubVendoDeviceId = null;

        function openSubVendoDeviceSettings(id) {
            currentSubVendoDeviceId = id;
            const devices = window.subVendoDevicesCache || [];
            const device = devices.find(d => Number(d.id) === Number(id));
            if (!device) return;

            document.getElementById('subvendo-device-name').value = device.name || '';
            document.getElementById('subvendo-device-description').value = device.description || '';
            document.getElementById('subvendo-device-rate').value = device.peso_per_pulse != null ? device.peso_per_pulse : 1;
            document.getElementById('subvendo-device-coin-pin').value = device.coin_pin != null ? device.coin_pin : 6;
            document.getElementById('subvendo-device-relay-pin').value = device.relay_pin != null ? device.relay_pin : 5;
            document.getElementById('subvendo-device-relay-active-state').value = device.relay_pin_active_state || 'LOW';
            document.getElementById('subvendo-device-download').value = device.download_speed ? (device.download_speed / 1024) : '';
            document.getElementById('subvendo-device-upload').value = device.upload_speed ? (device.upload_speed / 1024) : '';
            const freeSeconds = Number(device.free_time_seconds || 0);
            const freeH = Math.floor(freeSeconds / 3600);
            const freeM = Math.floor((freeSeconds % 3600) / 60);
            const freeS = freeSeconds % 60;
            document.getElementById('subvendo-device-free-h').value = freeH > 0 ? freeH : '';
            document.getElementById('subvendo-device-free-m').value = freeM > 0 ? freeM : '';
            document.getElementById('subvendo-device-free-s').value = freeS > 0 ? freeS : '';
            document.getElementById('subvendo-device-free-reclaim').value = device.free_time_reclaim_days != null ? device.free_time_reclaim_days : '';
            document.getElementById('subvendo-device-free-vlan').value = device.free_time_vlan || '';
            document.getElementById('subvendo-device-free-enabled').checked = !!device.free_time_enabled;

            populateSubVendoDeviceRates(id);
            document.getElementById('subvendo-device-modal').style.display = 'flex';
        }

        function closeSubVendoDeviceSettings() {
            document.getElementById('subvendo-device-modal').style.display = 'none';
            currentSubVendoDeviceId = null;
        }

        async function saveSubVendoDeviceSettings() {
            if (!currentSubVendoDeviceId) return;
            const freeH = Number(document.getElementById('subvendo-device-free-h').value) || 0;
            const freeM = Number(document.getElementById('subvendo-device-free-m').value) || 0;
            const freeS = Number(document.getElementById('subvendo-device-free-s').value) || 0;
            const totalFreeSeconds = (freeH * 3600) + (freeM * 60) + freeS;
            const reclaimVal = document.getElementById('subvendo-device-free-reclaim').value;
            const reclaimDays = reclaimVal === '' ? null : Number(reclaimVal);
            const freeVlan = document.getElementById('subvendo-device-free-vlan').value.trim();
            const freeEnabled = document.getElementById('subvendo-device-free-enabled').checked;
            const payload = {
                name: document.getElementById('subvendo-device-name').value,
                description: document.getElementById('subvendo-device-description').value,
                peso_per_pulse: Number(document.getElementById('subvendo-device-rate').value),
                coin_pin: Number(document.getElementById('subvendo-device-coin-pin').value),
                relay_pin: Number(document.getElementById('subvendo-device-relay-pin').value),
                relay_pin_active_state: document.getElementById('subvendo-device-relay-active-state').value,
                download_speed: document.getElementById('subvendo-device-download').value ? Math.round(Number(document.getElementById('subvendo-device-download').value) * 1024) : null,
                upload_speed: document.getElementById('subvendo-device-upload').value ? Math.round(Number(document.getElementById('subvendo-device-upload').value) * 1024) : null,
                free_time_seconds: totalFreeSeconds,
                free_time_reclaim_days: reclaimDays,
                free_time_vlan: freeVlan || null,
                free_time_enabled: freeEnabled
            };

            try {
                const res = await fetch(`/api/admin/subvendo/devices/${currentSubVendoDeviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data && data.success) {
                    const rateContainer = document.getElementById('subvendo-device-rates');
                    const checked = Array.from(rateContainer.querySelectorAll('input[type="checkbox"][data-rate-id]:checked'))
                        .map(x => Number(x.getAttribute('data-rate-id')))
                        .filter(x => Number.isFinite(x));
                    try {
                        await fetch(`/api/admin/subvendo/devices/${currentSubVendoDeviceId}/rates`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ visible_rate_ids: checked })
                        });
                    } catch (e) {}
                    closeSubVendoDeviceSettings();
                    loadSubVendoDevices();
                } else {
                    alert('Failed to save settings: ' + (data && data.error ? data.error : 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save device settings', e);
                alert('Error saving device settings');
            }
        }

        async function populateSubVendoDeviceRates(id) {
            const container = document.getElementById('subvendo-device-rates');
            if (!container) return;
            container.innerHTML = 'Loading rates...';
            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}/rates`);
                const rates = await res.json();
                if (!Array.isArray(rates) || rates.length === 0) {
                    container.innerHTML = '<div>No rates configured</div>';
                    return;
                }
                const html = rates.map(r => {
                    const minutes = Number(r.minutes) || 0;
                    let dur = minutes + 'm';
                    if (minutes >= 60) {
                        const h = Math.floor(minutes / 60);
                        const m = minutes % 60;
                        dur = h + 'h' + (m > 0 ? ' ' + m + 'm' : '');
                    }
                    const ul = r.upload_speed >= 1024 ? (r.upload_speed / 1024).toFixed(1) + ' Mbps' : r.upload_speed + ' Kbps';
                    const dl = r.download_speed >= 1024 ? (r.download_speed / 1024).toFixed(1) + ' Mbps' : r.download_speed + ' Kbps';
                    const type = r.is_pausable ? 'Pausable' : 'Continuous';
                    const checked = r.visible ? 'checked' : '';
                    return `
                        <label style="display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--border); border-radius:6px; font-size:0.8rem;">
                            <input type="checkbox" data-rate-id="${r.id}" ${checked}>
                            <div style="display:flex; flex-wrap:wrap; gap:12px; flex:1;">
                                <span><strong>Coin:</strong> ₱${r.amount}</span>
                                <span><strong>Duration:</strong> ${dur}</span>
                                <span><strong>Type:</strong> ${type}</span>
                                <span><strong>Upload:</strong> ${ul}</span>
                                <span><strong>Download:</strong> ${dl}</span>
                            </div>
                            <button class="btn btn-sm btn-warning subvendo-rate-edit-btn" data-rate-id="${r.id}" type="button">
                                Edit
                            </button>
                        </label>
                    `;
                }).join('');
                const addBtn = `
                    <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                        <button class="btn btn-sm btn-primary" onclick="if (typeof openRateModal === 'function') { openRateModal(); }">+ Add Rate</button>
                    </div>
                `;
                container.innerHTML = html + addBtn;

                try {
                    const buttons = container.querySelectorAll('.subvendo-rate-edit-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rateId = Number(btn.getAttribute('data-rate-id'));
                            const rate = Array.isArray(rates) ? rates.find(x => Number(x.id) === rateId) : null;
                            if (!rate) return;
                            if (typeof openRateModal === 'function') {
                                openRateModal(rate);
                            }
                        });
                    });
                } catch (e) {
                    console.error('Failed to wire rate edit buttons', e);
                }
            } catch (e) {
                console.error('Failed to load device rates', e);
                container.innerHTML = '<div>Failed to load rates</div>';
            }
        }

        let currentFreeTimeDeviceId = null;
        function openSubVendoFreeTimeConfig(id) {
            currentFreeTimeDeviceId = id;
            const devices = window.subVendoDevicesCache || [];
            const device = devices.find(d => Number(d.id) === Number(id));
            if (!device) return;

            // Populate fields
            const freeSeconds = Number(device.free_time_seconds || 0);
            const freeH = Math.floor(freeSeconds / 3600);
            const freeM = Math.floor((freeSeconds % 3600) / 60);
            const freeS = freeSeconds % 60;
            
            document.getElementById('ft-device-name').textContent = device.name || 'Device';
            document.getElementById('ft-h').value = freeH > 0 ? freeH : '';
            document.getElementById('ft-m').value = freeM > 0 ? freeM : '';
            document.getElementById('ft-s').value = freeS > 0 ? freeS : '';
            document.getElementById('ft-reclaim').value = device.free_time_reclaim_days != null ? device.free_time_reclaim_days : '';
            document.getElementById('ft-vlan').value = device.free_time_vlan || '';
            document.getElementById('ft-enabled').checked = !!device.free_time_enabled;

            const dlInput = document.getElementById('ft-dl');
            const ulInput = document.getElementById('ft-ul');
            if (dlInput) {
                const dlKbps = Number(device.free_time_download_speed || 0);
                if (Number.isFinite(dlKbps) && dlKbps > 0) {
                    dlInput.value = dlKbps / 1024;
                } else {
                    dlInput.value = '';
                }
            }
            if (ulInput) {
                const ulKbps = Number(device.free_time_upload_speed || 0);
                if (Number.isFinite(ulKbps) && ulKbps > 0) {
                    ulInput.value = ulKbps / 1024;
                } else {
                    ulInput.value = '';
                }
            }

            document.getElementById('subvendo-free-time-modal').style.display = 'flex';
        }

        function closeSubVendoFreeTimeConfig() {
            document.getElementById('subvendo-free-time-modal').style.display = 'none';
            currentFreeTimeDeviceId = null;
        }

        async function saveSubVendoFreeTimeConfig() {
            if (!currentFreeTimeDeviceId) return;
            
            const freeH = Number(document.getElementById('ft-h').value) || 0;
            const freeM = Number(document.getElementById('ft-m').value) || 0;
            const freeS = Number(document.getElementById('ft-s').value) || 0;
            const totalFreeSeconds = (freeH * 3600) + (freeM * 60) + freeS;
            
            const reclaimVal = document.getElementById('ft-reclaim').value;
            const reclaimDays = reclaimVal === '' ? null : Number(reclaimVal);
            const freeVlan = document.getElementById('ft-vlan').value.trim();
            const freeEnabled = document.getElementById('ft-enabled').checked;

            const dlInput = document.getElementById('ft-dl');
            const ulInput = document.getElementById('ft-ul');
            const dlMbps = dlInput ? Number(dlInput.value) || 0 : 0;
            const ulMbps = ulInput ? Number(ulInput.value) || 0 : 0;
            const dlKbps = dlMbps > 0 ? Math.round(dlMbps * 1024) : 0;
            const ulKbps = ulMbps > 0 ? Math.round(ulMbps * 1024) : 0;

            const payload = {
                free_time_seconds: totalFreeSeconds,
                free_time_reclaim_days: reclaimDays,
                free_time_vlan: freeVlan || null,
                free_time_enabled: freeEnabled,
                free_time_download_speed: dlKbps,
                free_time_upload_speed: ulKbps
            };

            try {
                const res = await fetch(`/api/admin/subvendo/devices/${currentFreeTimeDeviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data && data.success) {
                    closeSubVendoFreeTimeConfig();
                    loadSubVendoDevices();
                } else {
                    alert('Failed to save configuration: ' + (data && data.error ? data.error : 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save free time config', e);
                alert('Error saving configuration');
            }
        }

        async function deleteSubVendoDevice(id) {
            if(!confirm('Are you sure you want to remove this device?')) return;
            try {
                const res = await fetch(`/api/admin/subvendo/devices/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if(data.success) {
                    loadSubVendoDevices();
                } else {
                    alert('Failed to delete device: ' + data.error);
                }
            } catch(e) {
                console.error("Failed to delete device", e);
                alert('Error deleting device');
            }
        }

        // --- Theme Management ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            if (typeof updateChartTheme === 'function') updateChartTheme();
        }

        function updateThemeIcon(theme) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if (!sunIcon || !moonIcon) return;
            
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        // Initialize Theme
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const initialTheme = savedTheme || systemTheme;
            document.documentElement.setAttribute('data-theme', initialTheme);
            
            // We need to wait for DOMContentLoaded to update icons if they are not yet in DOM
            // But we set attribute immediately to avoid flash
            document.addEventListener('DOMContentLoaded', () => {
                updateThemeIcon(initialTheme);
            });
        })();
    </script>
    <style>
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color:var(--text-muted);
        }
        .status-online .status-dot {
            background-color: var(--status-active);
            box-shadow: 0 0 5px var(--status-active);
        }
        .status-online {
            color: var(--status-active);
        }
        .status-offline .status-dot {
            background-color: var(--status-expired);
        }
        .status-offline {
            color: var(--status-expired);
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background-color: var(--border);
            border-radius: 4px;
            margin-top: 15px;
            height: 24px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--secondary);
            transition: width 0.3s ease;
            text-align: center;
            line-height: 24px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f1c40f;
            --info: #3498db;
            --danger: #f72585;
            --dark: #1b2631;
            --light: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --bg-body: #f0f2f5;
            --sidebar-bg: #ffffff;
            --header-bg: #ffffff;
            --input-bg: #ffffff;
            --table-header-bg: #f8f9fa;
            --table-border: #f1f2f6;
            --status-active: #2ecc71;
            --log-bg: #f1f2f6;
            --log-text: #2d3436;
            --log-border: #dfe6e9;
            --log-timestamp: #636e72;
            --log-voucher: #d35400;
            --status-expired: #e74c3c;
            
            /* Chart Colors */
            --chart-cpu: #00cec9;
            --chart-cpu-track: #dfe6e9;
            --chart-dl: #10b981;
            --chart-dl-bg: rgba(16, 185, 129, 0.25);
            --chart-ul: #3b82f6;
            --chart-ul-bg: rgba(59, 130, 246, 0.25);
            --chart-grid: rgba(243, 244, 246, 1);
            --chart-text: #9ca3af;
            --chart-tooltip-bg: rgba(255, 255, 255, 0.95);
            --chart-tooltip-text: #1f2937;
            --chart-tooltip-border: #e5e7eb;
            
            /* Gauge Colors */
            --gauge-1: #00cec9;
            --gauge-2: #0984e3;
            --gauge-3: #6c5ce7;
            --gauge-4: #fdcb6e;
            --gauge-5: #e17055;
            --gauge-6: #00b894;
            --gauge-7: #e84393;
            --gauge-8: #636e72;
        }

        [data-theme="dark"] {
            --primary: #5c7cfa;
            --secondary: #4c6ef5;
            --success: #00d2d3;
            --danger: #ff6b6b;
            --dark: #f1f2f6;
            --light: #2f3640;
            --card-bg: #2f3640;
            --text-main: #dcdde1;
            --text-muted: #a4b0be;
            --border: #4b6584;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
            --bg-body: #1e272e;
            --sidebar-bg: #2f3640;
            --header-bg: #2f3640;
            --input-bg: #353b48;
            --table-header-bg: #353b48;
            --table-border: #4b6584;
            --status-active: #2ecc71;
            --status-expired: #ff6b6b;
            --log-bg: #1e272e;
            --log-text: #dcdde1;
            --log-border: #2c3e50;
            --log-timestamp: #95a5a6;
            --log-voucher: #f1c40f;
            
            /* Chart Colors */
            --chart-cpu: #00cec9;
            --chart-cpu-track: #636e72;
            --chart-dl: #2ecc71;
            --chart-dl-bg: rgba(46, 204, 113, 0.25);
            --chart-ul: #3498db;
            --chart-ul-bg: rgba(52, 152, 219, 0.25);
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-text: #b2bec3;
            --chart-tooltip-bg: #2d3436;
            --chart-tooltip-text: #dfe6e9;
            --chart-tooltip-border: #4b6584;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 180px; background: var(--sidebar-bg); color: var(--text-main); display: flex; flex-direction: column; transition: 0.3s; flex-shrink: 0; border-right: 1px solid var(--border); }
        .sidebar-header { padding: 10px; font-size: 1.4rem; font-weight: 700; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .sidebar-header svg { width: 24px; height: 24px; fill: var(--success); }
        .menu { flex: 1; padding-top: 20px; overflow-y: auto; }
        .menu-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(0,0,0,0.05); color: var(--text-main); border-right: 3px solid var(--success); }
        [data-theme="dark"] .menu-item:hover, [data-theme="dark"] .menu-item.active { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .menu-item svg { width: 18px; height: 18px; fill: currentColor; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); }
        .logout-btn { width: 100%; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .logout-btn:hover { background: var(--status-expired); }

        body.sidebar-collapsed .sidebar { width: 64px; }
        body.sidebar-collapsed .sidebar-header { justify-content: center; }
        body.sidebar-collapsed .sidebar-header div { display: none; }
        body.sidebar-collapsed .menu-item { padding: 15px 10px; justify-content: center; }
        body.sidebar-collapsed .menu-label { display: none; }
        body.sidebar-collapsed .sidebar-footer .menu-label { display: none; }
        body.sidebar-collapsed .sidebar-footer > div { display: none; }
        body.sidebar-collapsed .sidebar-footer { padding: 16px; display: flex; justify-content: center; }
        body.sidebar-collapsed .logout-btn { width: 44px; height: 44px; min-width: 44px; min-height: 44px; padding: 0; border-radius: 50%; justify-content: center; }
        body.sidebar-collapsed .logout-btn svg { display: block; width: 22px !important; height: 22px !important; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color:var(--text-muted); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--gauge-6); }
        input:focus + .slider { box-shadow: 0 0 1px #00b894; }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 20px; }
        .slider.round:before { border-radius: 50%; }

        .voucher-print-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; }
        .voucher-print-card { border: 1px solid #000; border-radius: 4px; font-size: 0.65rem; display: flex; flex-direction: row; align-items: stretch; overflow: hidden; }
        .voucher-price-strip { width: 18px; border-right: 1px dashed var(--text-main); display: flex; align-items: center; justify-content: center; background: var(--bg-body); }
        .voucher-price-text { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 0.6rem; font-weight: 700; }
        .voucher-main { flex: 1; padding: 4px 6px; display: flex; flex-direction: column; justify-content: center; }
        .voucher-print-code { font-weight: 700; font-size: 0.9rem; letter-spacing: 1px; }
        .voucher-meta-lines { margin-top: 2px; display: flex; flex-direction: column; gap: 1px; }
        .voucher-print-meta { font-size: 0.6rem; }
        .voucher-qr-wrap { width: 52px; display: flex; align-items: center; justify-content: center; padding-right: 4px; }
        .voucher-print-qr { display: inline-block; }

        @media print {
            @page { margin: 8mm; }
            body { background: var(--bg-body); }

            body.voucher-printing * {
                visibility: hidden !important;
            }
            body.voucher-printing #voucher-generated-modal,
            body.voucher-printing #voucher-generated-modal * {
                visibility: visible !important;
            }

            #sidebar,
            .topbar { display: none !important; }
            #voucher-generated-modal { 
                display: block !important; 
                position: static !important; 
                width: 100% !important; 
                height: auto !important; 
                background: none !important; 
                align-items: flex-start !important; 
                justify-content: flex-start !important;
            }
            #voucher-generated-modal > div { 
                box-shadow: none !important; 
                width: 100% !important; 
                max-width: 100% !important; 
                max-height: none !important; 
            }
            #voucher-generated-body { 
                display: grid !important; 
                grid-template-columns: repeat(3, 1fr); 
                gap: 6px; 
            }
            .voucher-print-card { page-break-inside: avoid; }
            #voucher-generated-modal button { display: none !important; }

            /* Print Header - Hidden on Screen */
            .print-only-header { display: none; }
            
            /* PPPoE Report Printing */
            @page { size: A4; margin: 1cm; }
            
            body.pppoe-report-printing * { visibility: hidden !important; }
            body.pppoe-report-printing #view-pppoe-sales,
            body.pppoe-report-printing #view-pppoe-sales * { visibility: visible !important; }
            body.pppoe-report-printing #view-pppoe-sales {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                display: block !important;
                background: white !important;
            }
            body.pppoe-report-printing .print-only-header { 
                display: block !important; 
                margin-bottom: 20px !important; 
                border-bottom: 2px solid #333 !important; 
                padding-bottom: 10px !important;
            }
            body.pppoe-report-printing .btn { display: none !important; } /* Hide buttons */
            body.pppoe-report-printing input { border: none !important; background: transparent !important; } /* Make inputs look like text */
            body.pppoe-report-printing .table-container { max-height: none !important; overflow: visible !important; border: none !important; box-shadow: none !important; }
            
            /* Hide Action Column in Report */
            body.pppoe-report-printing #pppoe-sales-table th:last-child,
            body.pppoe-report-printing #pppoe-sales-table td:last-child { display: none !important; }
            
            /* Ensure Table fits A4 */
            body.pppoe-report-printing table { width: 100% !important; font-size: 10pt !important; }
            body.pppoe-report-printing th, body.pppoe-report-printing td { padding: 8px 4px !important; }

            /* Ensure Stats Cards Grid fits */
            body.pppoe-report-printing .grid-4 { 
                display: grid !important; 
                grid-template-columns: repeat(4, 1fr) !important; 
                gap: 10px !important; 
                margin-bottom: 20px !important;
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            body.pppoe-report-printing .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                padding: 10px !important;
            }

            /* PPPoE Receipt Printing */
            body.pppoe-receipt-printing * { visibility: hidden !important; }
            body.pppoe-receipt-printing #pppoe-receipt-container,
            body.pppoe-receipt-printing #pppoe-receipt-container * { visibility: visible !important; }
            body.pppoe-receipt-printing #pppoe-receipt-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                display: block !important;
            }
        }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .topbar { background: var(--header-bg); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); z-index: 10; flex-shrink: 0; }
        .page-title { font-size: 1.25rem; font-weight: 600; color: var(--text-main); }
        .status-badge { background: rgba(46, 204, 113, 0.15); color: var(--status-active); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; background: var(--status-active); border-radius: 50%; }

        .content-scroll { padding: 10px 24px; overflow-y: auto; flex: 1; height: auto; min-height: 0; }
        
        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .grid-subvendo { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        .grid-3 { display: grid; grid-template-columns: 1.4fr 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        
        /* Cards */
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .card-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 0.95rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Info Rows */
        .info-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); font-weight: 500; }
        .info-value { font-weight: 600; color: var(--text-main); }

        /* Revenue Cards */
        .rev-card { position: relative; overflow: hidden; }
        .rev-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 10px 0 5px 0; }
        .rev-label { font-size: 0.85rem; color: var(--text-muted); }
        .rev-icon { position: absolute; right: 20px; top: 20px; width: 40px; height: 40px; opacity: 0.1; fill: var(--primary); }

        /* Tables */
        .table-container { background: var(--card-bg); border-radius: 12px; overflow-x: auto; overflow-y: auto; max-height: 500px; -webkit-overflow-scrolling: touch; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .table-container table { min-width: 600px; }
        .table-container th, .table-container td { white-space: nowrap; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--table-header-bg); padding: 15px 20px; text-align: center; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--table-border); font-size: 0.95rem; color: var(--text-main); text-align: center; }
        tr:last-child td { border-bottom: none; }
        .status-active { color: var(--status-active); font-weight: 600; }
        .status-expired { color: var(--status-expired); font-weight: 600; }
        .sales-grid-table th,
        .sales-grid-table td {
            border: 1px solid var(--table-border);
        }
        #active-codes-table th,
        #active-codes-table td {
            white-space: nowrap;
        }
        #active-codes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        #active-codes-header-title {
            white-space: nowrap;
        }
        #active-codes-header-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-color);
        }
        
        /* Mobile Device List */
        .device-list { display: none; }
        .device-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); padding: 12px; display: grid; grid-template-columns: 1fr; gap: 8px; }
        .device-card-header { display: flex; justify-content: space-between; align-items: center; }
        .device-name { display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text-main); }
        .device-id { font-family: monospace; color: var(--text-muted); font-size: 0.85rem; }
        .device-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-muted); }
        .device-actions { display: flex; gap: 8px; justify-content: flex-end; }


        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger { background: rgba(231, 76, 60, 0.15); color: var(--status-expired); }
        .btn-danger:hover { background: var(--status-expired); color: white; }
        .btn-primary { background: var(--primary); color: white; }

        /* Login Screen */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 12px; width: 350px; box-shadow: var(--shadow); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; background: var(--input-bg); color: var(--text-main); }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* Pull to Refresh */
        #pull-to-refresh {
            height: 50px;
            margin-top: -50px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: margin-top 0.2s;
            width: 100%;
            overflow: hidden;
            opacity: 0; /* Hidden on desktop */
        }
        .ptr-icon { transition: transform 0.3s; }
        .ptr-icon.rotate { transform: rotate(180deg); }
        
        .mobile-toggle { display: none; cursor: pointer; padding: 8px; border-radius: 8px; }
        .mobile-toggle:hover { background: rgba(0,0,0,0.06); }
        [data-theme="dark"] .mobile-toggle:hover { background: rgba(255,255,255,0.06); }
        .mobile-toggle svg { fill: var(--text-main); }

        #sidebar-overlay { display: none; }

        /* Settings Wrapper (Desktop) */
        .settings-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .pppoe-server-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .system-maintenance-grid {
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .settings-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .settings-item:hover { background: var(--table-header-bg); }
        .settings-item:last-child { border-bottom: none; }

        .sys-maint-btn {
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px;
            aspect-ratio: 1;
            height: auto;
            width: 100%;
            gap: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sys-maint-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .sys-maint-btn span { font-weight: 600; font-size: 0.7rem; }

        /* Mobile */
        @media (max-width: 768px) {
            #pull-to-refresh { opacity: 1; } /* Visible on mobile */
            .sidebar { position: fixed; top: 0; bottom: 0; left: -260px; width: 240px; height: auto; z-index: 100; }
            .sidebar.open { left: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            .grid-2, .grid-subvendo { grid-template-columns: 1fr; }
            .system-maintenance-grid {
                grid-template-columns: repeat(5, 1fr);
                padding: 10px;
                gap: 5px;
            }
            .sys-maint-btn {
                padding: 4px;
                gap: 3px;
            }
            .sys-maint-btn svg { width: 16px; height: 16px; }
            .sys-maint-btn span { font-size: 0.6rem; }
            .grid-3 { grid-template-columns: 1fr; }
            .form-grid { gap: 10px; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .mobile-toggle { display: block; }
            
            .content-scroll { padding: 10px 0 120px 0; }
            .topbar { flex-wrap: wrap; gap: 40px; padding: 0 15px; }
            .page-title { font-size: 1.2rem; }
            .status-badge { font-size: 0.75rem; padding: 4px 8px; }
            
            /* Center and reduce width of grids */
            .grid-2, .grid-3, .grid-4, .grid-subvendo, .settings-wrapper {
                width: 92%;
                margin-left: auto;
                margin-right: auto;
            }
            .settings-wrapper {
                grid-template-columns: 1fr;
            }
            .settings-wrapper .card {
                padding: 0 !important;
            }
            .settings-wrapper .card-title {
                padding-left: 10px;
                padding-top: 5px;
            }

            /* Ensure cards don't overflow */
            .card { padding: 15px; }
            
            /* Bandwidth Table Adjustment for Mobile */
            .bw-table th, .bw-table td { padding: 6px 4px; font-size: 0.75rem; }
            .bw-row-name { font-size: 0.75rem; }

            /* Mobile Scrollable Table */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                display: block;
            }
            .table-responsive table {
                min-width: 600px;
            }
            .table-responsive th, .table-responsive td {
                white-space: nowrap;
            }
            #active-codes-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            #active-codes-header-filter {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            #subvendo-device-modal > div {
                width: 98%;
                max-width: 98%;
            }
            #subvendo-device-form {
                padding: 12px !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            #view-subvendo .card-header { flex-wrap: wrap; gap: 10px; }
            #view-subvendo .form-group > div { flex-wrap: wrap; }
            #view-subvendo .form-group > div input { flex: 1 1 100%; }
            #view-subvendo .form-group > div .btn { width: 100%; }
            .table-container table { min-width: 100%; }
            #subvendo-devices-table th, #subvendo-devices-table td { padding: 10px 12px; font-size: 0.85rem; }
            #view-subvendo .table-container { display: none; }
            #view-subvendo .device-list { display: grid; gap: 10px; }

            #sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.35);
                z-index: 90;
            }
            #sidebar-overlay.open { display: block; }
            
            /* Stack Settings Grid on Mobile */
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            /* Chat Mobile Styles */
            .chat-container {
                position: relative;
                overflow: hidden;
            }
            .chat-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                transition: transform 0.3s ease;
                background: white;
            }
            .chat-sidebar.hidden {
                transform: translateX(-100%);
            }
            .chat-main {
                width: 100%;
                height: 100%;
            }
            #chat-toggle-list-btn {
                display: block !important;
            }
            .mobile-only-block {
                display: block !important;
            }
            
            /* Adjust Drawer Content Padding */
            .drawer-open .drawer-content {
                padding: 15px 5px;
            }
        }

        /* Spin Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }

        /* Bandwidth Stats Table */
        .bw-stats-container { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .bw-table { width: 100%; min-width: 500px; border-collapse: collapse; font-size: 0.85rem; color: var(--text-main); table-layout: fixed; }
        .bw-table th { text-align: right; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: bold; padding: 5px 0; border-bottom: 1px solid var(--border); white-space: nowrap; }
        .bw-table td { text-align: right; padding: 8px 0; border-bottom: 1px solid var(--border); white-space: nowrap; }
        .bw-table td:first-child, .bw-table th:first-child { text-align: left; }
        
        .bw-row-name { display: flex; align-items: center; gap: 8px; font-weight: 600; white-space: nowrap; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; display: inline-block; flex-shrink: 0; }
        #bandwidthChart { background: var(--card-bg); border-radius: 10px; }
        
        /* Active Sessions Light Table */
        .dark-card { background: var(--card-bg) !important; color: var(--text-main); border: 1px solid var(--border); }
        .dark-card .card-header { border-bottom: 1px solid var(--border); }
        .dark-card .card-title { color: var(--text-main); text-transform: uppercase; font-size: 0.95rem; font-weight: 700; }
        .dark-table-container { background: var(--card-bg); border: none; box-shadow: none; }
        .dark-table th { background: var(--table-header-bg); color: var(--text-muted); border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); text-transform: uppercase; font-size: 0.75rem; padding: 12px 10px; font-weight: 600; text-align: center; }
        .dark-table td { background: var(--card-bg); color: var(--text-main); border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 12px 10px; font-size: 0.85rem; vertical-align: middle; text-align: center; }
        .dark-table th:last-child, .dark-table td:last-child { border-right: none; }
        .code-text { color: var(--secondary); font-weight: 600; }
        .limit-text { color: var(--gauge-6); font-size: 0.8rem; }
        .type-badge { background: var(--input-bg); color: var(--secondary); padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-size: 0.75rem; font-weight: 600; border: 1px solid var(--border); }
        .search-input { background: var(--input-bg); border: 1px solid var(--border); padding: 8px 15px; border-radius: 4px; color: var(--text-main); width: 200px; outline: none; }
        .filter-select { background: var(--input-bg); border: 1px solid var(--border); padding: 8px; border-radius: 4px; color: var(--text-main); margin-right: 15px; outline: none; }
        .checkbox-custom { accent-color: var(--secondary); cursor: pointer; }
        .dots-menu { color: var(--text-muted); cursor: pointer; font-size: 1.2rem; line-height: 0.5; }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 20px;
            row-gap: 8px;
        }

        /* Drawer / Accordion */
        .drawer-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .drawer-header:hover {
            background-color: var(--table-header-bg);
        }
        .drawer-arrow {
            transition: transform 0.3s ease;
            width: 24px;
            height: 24px;
            fill: var(--text-muted);
        }
        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px; /* Keep horizontal padding */
        }
        .drawer-open .drawer-arrow {
            transform: rotate(180deg);
        }
        .drawer-open .drawer-content {
            border-top: 1px solid var(--border);
            padding: 15px;
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            height: 600px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .chat-sidebar {
            width: 300px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--table-header-bg);
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-main);
        }
        .chat-item:hover, .chat-item.active {
            background: var(--bg-body);
        }
        .chat-item.unread {
            background: var(--input-bg);
            border-left: 4px solid var(--primary);
        }
        .chat-item.unread .chat-mac {
            font-weight: 800;
            color: var(--text-main);
        }
        .chat-item.unread .chat-preview {
            font-weight: 600;
            color: var(--text-main);
        }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .chat-mac {
            font-weight: 600;
            color: var(--text-main);
        }
        .chat-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .chat-preview {
            font-size: 0.9rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-badge {
            background: var(--status-expired);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
        }
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text-main);
            background: var(--card-bg);
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @keyframes msgSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
            color: var(--text-main);
            position: relative;
            animation: msgSlideUp 0.3s ease-out forwards;
        }
        .message.received {
            align-self: flex-start;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-time {
            font-size: 0.7rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
            color: var(--text-muted);
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            background: var(--card-bg);
        }
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            outline: none;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-main);
        }
        .chat-input:focus {
            border-color: var(--secondary);
        }
        .chat-send-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .chat-send-btn:hover {
            background: var(--secondary);
        }
    </style>

    <style>
        @media (max-width: 768px) {
            .topbar {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px 15px;
                z-index: 50;
                position: relative;
                background: var(--card-bg) !important;
                width: 100%;
                box-sizing: border-box;
                min-height: auto;
            }
            .page-title {
                font-size: 1.1rem;
                display: block !important;
            }
            #header-icon {
                display: block !important;
            }
            #topbar-time {
                position: relative !important;
                left: auto !important;
                transform: none !important;
                order: 3;
                width: 100%;
                text-align: center;
                margin-top: 5px;
                display: block !important;
                color: var(--text-main) !important;
            }
            .status-badge {
                margin-left: auto;
                display: flex !important;
            }
        }
    </style>
    <style>
        /* Sub Vendo Device Modal Responsive Styles */
        .subvendo-form-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-col-span-2 {
            grid-column: span 2;
        }
        @media (max-width: 768px) {
            .subvendo-form-grid {
                /* Keep 2 columns like desktop, but compact gaps */
                grid-template-columns: 1fr 1fr; 
                padding: 10px;
                gap: 8px;
            }
            .form-col-span-2 {
                /* Keep spanning 2 columns like desktop */
                grid-column: span 2;
            }
            /* Make labels and inputs more compact */
            .subvendo-form-grid label {
                font-size: 0.75rem !important;
                margin-bottom: 2px !important;
            }
            .subvendo-form-grid input,
            .subvendo-form-grid select {
                padding: 6px 8px !important;
                font-size: 14px; /* Slightly smaller but readable */
                height: auto;
            }
            .subvendo-form-grid textarea {
                padding: 6px 8px !important;
                min-height: 60px !important;
            }
        }
    </style>
</head>
<body>


    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spin" style="width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%;"></div>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <img src="/neofi_nb.png" alt="NeoFi Logo" style="max-width: 200px; margin-bottom: 20px;">
        <div class="login-box">
            <h2 style="margin-bottom: 20px; color: var(--dark);">Admin Access</h2>
            <form onsubmit="login(); return false;">
                <label for="username" style="display:none;">Username</label>
                <input type="text" id="username" class="login-input" placeholder="Username" autocomplete="username">
                <label for="password" style="display:none;">Password</label>
                <input type="password" id="password" class="login-input" placeholder="Password" autocomplete="current-password">
                <div style="text-align:right; margin-bottom:15px;">
                    <a href="/forgot.html" style="font-size:0.85rem; color: var(--secondary); text-decoration:none;">Forgot Password?</a>
                </div>
                <button type="submit" class="login-btn">Secure Login</button>
            </form>
            <p id="login-error" style="color: var(--status-expired); font-size:0.85rem; margin-top:15px;"></p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-ui" style="display:none; width: 100%; height: 100%;">
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img id="sidebar-logo" src="/neofi_logo.png" data-logo-full="/neofi_logo.png" data-logo-compact="/neologo.png" alt="NeoFi" style="height: 40px; max-width: 100%; object-fit: contain; cursor: pointer;" onclick="nav('dashboard')">
                <div style="font-size: 0.7rem; color: var(--text-muted); align-self: center;">V1.0</div>
            </div>
            <div class="menu">
                <div class="menu-item active" onclick="nav('dashboard')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span class="menu-label">Dashboard</span>
                </div>
                <div class="menu-item" onclick="nav('interfaces')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    <span class="menu-label">Interfaces</span>
                </div>
                <div class="menu-item" onclick="nav('pppoe')">
                    <svg viewBox="0 0 24 24"><path d="M18 13h-.68l-2 2h1.91L19 17H5l1.78-2h2.05l-2-2H6l-3 3v4c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2v-4l-3-3zm-1-5.05l-4.95 4.95-3.54-3.54 4.95-4.95L17 7.95zm-4.24-5.66L6.39 8.66c-.39.39-.39 1.02 0 1.41l4.95 4.95c.39.39 1.02.39 1.41 0l6.36-6.36c.39-.39.39-1.02 0-1.41L14.16 2.29c-.39-.39-1.02-.39-1.41 0z"/></svg>
                    <span class="menu-label">PPPOE</span>
                </div>
                <div class="menu-item" onclick="nav('voucher')">
                    <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                    <span class="menu-label">Vouchers</span>
                </div>
                <div class="menu-item" onclick="nav('network')">
                    <svg viewBox="0 0 24 24"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    <span class="menu-label">Network</span>
                </div>
                <div class="menu-item" onclick="nav('qos')">
                    <svg viewBox="0 0 24 24"><path d="M3 17h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V5H3z"/></svg>
                    <span class="menu-label">QoS</span>
                </div>
                <div class="menu-item" onclick="nav('firewall')">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM12 22C7.31 20.78 4 16.03 4 11V6.3l8-3.56 8 3.56V11c0 5.03-3.31 9.78-8 11zM11 7h2v2h-2zm0 4h2v6h-2z"/></svg>
                    <span class="menu-label">AdBlocker</span>
                </div>
                <div class="menu-item" onclick="nav('subvendo')">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H9v-2h6v2zm-3-7l-2.5-3.48L12 6l2.5 1.52L12 11zm3 2h-6v-2h6v2z"/></svg>
                    <span class="menu-label">Sub Vendo</span>
                </div>
                <div class="menu-item" onclick="nav('portal')">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    <span class="menu-label">Portal</span>
                </div>
                <div class="menu-item" onclick="nav('syslogs')">
                    <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span class="menu-label">Logs</span>
                </div>
                <div class="menu-item" onclick="nav('devices')">
                    <svg viewBox="0 0 24 24"><path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/></svg>
                    <span class="menu-label">Devices</span>
                </div>
                <div class="menu-item" onclick="nav('chat')">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                    <span class="menu-label">Chat</span>
                </div>
                <div class="menu-item" onclick="nav('sales')">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 5H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 2v2H3V7h18zM3 17v-5h18v5H3zm4-3h4v2H7v-2zm6 0h4v2h-4v-2z"/>
                    </svg>
                    <span class="menu-label">Hotspot Sales</span>
                </div>
                <div class="menu-item" onclick="nav('pppoe-sales')">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    </svg>
                    <span class="menu-label">PPPoE Sales</span>
                </div>
                <div class="menu-item" onclick="nav('license')">
                    <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                    <span class="menu-label">License</span>
                </div>
                <div class="menu-item" onclick="nav('settings')">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87a.49.49 0 0 0 .12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    <span class="menu-label">Settings</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg viewBox="0 0 24 24" style="width:18px; fill:white;"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                    <span class="menu-label">Logout</span>
                </button>
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px; text-align: center;">Developed By: CJTECH</div>
            </div>
        </div>

        <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="topbar">
                <div style="display:flex; align-items:center;">
                    <div class="mobile-toggle" onclick="toggleSidebar()">
                        <svg viewBox="0 0 24 24" style="width:24px;"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </div>
                    <!-- Dashboard Icon (click to collapse sidebar) -->
                    <svg viewBox="0 0 24 24" style="width:24px; height:24px; margin-right:8px; fill:var(--dark); display:block; cursor:pointer;" id="header-icon" onclick="toggleSidebarCollapsed()">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    <div class="page-title" id="page-title">Dashboard</div>
                </div>
                
                <!-- System Time Display -->
                <div id="topbar-time" style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; display: none;">
                    --:--:--
                </div>

                <div style="display:flex; align-items:center; gap: 10px;">
                    <div id="chart-warning" style="display:none; color: white; background: var(--danger); padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                        Offline Mode: Charts Disabled
                    </div>
                    <div class="status-badge" style="white-space: nowrap; z-index: 10;">
                        <div class="status-dot"></div> System Online
                    </div>
                    <button id="theme-toggle" class="btn" onclick="toggleTheme()" style="padding: 6px; background: transparent; color: var(--text-main); display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 32px; height: 32px; border: 1px solid var(--border);">
                        <svg id="theme-icon-sun" viewBox="0 0 24 24" style="width:20px; height:20px; fill: currentColor; display: none;">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        <svg id="theme-icon-moon" viewBox="0 0 24 24" style="width:20px; height:20px; fill: currentColor;">
                            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="content-scroll">
                
                <div id="pull-to-refresh">
                    <svg class="ptr-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    <span class="ptr-text" style="margin-left:8px;">Pull to refresh</span>
                </div>

                <!-- VIEW: Dashboard -->
                <div id="view-dashboard" class="view-section">
                    
                    <div class="grid-3">
                        <!-- System Info -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                            <path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 4a1.5 1.5 0 1 1-1.5 1.5A1.5 1.5 0 0 1 12 6zm2 10h-4v-2h1v-4h-1V8h3v6h1z"/>
                                        </svg>
                                        <span>System Info</span>
                                    </span>
                                </div>
                            </div>
                            <div class="info-row"><span class="info-label">Device Model</span><span class="info-value" id="board-model">Loading...</span></div>
                            <div class="info-row"><span class="info-label">System</span><span class="info-value">Ubuntu / Armbian</span></div>
                            <div class="info-row"><span class="info-label">CPU Temp</span><span class="info-value" id="cpu-temp">--&deg;C</span></div>
                            <div class="info-row"><span class="info-label">CPU Load</span><span class="info-value" id="cpu-load">--%</span></div>
                            <div class="info-row"><span class="info-label">RAM Usage</span><span class="info-value" id="ram-usage">-- / -- MB</span></div>
                            <div class="info-row"><span class="info-label">Storage</span><span class="info-value" id="storage-usage">-- / -- GB</span></div>
                            <div class="info-row"><span class="info-label">Uptime</span><span class="info-value" id="uptime">--</span></div>
                        </div>

                        <div class="card" style="display:flex; flex-direction:column;">
                            <div class="card-header" style="margin-bottom:5px;">
                                <div class="card-title">
                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                            <path fill="currentColor" d="M9 3v2H7a2 2 0 0 0-2 2v2H3v2h2v2H3v2h2v2a2 2 0 0 0 2 2h2v2h2v-2h2v2h2v-2h2a2 2 0 0 0 2-2v-2h2v-2h-2v-2h2V9h-2V7a2 2 0 0 0-2-2h-2V3h-2v2h-2V3zm0 6h6v6H9z"/>
                                        </svg>
                                        <span>CPU Usage</span>
                                    </span>
                                </div>
                            </div>
                            <div style="width:100%; height:180px; position:relative;">
                                <canvas id="cpuChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                            <path fill="currentColor" d="M16 11a4 4 0 1 0-4-4a4 4 0 0 0 4 4zm-8 0a3 3 0 1 0-3-3a3 3 0 0 0 3 3zm0 2a5 5 0 0 0-5 5v1h4v-1a3 3 0 0 1 3-3h2.26A5 5 0 0 0 8 13zm8 0a5 5 0 0 0-4.58 3H14a3 3 0 0 1 3 3v1h5v-1a5 5 0 0 0-5-5z"/>
                                        </svg>
                                        <span>Clients Status</span>
                                    </span>
                                </div>
                            </div>
                            <div style="padding:10px 15px; font-size:0.9rem; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div>
                                    <div style="font-weight:bold; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">HOTSPOT</div>
                                    <div class="info-row">
                                        <span class="info-label">Connected</span>
                                        <span class="info-value" id="clients-connected-count">0</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Paused</span>
                                        <span class="info-value" id="clients-paused-count">0</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Disconnected</span>
                                        <span class="info-value" id="clients-disconnected-count">0</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-weight:bold; margin-bottom:5px; color:var(--text-muted); font-size:0.8rem;">PPPOE</div>
                                    <div class="info-row">
                                        <span class="info-label">Online</span>
                                        <span class="info-value" id="pppoe-online-count">0</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Offline</span>
                                        <span class="info-value" id="pppoe-offline-count">0</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Expired</span>
                                        <span class="info-value" id="pppoe-expired-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Cards -->
                    <div class="grid-4">
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 5h-2v2H8v2h3v4h2v-4h3v-2h-3z"/>
                                    </svg>
                                    <span>Daily Revenue</span>
                                </span>
                            </div>
                            <div class="rev-value" id="sales-daily">₱0.00</div>
                            <div class="rev-label">Today</div>
                            <svg class="rev-icon" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0h24v24H0z"/>
                                <path d="M8 19v-14h3.5a4.5 4.5 0 1 1 0 9h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 8h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 11h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M3 5v14h18V5H3zm4 12H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V7h2v2zm4 8H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
                                    </svg>
                                    <span>Weekly Revenue</span>
                                </span>
                            </div>
                            <div class="rev-value" id="sales-weekly">₱0.00</div>
                            <div class="rev-label">Last 7 Days</div>
                            <svg class="rev-icon" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0h24v24H0z"/>
                                <path d="M8 19v-14h3.5a4.5 4.5 0 1 1 0 9h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 8h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 11h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H5V9h14zm-7-2a4 4 0 1 0-4-4a4 4 0 0 0 4 4z"/>
                                    </svg>
                                    <span>Monthly Revenue</span>
                                </span>
                            </div>
                            <div class="rev-value" id="sales-monthly">₱0.00</div>
                            <div class="rev-label">This Month</div>
                            <svg class="rev-icon" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0h24v24H0z"/>
                                <path d="M8 19v-14h3.5a4.5 4.5 0 1 1 0 9h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 8h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 11h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M11 2v2H5v2h6v2l4-3zM7 10h2v10H7zm4 0h2v10h-2zm4 0h2v10h-2z"/>
                                    </svg>
                                    <span>Yearly Revenue</span>
                                </span>
                            </div>
                            <div class="rev-value" id="sales-yearly">₱0.00</div>
                            <div class="rev-label">This Year</div>
                            <svg class="rev-icon" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0h24v24H0z"/>
                                <path d="M8 19v-14h3.5a4.5 4.5 0 1 1 0 9h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 8h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 11h-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Dashboard Grid Layout -->
                    <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; align-items:stretch;">
                        
                        <!-- Left Column: Traffic Overview -->
                        <div style="flex: 1; min-width: 300px; display:flex; flex-direction:column;">
                            <div class="card" style="margin-top: 0; flex: 1; display:flex; flex-direction:column;">
                                <div class="card-header" style="display:flex; flex-direction:column; align-items:center; gap:2px; padding-bottom: 5px;">
                                    <div class="card-title" style="margin-bottom: 5px;">
                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                <path fill="currentColor" d="M3 17h2v-4h2v4h2v-7h2v7h2v-10h2v10h2v2H3z"/>
                                            </svg>
                                            <span style="text-transform: uppercase;">Traffic Overview</span>
                                        </span>
                                    </div>

                                    <div style="font-size:0.75rem; color: var(--text-muted); display:flex; gap:15px; justify-content:center; width: 100%; align-items:center;">
                                        <div style="display:flex; flex-direction:column; align-items:center;">
                                            <span style="color: var(--secondary); font-weight:600; display:flex; align-items:center; gap:5px;">
                                                <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background-color: var(--secondary);"></span>
                                                Download: <span id="rx-last">0 Mbps</span>
                                            </span>
                                            <span style="color: var(--secondary); font-weight:600; font-size: 0.7rem;">Total: <span id="rx-total">0 MB</span></span>
                                        </div>
                                        <div style="display:flex; flex-direction:column; align-items:center;">
                                            <span style="color: var(--status-active); font-weight:600; display:flex; align-items:center; gap:5px;">
                                                <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background-color: var(--status-active);"></span>
                                                Upload: <span id="tx-last">0 Mbps</span>
                                            </span>
                                            <span style="color: var(--status-active); font-weight:600; font-size: 0.7rem;">Total: <span id="tx-total">0 MB</span></span>
                                        </div>
                                    </div>

                                    <div style="font-size:0.9rem; color:var(--text-muted); font-weight:bold; margin-top:2px;">
                                        <select id="monitored-interface-select" onchange="onInterfaceChange()" style="border:none; background:transparent; font-weight:600; color:var(--text-main); cursor:pointer; outline:none; padding:0; text-align: center;">
                                            <option value="" disabled selected>Detecting...</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="height: 350px; width: 100%; position: relative; flex:1;">
                                    <canvas id="bandwidthChart"></canvas>
                                    <div id="bw-text-fallback" style="display:none; text-align:center; padding-top:100px; font-weight:bold; font-size:1.2rem;">
                                        Waiting for data...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Top Vendo & Clients -->
                        <div style="flex: 1; min-width: 300px; display:flex; flex-direction:column; gap:20px;">
                            
                            <!-- Top Vendo -->
                            <div class="card" style="margin-top:0; flex: 1; display:flex; flex-direction:column;">
                                <div class="card-header">
                                    <div class="card-title">
                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                            </svg>
                                            <span>Top Vendo</span>
                                        </span>
                                    </div>
                                    <select id="top-vendo-period" onchange="onTopVendoPeriodChange(this.value)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="daily">Today</option>
                                        <option value="weekly">Last 7 Days</option>
                                        <option value="monthly" selected>This Month</option>
                                        <option value="yearly">This Year</option>
                                    </select>
                                </div>
                                <div style="padding:10px 15px; font-size:0.9rem; flex:1; overflow:auto;">
                                    <div id="top-vendo-summary">Loading...</div>
                                </div>
                            </div>

                            <!-- Top Clients -->
                            <div class="card" style="margin-top:0; flex: 1; display:flex; flex-direction:column;">
                                <div class="card-header">
                                    <div class="card-title">
                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                <path fill="currentColor" d="M3 5v14h18V5H3zm3 10v-2h2v2H6zm0-4v-2h2v2H6zm0-4V5h2v2H6zm4 8v-2h2v2h-2zm0-4v-2h2v2h-2zm0-4V5h2v2h-2zm4 8v-2h2v2h-2zm0-4v-2h2v2h-2zm0-4V5h2v2h-2z"/>
                                            </svg>
                                            <span>Top 5 Clients by Sales</span>
                                        </span>
                                    </div>
                                    <select id="top-clients-period" onchange="onTopClientsPeriodChange(this.value)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="daily">Today</option>
                                        <option value="weekly">Last 7 Days</option>
                                        <option value="monthly" selected>This Month</option>
                                        <option value="yearly">This Year</option>
                                    </select>
                                </div>
                                <div style="padding:10px 15px; font-size:0.9rem; flex:1; overflow:auto;">
                                    <div id="top-clients-summary">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rate Modal -->
                <div id="rate-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                    <div style="background:var(--card-bg); width:95%; max-width:400px; border-radius:8px; box-shadow: var(--shadow); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
                        <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg);">
                            Manage Rate
                        </div>
                        <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                            <input type="hidden" id="rate-id">
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px;">Coin Amount (₱)</label>
                                <input type="number" id="rate-amount" class="login-input" placeholder="1, 5, 10" style="margin:0;">
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px;">Duration</label>
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1;">
                                        <input type="number" id="rate-days" placeholder="0" min="0" value="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Days</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="rate-hours" placeholder="0" min="0" value="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Hrs</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="rate-minutes" placeholder="0" min="0" value="15" class="login-input" style="margin:0; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Mins</div>
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1;">
                                    <label style="display:block; font-weight:600; margin-bottom:4px;">Upload (Mbps)</label>
                                    <input type="number" id="rate-ul" class="login-input" value="5" step="0.1" style="margin:0;">
                                </div>
                                <div style="flex:1;">
                                    <label style="display:block; font-weight:600; margin-bottom:4px;">Download (Mbps)</label>
                                    <input type="number" id="rate-dl" class="login-input" value="5" step="0.1" style="margin:0;">
                                </div>
                            </div>
                            <div>
                                 <div style="display:flex; align-items:center; height:40px;">
                                    <input type="checkbox" id="rate-pausable" checked style="margin-right:10px; transform:scale(1.2);">
                                    <label for="rate-pausable">Allow Pause?</label>
                                </div>
                            </div>
                        </div>
                        <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn btn-sm btn-danger" onclick="document.getElementById('rate-modal').style.display = 'none'">Cancel</button>
                            <button class="btn btn-sm btn-success" onclick="saveRate()">Save Rate</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Sales -->
                <div id="view-sales" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M3 5v14h18V5H3zm2 2h14v10H5V7zm2 2v2h4V9H7zm0 4v2h6v-2H7z"/>
                                    </svg>
                                    <span>Sales History</span>
                                </span>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:5px;">
                                <button class="btn btn-sm btn-primary" onclick="loadSalesData('daily')">Daily</button>
                                <button class="btn btn-sm" style="background:var(--bg-body);" onclick="loadSalesData('weekly')">Weekly</button>
                                <button class="btn btn-sm" style="background:var(--bg-body);" onclick="loadSalesData('monthly')">Monthly</button>
                                <button class="btn btn-sm" style="background:var(--bg-body);" onclick="loadSalesData('yearly')">Yearly</button>
                                <button class="btn btn-sm" style="background:var(--bg-body);" onclick="loadSalesData('history')">All Transactions</button>
                            </div>
                        </div>
                        <div style="flex:1 1 auto; overflow-x:auto; overflow-y:auto; min-height:0;">
                            <table id="sales-table" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                                                <span>Date</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                                <span>Amount</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M3 5v14h18V5H3zm2 2h14v10H5V7zm2 2v6h10V9H7z"/>
                                    </svg>
                                    <span>SALES BY VENDO</span>
                                </span>
                            </div>
                        </div>
                        <div style="overflow-x:auto; overflow-y:auto; height:260px;">
                            <table id="sales-by-device-table" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6zm-1 11h14v2H5v-2z"/>
                                                </svg>
                                                <span>Device</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1C8.13 1 5 4.13 5 8v2H4a1 1 0 0 0-1 1v9h18v-9a1 1 0 0 0-1-1h-1V8c0-3.87-3.13-7-7-7zm-5 7c0-2.76 2.24-5 5-5s5 2.24 5 5v2H7V8zm2 6h2v3h2v-3h2l-3-3-3 3z"/>
                                                </svg>
                                                <span>Total</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 15H5V9h14v10z"/>
                                                </svg>
                                                <span>Daily</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2L1 21h22L12 2zm0 4.84L18.93 19H5.07L12 6.84zM11 10v5h2v-5h-2zm0 6v2h2v-2h-2z"/>
                                                </svg>
                                                <span>Un Coins-Out</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M5 4h14v2H5V4zm0 4h14v2H5V8zm0 4h9v2H5v-2zm0 4h9v2H5v-2z"/>
                                                </svg>
                                                <span>Sales Logs</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M14.7 5.3l4 4-9.4 9.4H5.3v-4.4l9.4-9.4zM16 3l5 5-1.7 1.7-5-5L16 3z"/>
                                                </svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PPPoE Sales Report -->
                <div id="view-pppoe-sales" class="view-section" style="display:none;">
                    
                    <!-- Print Only Header -->
                    <div class="print-only-header">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <img id="print-company-logo" src="/neologo.png" alt="Logo" style="height:60px; width:auto;">
                                <div>
                                    <h2 id="print-company-name" style="margin:0; font-size:1.5rem; color:var(--text-main);">CJTECH PISOWIFI</h2>
                                    <div style="font-size:0.9rem; color:var(--text-muted);">Internet Service Provider</div>
                                </div>
                            </div>
                            <div style="text-align:right; font-size:0.9rem; color:var(--text-muted);">
                                <div><b>Contact:</b> <span id="print-company-contact">09123456789</span></div>
                                <div><b>Email:</b> <span id="print-company-email">admin@neofi.com</span></div>
                                <div id="pppoe-print-date"></div>
                            </div>
                        </div>
                    </div>

                     <!-- Date Filter & Actions -->
                    <div style="margin-bottom: 20px; display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:20px;">
                        <div style="font-weight:bold; font-size:1.1rem; padding-bottom: 5px;">PPPoE Sales Report</div>
                        
                        <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
                            <div style="display:flex; gap:15px;">
                                <div style="display:flex; flex-direction:column; gap:5px;">
                                    <label for="pppoe-sales-start" style="font-size:0.85rem; font-weight:600; color:var(--text-muted);">Start Date</label>
                                    <input type="date" id="pppoe-sales-start" class="login-input" style="margin:0; padding:6px 10px; height:38px;">
                                </div>
                                <div style="display:flex; flex-direction:column; gap:5px;">
                                    <label for="pppoe-sales-end" style="font-size:0.85rem; font-weight:600; color:var(--text-muted);">End Date</label>
                                    <input type="date" id="pppoe-sales-end" class="login-input" style="margin:0; padding:6px 10px; height:38px;">
                                </div>
                            </div>
                            
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="loadPppoeSalesData()" style="height:38px; display:flex; align-items:center;">Filter</button>
                                <button class="btn btn-primary" onclick="printPppoeReport()" style="display:flex; align-items:center; gap:6px; background-color: var(--secondary); height:38px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/><circle cx="18" cy="11.5" r="1"/></svg>
                                    Print Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid-4">
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 5h-2v2H8v2h3v4h2v-4h3v-2h-3z"/></svg>
                                    <span>Net Revenue</span>
                                </span>
                            </div>
                            <div class="rev-value" id="pppoe-net-revenue">₱0.00</div>
                            <div class="rev-label">Total Earnings</div>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/></svg>
                                    <span>Total Sales</span>
                                </span>
                            </div>
                            <div class="rev-value" id="pppoe-total-sales">₱0.00</div>
                            <div class="rev-label">Gross Sales</div>
                        </div>
                         <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12.79 21L3 11.21v-6c0-1.1.9-2 2-2h6l9.79 9.79-8 8zM5 7c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/></svg>
                                    <span>Total Discounts</span>
                                </span>
                            </div>
                            <div class="rev-value" id="pppoe-total-discounts">₱0.00</div>
                            <div class="rev-label">Discount Amount</div>
                        </div>
                        <div class="card rev-card">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 16c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z"/></svg>
                                    <span>Transactions</span>
                                </span>
                            </div>
                            <div class="rev-value" id="pppoe-transactions">0</div>
                            <div class="rev-label">Total Count</div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card">
                         <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M3 5v14h18V5H3zm2 2h14v10H5V7zm2 2v2h4V9H7zm0 4v2h6v-2H7z"/>
                                    </svg>
                                    <span>Sales History</span>
                                </span>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                             <table id="pppoe-sales-table" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Username</th>
                                        <th>Plan</th>
                                        <th>Router</th>
                                        <th>Price</th>
                                        <th>Discount</th>
                                        <th>Paid</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Receipt Container -->
                <div id="pppoe-receipt-container" style="display:none; background:var(--card-bg); color:var(--text-main); padding:20px; width:300px; margin:0 auto; font-family: 'Courier New', monospace;">
                    <!-- Content will be injected by JS -->
                </div>

                <!-- VIEW: Interfaces -->
                <div id="view-interfaces" class="view-section" style="display:none;">
                    <!-- Physical Interfaces Card -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                    </svg>
                                    <span>Physical / Main Interfaces</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main);">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadInterfaces()">Refresh</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="interfaces-table-physical" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                                </svg>
                                                <span>Interface</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                <span>Status</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20.38 8.57l-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 15.58 6.85l1.85-1.23A10 10 0 0 0 3.35 19a2 2 0 0 0 1.72 1h13.85a2 2 0 0 0 1.74-1 10 10 0 0 0-.27-10.44zM12 13a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
                                                <span>Speed</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h5v2H7v-2z"/>
                                                </svg>
                                                <span>IP Address</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h3v2H7v-2z"/>
                                                </svg>
                                                <span>MAC Address</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                </svg>
                                                <span>Netmask</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                </svg>
                                                <span>Family</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VLAN Interfaces Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                    </svg>
                                    <span>VLAN Interfaces</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadInterfaces()">Refresh</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="interfaces-table-vlan" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                                </svg>
                                                <span>Interface</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                <span>Status</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h5v2H7v-2z"/>
                                                </svg>
                                                <span>IP Address</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h3v2H7v-2z"/>
                                                </svg>
                                                <span>MAC Address</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                </svg>
                                                <span>Netmask</span>
                                            </span>
                                        </th>
                                        <th style="position: sticky; top: 0; background: var(--table-header-bg); z-index: 1;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                </svg>
                                                <span>Family</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PPPOE -->
                <div id="view-pppoe" class="view-section" style="display:none;">
                                    <!-- Server Settings Card -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                    </svg>
                                    <span>Server Settings</span>
                                </span>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="pppoe-server-enabled">
                                <label class="form-check-label" for="pppoe-server-enabled">Enable Server</label>
                            </div>
                        </div>
                        <div style="padding:10px;">
                            <div class="pppoe-server-grid">
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">Interface</label>
                                    <select id="pppoe-server-iface" class="login-input" style="width:100%; background:var(--input-bg); color:var(--text-main); margin: 2px 0; padding: 6px;">
                                        <option value="br0">br0</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">Local IP (Server)</label>
                                    <input type="text" id="pppoe-server-local-ip" class="login-input" placeholder="10.10.10.1" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">Remote IP Start</label>
                                    <input type="text" id="pppoe-server-remote-start" class="login-input" placeholder="10.10.10.2" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">IP Pool Count</label>
                                    <input type="number" id="pppoe-server-count" class="login-input" placeholder="50" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">DNS 1</label>
                                    <input type="text" id="pppoe-server-dns1" class="login-input" placeholder="8.8.8.8" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">DNS 2</label>
                                    <input type="text" id="pppoe-server-dns2" class="login-input" placeholder="8.8.4.4" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">Expired Pool </label>
                                    <input type="text" id="pppoe-server-expired-pool" class="login-input" placeholder="172.15.10.2-172.15.10.254" style="margin: 2px 0; padding: 6px;">
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size: 0.8rem;">NTP Server</label>
                                    <input type="text" id="pppoe-server-ntp" class="login-input" placeholder="pool.ntp.org" style="margin: 2px 0; padding: 6px;">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="savePppoeServerConfig()" style="margin-top:10px;">Save & Restart Server</button>
                        </div>
                    </div>

                    <!-- Profile Management Card -->
                    <div class="card" id="pppoe-profiles-card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    <span>Billing Plan</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openPppoeProfileModal()">+ Add Plan</button>
                            </div>
                        </div>
                        <div style="padding:0;">
                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="sales-grid-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: var(--table-header-bg); color: var(--text-main); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
                                                    <span>PLAN</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                                    <span>PRICE</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20.38 8.57l-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 15.58 6.85l1.85-1.23A10 10 0 0 0 3.35 19a2 2 0 0 0 1.72 1h13.85a2 2 0 0 0 1.74-1 10 10 0 0 0-.27-10.44zM12 13a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
                                                    <span>SPEED</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10; text-align: center;">
                                                <span style="display:inline-flex;align-items:center;gap:6px; justify-content: center;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                                    <span>ACTIONS</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="pppoe-profiles-list" style="font-size: 0.9rem;">
                                        <!-- JS populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Card -->
                    <div class="card" id="pppoe-users-card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                    </svg>
                                    <span>PPPoE Users List</span>
                                    <span id="pppoe-users-count" class="badge bg-secondary" style="margin-left:8px; font-size:0.75em;">0</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-warning" onclick="checkPppoeExpiration()" style="margin-right:5px;" title="Check for expired users immediately">Check Expiration</button>
                                <button class="btn btn-sm btn-primary" onclick="openPppoeUserModal()">+ Add User</button>
                            </div>
                        </div>
                        <div style="padding:0;">
                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="sales-grid-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: var(--table-header-bg); color: var(--text-main); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                                    <span>Username</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3 3.1-3 1.71 0 3.1 1.29 3.1 3v2z"/></svg>
                                                    <span>Password</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                                    <span>Plan</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                    <span>Expires</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                    <span>Status</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10; text-align: center;">
                                                <span style="display:inline-flex;align-items:center;gap:6px; justify-content: center;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                                    <span>Actions</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="pppoe-users-all-list" style="font-size: 0.9rem;">
                                        <!-- JS populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Status Card -->
                    <div class="card" id="pppoe-status-card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                    </svg>
                                    <span>Active PPPoE Status</span>
                                    <span id="pppoe-status-count" class="badge bg-secondary" style="margin-left:8px; font-size:0.75em;">0</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadPppoeUsers(true)">Refresh</button>
                            </div>
                        </div>
                        <div style="padding:0;">
                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="sales-grid-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: var(--table-header-bg); color: var(--text-main); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                                    <span>Username</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                    <span>Status</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h5v2H7v-2z"/></svg>
                                                    <span>Remote IP</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                    <span>Uptime</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V5H3z"/></svg>
                                                    <span>Limit (U/D)</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
                                                    <span>RX</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
                                                    <span>TX</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10; text-align: center;">
                                                <span style="display:inline-flex;align-items:center;gap:6px; justify-content: center;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                                                    <span>ACTION</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="pppoe-status-table-body" style="font-size: 0.9rem;">
                                        <!-- JS populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Expired PPPoE Users Card -->
                    <div class="card" id="pppoe-expired-card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <div class="card-title">
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                    </svg>
                                    <span>Expired PPPoE Users</span>
                                    <span id="pppoe-expired-count" class="badge bg-secondary" style="margin-left:8px; font-size:0.75em;">0</span>
                                </span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadPppoeUsers(true)">Refresh</button>
                            </div>
                        </div>
                        <div style="padding:0;">
                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="sales-grid-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: var(--table-header-bg); color: var(--text-main); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                                    <span>Username</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                    <span>Status</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h5v2H7v-2z"/></svg>
                                                    <span>Remote IP</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                    <span>Uptime</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V5H3z"/></svg>
                                                    <span>Limit (U/D)</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
                                                    <span>RX</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10;">
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
                                                    <span>TX</span>
                                                </span>
                                            </th>
                                            <th style="padding: 12px 15px; position: sticky; top: 0; background: var(--table-header-bg); z-index: 10; text-align: center;">
                                                <span style="display:inline-flex;align-items:center;gap:6px; justify-content: center;">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                                                    <span>ACTION</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="pppoe-expired-table-body" style="font-size: 0.9rem;">
                                        <!-- JS populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PPPoE User Modal -->
                <div id="pppoe-user-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:400px; max-width:90%;">
                        <h3 id="pppoe-modal-title" style="margin-top:0;">Add PPPoE User</h3>
                        <input type="hidden" id="pppoe-user-id">
                        
                        <div style="margin-bottom:10px;">
                            <label>Username</label>
                            <input type="text" id="pppoe-modal-user" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Password</label>
                            <input type="text" id="pppoe-modal-pass" class="login-input" style="width:100%;">
                        </div>
                        <!--
                        <div style="margin-bottom:10px;">
                            <label>MAC Address (Optional)</label>
                            <input type="text" id="pppoe-modal-mac" class="login-input" style="width:100%;" placeholder="XX:XX:XX:XX:XX:XX">
                        </div>
                        -->
                        <div style="margin-bottom:10px;">
                            <label>Profile</label>
                            <select id="pppoe-modal-profile" class="login-input" style="width:100%;">
                                <option value="">No Profile (Unlimited)</option>
                            </select>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Expiration (YYYY-MM-DD HH:mm)</label>
                            <input type="datetime-local" id="pppoe-modal-expiry" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Status</label>
                            <select id="pppoe-modal-active" class="login-input" style="width:100%;">
                                <option value="1">Active</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                            <button class="btn btn-danger" onclick="closePppoeUserModal()">Cancel</button>
                            <button class="btn btn-success" onclick="savePppoeUser()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- PPPoE Profile Modal -->
                <div id="pppoe-profile-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:400px; max-width:90%;">
                        <h3 id="pppoe-profile-modal-title" style="margin-top:0;">Add PPPoE Profile</h3>
                        <input type="hidden" id="pppoe-profile-id">
                        
                        <div style="margin-bottom:10px;">
                            <label>Plan Name</label>
                            <input type="text" id="pppoe-profile-name" class="login-input" style="width:100%;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Price (₱)</label>
                            <input type="number" id="pppoe-profile-price" class="login-input" style="width:100%;" placeholder="0" min="0">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Upload Limit (Mbps)</label>
                            <input type="number" id="pppoe-profile-rate-up" class="login-input" style="width:100%;" placeholder="0 for unlimited" step="0.1">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label>Download Limit (Mbps)</label>
                            <input type="number" id="pppoe-profile-rate-down" class="login-input" style="width:100%;" placeholder="0 for unlimited" step="0.1">
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                            <button class="btn btn-danger" onclick="closePppoeProfileModal()">Cancel</button>
                            <button class="btn btn-success" onclick="savePppoeProfile()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Voucher -->
                <div id="view-voucher" class="view-section" style="display:none;">
                    <div class="card" style="max-height:420px; display:flex; flex-direction:column;">
                        <div class="card-header">
                            <div class="card-title">Voucher Management</div>
                            <div style="display:flex; gap:10px;">
                                <button id="btn-delete-selected" class="btn btn-sm btn-danger" style="display:none;" onclick="deleteSelectedVouchers()">Delete Selected</button>
                                <button class="btn btn-sm btn-primary" onclick="openVoucherModal()">Generate Voucher</button>
                            </div>
                        </div>
                        <div style="padding: 10px; display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; row-gap:8px; column-gap:10px;">
                            <div style="color:var(--text-color); flex:1 1 260px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <span>Show</span>
                                <select id="voucher-entries" onchange="setTableLimit(this)" style="padding:5px; border-radius:4px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);">
                                    <option value="10">10</option>
                                    <option value="100">100</option>
                                    <option value="500">500</option>
                                    <option value="all">ALL</option>
                                </select>
                                <span>entries</span>
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" id="voucher-show-used" onchange="loadVouchersData()" style="accent-color: var(--gauge-6);" title="Show used vouchers">
                                </label>
                                <button onclick="showBatchVoucherTickets()" style="padding:4px 8px; border-radius:4px; border:1px solid var(--border-color); background:var(--card-bg); cursor:pointer; font-size:0.75rem; white-space:nowrap;">
                                    Show / Print Batch
                                </button>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px; color:var(--text-color); flex:1 1 220px; flex-wrap:wrap; justify-content:flex-end;">
                                <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem;">
                                    <span>Batch:</span>
                                    <select id="voucher-batch-filter" onchange="loadVouchersData()" style="padding:5px; border-radius:4px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);">
                                        <option value="">All</option>
                                    </select>
                                </label>
                                <div style="display:flex; align-items:center; gap:6px; flex:1 1 140px;">
                                    <span>Search:</span>
                                    <input type="text" id="voucher-search" autocomplete="off" style="flex:1 1 auto; padding:5px; border:2px solid var(--primary); border-radius:4px; background:var(--card-bg); color:var(--text-color); min-width:0;">
                                </div>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="voucher-table" class="sales-grid-table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:var(--bg-color); text-align:left;">
                                        <th style="padding:10px;">
                                            <input type="checkbox" id="select-all-vouchers" onclick="toggleSelectAll(this)">
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M7 2v2H5v14h14V4h-2V2h-2v2H9V2H7zm0 6h10v8H7V8z"/>
                                                </svg>
                                                <span>Code</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                </svg>
                                                <span>Duration</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6zm-1 11h14v2H5v-2z"/>
                                                </svg>
                                                <span>Plan</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1C8.13 1 5 4.13 5 8v2H4a1 1 0 0 0-1 1v9h18v-9a1 1 0 0 0-1-1h-1V8c0-3.87-3.13-7-7-7zM9 14h6v2H9v-2z"/>
                                                </svg>
                                                <span>Price</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                </svg>
                                                <span>Status</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody style="color:var(--text-color);"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 25px;">
                        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <div class="card-title">Voucher Batches</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadVoucherBatches()">Refresh Batches</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="voucher-batches-table" class="sales-grid-table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:var(--bg-color); text-align:left;">
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>
                                                <span>Batch ID</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                <span>Created</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/></svg>
                                                <span>Plan</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                                <span>Price</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12zM10 9h8v2h-8V9zm0 3h4v2h-4v-2zm0-6h8v2h-8V6z"/></svg>
                                                <span>Count</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                                <span>Actions</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ACTIVE CODES Card -->
                    <div class="card" style="margin-top: 25px;">
                        <div class="card-header" id="active-codes-header">
                            <div class="card-title" id="active-codes-header-title">ACTIVE CODES (SESSIONS)</div>
                            <div id="active-codes-header-filter" style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <span>Status:</span>
                                <select id="active-codes-status-filter" style="padding:5px 10px; border-radius:4px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);" onchange="loadActiveCodes()">
                                    <option value="all">Show All</option>
                                    <option value="online">Show Online</option>
                                    <option value="offline_paused">Show Offline / Paused</option>
                                </select>
                                <button class="btn btn-sm btn-primary" onclick="loadActiveCodes()">Refresh</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="active-codes-table" class="sales-grid-table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--table-header-bg); text-align:center;">
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M7 2v2H5v14h14V4h-2V2h-2v2H9V2H7zm0 6h10v8H7V8z"/>
                                                </svg>
                                                <span>Code</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h3v2H7v-2z"/>
                                                </svg>
                                                <span>MAC Address</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h3v2H7V9zm0 4h5v2H7v-2z"/>
                                                </svg>
                                                <span>IP Address</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 4h16v2H4zm0 4h10v2H4zm0 4h8v2H4zm0 4h6v2H4z"/>
                                                </svg>
                                                <span>Interface</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                </svg>
                                                <span>Time Remaining</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1C8.13 1 5 4.13 5 8v2H4a1 1 0 0 0-1 1v9h18v-9a1 1 0 0 0-1-1h-1V8c0-3.87-3.13-7-7-7zM9 14h6v2H9v-2z"/>
                                                </svg>
                                                <span>Total Coins</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 18h2v-5H4v5zm4 0h2V9H8v9zm4 0h2V5h-2v13zm4 0h2v-8h-2v8z"/>
                                                </svg>
                                                <span>Traffic (DL/UP)</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-1-11h2v5h-2zm0 6h2v2h-2z"/>
                                                </svg>
                                                <span>Idle Countdown</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px; text-align:center;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                </svg>
                                                <span>Status</span>
                                            </span>
                                        </th>
                                        <th style="padding:10px;">
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                </svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody style="color:var(--text-main);"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Voucher Modal (Symmetrical Card) -->
                <div id="voucher-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                    <div style="background:var(--card-bg); width:95%; max-width:420px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: var(--shadow); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
                        <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10;">
                            Generate Voucher
                        </div>
                        <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            
                            <!-- Full Width: Batch Code -->
                            <div style="grid-column: span 2;">
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Batch Code (Group ID)</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="v-batch-id" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                                    <button class="btn btn-sm btn-secondary" onclick="generateRandomBatchId()" title="Regenerate" style="padding: 0 12px; font-size: 1.2rem;">&#8635;</button>
                                </div>
                            </div>

                            <!-- Full Width: Plan -->
                            <div style="grid-column: span 2;">
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Plan</label>
                                <select id="v-plan" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main);">
                                    <option value="Standard">Standard</option>
                                </select>
                            </div>

                            <!-- Row: Qty | Type -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Quantity</label>
                                <input type="number" id="v-qty" value="1" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Type</label>
                                <select id="v-type" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main);">
                                    <option value="Pausable">Pausable</option>
                                    <option value="One-Time">One-Time</option>
                                </select>
                            </div>

                            <!-- Row: Duration | Price -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Duration</label>
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1;">
                                        <input type="number" id="v-days" placeholder="0" min="0" value="0" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Days</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="v-hours" placeholder="0" min="0" value="1" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Hrs</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="v-minutes" placeholder="0" min="0" value="0" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box; text-align:center;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); text-align:center;">Mins</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Price (₱)</label>
                                <input type="number" id="v-price" placeholder="0.00" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>

                            <!-- Row: Upload | Download -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Upload (Mbps)</label>
                                <input type="number" id="v-ul" value="2" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Download (Mbps)</label>
                                <input type="number" id="v-dl" value="2" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>

                            <!-- Section Header -->
                            <div style="grid-column: span 2; margin-top:5px; border-bottom:1px solid var(--border); padding-bottom:5px; font-weight:bold; color:var(--text-muted); font-size:0.9rem;">
                                Code Options
                            </div>

                            <!-- Row: Prefix | Length -->
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Prefix</label>
                                <input type="text" id="v-prefix" placeholder="Optional" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Length</label>
                                <input type="number" id="v-length" value="6" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>

                            <!-- Random Toggle -->
                            <div style="grid-column: span 2; display:flex; align-items:center; justify-content:space-between; background:var(--bg-body); padding:8px; border-radius:4px;">
                                <label for="v-random" style="font-weight:600; font-size:0.85rem; cursor:pointer;">Randomize Code?</label>
                                <input type="checkbox" id="v-random" checked onchange="toggleCustomVoucher()" style="transform:scale(1.2);">
                            </div>

                            <!-- Custom Code (Full Width) -->
                            <div style="grid-column: span 2;">
                                <input type="text" id="v-custom" placeholder="Enter Custom Code (Uncheck Random first)" disabled style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--bg-body); color:var(--text-main); opacity:0.7; box-sizing:border-box;">
                            </div>

                            <!-- Plan Name (Full Width) -->
                            <div style="grid-column: span 2;">
                                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.85rem;">Plan Name</label>
                                <input type="text" id="v-name" placeholder="e.g. 1 Hour Standard" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); box-sizing:border-box;">
                            </div>

                        </div>
                        <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                            <button class="btn" style="background:var(--status-expired); color:white; padding:8px 15px; border:none; border-radius:4px; font-size:0.9rem;" onclick="closeVoucherModal()">Close</button>
                            <button class="btn" style="background:var(--status-active); color:white; padding:8px 15px; border:none; border-radius:4px; font-size:0.9rem;" onclick="generateVouchers()">Generate</button>
                        </div>
                    </div>
                </div>

                <div id="voucher-generated-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
                    <div style="background:var(--card-bg); width:95%; max-width:920px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow:var(--shadow); display:flex; flex-direction:column; color:var(--text-main);">
                        <div style="padding:12px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <div id="voucher-generated-title" style="font-weight:700; font-size:1rem;">Generated Vouchers</div>
                            <div>
                                <button onclick="printGeneratedVouchers()" style="margin-right:8px; padding:6px 10px; border-radius:4px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); cursor:pointer; font-size:0.85rem;">Print</button>
                                <button onclick="closeGeneratedVoucherModal()" style="padding:6px 10px; border-radius:4px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main); cursor:pointer; font-size:0.85rem;">Close</button>
                            </div>
                        </div>
                        <div id="voucher-generated-body" style="padding:16px;"></div>
                    </div>
                </div>

                <!-- Sub Vendo Free Time Configuration Modal -->
                <div id="subvendo-free-time-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1100; justify-content:center; align-items:center;">
                    <div style="background:var(--card-bg); width:90%; max-width:500px; max-height:90vh; overflow-y:auto; border-radius:8px; box-shadow:var(--shadow); display:flex; flex-direction:column; color:var(--text-main);">
                        <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main);">Free Time Configuration</h3>
                            <button onclick="closeSubVendoFreeTimeConfig()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:var(--text-muted);">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <div style="margin-bottom:15px; padding:10px; background:rgba(67, 97, 238, 0.1); border-radius:6px; color:var(--primary); font-size:0.9rem;">
                                Configuring for: <strong id="ft-device-name">Device</strong>
                            </div>

                            <div style="margin-bottom:20px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <label style="font-weight:600;">Enable Free Time</label>
                                    <div class="form-check form-switch" style="margin:0;">
                                        <input class="form-check-input" type="checkbox" id="ft-enabled" style="transform:scale(1.2);">
                                    </div>
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-muted); margin-top:-5px; margin-bottom:15px;">
                                    If enabled, this device will give free time to users according to settings below.
                                </div>
                            </div>

                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">Free Time Duration (H:M:S)</label>
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1;">
                                        <input type="number" id="ft-h" placeholder="0" min="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:2px;">Hours</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="ft-m" placeholder="0" min="0" max="59" class="login-input" style="margin:0; text-align:center;">
                                        <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:2px;">Mins</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="ft-s" placeholder="0" min="0" max="59" class="login-input" style="margin:0; text-align:center;">
                                        <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:2px;">Secs</div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">Free Time Speed Limit (Mbps)</label>
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1;">
                                        <input type="number" id="ft-dl" placeholder="0" min="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:2px;">Download</div>
                                    </div>
                                    <div style="flex:1;">
                                        <input type="number" id="ft-ul" placeholder="0" min="0" class="login-input" style="margin:0; text-align:center;">
                                        <div style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin-top:2px;">Upload</div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">Reclaim Free Time (Days)</label>
                                <input type="number" id="ft-reclaim" placeholder="e.g. 1 (Daily reset)" min="0" class="login-input" style="width:100%;">
                                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">
                                    How many days before a user can claim free time again. Leave empty for one-time only.
                                </div>
                            </div>

                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">VLAN Interface (Optional)</label>
                                <input type="text" id="ft-vlan" placeholder="e.g. eth0.10" class="login-input" style="width:100%;">
                                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">
                                    If set, free time users will be assigned to this interface/VLAN.
                                </div>
                            </div>

                            <div style="margin-bottom:0; border-top:1px solid var(--border); padding-top:12px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-weight:600; margin-bottom:4px; font-size:0.9rem;">Free Time Widget</div>
                                        <div style="font-size:0.8rem; color:var(--text-muted);">
                                            Show the Free Time widget on client portal when user has no remaining time.
                                        </div>
                                    </div>
                                    <div class="form-check form-switch" style="margin-left:10px;">
                                        <input class="form-check-input" type="checkbox" id="subvendo-free-time-widget-toggle" onchange="toggleSubVendoFreeTimeWidget(this)" style="transform:scale(1.2);">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg);">
                            <button class="btn" style="background:var(--text-muted); color:white;" onclick="closeSubVendoFreeTimeConfig()">Cancel</button>
                            <button class="btn" style="background: var(--info); color:white;" onclick="saveSubVendoFreeTimeConfig()">Save Configuration</button>
                        </div>
                    </div>
                </div>



                <!-- QoS Limit Modal -->
                <div id="qos-limit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                    <div style="background:var(--card-bg); width:90%; max-width:400px; padding:20px; border-radius:8px; box-shadow:var(--shadow); color:var(--text-main);">
                        <h3 style="margin-top:0;">Edit Bandwidth Limit</h3>
                        <p id="qos-modal-ip" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;"></p>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Download Limit (Mbps)</label>
                            <input type="number" id="qos-edit-dl" class="login-input" style="width:100%; margin:0;">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Upload Limit (Mbps)</label>
                            <input type="number" id="qos-edit-ul" class="login-input" style="width:100%; margin:0;">
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn btn-sm btn-danger" onclick="document.getElementById('qos-limit-modal').style.display='none'">Cancel</button>
                            <button class="btn btn-sm btn-success" onclick="saveQosLimit()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Network -->
                <div id="view-network" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header" style="margin-bottom: 10px;">
                            <div class="card-title">WAN Configuration</div>
                        </div>
                        <div>
                            <div class="grid-2" style="gap: 4px; margin-bottom: 4px;">
                                <div id="wan-interface-group">
                                    <label for="wan-interface" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">WAN Interface</label>
                                    <select id="wan-interface" class="login-input" style="margin:1px 0; padding:4px; width:100%; max-width:400px;" autocomplete="off">
                                        <option value="" disabled selected>Loading interfaces...</option>
                                    </select>
                                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:1px;">
                                        Select the physical interface connected to your internet source.
                                    </div>
                                </div>
                                <div>
                                    <label for="wan-mode" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Connection Mode</label>
                                    <select id="wan-mode" class="login-input" style="margin:1px 0; padding:4px; width:100%; max-width:400px;" onchange="toggleWanMode()" autocomplete="off">
                                        <option value="dynamic">Dynamic (DHCP)</option>
                                        <option value="static">Static IP</option>
                                        <option value="pppoe">PPPoE</option>
                                        <option value="dual_wan">Dual WAN Smart Loadbalancing</option>
                                        <option value="multi_wan">Multiple WAN Smart Loadbalancing</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Dynamic Info -->
                            <div id="mode-dynamic" class="wan-mode-section" style="padding:6px; background:var(--bg-body); border-radius:6px; margin-top:2px;">
                                <div style="display:flex; gap:6px; align-items:center; color:var(--success);">
                                    <svg viewBox="0 0 24 24" style="width:18px; fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                    <span style="font-weight:600; font-size:0.9rem;">Automatic Configuration</span>
                                </div>
                                <p style="font-size:0.85rem; color:var(--text-muted); margin:2px 0 0 24px;">
                                    The system will automatically obtain an IP address from your ISP or upstream router.
                                </p>
                            </div>

                            <!-- Static Config -->
                            <div id="mode-static" class="wan-mode-section" style="display:none; margin-top:2px;">
                                <div class="form-grid" style="align-items: start; gap:1px;">
                                    <!-- Left Column -->
                                    <div style="display:flex; flex-direction:column; gap:1px;">
                                        <div>
                                            <label for="wan-ip" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">IP Address</label>
                                            <input type="text" id="wan-ip" class="login-input" placeholder="192.168.1.2" style="margin:1px 0; padding:4px;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-gateway" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Gateway</label>
                                            <input type="text" id="wan-gateway" class="login-input" placeholder="192.168.1.1" style="margin:1px 0; padding:4px;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-dns1" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">DNS 1</label>
                                            <input type="text" id="wan-dns1" class="login-input" placeholder="8.8.8.8" style="margin:1px 0; padding:4px;" autocomplete="off">
                                        </div>
                                    </div>
                                    
                                    <!-- Right Column -->
                                    <div style="display:flex; flex-direction:column; gap:1px;">
                                        <div>
                                            <label for="wan-netmask" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Netmask</label>
                                            <input type="text" id="wan-netmask" class="login-input" placeholder="255.255.255.0" style="margin:1px 0; padding:4px;" autocomplete="off">
                                        </div>
                                        <div>
                                            <label for="wan-dns2" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">DNS 2 (Optional)</label>
                                            <input type="text" id="wan-dns2" class="login-input" placeholder="8.8.4.4" style="margin:1px 0; padding:4px;" autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PPPoE Config -->
                            <div id="mode-pppoe" class="wan-mode-section" style="display:none; margin-top:2px;">
                                <div class="form-grid" style="align-items: start; gap:1px;">
                                    <!-- Left Column -->
                                    <div style="display:flex; flex-direction:column; gap:1px;">
                                        <div>
                                            <label for="pppoe-user" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Username</label>
                                            <input type="text" id="pppoe-user" class="login-input" placeholder="ISP Username" style="margin:1px 0; padding:4px;" autocomplete="username">
                                        </div>
                                        <div>
                                            <label for="pppoe-dns1" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">DNS 1 (Optional)</label>
                                            <input type="text" id="pppoe-dns1" class="login-input" placeholder="8.8.8.8" style="margin:1px 0; padding:4px;">
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div style="display:flex; flex-direction:column; gap:1px;">
                                        <div>
                                            <label for="pppoe-pass" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Password</label>
                                            <input type="password" id="pppoe-pass" class="login-input" placeholder="ISP Password" style="margin:1px 0; padding:4px;" autocomplete="current-password">
                                        </div>
                                        <div>
                                            <label for="pppoe-dns2" style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">DNS 2 (Optional)</label>
                                            <input type="text" id="pppoe-dns2" class="login-input" placeholder="8.8.4.4" style="margin:1px 0; padding:4px;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dual WAN Config -->
                            <div id="mode-dual_wan" class="wan-mode-section" style="display:none; margin-top:2px;">
                                <div style="margin-bottom:4px; padding:6px; background:var(--bg-body); border-radius:6px;">
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Load Balancing Strategy</label>
                                    <select id="dual-strategy" class="login-input" style="max-width:300px; margin:1px 0; padding:4px;">
                                        <option value="balance-rr">Weighted Round Robin (Balance Traffic)</option>
                                        <option value="failover">Failover (Primary/Backup)</option>
                                    </select>
                                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:2px;">
                                        <b>Round Robin:</b> Distributes traffic across both connections. <b>Failover:</b> Uses Secondary only if Primary fails.
                                    </div>
                                </div>

                                <div class="form-grid" style="align-items:start; gap:4px;">
                                    <!-- WAN 1 -->
                                    <div class="card" style="padding:6px; border:1px solid var(--border); box-shadow:none;">
                                        <div style="font-weight:700; color:var(--primary); margin-bottom:4px; border-bottom:1px solid var(--border); padding-bottom:4px; font-size:0.9rem;">WAN 1 (Primary)</div>
                                        
                                        <label style="font-weight:600; font-size:0.8rem; margin-bottom:0px;">Interface</label>
                                        <select id="dual-wan1-iface" class="login-input wan-iface-select" style="margin:1px 0; padding:4px;"></select>
                                        
                                        <label style="font-weight:600; font-size:0.8rem; margin-top:2px; margin-bottom:0px;">Connection Type</label>
                                        <select id="dual-wan1-type" class="login-input" onchange="toggleDualWanFields('wan1')" style="margin:1px 0; padding:4px;">
                                            <option value="dynamic">Dynamic (DHCP)</option>
                                            <option value="static">Static IP</option>
                                            <option value="pppoe">PPPoE</option>
                                        </select>

                                        <!-- Static Fields -->
                                        <div id="dual-wan1-static-fields" style="display:none; margin-top:2px;">
                                            <input id="dual-wan1-ip" placeholder="IP Address" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan1-gateway" placeholder="Gateway" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan1-netmask" placeholder="Netmask" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan1-dns" placeholder="DNS" class="login-input" style="margin:1px 0; padding:4px;">
                                        </div>
                                        
                                        <!-- PPPoE Fields -->
                                        <div id="dual-wan1-pppoe-fields" style="display:none; margin-top:2px;">
                                            <input id="dual-wan1-user" placeholder="Username" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan1-pass" placeholder="Password" type="password" class="login-input" style="margin:1px 0; padding:4px;">
                                        </div>
                                    </div>

                                    <!-- WAN 2 -->
                                    <div class="card" style="padding:6px; border:1px solid var(--border); box-shadow:none;">
                                        <div style="font-weight:700; color:var(--primary); margin-bottom:4px; border-bottom:1px solid var(--border); padding-bottom:4px; font-size:0.9rem;">WAN 2 (Secondary)</div>
                                        
                                        <label style="font-weight:600; font-size:0.8rem; margin-bottom:0px;">Interface</label>
                                        <select id="dual-wan2-iface" class="login-input wan-iface-select" style="margin:1px 0; padding:4px;"></select>
                                        
                                        <label style="font-weight:600; font-size:0.8rem; margin-top:2px; margin-bottom:0px;">Connection Type</label>
                                        <select id="dual-wan2-type" class="login-input" onchange="toggleDualWanFields('wan2')" style="margin:1px 0; padding:4px;">
                                            <option value="dynamic">Dynamic (DHCP)</option>
                                            <option value="static">Static IP</option>
                                            <option value="pppoe">PPPoE</option>
                                        </select>

                                        <!-- Static Fields -->
                                        <div id="dual-wan2-static-fields" style="display:none; margin-top:2px;">
                                            <input id="dual-wan2-ip" placeholder="IP Address" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan2-gateway" placeholder="Gateway" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan2-netmask" placeholder="Netmask" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan2-dns" placeholder="DNS" class="login-input" style="margin:1px 0; padding:4px;">
                                        </div>
                                        
                                        <!-- PPPoE Fields -->
                                        <div id="dual-wan2-pppoe-fields" style="display:none; margin-top:2px;">
                                            <input id="dual-wan2-user" placeholder="Username" class="login-input" style="margin:1px 0; padding:4px;">
                                            <input id="dual-wan2-pass" placeholder="Password" type="password" class="login-input" style="margin:1px 0; padding:4px;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi WAN Config -->
                            <div id="mode-multi_wan" class="wan-mode-section" style="display:none; margin-top:2px;">
                                <div class="card" style="padding:6px; border:1px solid var(--border); box-shadow:none;">
                                    <div style="margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-weight:700; color:var(--primary); font-size:0.95rem;">Multiple WAN Interfaces</div>
                                            <div style="font-size:0.8rem; color:var(--text-muted);">Add multiple internet sources for advanced load balancing.</div>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <div style="display:flex; align-items:center; gap:5px;">
                                                <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                                <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main);">
                                                    <option value="10">10</option>
                                                    <option value="100">100</option>
                                                    <option value="500">500</option>
                                                    <option value="all">ALL</option>
                                                </select>
                                            </div>
                                            <button class="btn btn-sm btn-success" onclick="addMultiWanRow()" style="padding: 2px 8px; font-size: 0.8rem;">+ Add WAN Interface</button>
                                        </div>
                                    </div>
                                    
                                    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table sales-grid-table" id="multi-wan-table" style="margin-bottom:0;">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                                <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6z"/>
                                                            </svg>
                                                            <span>Interface</span>
                                                        </span>
                                                    </th>
                                                    <th>
                                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                                <path fill="currentColor" d="M4 18h2v-5H4v5zm4 0h2V9H8v9zm4 0h2V5h-2v13zm4 0h2v-8h-2v8z"/>
                                                            </svg>
                                                            <span>Type</span>
                                                        </span>
                                                    </th>
                                                    <th>
                                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                                <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h3v2H7V9zm0 4h5v2H7v-2z"/>
                                                            </svg>
                                                            <span>Weight</span>
                                                        </span>
                                                    </th>
                                                    <th>
                                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                                <path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm2 2h8v2H8V9zm0 3h5v2H8v-2z"/>
                                                            </svg>
                                                            <span>Details</span>
                                                        </span>
                                                    </th>
                                                    <th>
                                                        <span style="display:inline-flex;align-items:center;gap:6px;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                                <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                            </svg>
                                                            <span>Action</span>
                                                        </span>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top:4px; font-size:0.8rem; color:var(--text-muted); font-style:italic;">
                                        * Use "Weight" to distribute traffic (e.g., 2:1 ratio). Higher weight = more traffic.
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:5px; padding-top:5px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                                <div id="wan-status" class="status-indicator">
                                    <div class="status-dot"></div>
                                    <span id="wan-status-text">Checking...</span>
                                </div>
                                <button class="btn btn-primary" onclick="saveNetworkConfig()">Save Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- ZeroTier Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header">
                            <div class="card-title">ZeroTier Configuration</div>
                            <div id="zt-status-badge" class="status-badge" style="background:var(--text-muted); color:var(--card-bg); font-size:0.7rem;">Checking...</div>
                        </div>

                        <!-- Install Area -->
                        <div id="zt-install-area" style="display:none; text-align:center; padding:6px;">
                            <p style="color:var(--text-muted); margin-bottom:5px;">ZeroTier is not installed on this system.</p>
                            <button class="btn btn-primary" onclick="installZeroTier()">Install ZeroTier</button>
                            <div id="zt-install-progress" class="progress-container">
                                <div id="zt-install-bar" class="progress-bar">0%</div>
                            </div>
                            <div style="margin-top:5px; font-size:0.8rem; color:var(--text-muted);">Runs: curl -s https://install.zerotier.com | sudo bash</div>
                        </div>

                        <!-- Config Area -->
                        <div id="zt-config-area" style="display:none;">
                            <div class="form-grid" style="align-items: end; gap:2px;">
                                <div style="flex-grow:1;">
                                    <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Join Network</label>
                                    <input type="text" id="zt-network-id" class="login-input" placeholder="Network ID (16 chars)" style="margin:1px 0; padding:4px;">
                                </div>
                                <button class="btn btn-primary" onclick="joinZeroTier()" style="height:38px; margin-bottom:2px;">Join</button>
                            </div>
                            
                            <div id="zt-info-area" style="margin-top:8px; display:none;">
                                <div class="info-row"><span class="info-label">Version</span><span class="info-value" id="zt-version">--</span></div>
                                <div class="info-row"><span class="info-label">Device ID</span><span class="info-value" id="zt-device-id">--</span></div>
                                <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="zt-status-text">--</span></div>
                            </div>

                            <!-- Networks List -->
                            <div id="zt-networks-list" style="margin-top:8px; max-height: 500px; overflow-y: auto;">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- VLAN Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header">
                            <div class="card-title">Vlan Interface</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main);">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openVlanModal()">Add</button>
                                <button class="btn btn-sm btn-danger" id="vlan-delete-btn" style="display:none;" onclick="deleteSelectedVlans()">Delete Selected</button>
                                <button class="btn btn-sm btn-primary" onclick="applyVlanChanges()">Apply changes</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table class="table sales-grid-table" id="vlan-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px; text-align: center;">
                                            <input type="checkbox" id="vlan-select-all" onclick="toggleVlanSelectAll(this)" style="cursor:pointer; width: 16px; height: 16px;">
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm2 2h8v2H8V9z"/></svg>
                                                <span>Name</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                                <span>Ifname</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2 9h20v6H2V9zm2 2v2h16v-2H4zm-2 6h20v2H2v-2zM2 5h20v2H2V5z"/></svg>
                                                <span>MAC</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-2v5H6v2h2v5h2v-5h2v-2zm5 5h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                                                <span>VID</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;justify-content:center;width:100%;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- DHCP Server Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="card-title">DHCP Server</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main);">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openDhcpModal()">Add</button>
                            </div>
                        </div>
                        <div class="card-body">


                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="table sales-grid-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                                    <span>Interface</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>
                                                    <span>Address</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                                                    <span>Pool</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                                    <span>Mask</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                                                    <span>Size</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                                    <span>DNS</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;justify-content:center;width:100%;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                    <span>Action</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="dhcp-table-body">
                                        <!-- Loaded via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bridge Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="card-title">Bridge Configuration</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="document.getElementById('bridge-modal').style.display = 'flex'">+ Add Bridge</button>
                            </div>
                        </div>

                        <!-- Bridge List -->
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table class="table sales-grid-table" id="bridge-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm2 2h8v2H8V9z"/>
                                                </svg>
                                                <span>Name</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5h18v2H3V5zm0 4h18v2H3V9zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                                                </svg>
                                                <span>Members</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h3v2H7V9zm0 4h5v2H7v-2z"/>
                                                </svg>
                                                <span>IP Address</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                </svg>
                                                <span>Netmask</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm4 2h2v6h-2zm4 0h2v6h-2z"/>
                                                </svg>
                                                <span>STP</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                </svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Built-in WiFi Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header">
                            <div class="card-title">Built-in WiFi (Access Point)</div>
                        </div>
                        <div style="padding: 6px;">
                            <form id="wifi-config-form" onsubmit="saveWifiConfig(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                                    <div style="grid-column: span 2; display: flex; align-items: center; margin-bottom: 2px;">
                                        <input type="checkbox" id="wifi-enabled" style="margin-right: 6px; transform: scale(1.1);">
                                        <label for="wifi-enabled" style="font-weight: 600; font-size: 0.8rem;">Enable WiFi Access Point</label>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">SSID (Network Name)</label>
                                        <input type="text" id="wifi-ssid" class="login-input" style="margin:1px 0; padding:4px;" required>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Authentication Mode</label>
                                        <select id="wifi-auth-mode" class="login-input" style="margin:1px 0; padding:4px;" onchange="toggleWifiAuth()">
                                            <option value="open">Open (No Security)</option>
                                            <option value="shared">Shared (WEP)</option>
                                            <option value="wpa">WPA PresharedKey</option>
                                            <option value="wpa2">WPA2 PresharedKey</option>
                                            <option value="mixed">WPA/WPA2 PresharedKey</option>
                                        </select>
                                    </div>
                                    <div id="wifi-password-container">
                                        <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Password (Min 8 chars)</label>
                                        <input type="text" id="wifi-password" class="login-input" style="margin:1px 0; padding:4px;" placeholder="Enter WiFi Password">
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Channel</label>
                                        <select id="wifi-channel" class="login-input" style="margin:1px 0; padding:4px;">
                                            <option value="1">Channel 1</option>
                                            <option value="6">Channel 6</option>
                                            <option value="11">Channel 11</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display:block; font-weight:600; margin-bottom:0px; font-size:0.8rem;">Hardware Mode</label>
                                        <select id="wifi-hw-mode" class="login-input" style="margin:1px 0; padding:4px;">
                                            <option value="g">802.11g (2.4GHz)</option>
                                            <option value="n">802.11n (2.4GHz)</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 5px; display: flex; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary">Save WiFi Settings</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Walled Garden Configuration -->
                    <div class="card" style="margin-top: 5px;">
                        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="card-title">Walled Garden / Domain Filter</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openWalledGardenModal()">+ Add Domain</button>
                            </div>
                        </div>
                        <div style="padding: 6px;">
                            <!-- List Table -->
                            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                <table class="table sales-grid-table" id="wg-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm2 2h8v2H8V9zm0 3h5v2H8v-2z"/>
                                                    </svg>
                                                    <span>Domain</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path fill="currentColor" d="M4 18h2v-5H4v5zm4 0h2V9H8v9zm4 0h2V5h-2v13zm4 0h2v-8h-2v8z"/>
                                                    </svg>
                                                    <span>Type</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h3v2H7V9zm0 4h5v2H7v-2z"/>
                                                    </svg>
                                                    <span>Address (Auto-Resolved)</span>
                                                </span>
                                            </th>
                                            <th>
                                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                    </svg>
                                                    <span>Action</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: QoS -->
                <div id="view-qos" class="view-section" style="display:none;">
                    <!-- QoS Performance Mode -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">QoS Performance Mode</div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Select Application Profile</label>
                                <select id="qos-mode-select" class="login-input" style="margin:0; width:100%; max-width:400px;" onchange="updateQoSDescription()">
                                    <option value="gaming">Gaming / Low-Latency Focused</option>
                                    <option value="family">Family / Household Management</option>
                                    <option value="enterprise">Enterprise / Business Critical</option>
                                    <option value="green">Green / Sustainable Angle</option>
                                </select>
                            </div>
                            
                            <div id="qos-mode-desc" style="background:var(--bg-body); padding:15px; border-radius:8px; border-left:4px solid var(--primary); margin-bottom:20px;">
                                <!-- Populated via JS -->
                            </div>

                            <!-- Green Stats (Visible only in Green Mode) -->
                            <div id="green-stats" style="display:none; margin-bottom: 20px;">
                                <div class="grid-4">
                                    <div class="card" style="text-align: center; padding: 15px;">
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Power Saved</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">12%</div>
                                    </div>
                                    <div class="card" style="text-align: center; padding: 15px;">
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Carbon Offset</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">0.4 kg</div>
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; justify-content:flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="saveQoSMode()">Apply Mode</button>
                                <!-- Rage Mode Button (Visible only in Gaming Mode) -->
                                <button id="rage-btn" class="btn btn-danger" style="display:none;" onclick="triggerRageMode()">
                                    <i class="fas fa-fire"></i> RAGE MODE (Boost 30s)
                                </button>
                            </div>
                        </div>
                    </div>




                </div>

                <!-- VIEW: AdBlocker / Firewall -->
                <div id="view-firewall" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">AdBlocker & Firewall Rules</div>
                            <button class="btn btn-sm btn-primary" onclick="showAddRuleModal()">+ Add Rule</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="firewall-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                                <span>Port</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M16.01 11H4v2h12.01v3L20 12l-3.99-4zM8 8h12V6H8V3L4 7l4 4z"/></svg>
                                                <span>Protocol</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                                                <span>Comment</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                <span>Created At</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;justify-content:center;width:100%;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- VIEW: Portal Logs -->
                <div id="view-portal" class="view-section" style="display:none;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start;">
                        <!-- Portal Configuration Card -->
                        <div class="card" style="flex: 1; min-width: 250px; max-width: 600px;">
                            <div class="card-header">
                                <div class="card-title">Portal Configuration</div>
                            </div>
                            <form id="portal-config-form" onsubmit="savePortalConfig(event)">
                                <div style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                    <div style="grid-column: 1 / -1;">
                                        <label for="portal-theme-select" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Portal Theme</label>
                                        <select id="portal-theme-select" class="login-input" style="margin:0;" onchange="updatePortalPreview(this.value)">
                                            <option value="portal.html">Default (portal.html)</option>
                                        </select>
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">Select the active portal theme file from public directory (must start with 'portal' and end with '.html')</div>
                                    </div>
                                <div>
                                    <label for="portal-container-width" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Container Max Width (px)</label>
                                    <input type="number" id="portal-container-width" class="login-input" min="300" max="800" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-icon-size" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Icon Size (px)</label>
                                    <input type="number" id="portal-icon-size" class="login-input" min="20" max="100" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-status-container-size" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Status Icon Container Size (px)</label>
                                    <input type="number" id="portal-status-container-size" class="login-input" min="30" max="100" style="margin:0;" autocomplete="off">
                                </div>
                                <div>
                                    <label for="portal-banner-height" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Banner Height (px) - Set to 0 to hide</label>
                                    <input type="number" id="portal-banner-height" class="login-input" min="0" max="500" style="margin:0;" autocomplete="off">
                                </div>
                                <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-body); border-radius: 6px; border: 1px solid var(--border);">
                                        <div style="display:flex; align-items:center;">
                                            <span style="font-weight: 600; color: var(--text-main);">Hide Voucher Code Display</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="portal-hide-voucher-code">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; padding-left: 10px;">
                                        If enabled, the "CODE: XXXXXX" text will be hidden on the client portal.
                                    </div>
                                </div>

                                <!-- Ticker Settings -->
                                <div style="grid-column: 1 / -1; margin-top: 5px; border-top: 1px solid var(--border); padding-top: 10px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-body); border-radius: 6px; border: 1px solid var(--border);">
                                        <div style="display:flex; align-items:center;">
                                            <span style="font-weight: 600; color: var(--text-main);">Enable Scrolling Ticker</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="portal-ticker-enabled">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label for="portal-ticker-text" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Ticker Text</label>
                                        <input type="text" id="portal-ticker-text" class="login-input" placeholder="Thank you for choosing our piso wifi hotspot services!" style="margin:0;">
                                    </div>
                                </div>

                                <!-- Banner Mode Selection -->
                                <div style="grid-column: 1 / -1; margin-top: 10px;">
                                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Banner Mode</label>
                                    <div style="display:flex; gap:20px;">
                                        <div style="display:flex; align-items:center;">
                                            <input type="radio" id="mode-fixed" name="banner_mode" value="fixed" checked onchange="toggleBannerMode()">
                                            <label for="mode-fixed" style="margin-left:8px; cursor:pointer;">Fixed Banner</label>
                                        </div>
                                        <div style="display:flex; align-items:center;">
                                            <input type="radio" id="mode-slideshow" name="banner_mode" value="slideshow" onchange="toggleBannerMode()">
                                            <label for="mode-slideshow" style="margin-left:8px; cursor:pointer;">Slideshow</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- FIXED BANNER SETTINGS -->
                                <div id="fixed-banner-settings" style="grid-column: 1 / -1; display: contents;">
                                    <div style="grid-column: 1 / -1; margin-bottom: 10px;">
                                        <div style="display:flex; align-items:center; height:40px;">
                                            <input type="checkbox" id="portal-use-default-banner" style="margin-right:10px; transform:scale(1.2);" onchange="toggleBannerUpload()">
                                            <label for="portal-use-default-banner" style="font-weight:600; font-size:0.9rem; cursor:pointer;">Use Default Banner</label>
                                        </div>
                                        <div id="default-banner-selector" style="display:none; margin-top:10px;">
                                            <label for="portal-default-banner-file" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Select Default Banner</label>
                                            <select id="portal-default-banner-file" class="login-input" style="margin:0;">
                                                <option value="op-banner.png">Default Banner 1 (op-banner.png)</option>
                                                <option value="op-banner1.png">Default Banner 2 (op-banner1.png)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="grid-column: 1 / -1;" id="banner-upload-section">
                                        <label for="portal-banner-upload" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Banner Image (PNG/JPG)</label>
                                        <input type="file" id="portal-banner-upload" accept="image/png, image/jpeg" style="margin:0 0 10px 0;">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="uploadPortalBanner()">Upload Banner</button>
                                    </div>
                                </div>

                                <!-- SLIDESHOW SETTINGS -->
                                <div id="slideshow-settings" style="grid-column: 1 / -1; display:none; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 10px;">
                                    <div class="form-group">
                                        <label>Slide Interval (ms)</label>
                                        <input type="number" id="portal-slideshow-interval" class="login-input" value="3000">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="font-weight:600; font-size:0.9rem;">Current Slides</label>
                                        <div id="slideshow-list" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; min-height: 50px; background: var(--bg-body); padding: 10px; border-radius: 4px;">
                                            <!-- Slides populated via JS -->
                                        </div>
                                    </div>

                                    <div>
                                        <label style="font-weight:600; font-size:0.9rem;">Add New Slide</label>
                                        <input type="file" id="portal-slideshow-upload" accept="image/png, image/jpeg" style="margin:0 0 10px 0;">
                                        <button type="button" class="btn btn-sm btn-success" onclick="uploadSlideshowImage()">Add Slide</button>
                                    </div>
                                </div>

                                <!-- Footer Settings -->
                                <div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                                    <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: var(--text-main);">Footer Configuration</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        <div>
                                            <label for="portal-footer-text" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Footer Text</label>
                                            <input type="text" id="portal-footer-text" class="login-input" placeholder="e.g. Powered by MyISP (Empty = Default)" style="margin:0;">
                                        </div>
                                        <div>
                                            <label for="portal-footer-link" style="display:block; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Footer Link (URL)</label>
                                            <input type="text" id="portal-footer-link" class="login-input" placeholder="e.g. https://myisp.com" style="margin:0;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 0 20px 20px 20px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Portal Changes</button>
                                <button type="button" class="btn btn-success" style="flex: 1;" onclick="openSaveTemplateModal()">Save as Template</button>
                                <button type="button" class="btn btn-info" style="flex: 1;" onclick="openLoadTemplateModal()">Load Template</button>
                            </div>
                        </form>
                    </div>

                    <!-- Portal Preview Card -->
                    <div class="card" style="flex: 1; min-width: 250px;">
                        <div class="card-header">
                            <div class="card-title">Portal Overview</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm btn-secondary" onclick="setPreviewMode('mobile')">ðŸ“± Mobile</button>
                                <button class="btn btn-sm btn-secondary" onclick="setPreviewMode('desktop')">ðŸ’» Desktop</button>
                            </div>
                        </div>
                        <div style="background: var(--bg-body); padding: 10px; border-radius: 8px; display: flex; justify-content: center; min-height: 600px; overflow: hidden;">
                            <iframe id="portal-preview-frame" src="portal.html" style="width: 100%; max-width: 375px; height: 667px; border: 4px solid var(--text-main); border-radius: 12px; background: var(--card-bg); transition: all 0.3s ease;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

                <!-- VIEW: System Logs -->
                <div id="view-syslogs" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Logs</div>
                            <div class="log-controls" style="display: flex; gap: 10px;">
                                <select id="log-category-filter" class="login-input" style="margin:0; width: auto;" onchange="loadLogs(this.value)">
                                    <option value="system">System</option>
                                    <option value="pppoe">PPPoE</option>
                                    <option value="hotspot">Hotspot</option>
                                    <option value="errors">Critical Errors</option>
                                </select>
                                <button class="btn btn-sm btn-primary" onclick="loadLogs(document.getElementById('log-category-filter').value)">Refresh</button>
                            </div>
                        </div>
                        <div class="log-container" style="padding: 0;">
                            <div style="background: var(--log-bg); color: var(--log-text); font-family: 'Courier New', monospace; padding: 15px; height: 500px; overflow-y: auto; font-size: 0.9rem;" id="log-display-area">
                                Loading logs...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Devices -->
                <div id="view-devices" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Connected Devices</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                    <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                        <option value="10">10</option>
                                        <option value="100">100</option>
                                        <option value="500">500</option>
                                        <option value="all">ALL</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="loadDevicesData()">Refresh</button>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table id="devices-table" class="sales-grid-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h3v2H7v-2z"/>
                                                </svg>
                                                <span>MAC Address</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h3v2H7V9zm0 4h5v2H7v-2z"/>
                                                </svg>
                                                <span>IP Address</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M4 6h16v12H4z" opacity="0.3" />
                                                    <path fill="currentColor" d="M2 6c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6zm2 0v12h16V6H4zM8 14h8v2H8v-2zm0-4h8v2H8v-2z" />
                                                </svg>
                                                <span>Device Name</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                </svg>
                                                <span>Status</span>
                                            </span>
                                        </th>
                                        <th>
                                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                </svg>
                                                <span>Action</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Chat -->
                <div id="view-chat" class="view-section" style="display:none;">
                    <div class="chat-container">
                        <!-- Sidebar: Conversations -->
                        <div class="chat-sidebar" id="chat-sidebar">
                            <!-- Chat Settings Block -->
                            <div style="padding: 15px; border-bottom: 1px solid var(--border); background: var(--card-bg);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">Client Chat</span>
                                    <label class="switch" style="transform: scale(0.8); margin: 0;">
                                        <input type="checkbox" id="chat-enabled-toggle" onchange="saveChatSettings(event)">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                    Show widget on portal
                                </div>
                            </div>

                            <!-- Chat Type Selector -->
                            <div style="padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); display: flex; gap: 10px;">
                                <button onclick="setChatType('hotspot')" id="chat-type-hotspot" class="btn btn-sm btn-primary" style="flex:1;">Hotspot</button>
                                <button onclick="setChatType('pppoe')" id="chat-type-pppoe" class="btn btn-sm btn-outline-primary" style="flex:1;">PPPoE</button>
                            </div>

                            <div class="chat-header" style="background: var(--bg-body); display: flex; justify-content: space-between; align-items: center;">
                                Conversations
                                <button onclick="toggleChatSidebar()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); display: none;" class="mobile-only-block" title="Hide List">
                                    <svg style="width:20px; height:20px;" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                                </button>
                            </div>
                            <div class="chat-list" id="chat-list">
                                <!-- Chat items will be loaded here -->
                                <div style="padding:20px; text-align:center; color:var(--text-muted);">Loading...</div>
                            </div>
                        </div>

                        <!-- Main: Chat Window -->
                        <div class="chat-main">
                    <div class="chat-header" style="display: flex; align-items: center;">
                        <button id="chat-toggle-list-btn" onclick="toggleChatSidebar()" style="display:none; background:none; border:none; margin-right:10px; cursor:pointer;">
                            <svg style="width:24px; height:24px; fill:var(--text-main);" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        <span id="chat-current-user">Select a conversation</span>
                        <div class="status-indicator" id="chat-status-indicator" style="margin-left:auto; display:none;">
                            <span class="status-dot"></span>
                            <span class="status-text">Connected</span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." disabled>
                        <button class="chat-send-btn" id="chat-send-btn" onclick="sendAdminMessage()" disabled>Send</button>
                    </div>
                </div>
                    </div>
                </div>

                <!-- VIEW: Settings -->
                <div id="view-settings" class="view-section" style="display:none;">
                    <div class="settings-wrapper">
                        
                        <!-- General Settings Group -->
                        <div class="card" style="height: 100%;">
                            <div class="card-header">
                                <div class="card-title" style="text-transform: uppercase; color: var(--text-muted); font-size: 0.85rem; font-weight: 700;">General Settings</div>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <!-- Vendo Settings Item -->
                                <div onclick="document.getElementById('vendo-settings-modal').style.display='flex'" class="settings-item">
                                    <span style="font-weight: 500; color: var(--text-main);">Vendo Settings</span>
                                    <svg style="width: 20px; height: 20px; fill: var(--text-muted);" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Security Configuration Item -->
                                <div onclick="document.getElementById('security-config-modal').style.display='flex'; loadSecurityCredentials();" class="settings-item">
                                    <span style="font-weight: 500; color: var(--text-main);">Security Configuration</span>
                                    <svg style="width: 20px; height: 20px; fill: var(--text-muted);" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Time & NTP Settings Item -->
                                <div onclick="document.getElementById('time-settings-modal').style.display='flex'" class="settings-item">
                                    <span style="font-weight: 500; color: var(--text-main);">Time & NTP Settings</span>
                                    <svg style="width: 20px; height: 20px; fill: var(--text-muted);" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Company Settings Item -->
                                <div onclick="openCompanySettingsModal()" class="settings-item">
                                    <span style="font-weight: 500; color: var(--text-main);">Company Settings</span>
                                    <svg style="width: 20px; height: 20px; fill: var(--text-muted);" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>

                                <!-- Point Configurations Item -->
                                <div onclick="document.getElementById('point-rates-list-modal').style.display='flex'; loadPointRatesData(); loadPointsEarningRate();" class="settings-item">
                                    <span style="font-weight: 500; color: var(--text-main);">Point Configurations</span>
                                    <svg style="width: 20px; height: 20px; fill: var(--text-muted);" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                                </div>
                            </div>
                        </div>

                        <!-- System Maintenance -->
                        <div class="card" style="height: 100%;">
                            <div class="card-header">
                                <div class="card-title" style="text-transform: uppercase; color: var(--text-muted); font-size: 0.85rem; font-weight: 700;">System Maintenance</div>
                            </div>
                            <div class="system-maintenance-grid">
                                <button onclick="rebootSystem()" class="btn sys-maint-btn" style="background:var(--warning);">
                                    <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                                    <span>Reboot</span>
                                </button>

                                <input type="file" id="update-file-input" accept=".tar.gz" style="display:none;" onchange="uploadUpdatePackage()">
                                <button onclick="document.getElementById('update-file-input').click()" class="btn sys-maint-btn" style="background: var(--info);">
                                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                                    <span>Upload Update</span>
                                </button>
                                
                                <button onclick="createUpdatePackage()" class="btn sys-maint-btn" style="background:var(--gauge-6);">
                                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                                    <span>Create Update</span>
                                </button>

                                 <button onclick="upgradeSystem('online')" class="btn sys-maint-btn" style="background:var(--gauge-3);">
                                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                                    <span>Upgrade</span>
                                </button>

                                <button onclick="downloadBackup()" class="btn sys-maint-btn" style="background: var(--info);">
                                    <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm7-18l-5 5h3v6h4v-6h3l-5-5z"/></svg>
                                    <span>Backup</span>
                                </button>

                                <button onclick="restoreFromBackup()" class="btn sys-maint-btn" style="background:var(--gauge-3);">
                                    <svg viewBox="0 0 24 24"><path d="M12 5l-5 5h3v4h4v-4h3l-5-5zM5 18h14v2H5z"/></svg>
                                    <span>Restore</span>
                                </button>

                                <button onclick="factoryReset()" class="btn sys-maint-btn" style="background: var(--status-expired);">
                                    <svg viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>
                                    <span>Reset</span>
                                </button>

                                <button onclick="verifyConfiguration()" class="btn sys-maint-btn" style="background: var(--status-active);">
                                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    <span>Verify</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- VIEW: License -->
                <div id="view-license" class="view-section" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System License</div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="font-family: monospace; line-height: 1.8; color: var(--text-main); font-size: 1rem;">
                                <div><strong>Status:</strong> <span id="lic-status" style="font-weight:bold;">Loading...</span></div>
                                <div><strong>HWID:</strong> <span id="lic-hwid">Loading...</span></div>
                                <div><strong>Device Model:</strong> <span id="lic-model">Loading...</span></div>
                                <div><strong>Key:</strong> <span id="lic-key" style="font-weight:bold; color:var(--primary);">---</span></div>
                                <div><strong>Activated:</strong> <span id="lic-activated">---</span></div>
                                <div><strong>Expiration:</strong> <span id="lic-expiration">---</span></div>
                            </div>

                            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

                            <h3 style="font-size: 1.1rem; margin-bottom: 15px;">Activate License</h3>
                            <div id="activation-form" style="display: flex; gap: 10px; max-width: 500px;">
                                <input type="text" id="license-key-input" class="form-control" placeholder="Enter License Key (NEO-XXXX-XXXX-XXXX)">
                                <button onclick="activateLicense()" class="btn btn-primary">Activate</button>
                            </div>
                            <p style="font-size: 0.8rem; color:var(--text-muted); margin-top: 10px;">
                                Need a license? Contact <a href="https://neofisystem.com" target="_blank">NeoFi System</a> support.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Sub Vendo -->
                <div id="view-subvendo" class="view-section" style="display:none;">
                    <div class="grid-subvendo">
                        <!-- Left Column -->
                        <div>
                            <!-- Sub Vendo Config -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Sub Vendo Configuration</div>
                                </div>
                                <div style="padding: 15px;">
                                    <div class="form-group">
                                        <label for="subvendo-key" style="display:block; font-weight:600; margin-bottom:6px;">Sub Vendo Key</label>
                                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                            <input type="text" id="subvendo-key" class="login-input" style="margin:0; flex:1 1 240px;" placeholder="Enter secure key">
                                            <button class="btn btn-primary" onclick="saveSubVendoKey()">Save</button>
                                        </div>
                                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:6px;">
                                            Used to authenticate ESP8266 devices.
                                        </div>
                                    </div>
                                    <!-- Main Vendo Free Time Modal (Moved to bottom) -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Waiting List -->
                            <div class="card" id="subvendo-waiting-card">
                                <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                                    <div class="card-title">Waiting List <span id="waiting-count" class="badge bg-danger" style="margin-left:5px; font-size:0.7em; display:none;">0</span></div>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <div style="display:flex; align-items:center; gap:5px;">
                                            <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                            <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                                <option value="10">10</option>
                                                <option value="100">100</option>
                                                <option value="500">500</option>
                                                <option value="all">ALL</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-sm btn-primary" onclick="loadSubVendoWaitingList()">Refresh</button>
                                    </div>
                                </div>
                                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                    <table id="subvendo-waiting-table" class="sales-grid-table">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2 9h20v6H2V9zm2 2v2h16v-2H4zm-2 6h20v2H2v-2zM2 5h20v2H2V5z"/></svg>
                                                        <span>MAC Address</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>
                                                        <span>IP Address</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 5h16v14H4V5zm2 2v10h12V7H6zm2 2h8v2H8V9z"/></svg>
                                                        <span>Name</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                        <span>Created At</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;justify-content:center;width:100%;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                        <span>Action</span>
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td colspan="5" style="text-align:center;">No pending devices</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Registered Devices -->
                            <div class="card" style="margin-top: 25px;">
                                <div class="card-header">
                                    <div class="card-title">Registered Devices</div>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <div style="display:flex; align-items:center; gap:5px;">
                                            <span style="font-size:0.8rem; color:var(--text-muted);">Show:</span>
                                            <select onchange="setTableLimit(this)" style="border-radius:4px; padding:2px 6px; font-size:0.75rem;">
                                                <option value="10">10</option>
                                                <option value="100">100</option>
                                                <option value="500">500</option>
                                                <option value="all">ALL</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-sm btn-primary" onclick="loadSubVendoDevices()">Refresh</button>
                                    </div>
                                </div>
                                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                                    <table id="subvendo-devices-table" class="sales-grid-table">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path fill="currentColor" d="M4 5h16v11H4V5zm2 2v7h12V7H6zm-1 11h14v2H5v-2z"/>
                                                        </svg>
                                                        <span>Name</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path fill="currentColor" d="M3 5v14h18V5H3zm16 12H5V7h14v10zM7 9h5v2H7V9zm0 4h3v2H7v-2z"/>
                                                        </svg>
                                                        <span>Device ID</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path fill="currentColor" d="M12 2A10 10 0 1 0 22 12A10.011 10.011 0 0 0 12 2zm-1 15l-5-5l1.41-1.41L11 14.17l5.59-5.58L18 10z"/>
                                                        </svg>
                                                        <span>Status</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path fill="currentColor" d="M12 1a9 9 0 1 0 9 9a9 9 0 0 0-9-9zm0 16a7 7 0 1 1 7-7a7 7 0 0 1-7 7zm-.5-11h1.5v4.25l3.5 2.08-.75 1.23L11.5 11z"/>
                                                        </svg>
                                                        <span>Last Active</span>
                                                    </span>
                                                </th>
                                                <th>
                                                    <span style="display:inline-flex;align-items:center;gap:6px;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15 3.59l3.75 3.75l1.96-2.3z"/>
                                                        </svg>
                                                        <span>Action</span>
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="subvendo-devices-list" class="device-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    <!-- Vendo Settings Modal -->
    <div id="vendo-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:600px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Vendo Settings</span>
                <button onclick="document.getElementById('vendo-settings-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form onsubmit="saveSettings(event); document.getElementById('vendo-settings-modal').style.display='none';">
                    <div id="settings-container" class="settings-grid"></div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button type="submit" class="btn" style="background:var(--success); color:white;">Save Vendo Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div id="company-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Company Settings</span>
                <button onclick="document.getElementById('company-settings-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form id="company-settings-form" onsubmit="saveCompanySettings(event)">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Company Name</label>
                        <input type="text" name="company_name" class="login-input" style="width:100%; margin:0;" required>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Contact Number</label>
                        <input type="text" name="company_contact" class="login-input" style="width:100%; margin:0;" required>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Email Address</label>
                        <input type="email" name="company_email" class="login-input" style="width:100%; margin:0;" required>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Company Logo</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img id="company-logo-preview" src="" alt="Preview" style="height:50px; width:auto; border:1px solid var(--border); padding:2px; display:none;">
                            <input type="file" id="company-logo-input" accept="image/*" onchange="previewCompanyLogo(this)">
                        </div>
                        <small style="color:var(--text-muted);">Max size: 500KB. Recommended height: 50px.</small>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="submit" class="btn" style="background:var(--success); color:white;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Security Config Modal -->
    <div id="security-config-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Security Configuration</span>
                <button onclick="document.getElementById('security-config-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form id="security-form" onsubmit="updateCredentials(event); document.getElementById('security-config-modal').style.display='none';">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-username" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Admin Username</label>
                        <input type="text" id="admin-username" class="login-input" style="margin:0; padding: 3px 8px;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-password" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">New Password</label>
                        <div style="display:flex; align-items:center;">
                            <input type="password" id="admin-password" class="login-input" style="margin:0; padding: 3px 8px; flex:1;" required>
                            <button type="button" id="btn-eye-1" onclick="togglePasswordVisibility('admin-password', 'btn-eye-1')" style="background:none; border:none; padding:0 8px; cursor:pointer; color:var(--text-muted);">
                                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                        </div>
                    </div>
                     <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-confirm-password" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Confirm Password</label>
                        <div style="display:flex; align-items:center;">
                            <input type="password" id="admin-confirm-password" class="login-input" style="margin:0; padding: 3px 8px; flex:1;" required>
                            <button type="button" id="btn-eye-2" onclick="togglePasswordVisibility('admin-confirm-password', 'btn-eye-2')" style="background:none; border:none; padding:0 8px; cursor:pointer; color:var(--text-muted);">
                                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-security-question" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Security Question</label>
                        <select id="admin-security-question" class="login-input" style="margin:0; padding: 3px 8px;">
                            <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                            <option value="What is the name of your first pet?">What is the name of your first pet?</option>
                            <option value="What is your favorite movie?">What is your favorite movie?</option>
                            <option value="What is your favorite book?">What is your favorite book?</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="admin-security-answer" style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1;">Security Answer</label>
                        <input type="text" id="admin-security-answer" class="login-input" style="margin:0; padding: 3px 8px;" placeholder="Answer for recovery">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Credentials</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Time Settings Modal -->
    <div id="time-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Time & NTP Settings</span>
                <button onclick="document.getElementById('time-settings-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <form onsubmit="saveTimeSettings(event); document.getElementById('time-settings-modal').style.display='none';">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Time Synchronization</label>
                        <select id="time-sync-mode" class="login-input" style="margin:0;" onchange="toggleTimeInputs()">
                            <option value="auto">Automatic (NTP)</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div id="ntp-server-group" class="form-group" style="margin-bottom: 15px;">
                        <div style="display:grid; grid-template-columns: 1fr; gap: 10px;">
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:5px; color:var(--success);">Server 1:</label>
                                <input type="text" id="ntp-server-1" class="login-input" style="margin:0;" placeholder="132.163.97.3">
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:5px; color:var(--success);">Server 2:</label>
                                <input type="text" id="ntp-server-2" class="login-input" style="margin:0;" placeholder="202.90.132.242">
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:5px; color:var(--success);">Server 3:</label>
                                <input type="text" id="ntp-server-3" class="login-input" style="margin:0;" placeholder="">
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:5px; color:var(--success);">Server 4:</label>
                                <input type="text" id="ntp-server-4" class="login-input" style="margin:0;" placeholder="">
                            </div>
                        </div>
                    </div>
                    <div id="manual-time-group" class="form-group" style="margin-bottom: 15px; display:none;">
                        <label for="manual-datetime" style="display:block; font-weight:600; margin-bottom:5px;">Set Time & Date</label>
                        <input type="datetime-local" id="manual-datetime" class="login-input" style="margin:0;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Timezone Mode</label>
                        <select id="timezone-mode" class="login-input" style="margin:0;" onchange="toggleTimeInputs()">
                            <option value="auto">Automatic (Default)</option>
                            <option value="manual">Manual Selection</option>
                        </select>
                    </div>
                    <div id="timezone-select-group" class="form-group" style="margin-bottom: 15px; display:none;">
                        <label for="timezone-select" style="display:block; font-weight:600; margin-bottom:5px;">Select Timezone</label>
                        <select id="timezone-select" class="login-input" style="margin:0;">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                            Current System Time: <span id="current-system-time" style="font-weight: 600;">Loading...</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Time Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="subvendo-device-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:520px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10;">
                Sub Vendo Device Settings
            </div>
            <div id="subvendo-device-form" class="subvendo-form-grid">
                <div class="form-col-span-2">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Name</label>
                    <input type="text" id="subvendo-device-name" class="login-input" style="margin:0;" autocomplete="off">
                </div>
                <div class="form-col-span-2">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Description</label>
                    <textarea id="subvendo-device-description" class="login-input" style="margin:0; min-height:80px; resize:vertical;" autocomplete="off"></textarea>
                </div>
                
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Download</label>
                    <input type="number" id="subvendo-device-download" class="login-input" style="margin:0;" placeholder="Default (Mbps)" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Upload</label>
                    <input type="number" id="subvendo-device-upload" class="login-input" style="margin:0;" placeholder="Default (Mbps)" autocomplete="off">
                </div>

                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Coin Acceptor</label>
                    <input type="number" id="subvendo-device-coin-pin" class="login-input" style="margin:0;" min="0" max="16" step="1" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Relay Pin</label>
                    <input type="number" id="subvendo-device-relay-pin" class="login-input" style="margin:0;" min="0" max="16" step="1" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Relay Active State</label>
                    <select id="subvendo-device-relay-active-state" class="login-input" style="margin:0;">
                        <option value="HIGH">Active HIGH</option>
                        <option value="LOW">Active LOW</option>
                    </select>
                </div>

                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Rate/Pulse</label>
                    <input type="number" id="subvendo-device-rate" class="login-input" style="margin:0;" min="1" max="100" step="1" autocomplete="off">
                </div>

                <div class="form-col-span-2" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Free Time To Give</label>
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <div style="display:flex; align-items:center; gap:4px;">
                            <input type="number" id="subvendo-device-free-h" class="login-input" style="margin:0; width:80px;" min="0" autocomplete="off">
                            <span style="font-size:0.8rem;">h</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <input type="number" id="subvendo-device-free-m" class="login-input" style="margin:0; width:80px;" min="0" max="59" autocomplete="off">
                            <span style="font-size:0.8rem;">m</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <input type="number" id="subvendo-device-free-s" class="login-input" style="margin:0; width:80px;" min="0" max="59" autocomplete="off">
                            <span style="font-size:0.8rem;">s</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Reclaim After (Days)</label>
                    <input type="number" id="subvendo-device-free-reclaim" class="login-input" style="margin:0;" min="0" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">VLAN Interface</label>
                    <input type="text" id="subvendo-device-free-vlan" class="login-input" style="margin:0;" placeholder="e.g. eth0.10" autocomplete="off">
                </div>

                <div class="form-col-span-2" style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:600; font-size:0.85rem;">Enable Free Time</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Include this device in Free Time list.</div>
                        </div>
                        <div class="form-check form-switch" style="margin:0;">
                            <input class="form-check-input" type="checkbox" id="subvendo-device-free-enabled">
                        </div>
                    </div>
                </div>

                <div class="form-col-span-2" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.85rem;">Rates Visibility</label>
                    <div id="subvendo-device-rates" style="display:grid; grid-template-columns: 1fr; gap:8px;"></div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="closeSubVendoDeviceSettings()">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveSubVendoDeviceSettings()">Save</button>
            </div>
        </div>
    </div>



    <!-- VLAN Modal -->
    <div id="vlan-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div id="vlan-modal-title" style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10;">
                New VLAN
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label for="vlan-name" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Name (Optional)</label>
                    <input type="text" id="vlan-name" class="login-input" placeholder="e.g. Guest Network" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="vlan-parent" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Parent Interface</label>
                    <select id="vlan-parent" class="login-input" style="margin:0;">
                        <!-- Populated via JS -->
                    </select>
                </div>
                <div>
                    <label for="vlan-id" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">VLAN ID</label>
                    <input type="text" id="vlan-id" class="login-input" placeholder="10 or 30-50" style="margin:0;" autocomplete="off" oninput="handleVlanIdInput(this)">
                </div>
                
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">MAC Address</label>
                    <div style="margin-bottom:8px;">
                         <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vlan-auto-mac" checked onchange="toggleVlanMacInput()">
                            <label class="form-check-label" for="vlan-auto-mac">
                                Auto Generate MAC Address
                            </label>
                        </div>
                    </div>
                    <input type="text" id="vlan-mac" class="login-input" placeholder="00:11:22:33:44:55" style="margin:0;" disabled autocomplete="off">
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Locally administered MAC will be generated if checked.</div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('vlan-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveVlan()">Create VLAN</button>
            </div>
        </div>
    </div>

    <!-- DHCP Modal -->
    <div id="dhcp-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:600px; color:var(--text-main); border-radius:8px; display:flex; flex-direction:column; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem;">New DHCP</div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                 <div style="background:var(--bg-body); padding:10px; border-radius:4px; border:1px solid var(--border);">
                     <label style="display:block; margin-bottom:5px; font-weight:600;">Global Bitmask Setting</label>
                     <div style="display:flex; gap:10px; align-items: center;">
                         <input type="number" id="dhcp-bitmask" class="login-input" style="width:100px; margin:0;" value="19" placeholder="e.g. 19">
                         <button class="btn btn-sm btn-primary" onclick="saveDhcpSettings()">Save Bitmask</button>
                     </div>
                     <div style="font-size: 0.8rem; color:var(--text-muted); margin-top:5px;">Controls subnet size (e.g. /19 = 8192 IPs, /24 = 254 IPs). <strong>Save before adding.</strong></div>
                 </div>

                 <div>
                     <label style="display:block; margin-bottom:5px; font-weight:600;">Interface</label>
                     <select id="dhcp-interface-select" class="login-input" style="width:100%; margin:0;">
                         <!-- Populate -->
                     </select>
                 </div>
                 <div style="display:flex; gap:10px;">
                     <div style="flex-grow:1;">
                         <label style="display:block; margin-bottom:5px; font-weight:600;">DNS1</label>
                         <input type="text" id="dhcp-dns1" class="login-input" style="width:100%; margin:0;" value="8.8.8.8">
                     </div>
                     <div style="flex-grow:1;">
                         <label style="display:block; margin-bottom:5px; font-weight:600;">DNS2</label>
                         <input type="text" id="dhcp-dns2" class="login-input" style="width:100%; margin:0;" value="8.8.4.4">
                     </div>
                 </div>
                 
                 <!-- Info Block -->
                 <div id="dhcp-calc-info" style="background:var(--bg-body); padding:15px; border-radius:4px; font-family:monospace; font-size:0.9rem; line-height:1.6; border:1px solid var(--border);">
                     Loading next available slot...
                 </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('dhcp-modal').style.display = 'none'">Close</button>
                <button class="btn btn-sm btn-success" onclick="addDhcpServer()">Save</button>
            </div>
        </div>
    </div>

    <!-- Bridge Modal -->
    <div id="bridge-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div id="bridge-modal-title" style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10;">
                New Bridge
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label for="bridge-name" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Bridge Name</label>
                    <input type="text" id="bridge-name" class="login-input" placeholder="br0" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="bridge-ip" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">IP Address</label>
                    <input type="text" id="bridge-ip" class="login-input" placeholder="192.168.1.1" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label for="bridge-netmask" style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Netmask</label>
                    <input type="text" id="bridge-netmask" class="login-input" placeholder="255.255.255.0" style="margin:0;" autocomplete="off">
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">STP</label>
                    <div style="display:flex; align-items:center; height:40px;">
                        <input type="checkbox" id="bridge-stp" style="margin-right:10px; transform:scale(1.2);">
                        <label for="bridge-stp">Enable Spanning Tree Protocol</label>
                    </div>
                </div>
                <div style="grid-column: span 2;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Member Interfaces</label>
                    <div id="bridge-interfaces" style="display:flex; flex-wrap:wrap; gap:15px; background:var(--bg-body); padding:10px; border:1px solid var(--border); border-radius:4px;">
                        <!-- Checkboxes populated via JS -->
                    </div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('bridge-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveBridge()">Create/Update Bridge</button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verify-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:600px; max-height:90vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>System Configuration Check</span>
                <button onclick="document.getElementById('verify-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div id="verify-results" style="padding:20px;">
                <!-- Results populated here -->
                <div style="text-align:center; color:var(--text-muted);">Running checks...</div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('verify-modal').style.display = 'none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Point Rates List Modal -->
    <div id="point-rates-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:800px; max-height:90vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span>Point Configurations</span>
                <button onclick="document.getElementById('point-rates-list-modal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:20px;">
                <!-- Earning Config -->
                <div style="margin-bottom:20px; padding:15px; background:var(--input-bg); border:1px solid var(--border); border-radius:4px;">
                    <div style="font-weight:600; margin-bottom:10px;">Earning Configuration</div>
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
                        <label style="margin:0;">Earn</label>
                        <input type="number" id="points-earning-rate" class="login-input" style="width:80px; margin:0;" step="0.1" min="0" placeholder="0">
                        <label style="margin:0;">Points per 1.0 Amount (e.g. 1 Peso)</label>
                        <button class="btn btn-sm btn-success" onclick="savePointsEarningRate()">Save Earning Rate</button>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Set to 0 to disable points earning. Example: 1.0 means 1 Point per 1 Peso.</div>
                </div>

                <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:600;">Redemption Rates</div>
                    <button class="btn btn-sm btn-primary" onclick="openPointRateModal()">Add New Rate</button>
                </div>
                <div class="table-container">
                    <table id="point-rates-table" class="sales-grid-table">
                        <thead>
                            <tr>
                                <th>Points Cost</th>
                                <th>Duration</th>
                                <th>Bandwidth (Up/Down)</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('point-rates-list-modal').style.display = 'none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Point Rate Edit/Add Modal -->
    <div id="point-rate-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1050; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:500px; max-height:95vh; overflow-y:auto; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div id="point-rate-modal-title" style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg); position:sticky; top:0; z-index:10;">
                New Point Rate
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="hidden" id="point-rate-id">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Points Cost</label>
                    <input type="number" id="point-rate-points" class="login-input" placeholder="e.g. 100" style="margin:0;" min="1">
                </div>
                
                <div style="display:flex; gap:10px;">
                     <div style="flex:1;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Duration</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div style="flex:1;">
                                <input type="number" id="point-rate-h" class="login-input" placeholder="H" style="margin:0; text-align:center;" min="0">
                                <small style="display:block; text-align:center; color:var(--text-muted); font-size:0.75rem;">Hours</small>
                            </div>
                            <span style="font-weight:bold;">:</span>
                            <div style="flex:1;">
                                <input type="number" id="point-rate-m" class="login-input" placeholder="M" style="margin:0; text-align:center;" min="0" max="59">
                                <small style="display:block; text-align:center; color:var(--text-muted); font-size:0.75rem;">Mins</small>
                            </div>
                            <span style="font-weight:bold;">:</span>
                            <div style="flex:1;">
                                <input type="number" id="point-rate-s" class="login-input" placeholder="S" style="margin:0; text-align:center;" min="0" max="59">
                                <small style="display:block; text-align:center; color:var(--text-muted); font-size:0.75rem;">Secs</small>
                            </div>
                        </div>
                     </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Download (Mbps)</label>
                        <input type="number" id="point-rate-down" class="login-input" placeholder="5" style="margin:0;" min="0.1" step="0.1">
                    </div>
                    <div style="flex:1;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Upload (Mbps)</label>
                        <input type="number" id="point-rate-up" class="login-input" placeholder="5" style="margin:0;" min="0.1" step="0.1">
                    </div>
                </div>

                <div>
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Type</label>
                    <select id="point-rate-type" class="login-input" style="margin:0;">
                        <option value="1">Pausable (Flex)</option>
                        <option value="0">Continuous</option>
                    </select>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--card-bg); position:sticky; bottom:0; z-index:10;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('point-rate-modal').style.display = 'none'">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="savePointRate()">Save Rate</button>
            </div>
        </div>
    </div>

    <script>
        // --- Init Charts ---
        let bwChart, cpuDoughnut;
        
        // --- Global Interval Manager ---
        const IntervalManager = {
            intervals: {},
            start: function(name, callback, delay) {
                // Ensure we don't start duplicate intervals for the same name
                if (this.intervals[name]) clearInterval(this.intervals[name]);
                this.intervals[name] = setInterval(callback, delay);
            },
            stop: function(name) {
                if (this.intervals[name]) {
                    clearInterval(this.intervals[name]);
                    delete this.intervals[name];
                }
            },
            stopAll: function() {
                for (const name in this.intervals) {
                    clearInterval(this.intervals[name]);
                }
                this.intervals = {};
            }
        };

        let visualInterfaceMap = {}; // Map real interface names to visual names (e.g. end0 -> eth0)
        let chartsEnabled = false;
        let topVendoPeriod = 'monthly';
        let topClientsPeriod = 'monthly';

        // --- Theme Helpers ---
        function getVar(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        function updateChartTheme() {
            if (!chartsEnabled) return;
            
            const gridColor = getVar('--chart-grid');
            const textColor = getVar('--chart-text');
            const tooltipBg = getVar('--chart-tooltip-bg');
            const tooltipText = getVar('--chart-tooltip-text');
            const tooltipBorder = getVar('--chart-tooltip-border');

            // Refresh gauge colors from CSS variables
            gaugeColors = [
                getVar('--gauge-1') || '#00cec9',
                getVar('--gauge-2') || '#0984e3',
                getVar('--gauge-3') || '#6c5ce7',
                getVar('--gauge-4') || '#fdcb6e',
                getVar('--gauge-5') || '#e17055',
                getVar('--gauge-6') || '#00b894',
                getVar('--gauge-7') || '#e84393',
                getVar('--gauge-8') || '#636e72'
            ];

            // Update Bandwidth Chart
            if (bwChart) {
                const dlColor = getVar('--chart-dl');
                const ulColor = getVar('--chart-ul');
                
                // Re-create gradients
                const ctxBw = document.getElementById('bandwidthChart').getContext('2d');
                const dlFill = ctxBw.createLinearGradient(0, 0, 0, 300);
                dlFill.addColorStop(0, getVar('--chart-dl-bg')); 
                dlFill.addColorStop(1, 'rgba(0,0,0,0)');

                const ulFill = ctxBw.createLinearGradient(0, 0, 0, 300);
                ulFill.addColorStop(0, getVar('--chart-ul-bg')); 
                ulFill.addColorStop(1, 'rgba(0,0,0,0)');

                bwChart.data.datasets[0].borderColor = dlColor;
                bwChart.data.datasets[0].backgroundColor = dlFill;
                bwChart.data.datasets[1].borderColor = ulColor;
                bwChart.data.datasets[1].backgroundColor = ulFill;
                
                bwChart.options.scales.y.grid.color = gridColor;
                bwChart.options.scales.y.ticks.color = textColor;
                
                bwChart.options.plugins.tooltip.backgroundColor = tooltipBg;
                bwChart.options.plugins.tooltip.titleColor = tooltipText;
                bwChart.options.plugins.tooltip.bodyColor = tooltipText;
                bwChart.options.plugins.tooltip.borderColor = tooltipBorder;
                
                bwChart.update();
            }

            // Update CPU Chart
            if (cpuDoughnut) {
                cpuDoughnut.options.scales.x.grid.color = gridColor;
                cpuDoughnut.options.scales.x.ticks.color = textColor;
                cpuDoughnut.options.scales.y.ticks.color = textColor;
                
                // Apply tooltip styles to CPU chart as well for consistency
                if (!cpuDoughnut.options.plugins.tooltip) cpuDoughnut.options.plugins.tooltip = {};
                cpuDoughnut.options.plugins.tooltip.backgroundColor = tooltipBg;
                cpuDoughnut.options.plugins.tooltip.titleColor = tooltipText;
                cpuDoughnut.options.plugins.tooltip.bodyColor = tooltipText;
                cpuDoughnut.options.plugins.tooltip.borderColor = tooltipBorder;
                cpuDoughnut.options.plugins.tooltip.borderWidth = 1;
                
                cpuDoughnut.update();
            }
        }

        // Unique colors for each core
        let gaugeColors = [
            getVar('--gauge-1') || '#00cec9',
            getVar('--gauge-2') || '#0984e3',
            getVar('--gauge-3') || '#6c5ce7',
            getVar('--gauge-4') || '#fdcb6e',
            getVar('--gauge-5') || '#e17055',
            getVar('--gauge-6') || '#00b894',
            getVar('--gauge-7') || '#e84393',
            getVar('--gauge-8') || '#636e72'
        ];

        function updateCpuChart(cores) {
            if (!cpuDoughnut) return;
            if (!Array.isArray(cores) || cores.length === 0) return;

            const avg = cores.reduce((a, b) => a + b, 0) / cores.length;

            const labels = ['AVG', ...cores.map((_, i) => `CPU ${i + 1}`)];
            const data = [avg, ...cores].map(v => {
                const n = Number(v) || 0;
                return Math.max(0, Math.min(100, n));
            });
            const colors = [gaugeColors[0], ...cores.map((_, i) => gaugeColors[(i + 1) % gaugeColors.length])];

            cpuDoughnut.data.labels = labels;

            if (!cpuDoughnut.data.datasets || cpuDoughnut.data.datasets.length === 0) {
                cpuDoughnut.data.datasets = [{
                    label: 'CPU Usage',
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    borderRadius: 4,
                    maxBarThickness: 18
                }];
            } else {
                cpuDoughnut.data.datasets[0].data = data;
                cpuDoughnut.data.datasets[0].backgroundColor = colors;
            }

            cpuDoughnut.update();
        }

        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js not loaded.");
                return;
            }
            chartsEnabled = true;

            // Bandwidth Chart
            const ctxBw = document.getElementById('bandwidthChart').getContext('2d');
            
            // Define Colors (Download = Green, Upload = Blue)
            const dlColor = getVar('--chart-dl');
            const ulColor = getVar('--chart-ul');

            // Gradient Fills
            const dlFill = ctxBw.createLinearGradient(0, 0, 0, 300);
            dlFill.addColorStop(0, getVar('--chart-dl-bg')); 
            dlFill.addColorStop(1, 'rgba(0,0,0,0)');

            const ulFill = ctxBw.createLinearGradient(0, 0, 0, 300);
            ulFill.addColorStop(0, getVar('--chart-ul-bg')); 
            ulFill.addColorStop(1, 'rgba(0,0,0,0)');

            bwChart = new Chart(ctxBw, {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [
                        { 
                            label: 'Download', 
                            data: Array(60).fill(0), 
                            borderColor: dlColor,
                            backgroundColor: dlFill,
                            fill: 'start',
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            order: 1
                        },
                        { 
                            label: 'Upload', 
                            data: Array(60).fill(0), 
                            borderColor: ulColor,
                            backgroundColor: ulFill,
                            fill: 'start',
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8,
                                font: { size: 11, family: "'Inter', sans-serif" }
                            }
                        },
                        tooltip: {
                            backgroundColor: getVar('--chart-tooltip-bg'),
                            titleColor: getVar('--chart-tooltip-text'),
                            bodyColor: getVar('--chart-tooltip-text'),
                            borderColor: getVar('--chart-tooltip-border'),
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 8,
                            titleFont: { weight: '600' },
                            callbacks: {
                                label: (ctx) => {
                                    const v = Number(ctx.parsed.y || 0);
                                    return `${ctx.dataset.label}: ${v.toFixed(2)} Mbps`;
                                }
                            }
                        }
                    },
                    scales: { 
                        x: { 
                            display: false,
                            grid: { display: false }
                        },
                        y: { 
                            beginAtZero: true,
                            grid: { 
                                color: getVar('--chart-grid'), 
                                borderDash: [4, 4],
                                drawBorder: false 
                            },
                            ticks: { 
                                color: getVar('--chart-text'),
                                font: { size: 10 },
                                callback: (value) => value + ' M'
                            }
                        } 
                    },
                    animation: false
                }
            });

            const ctxCpu = document.getElementById('cpuChart').getContext('2d');
            cpuDoughnut = new Chart(ctxCpu, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 0,
                        borderRadius: 4,
                        maxBarThickness: 18
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            backgroundColor: getVar('--chart-tooltip-bg'),
                            titleColor: getVar('--chart-tooltip-text'),
                            bodyColor: getVar('--chart-tooltip-text'),
                            borderColor: getVar('--chart-tooltip-border'),
                            borderWidth: 1,
                            callbacks: { 
                                label: function(ctx) {
                                    const value = typeof ctx.parsed.x === 'number' ? ctx.parsed.x : ctx.parsed.y;
                                    const label = ctx.label || `CPU ${ctx.dataIndex + 1}`;
                                    return label + ': ' + value.toFixed(1) + '%';
                                }
                            } 
                        } 
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: getVar('--chart-grid'), borderDash: [2, 3] },
                            ticks: { 
                                color: getVar('--chart-text'),
                                callback: function(value) { return value + '%'; }
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: getVar('--chart-text') }
                        }
                    },
                    animation: {
                        duration: 300,
                        easing: 'linear'
                    }
                }
            });
        }

        // --- Core Logic ---
        let currentView = 'dashboard';

        // --- Idle Timeout Logic ---
        let idleTimer;
        const IDLE_LIMIT = 3600000; // 1 hour

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            // Only set timer if user is logged in (dashboard is visible)
            const dashboard = document.getElementById('dashboard-ui');
            if (dashboard && dashboard.style.display !== 'none') {
                idleTimer = setTimeout(() => {
                    logout(true); 
                }, IDLE_LIMIT);
            }
        }

        function initIdleTimer() {
             const events = ['mousemove', 'mousedown', 'click', 'keypress', 'touchstart'];
             events.forEach(evt => {
                window.addEventListener(evt, resetIdleTimer, { passive: true });
             });
             // Scroll doesn't bubble, so use capture to catch scrolling in divs
             window.addEventListener('scroll', resetIdleTimer, { capture: true, passive: true });
             resetIdleTimer();
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/dashboard', { credentials: 'include', cache: 'no-store' });
                document.getElementById('loading-overlay').style.display = 'none';
                if (res.ok) showDashboard(false);
                else document.getElementById('login-screen').style.display = 'flex';
            } catch(e) {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        async function manualRefresh(btn) {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('spin');
            
            try {
                if (currentView === 'dashboard') await loadDashboardData();
                else if (currentView === 'sales') await loadSalesData('daily'); // Default to daily for now
                // Settings doesn't need refresh usually
            } catch (e) {
                console.error("Refresh failed", e);
            } finally {
                setTimeout(() => icon.classList.remove('spin'), 500); // Min 500ms spin
            }
        }


        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });
            if (res.ok) showDashboard(true);
            else document.getElementById('login-error').textContent = 'Invalid credentials';
        }

        async function logout(skipConfirm = false) {
            if (!skipConfirm) {
                if (!await showConfirm("Are you sure you want to log out?", true, "Logout")) return;
            }
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).then(() => location.reload());
        }

        let systemClockInterval = null;

        function startClock(serverTimeString) {
            if (systemClockInterval) clearInterval(systemClockInterval);

            const serverTime = new Date(serverTimeString);
            const clientTime = new Date();
            const offset = serverTime - clientTime;

            const updateClock = () => {
                const now = new Date();
                const estimatedServerTime = new Date(now.getTime() + offset);
                
                // Update Topbar Time
                const topbarTime = document.getElementById('topbar-time');
                if (topbarTime) {
                    topbarTime.style.display = 'block';
                    // Format: Jan 11, 10:30:45 AM
                    topbarTime.textContent = estimatedServerTime.toLocaleString('en-US', { 
                        month: 'short', day: 'numeric', 
                        hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true 
                    });
                }

                // Update Settings Page Time (if element exists and is visible)
                const settingsTime = document.getElementById('current-system-time');
                if (settingsTime) {
                    settingsTime.textContent = estimatedServerTime.toLocaleString();
                }
            };

            updateClock();
            systemClockInterval = setInterval(updateClock, 1000);
        }

        async function initSystemClock() {
            try {
                const res = await fetch('/api/admin/system/time');
                if (res.ok) {
                    const settings = await res.json();
                    if (settings.current_system_time) {
                        startClock(settings.current_system_time);
                    }
                }
            } catch (e) {
                console.error("Failed to init system clock", e);
            }
        }

        function showDashboard(forceDashboard) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-ui').style.display = 'flex';
            initCharts();
            initIdleTimer();
            initSystemClock(); // Start the clock
            
            // Init Chat (Authenticated)
            initChatSocket();
            const storedMac = localStorage.getItem('admin_chat_active_mac');
            if (storedMac) {
                // Ensure selectConversation is available or handle potentially missing DOM
                if(typeof selectConversation === 'function') selectConversation(storedMac);
            } else {
                if(typeof loadConversations === 'function') loadConversations();
            }

            const view = forceDashboard ? 'dashboard' : (localStorage.getItem('admin_last_view') || 'dashboard');
            showView(view);
        }

        function nav(view) {
            showView(view);
            // On mobile, close sidebar after click
            if (window.innerWidth <= 768) {
                setSidebarOpen(false);
            }
        }

        function showView(view) {
            // Clear all intervals from previous views
            IntervalManager.stopAll();

            if (typeof stopPppoeStatsRefresh === 'function') {
                stopPppoeStatsRefresh();
            }

            currentView = view;
            localStorage.setItem('admin_last_view', view); // Persist view

            // Hide all
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById('view-' + view).style.display = 'block';
            
            // Update Menu Active State
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                if(item.getAttribute('onclick').includes(view)) {
                    item.classList.add('active');
                    // Update Header Icon
                    const svg = item.querySelector('svg');
                    const headerIcon = document.getElementById('header-icon');
                    if (svg && headerIcon) {
                        headerIcon.innerHTML = svg.innerHTML;
                    }
                }
            });

            const titleMap = {
                dashboard: 'Dashboard',
                interfaces: 'Interfaces',
                pppoe: 'PPPoE',
                voucher: 'Vouchers',
                rates: 'Rates',
                network: 'Network',
                qos: 'QoS',
                firewall: 'Firewall',
                subvendo: 'Sub Vendo',
                portal: 'Portal',
                syslogs: 'Logs',
                devices: 'Devices',
                chat: 'Chat',
                sales: 'Sales',
                'pppoe-sales': 'PPPoE Sales',
                settings: 'Settings'
            };
            const title = titleMap[view] || view.charAt(0).toUpperCase() + view.slice(1);
            document.getElementById('page-title').textContent = title;

            const scroller = document.querySelector('.content-scroll');
            if (scroller) scroller.scrollTop = 0;

            // Load Data
            if (view === 'dashboard') {
                loadDashboardData();
                IntervalManager.start('dashboard', loadDashboardData, 5000);
            } else if (view === 'sales') {
                loadSalesData('daily');
            } else if (view === 'pppoe-sales') {
                loadPppoeSalesData();
            } else if (view === 'settings') {
                loadSettingsData();
            } else if (view === 'license') {
                loadLicenseInfo();
            } else if (view === 'portal') {
                loadPortalConfig();
            } else if (view === 'voucher') {
                loadVoucherBatches();
                loadVouchersData();
                loadActiveCodes();
                
                // 1. Refresh Vouchers/Batches every 5s (Less frequent)
                IntervalManager.start('voucher', () => {
                    loadVoucherBatches();
                    loadVouchersData();
                }, 5000);

                // 2. Refresh Active Codes every 1s (Real-time traffic/time)
                IntervalManager.start('voucher_active', () => {
                    loadActiveCodes();
                }, 1000);
            } else if (view === 'interfaces') {
                loadInterfaces();
            } else if (view === 'rates') {
                loadRatesData();
            } else if (view === 'chat') {
                loadConversations();
                loadChatSettings();
                // Ensure sidebar is visible when entering chat view
                const sidebar = document.getElementById('chat-sidebar');
                if(sidebar) sidebar.classList.remove('hidden');
            } else if (view === 'qos') {
                // loadQoSUsers(); // Removed
                loadQoSMode();
            } else if (view === 'network') {
                loadNetworkConfig();
                loadWifiConfig();
                loadWalledGarden();
                loadVlans();
                loadDhcp();
            } else if (view === 'devices') {
                loadDevicesData();
                devicesInterval = setInterval(() => {
                    loadDevicesData();
                }, 3000);
            } else if (view === 'firewall') {
                loadFirewallRules();
            } else if (view === 'pppoe') {
                loadPppoeServerConfig();
                if (typeof startPppoeStatsRefresh === 'function') {
                    startPppoeStatsRefresh();
                }
            } else if (view === 'syslogs') {
                loadLogs('system');
            } else if (view === 'subvendo') {
                loadSubVendoConfig();
                loadSubVendoDevices();
                loadSubVendoWaitingList();
                IntervalManager.start('subvendo', () => {
                    loadSubVendoDevices();
                    loadSubVendoWaitingList();
                }, 3000);
            }
        }

        function setSidebarOpen(open) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar) return;
            sidebar.classList.toggle('open', !!open);
            if (overlay) overlay.classList.toggle('open', !!open);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            setSidebarOpen(!sidebar.classList.contains('open'));
        }

        function setSidebarCollapsed(collapsed) {
            const sidebar = document.getElementById('sidebar');
            const logo = document.getElementById('sidebar-logo');
            if (!sidebar) return;
            sidebar.classList.toggle('collapsed', !!collapsed);
            document.body.classList.toggle('sidebar-collapsed', !!collapsed);
            if (logo) {
                const full = logo.getAttribute('data-logo-full') || '/neofi_logo.png';
                const compact = logo.getAttribute('data-logo-compact') || '/neologo.png';
                logo.src = collapsed ? compact : full;
            }
        }

        function toggleSidebarCollapsed() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            setSidebarCollapsed(!sidebar.classList.contains('collapsed'));
        }

        // --- Data Loading ---
        async function loadDashboardData() {
            try {
                const res = await fetch('/api/admin/dashboard', { credentials: 'include', cache: 'no-store' });
                if(res.status === 401) return location.reload();
                const data = await res.json();

                if (data.device_model) {
                    document.getElementById('board-model').textContent = data.device_model;
                }

                // Cards
                document.getElementById('sales-daily').textContent = '₱' + data.total_sales_today.toFixed(2);
                document.getElementById('sales-weekly').textContent = '₱' + (data.total_sales_week || 0).toFixed(2);
                document.getElementById('sales-monthly').textContent = '₱' + (data.total_sales_month || 0).toFixed(2);
                document.getElementById('sales-yearly').textContent = '₱' + (data.total_sales_year || 0).toFixed(2);
                
                document.getElementById('cpu-temp').textContent = data.cpu_temp ? data.cpu_temp.toFixed(1) + '°C' : 'N/A';
                document.getElementById('ram-usage').textContent = 
                    ((data.memory.total - data.memory.free) / 1024 / 1024).toFixed(0) + ' / ' + 
                    (data.memory.total / 1024 / 1024).toFixed(0) + ' MB';
                
                if (data.storage) {
                    const totalGB = (data.storage.total / 1024 / 1024 / 1024).toFixed(1);
                    const usedGB = (data.storage.used / 1024 / 1024 / 1024).toFixed(1);
                    const storageEl = document.getElementById('storage-usage');
                    if(storageEl) storageEl.textContent = `Used: ${usedGB} GB / Total: ${totalGB} GB`;
                }

                const uptimeHrs = (data.uptime / 3600).toFixed(1);
                document.getElementById('uptime').textContent = uptimeHrs + ' hrs';

                const connectedEl = document.getElementById('clients-connected-count');
                const pausedEl = document.getElementById('clients-paused-count');
                const disconnectedEl = document.getElementById('clients-disconnected-count');
                if (connectedEl) connectedEl.textContent = (data.clients_connected || 0);
                if (pausedEl) pausedEl.textContent = (data.clients_paused || 0);
                if (disconnectedEl) disconnectedEl.textContent = (data.clients_disconnected || 0);

                if (document.getElementById('pppoe-online-count')) document.getElementById('pppoe-online-count').textContent = (data.pppoe_online || 0);
                if (document.getElementById('pppoe-offline-count')) document.getElementById('pppoe-offline-count').textContent = (data.pppoe_offline || 0);
                if (document.getElementById('pppoe-expired-count')) document.getElementById('pppoe-expired-count').textContent = (data.pppoe_expired || 0);

                await refreshTopVendoSummary(false);
                await refreshTopClientsSummary(false);

                // CPU Chart Update
                let avgCpu = 0;
                let cores = [];
                
                if (data.cpu_usage) {
                    if (typeof data.cpu_usage === 'object' && data.cpu_usage.cores) {
                        // New format with per-core data
                        if (data.cpu_usage.cores.length > 0) {
                            // Calculate exact average of all cores as requested
                            const totalLoad = data.cpu_usage.cores.reduce((a, b) => a + b, 0);
                            avgCpu = totalLoad / data.cpu_usage.cores.length;
                        } else {
                            avgCpu = data.cpu_usage.avg;
                        }
                        cores = data.cpu_usage.cores;
                    } else {
                        // Old format or simple number
                        avgCpu = data.cpu_usage;
                        cores = [avgCpu];
                    }
                } else {
                    // Fallback to load_avg
                    avgCpu = (data.load_avg && data.load_avg.length > 0) ? (data.load_avg[0] * 10) : 0;
                    cores = [avgCpu];
                }

                // Ensure avgCpu is a valid number
                avgCpu = Number(avgCpu) || 0;

                // Update text elements immediately (before charts to prevent blocking on chart errors)
                const cpuTextEl = document.getElementById('cpu-text');
                if (cpuTextEl) cpuTextEl.textContent = Math.min(100, avgCpu).toFixed(1) + '%';

                const cpuLoadEl = document.getElementById('cpu-load');
                if (cpuLoadEl) cpuLoadEl.textContent = Math.min(100, avgCpu).toFixed(1) + '%';

                if (chartsEnabled && cpuDoughnut) {
                    try {
                        updateCpuChart(cores);
                    } catch(e) {
                        console.error("Chart Update Error:", e);
                    }
                }

                // DNS Stats Update
                if (data.dns) {
                    const stats = data.dns.stats;
                    const sHtml = `
                        <div style="margin-bottom:4px;">Total DNS Queries: <b>${stats.total_queries}</b></div>
                        <div style="margin-bottom:4px;">Answered from Cache: <b>${stats.cache_hits}</b> (${stats.cache_percent} %)</div>
                        <div style="margin-bottom:4px;">Blocked Request: <b>${stats.blocked_requests}</b></div>
                        <div style="margin-bottom:4px;">Block Rate: <b>${stats.block_rate} %</b></div>
                        <div style="margin-bottom:4px;">Blocklist Entries: <b>${stats.blocklist_entries.toLocaleString()}</b></div>
                    `;
                    const dnsContent = document.getElementById('dns-stats-content');
                    if(dnsContent) dnsContent.innerHTML = sHtml;

                    const renderList = (id, items) => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        if (!items || items.length === 0) {
                            el.innerHTML = '<li>No data</li>';
                            return;
                        }
                        el.innerHTML = items.map(i => `<li style="margin-bottom:4px;">${i.name || i.ip} (${i.count})</li>`).join('');
                    };

                    renderList('dns-top-blocked', data.dns.top_blocked);
                    renderList('dns-top-queried', data.dns.top_queried);
                    renderList('dns-top-clients', data.dns.top_clients);
                }



               // Bandwidth Chart (Mocking data for now as backend doesn't provide history yet)
                // In production, backend should send [rx, tx]
                updateBandwidthChart();
                
                // If on Network tab, refresh specific network data
                if (document.getElementById('view-network').style.display === 'block') {
                    // Only fetch if we haven't fetched recently or forced
                    // For simplicity, we might just let the user click Refresh or rely on this loop
                    // But to avoid flicker, maybe we don't auto-refresh the tables every 3s
                }

            } catch(e) {
                console.error("Dashboard Load Error:", e);
            }
        }

        async function refreshTopVendoSummary(showLoading) {
            const topVendoEl = document.getElementById('top-vendo-summary');
            if (!topVendoEl) return;

            const period = topVendoPeriod || 'monthly';
            if (showLoading) {
                topVendoEl.textContent = 'Loading...';
            }

            try {
                const res = await fetch(`/api/admin/sales/by-device?type=${encodeURIComponent(period)}`, { credentials: 'include', cache: 'no-store' });
                if (res.ok) {
                    const rows = await res.json();
                    if (Array.isArray(rows) && rows.length > 0) {
                        const sorted = rows.slice().sort((a, b) => (Number(b.total) || 0) - (Number(a.total) || 0));
                        const top = sorted.slice(0, 5);
                        const html = top.map(r => {
                            const name = r.name || r.source || '-';
                            const amt = (Number(r.total) || 0).toFixed(2);
                            return `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span>${name}</span>
                                        <span style="font-weight:bold;">₱${amt}</span>
                                    </div>`;
                        }).join('');
                        topVendoEl.innerHTML = html;
                    } else {
                        let text = 'No sales data';
                        if (period === 'daily') text += ' today';
                        else if (period === 'weekly') text += ' in last 7 days';
                        else if (period === 'monthly') text += ' this month';
                        else if (period === 'yearly') text += ' this year';
                        topVendoEl.textContent = text;
                    }
                } else {
                    topVendoEl.textContent = 'Unable to load data';
                }
            } catch (e) {
                topVendoEl.textContent = 'Error loading data';
            }
        }

        async function refreshTopClientsSummary(showLoading) {
            const topClientsEl = document.getElementById('top-clients-summary');
            if (!topClientsEl) return;

            const period = topClientsPeriod || 'monthly';
            if (showLoading) {
                topClientsEl.textContent = 'Loading...';
            }

            try {
                const res = await fetch(`/api/admin/sales/by-client?type=${encodeURIComponent(period)}`, { credentials: 'include', cache: 'no-store' });
                if (res.ok) {
                    const rows = await res.json();
                    if (Array.isArray(rows) && rows.length > 0) {
                        const sorted = rows.slice().sort((a, b) => (Number(b.total) || 0) - (Number(a.total) || 0));
                        const top = sorted.slice(0, 5);
                        const html = top.map(r => {
                            const mac = r.mac_address || 'Unknown';
                            const userCode = r.user_code || '';
                            const alias = (r.alias || '').trim();
                            const clientId = (r.client_id || '').trim();
                            
                            // Display Name Priority: Alias -> User Code -> MAC
                            const name = alias || (userCode ? `User: ${userCode}` : mac);
                            
                            const metaParts = [];
                            // If name is Alias, show User Code or MAC
                            if (alias) {
                                if (userCode) metaParts.push(userCode);
                                else if (mac) metaParts.push(mac);
                            } else if (userCode) {
                                // If name is User Code, show MAC
                                if (mac) metaParts.push(mac);
                            }
                            
                            if (clientId) metaParts.push(`ID: ${clientId}`);
                            
                            // Fallback if metaParts is empty but we have a MAC that isn't the name
                            if (metaParts.length === 0 && mac && name !== mac) {
                                metaParts.push(mac);
                            }

                            const metaLine = metaParts.length ? `<div style="font-size:0.75rem; color: var(--text-muted);">${metaParts.join(' | ')}</div>` : '';
                            const amt = (Number(r.total) || 0).toFixed(2);
                            return `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <div style="display:flex; flex-direction:column;">
                                            <span style="font-weight:600; font-size:0.9rem;">${name}</span>
                                            ${metaLine}
                                        </div>
                                        <span style="font-weight:bold;">₱${amt}</span>
                                    </div>`;
                        }).join('');
                        topClientsEl.innerHTML = html;
                    } else {
                        let text = 'No client sales';
                        if (period === 'daily') text += ' today';
                        else if (period === 'weekly') text += ' in last 7 days';
                        else if (period === 'monthly') text += ' this month';
                        else if (period === 'yearly') text += ' this year';
                        topClientsEl.textContent = text;
                    }
                } else {
                    topClientsEl.textContent = 'Unable to load data';
                }
            } catch (e) {
                topClientsEl.textContent = 'Error loading data';
            }
        }

        function onTopVendoPeriodChange(value) {
            topVendoPeriod = value || 'monthly';
            const select = document.getElementById('top-vendo-period');
            if (select && select.value !== topVendoPeriod) {
                select.value = topVendoPeriod;
            }
            refreshTopVendoSummary(true);
        }

        function onTopClientsPeriodChange(value) {
            topClientsPeriod = value || 'monthly';
            const select = document.getElementById('top-clients-period');
            if (select && select.value !== topClientsPeriod) {
                select.value = topClientsPeriod;
            }
            refreshTopClientsSummary(true);
        }

        // --- Logs Logic ---
        async function loadLogs(category = 'system') {
            const displayArea = document.getElementById('log-display-area');
            const categorySelect = document.getElementById('log-category-filter');
            
            // Sync select if called without event
            if (categorySelect.value !== category) {
                categorySelect.value = category;
            }

            displayArea.innerHTML = '<div style="color: var(--text-muted);">Loading logs...</div>';

            try {
                const res = await fetch(`/api/logs?source=${category}&limit=100`, { credentials: 'include' });
                if (!res.ok) {
                    let errMsg = res.statusText;
                    try {
                        const errJson = await res.json();
                        errMsg = errJson.error || errMsg;
                    } catch (err) {
                        errMsg = await res.text();
                    }
                    throw new Error(`Failed to fetch logs (${res.status}): ${errMsg}`);
                }
                const logs = await res.json();

                if (!logs || logs.length === 0) {
                    displayArea.innerHTML = '<div style="color: var(--text-muted);">No logs found.</div>';
                    return;
                }

                let html = '';
                logs.forEach(log => {
                    let line = '';
                    // Formatting based on category
                    if (category === 'system' || category === 'errors') {
                        // system_logs table: id, level, category, message, timestamp
                        const color = log.level === 'CRITICAL' ? 'var(--danger)' : 
                                      log.level === 'ERROR' ? 'var(--danger)' : 
                                      log.level === 'WARN' ? 'var(--warning)' : 'var(--success)';
                        
                        line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">[${new Date(log.timestamp).toLocaleString()}]</span> 
                                    <span style="color: ${color}; font-weight: bold;">[${log.level}]</span> 
                                    <span style="color: var(--info);">[${log.category}]</span> 
                                    <span style="color: var(--log-text);">${log.message}</span>
                                </div>`;
                    } else if (category === 'hotspot') {
                        // Combined Hotspot Logs (Vouchers + Coins + Expirations)
                        // Log structure depends on backend. Assuming standardized fields or conditional formatting.
                        
                        if (log.type === 'voucher_usage') {
                             line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">[${new Date(log.timestamp).toLocaleString()}]</span> 
                                    <span style="color: var(--log-voucher);">[VOUCHER]</span> 
                                    <span style="color: var(--log-text);">Code: ${log.details.code} (${log.details.plan_name} - ₱${log.details.price})</span> 
                                    <span style="color: var(--text-muted);">used by ${log.details.mac_address} (${log.details.ip_address || 'N/A'})</span>
                                </div>`;
                        } else if (log.type === 'coin_insert') {
                            line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">[${new Date(log.timestamp).toLocaleString()}]</span> 
                                    <span style="color: var(--status-active);">[COIN]</span> 
                                    <span style="color: var(--log-text);">Amount: ₱${log.details.amount} (Source: ${log.details.source})</span> 
                                    <span style="color: var(--text-muted);">User: ${log.details.user_code || 'Unknown'} (MAC: ${log.details.mac_address})</span>
                                </div>`;
                        } else if (log.type === 'session_expired') {
                             line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">[${new Date(log.timestamp).toLocaleString()}]</span> 
                                    <span style="color: var(--status-expired);">[EXPIRED]</span> 
                                    <span style="color: var(--log-text);">Session Expired</span> 
                                    <span style="color: var(--text-muted);">User: ${log.details.user_code || 'Unknown'} (MAC: ${log.details.mac_address})</span>
                                </div>`;
                        } else {
                            // Fallback for legacy voucher logs or generic hotspot logs
                             line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">[${new Date(log.timestamp || log.used_at).toLocaleString()}]</span> 
                                    <span style="color: var(--info);">[HOTSPOT]</span> 
                                    <span style="color: var(--log-text);">${log.message || JSON.stringify(log)}</span> 
                                </div>`;
                        }
                    } else if (category === 'pppoe') {
                        // Raw text or object
                        const msg = log.message || log.raw || JSON.stringify(log);
                        const time = log.timestamp ? `[${new Date(log.timestamp).toLocaleString()}] ` : '';
                        line = `<div style="margin-bottom: 4px; border-bottom: 1px solid var(--log-border); padding-bottom: 2px;">
                                    <span style="color: var(--log-timestamp);">${time}</span>
                                    <span style="color:var(--warning);">[PPPoE]</span> 
                                    <span style="color: var(--log-text);">${msg}</span>
                                </div>`;
                    }
                    html += line;
                });

                displayArea.innerHTML = html;
            } catch (e) {
                console.error("Log load error:", e);
                displayArea.innerHTML = `<div style="color: var(--status-expired);">Error loading logs: ${e.message}</div>`;
            }
        }

        async function verifyConfiguration() {
            const modal = document.getElementById('verify-modal');
            const resultsDiv = document.getElementById('verify-results');
            
            modal.style.display = 'flex';
            resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Running system checks...</div>';
            
            try {
                const res = await fetch('/api/admin/system/verify', { credentials: 'include' });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                let html = '';
                data.checks.forEach(check => {
                    let icon = '';
                    let color = '';
                    
                    switch(check.status) {
                        case 'success':
                            icon = '<i class="fas fa-check-circle"></i>';
                            color = 'var(--status-active)';
                            break;
                        case 'warning':
                            icon = '<i class="fas fa-exclamation-triangle"></i>';
                            color = 'var(--warning)';
                            break;
                        case 'error':
                            icon = '<i class="fas fa-times-circle"></i>';
                            color = 'var(--status-expired)';
                            break;
                        default:
                            icon = '<i class="fas fa-info-circle"></i>';
                            color = 'var(--info)';
                    }
                    
                    html += `<div style="display:flex; align-items:center; margin-bottom:10px; padding:10px; background:var(--bg-body); border-radius:5px; border-left: 4px solid ${color};">
                        <div style="color:${color}; font-size:1.2rem; margin-right:15px; min-width:20px; text-align:center;">${icon}</div>
                        <div>
                            <div style="font-weight:600; color:var(--text-main);">${check.category}</div>
                            <div style="font-size:0.9rem; color:var(--text-muted);">${check.message}</div>
                        </div>
                    </div>`;
                });
                
                resultsDiv.innerHTML = html;
                
            } catch (e) {
                console.error("Verification failed", e);
                resultsDiv.innerHTML = `<div style="color:var(--status-expired); padding:20px; text-align:center;">
                    <i class="fas fa-exclamation-circle" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    Verification failed: ${e.message}
                </div>`;
            }
        }

        // --- WiFi Config Logic ---
        function toggleWifiAuth() {
            const mode = document.getElementById('wifi-auth-mode').value;
            const passContainer = document.getElementById('wifi-password-container');
            const passInput = document.getElementById('wifi-password');
            
            if (mode === 'open') {
                passContainer.style.display = 'none';
                passInput.required = false;
                passInput.value = ''; // Clear password for open network
            } else {
                passContainer.style.display = 'block';
                // passInput.required = true; // Optional: Enforce password requirement
            }
        }

        async function loadWifiConfig() {
            try {
                const res = await fetch('/api/admin/wifi/config', { credentials: 'include' });
                const config = await res.json();
                
                document.getElementById('wifi-enabled').checked = config.enabled;
                document.getElementById('wifi-ssid').value = config.ssid || 'NeoFi_Built-In_WiFi';
                
                // Set Auth Mode
                let authMode = config.auth_mode;
                if (!authMode) {
                    // Fallback logic if auth_mode not returned by older backend
                    if (config.password) authMode = 'wpa2';
                    else authMode = 'open';
                }
                document.getElementById('wifi-auth-mode').value = authMode || 'wpa2';
                
                document.getElementById('wifi-password').value = config.password || '';
                document.getElementById('wifi-channel').value = config.channel || 6;
                document.getElementById('wifi-hw-mode').value = config.hw_mode || 'g';
                
                // Toggle inputs based on enabled state
                toggleWifiInputs(config.enabled);
                toggleWifiAuth(); // Set initial visibility
            } catch (e) {
                console.error('Error loading WiFi config:', e);
            }
        }

        document.getElementById('wifi-enabled').addEventListener('change', (e) => {
            toggleWifiInputs(e.target.checked);
        });

        function toggleWifiInputs(enabled) {
            const inputs = ['wifi-ssid', 'wifi-auth-mode', 'wifi-password', 'wifi-channel', 'wifi-hw-mode'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = !enabled;
            });
            if (enabled) toggleWifiAuth(); // Ensure correct state when enabling
        }

        async function saveWifiConfig(e) {
            e.preventDefault();
            const enabled = document.getElementById('wifi-enabled').checked;
            const ssid = document.getElementById('wifi-ssid').value;
            const auth_mode = document.getElementById('wifi-auth-mode').value;
            const password = document.getElementById('wifi-password').value;
            const channel = parseInt(document.getElementById('wifi-channel').value);
            const hw_mode = document.getElementById('wifi-hw-mode').value;

            try {
                const res = await fetch('/api/admin/wifi/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, ssid, auth_mode, password, channel, hw_mode }),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    alert('WiFi configuration saved. Access Point is restarting...');
                } else {
                    const err = await res.json();
                    alert('Error saving WiFi config: ' + err.error);
                }
            } catch (e) {
                console.error('Error saving WiFi config:', e);
                alert('Network error saving WiFi config');
            }
        }

        window.addEventListener('afterprint', () => {
            if (document && document.body) {
                document.body.classList.remove('voucher-printing');
            }
        });

        let lastRx = 0;
        let lastTx = 0;
        let lastTime = Date.now();
        let baseRx = 0;
        let baseTx = 0;

        function onInterfaceChange() {
            // Reset counters to avoid spikes when switching interfaces
            lastRx = 0;
            lastTx = 0;
            // Immediate update (optional, or wait for next interval)
            updateBandwidthChart();
        }

        function formatTrafficAmount(bytes) {
            const mb = bytes / (1024 * 1024);
            if (mb >= 1024) {
                const gb = mb / 1024;
                return gb.toFixed(2) + ' GB';
            }
            return mb.toFixed(2) + ' MB';
        }

        async function updateBandwidthChart() {
            try {
                const res = await fetch('/api/admin/network-stats', { credentials: 'include' });
                const stats = await res.json();
                
                const select = document.getElementById('monitored-interface-select');
                let selectedIface = select ? select.value : '';

                // Populate Dropdown if empty or "Detecting..."
                if (select && (select.options.length <= 1 && select.options[0].disabled)) {
                    select.innerHTML = '';
                    
                    // Add "All Interfaces" option
                    const allOpt = document.createElement('option');
                    allOpt.value = 'Aggregate';
                    allOpt.textContent = 'All Interfaces (Aggregate)';
                    select.appendChild(allOpt);

                    // Add detected interfaces
                    stats.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.interface;
                        opt.textContent = s.interface;
                        select.appendChild(opt);
                    });
                }

                let currentRx = 0;
                let currentTx = 0;
                let targetStats = null;

                // Auto-detect if nothing selected yet
                if (!selectedIface) {
                    selectedIface = 'Aggregate';
                    if (select) select.value = selectedIface;
                }

                // Fetch data based on selection
                if (selectedIface === 'Aggregate') {
                    stats.forEach(iface => {
                        if (iface.interface !== 'lo') {
                            currentRx += iface.rx_bytes;
                            currentTx += iface.tx_bytes;
                        }
                    });
                } else {
                    targetStats = stats.find(s => s.interface === selectedIface);
                    if (targetStats) {
                        currentRx = targetStats.rx_bytes;
                        currentTx = targetStats.tx_bytes;
                    }
                }

                const now = Date.now();
                if (lastRx === 0) {
                    lastRx = currentRx;
                    lastTx = currentTx;
                    lastTime = now;
                    baseRx = currentRx;
                    baseTx = currentTx;
                    return;
                }

                const duration = (now - lastTime) / 1000; // seconds
                if (duration <= 0) return;

                // Calculate Mbps
                let rxSpeed = ((currentRx - lastRx) * 8) / (1000000 * duration);
                let txSpeed = ((currentTx - lastTx) * 8) / (1000000 * duration);

                // Sanity check
                if (rxSpeed < 0 || rxSpeed > 1000) rxSpeed = 0;
                if (txSpeed < 0 || txSpeed > 1000) txSpeed = 0;

                let downloadSpeed, uploadSpeed;
                
                // Determine if interface is WAN-like (Aggregate or specific WAN)
                let isWanInterface = false;
                if (selectedIface === 'Aggregate') {
                    isWanInterface = true; // Treat aggregate as system In/Out
                } else {
                    const wanPrefixes = ['pppoe', 'ppp', 'eth', 'usb', 'wwan'];
                    isWanInterface = wanPrefixes.some(p => selectedIface.startsWith(p));
                    if (selectedIface === 'wlan1') isWanInterface = true; 
                }

                if (isWanInterface) {
                    downloadSpeed = rxSpeed; // WAN: RX is Download (from Internet)
                    uploadSpeed = txSpeed;   // WAN: TX is Upload (to Internet)
                } else {
                    downloadSpeed = txSpeed; // LAN: TX is Download (to Client)
                    uploadSpeed = rxSpeed;   // LAN: RX is Upload (from Client)
                }

                lastRx = currentRx;
                lastTx = currentTx;
                lastTime = now;

                if (!chartsEnabled || !bwChart) return;

                // Update Chart
                const labels = bwChart.data.labels;
                const dlData = bwChart.data.datasets[0].data;
                const ulData = bwChart.data.datasets[1].data;

                labels.shift();
                labels.push('');
                dlData.shift();
                dlData.push(downloadSpeed);
                ulData.shift();
                ulData.push(uploadSpeed);

                // Dynamic Y-Axis Scaling
                const maxVal = Math.max(
                    ...dlData.map(v => Number(v) || 0),
                    ...ulData.map(v => Number(v) || 0)
                );
                
                const raw = Math.max(1, maxVal * 1.15);
                let step = 1;
                if (raw <= 5) step = 1;
                else if (raw <= 10) step = 2;
                else if (raw <= 50) step = 10;
                else if (raw <= 100) step = 20;
                else step = 50;

                const nice = Math.ceil(raw / step) * step;
                bwChart.options.scales.y.max = nice;
                bwChart.options.scales.y.min = 0;

                bwChart.update('none'); 

                // Update stats if function exists
                if (typeof updateBwStats === 'function') {
                    updateBwStats(dlData, ulData);
                }

                let totalDownloadBytes = 0;
                let totalUploadBytes = 0;

                if (isWanInterface) {
                    if (currentRx >= baseRx) totalDownloadBytes = currentRx - baseRx;
                    if (currentTx >= baseTx) totalUploadBytes = currentTx - baseTx;
                } else {
                    if (currentTx >= baseTx) totalDownloadBytes = currentTx - baseTx;
                    if (currentRx >= baseRx) totalUploadBytes = currentRx - baseRx;
                }

                const dlTotalEl = document.getElementById('rx-total');
                const ulTotalEl = document.getElementById('tx-total');
                if (dlTotalEl) dlTotalEl.textContent = formatTrafficAmount(totalDownloadBytes);
                if (ulTotalEl) ulTotalEl.textContent = formatTrafficAmount(totalUploadBytes);
            } catch (e) {
                console.error("Chart error", e);
            }
        }

        function updateBwStats(rxData, txData) {
            // RX Data is positive
            const rxVals = rxData.map(v => parseFloat(v));
            const rxMin = Math.min(...rxVals);
            const rxMax = Math.max(...rxVals);
            const rxAvg = rxVals.reduce((a, b) => a + b, 0) / rxVals.length;
            const rxLast = rxVals[rxVals.length - 1];

            // TX Data is negative, convert to positive for stats
            const txVals = txData.map(v => Math.abs(parseFloat(v)));
            const txMin = Math.min(...txVals);
            const txMax = Math.max(...txVals);
            const txAvg = txVals.reduce((a, b) => a + b, 0) / txVals.length;
            const txLast = txVals[txVals.length - 1];

            // Helper to update DOM - Values are already in Mbps
            const set = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.textContent = val.toFixed(2) + ' Mbps';
            };

            set('rx-min', rxMin);
            set('rx-max', rxMax);
            set('rx-avg', rxAvg);
            set('rx-last', rxLast);

            set('tx-min', txMin);
            set('tx-max', txMax);
            set('tx-avg', txAvg);
            set('tx-last', txLast);
        }

        async function loadSalesData(type='daily') {
            currentSalesType = type;
            // Update active button state
            const btns = document.querySelectorAll('#view-sales button.btn-sm');
            if(btns.length > 0) {
                 btns.forEach(b => {
                     // specific match or fallback
                     const btnText = b.textContent.toLowerCase();
                     const isMatch = (type === 'history' && btnText.includes('all')) || 
                                   (type !== 'history' && btnText === type);
                                   
                     if(isMatch) {
                         b.classList.add('btn-primary');
                         b.style.background = '';
                     } else {
                         b.classList.remove('btn-primary');
                         b.style.background = 'var(--bg-body)';
                     }
                 });
            }

            const tableHead = document.querySelector('#sales-table thead tr');
            const tbody = document.querySelector('#sales-table tbody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';

            try {
                // Pre-fetch device names if history mode to populate cache
                let deviceDataPromise = null;
                if (type === 'history') {
                    deviceDataPromise = loadSalesByDevice(type);
                }

                const res = await fetch('/api/admin/sales?type=' + type);
                if(res.status === 401) return location.reload();
                const data = await res.json();
                
                // Wait for device data if needed
                if (deviceDataPromise) {
                    await deviceDataPromise;
                }
                
                tbody.innerHTML = '';

                if (type === 'history') {
                    // History Mode: per coin insert log
                    tableHead.innerHTML = `
                        <th style="padding:10px;">ID</th>
                        <th style="padding:10px;">Time Stamp</th>
                        <th style="padding:10px;">User Device ID</th>
                        <th style="padding:10px;">Amount</th>
                        <th style="padding:10px;">Vendo</th>
                    `;

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No transactions found</td></tr>';
                        // deviceDataPromise already called if history
                        return;
                    }

                    // Build lookup map from cache
                    const deviceMap = {};
                    if (window.salesByDeviceCache && Array.isArray(window.salesByDeviceCache)) {
                        window.salesByDeviceCache.forEach(d => {
                            if (d.source) deviceMap[d.source] = d.name || d.source;
                        });
                    }

                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        const date = new Date(d.timestamp).toLocaleString();
                        const amount = Number(d.amount) || 0;
                        const sourceRaw = d.source || 'hardware';
                        const sourceName = deviceMap[sourceRaw] || sourceRaw;

                        tr.innerHTML = `
                            <td>${d.id}</td>
                            <td>${date}</td>
                            <td style="font-family:monospace;">${d.mac_address || 'Unknown'}</td>
                            <td style="font-weight:bold; color:var(--success);">₱${amount.toFixed(2)}</td>
                            <td style="font-family:monospace;">${sourceName}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Already called loadSalesByDevice(type) via deviceDataPromise
                } else {
                    // Aggregated Mode: Date | Amount
                    tableHead.innerHTML = `
                        <th>
                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                                <span>Date</span>
                            </span>
                        </th>
                        <th>
                            <span style="display:inline-flex;align-items:center;gap:6px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                <span>Amount</span>
                            </span>
                        </th>
                    `;
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">No sales data</td></tr>';
                        await loadSalesByDevice(type);
                        return;
                    }

                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${d.label}</td><td style="font-weight:bold;">₱${d.value.toFixed(2)}</td>`;
                        tbody.appendChild(tr);
                    });

                    await loadSalesByDevice(type);
                }
            } catch (e) {
                console.error("Error loading sales:", e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--danger);">Error loading data</td></tr>';
            }
        }

        async function loadSalesByDevice(type='daily') {
            const tbody = document.querySelector('#sales-by-device-table tbody');
            if (!tbody) return;

            try {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Loading...</td></tr>';

                const res = await fetch('/api/admin/sales/by-device?type=' + type);
                if (res.status === 401) return location.reload();
                const rows = await res.json();

                tbody.innerHTML = '';
                window.salesByDeviceCache = Array.isArray(rows) ? rows : [];
                if (!Array.isArray(rows) || rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No device sales data</td></tr>';
                    return;
                }

                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const total = (Number(r.total) || 0).toFixed(2);
                    const daily = (Number(r.daily) || 0).toFixed(2);
                    const pending = (Number(r.pending) || 0).toFixed(2);
                    tr.innerHTML = `
                        <td>${r.name || r.source || '-'}</td>
                        <td style="font-weight:bold;">₱${total}</td>
                        <td>₱${daily}</td>
                        <td style="color:var(--warning); font-weight:600;">₱${pending}</td>
                        <td>
                            <button class="btn btn-sm" onclick="openSalesCoinsOutLogsModal('${r.source || ''}')">Sales Logs</button>
                        </td>
                        <td>
                            <button class="btn btn-sm" onclick="openSalesCoinsOutModal('${r.source || ''}')">Coins Out</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading sales by device:", e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--danger);">Error loading device sales</td></tr>';
            }
        }

        let salesCoinsOutSource = null;
        let salesCoinsOutPending = 0;
        let currentPppoeSales = [];

        async function loadPppoeSalesData() {
            const startEl = document.getElementById('pppoe-sales-start');
            const endEl = document.getElementById('pppoe-sales-end');
            
            let query = '';
            if (startEl && endEl && startEl.value && endEl.value) {
                query = `?startDate=${startEl.value}&endDate=${endEl.value}`;
            }

            const tbody = document.querySelector('#pppoe-sales-table tbody');
            if(tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>';

            try {
                const res = await fetch('/api/admin/pppoe/sales' + query);
                if(res.status === 401) return location.reload();
                const data = await res.json();
                
                currentPppoeSales = data || [];

                // Calculate Stats
                let netRevenue = 0;
                let totalSales = 0;
                let totalDiscounts = 0;
                let transactions = data.length;

                data.forEach(d => {
                    netRevenue += Number(d.amount_paid) || 0;
                    totalSales += Number(d.plan_price) || 0;
                    totalDiscounts += Number(d.discount) || 0;
                });

                // Update Stats Cards
                const revEl = document.getElementById('pppoe-net-revenue');
                const salesEl = document.getElementById('pppoe-total-sales');
                const discEl = document.getElementById('pppoe-total-discounts');
                const transEl = document.getElementById('pppoe-transactions');

                if(revEl) revEl.textContent = '₱' + netRevenue.toFixed(2);
                if(salesEl) salesEl.textContent = '₱' + totalSales.toFixed(2);
                if(discEl) discEl.textContent = '₱' + totalDiscounts.toFixed(2);
                if(transEl) transEl.textContent = transactions;

                // Populate Table
                if(tbody) {
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No sales data found</td></tr>';
                        return;
                    }

                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        const date = new Date(d.created_at).toLocaleString();
                        tr.innerHTML = `
                            <td>${date}</td>
                            <td>${d.username || '-'}</td>
                            <td>${d.plan_name || '-'}</td>
                            <td>${d.router_name || '-'}</td>
                            <td>₱${(Number(d.plan_price)||0).toFixed(2)}</td>
                            <td>₱${(Number(d.discount)||0).toFixed(2)}</td>
                            <td style="font-weight:bold; color:var(--success);">₱${(Number(d.amount_paid)||0).toFixed(2)}</td>
                            <td>
                                <div style="display:flex; gap:6px; justify-content:center;">
                                    <button class="btn btn-sm" onclick="printPppoeReceipt('${d.id}')" title="Print Receipt" style="padding:4px 8px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePppoeSale('${d.id}')" title="Delete">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

            } catch(e) {
                console.error("Error loading PPPoE sales:", e);
                if(tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--danger);">Error loading data</td></tr>';
            }
        }
        
        function printPppoeReport() {
            updateCompanyBrandingUI(); // Update dynamic branding before printing
            const dateEl = document.getElementById('pppoe-print-date');
            if(dateEl) dateEl.innerHTML = '<b>Date:</b> ' + new Date().toLocaleDateString();
            document.body.classList.add('pppoe-report-printing');
            window.print();
        }
        
        window.addEventListener('afterprint', () => {
            document.body.classList.remove('pppoe-report-printing');
            document.body.classList.remove('pppoe-receipt-printing');
        });

        function printPppoeReceipt(id) {
            const sale = currentPppoeSales.find(s => s.id == id);
            if (!sale) return;

            const container = document.getElementById('pppoe-receipt-container');
            if (!container) return;

            const date = new Date(sale.created_at).toLocaleString();
            const price = (Number(sale.plan_price)||0).toFixed(2);
            const discount = (Number(sale.discount)||0).toFixed(2);
            const paid = (Number(sale.amount_paid)||0).toFixed(2);

            const logo = currentCompanySettings.company_logo || '/neologo.png';
            const companyName = currentCompanySettings.company_name || 'CJTECH PISOWIFI';
            const contact = currentCompanySettings.company_contact || '09123456789';
            const email = currentCompanySettings.company_email || 'admin@neofi.com';

            container.innerHTML = `
                <div style="text-align:center; margin-bottom:15px; border-bottom:1px dashed var(--border); padding-bottom:10px;">
                    <img src="${logo}" alt="Logo" style="height:50px; width:auto; margin-bottom:5px;">
                    <h3 style="margin:0;">${companyName}</h3>
                    <div style="font-size:0.8rem;">Contact: ${contact}</div>
                    <div style="font-size:0.8rem;">Email: ${email}</div>
                    <div style="font-size:0.9rem; font-weight:bold; margin-top:10px;">OFFICIAL RECEIPT</div>
                    <div style="font-size:0.8rem;">${date}</div>
                </div>
                <div style="margin-bottom:15px; font-size:0.9rem;">
                    <div style="display:flex; justify-content:space-between;"><span>User:</span> <b>${sale.username}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span>Plan:</span> <span>${sale.plan_name}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Router:</span> <span>${sale.router_name}</span></div>
                </div>
                <div style="margin-bottom:15px; border-top:1px dashed var(--border); border-bottom:1px dashed var(--border); padding:10px 0;">
                    <div style="display:flex; justify-content:space-between;"><span>Price:</span> <span>₱${price}</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Discount:</span> <span>₱${discount}</span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; margin-top:5px;">
                        <span>TOTAL:</span> <span>₱${paid}</span>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.8rem;">
                    Thank you for your payment!
                </div>
            `;

            document.body.classList.add('pppoe-receipt-printing');
            window.print();
        }

        async function deletePppoeSale(id) {
            if(!confirm('Are you sure you want to delete this sale record?')) return;
            try {
                const res = await fetch('/api/admin/pppoe/sales/' + id, { method: 'DELETE' });
                if(res.ok) {
                    loadPppoeSalesData();
                } else {
                    alert('Failed to delete sale record');
                }
            } catch(e) {
                console.error("Error deleting PPPoE sale:", e);
                alert('Error deleting sale record');
            }
        }

        function openSalesCoinsOutModal(source) {
            const modal = document.getElementById('sales-coinsout-modal');
            const nameEl = document.getElementById('sales-coinsout-device');
            const baseEl = document.getElementById('sales-coinsout-base');
            const percentEl = document.getElementById('sales-coinsout-percent');
            const shareEl = document.getElementById('sales-coinsout-share');
            const ownerEl = document.getElementById('sales-coinsout-owner');

            const rows = window.salesByDeviceCache || [];
            const row = rows.find(r => (r.source || '') === source) || null;

            const base = row ? Number(row.pending || 0) : 0;
            salesCoinsOutSource = source;
            salesCoinsOutPending = base;

            if (nameEl) nameEl.textContent = row ? (row.name || row.source || '-') : source || '-';
            if (baseEl) baseEl.textContent = `₱${base.toFixed(2)}`;

            if (percentEl) {
                if (!percentEl.value) percentEl.value = '20';
            }

            const pct = percentEl ? (Number(percentEl.value) || 0) : 0;
            const shareAmount = base * (pct / 100);
            const ownerAmount = base - shareAmount;

            if (shareEl) shareEl.textContent = `₱${shareAmount.toFixed(2)}`;
            if (ownerEl) ownerEl.textContent = `₱${ownerAmount.toFixed(2)}`;

            if (modal) modal.style.display = 'flex';
        }

        function closeSalesCoinsOutModal() {
            const modal = document.getElementById('sales-coinsout-modal');
            if (modal) modal.style.display = 'none';
        }

        function recalcSalesCoinsOutShare() {
            const base = salesCoinsOutPending || 0;
            const percentEl = document.getElementById('sales-coinsout-percent');
            const shareEl = document.getElementById('sales-coinsout-share');
            const ownerEl = document.getElementById('sales-coinsout-owner');

            let pct = percentEl ? Number(percentEl.value) : 0;
            if (!Number.isFinite(pct)) pct = 0;
            if (pct < 0) pct = 0;
            if (pct > 100) pct = 100;
            if (percentEl) percentEl.value = pct.toString();

            const shareAmount = base * (pct / 100);
            const ownerAmount = base - shareAmount;

            if (shareEl) shareEl.textContent = `₱${shareAmount.toFixed(2)}`;
            if (ownerEl) ownerEl.textContent = `₱${ownerAmount.toFixed(2)}`;
        }

        async function openSalesCoinsOutLogsModal(source) {
            const modal = document.getElementById('sales-coinsout-logs-modal');
            const deviceEl = document.getElementById('sales-coinsout-logs-device');
            const listEl = document.getElementById('sales-coinsout-logs-list');
            if (!modal || !listEl) return;

            const rows = window.salesByDeviceCache || [];
            const row = rows.find(r => (r.source || '') === source) || null;
            if (deviceEl) deviceEl.textContent = row ? (row.name || row.source || '-') : source || '-';

            listEl.innerHTML = '<li>Loading...</li>';

            try {
                const res = await fetch('/api/admin/sales/coins-out/logs?source=' + encodeURIComponent(source));
                if (res.status === 401) return location.reload();
                const logs = await res.json();
                listEl.innerHTML = '';
                if (!Array.isArray(logs) || logs.length === 0) {
                    listEl.innerHTML = '<li>No Coins Out records</li>';
                } else {
                    logs.forEach(item => {
                        const li = document.createElement('li');
                        const ts = item.created_at ? new Date(item.created_at.replace(' ', 'T')).toLocaleString() : '';
                        const amount = Number(item.amount || 0).toFixed(2);
                        const base = item.base_amount != null ? Number(item.base_amount) : null;
                        const pct = item.partner_percent != null ? Number(item.partner_percent) : null;
                        let detail = '';
                        if (base != null && !Number.isNaN(base) && pct != null && !Number.isNaN(pct)) {
                            const share = base * (pct / 100);
                            detail = ` (from ₱${base.toFixed(2)}, ${pct.toFixed(0)}% = ₱${share.toFixed(2)} share)`;
                        }
                        li.textContent = `${ts} â€” ₱${amount}${detail}`;
                        listEl.appendChild(li);
                    });
                }
            } catch (e) {
                console.error('Coins Out logs load error', e);
                listEl.innerHTML = '<li>Error loading logs</li>';
            }

            modal.style.display = 'flex';
        }

        function closeSalesCoinsOutLogsModal() {
            const modal = document.getElementById('sales-coinsout-logs-modal');
            if (modal) modal.style.display = 'none';
        }

        async function performSalesCoinsOut() {
            if (!salesCoinsOutSource) {
                closeSalesCoinsOutModal();
                return;
            }
            try {
                const base = salesCoinsOutPending || 0;
                const percentEl = document.getElementById('sales-coinsout-percent');
                let pct = percentEl ? Number(percentEl.value) : 0;
                if (!Number.isFinite(pct)) pct = 0;
                if (pct < 0) pct = 0;
                if (pct > 100) pct = 100;
                const partnerShare = base * (pct / 100);
                const coinsOutAmount = base - partnerShare;

                const res = await fetch('/api/admin/sales/coins-out', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: salesCoinsOutSource, amount: coinsOutAmount, base: base, percent: pct })
                });
                if (res.status === 401) return location.reload();
                
                if (!res.ok) {
                    const text = await res.text();
                    try {
                        const json = JSON.parse(text);
                        alert('Coins Out failed: ' + (json.error || text));
                    } catch (e) {
                        alert('Coins Out failed: ' + text.substring(0, 100));
                    }
                    return;
                }

                const data = await res.json();
                if (data && data.success) {
                    closeSalesCoinsOutModal();
                    await loadSalesByDevice(currentSalesType || 'daily');
                } else {
                    alert('Coins Out failed');
                }
            } catch (e) {
                console.error('Coins Out error', e);
                alert('Coins Out error: ' + e.message);
            }
        }

        // --- Time & NTP Settings ---

        async function loadTimeSettings() {
            try {
                // Load Timezones first if empty
                const tzSelect = document.getElementById('timezone-select');
                if (tzSelect.options.length === 0) {
                    await loadTimezones();
                }

                const res = await fetch('/api/admin/system/time');
                const settings = await res.json();
                
                document.getElementById('time-sync-mode').value = settings.time_sync_mode || 'auto';
                
                const ntpServers = (settings.ntp_server || '132.163.97.3 202.90.132.242 pool.ntp.org').split(' ');
                document.getElementById('ntp-server-1').value = ntpServers[0] || '';
                document.getElementById('ntp-server-2').value = ntpServers[1] || '';
                document.getElementById('ntp-server-3').value = ntpServers[2] || '';
                document.getElementById('ntp-server-4').value = ntpServers[3] || '';

                document.getElementById('timezone-mode').value = settings.timezone_mode || 'auto';
                document.getElementById('timezone-select').value = settings.timezone || 'Asia/Manila';
                
                if (settings.manual_datetime) {
                    document.getElementById('manual-datetime').value = settings.manual_datetime;
                }
                
                if (settings.current_system_time) {
                    startClock(settings.current_system_time);
                }

                toggleTimeInputs();
            } catch (e) {
                console.error("Error loading time settings", e);
            }
        }

        async function loadTimezones() {
            try {
                const res = await fetch('/api/admin/system/timezones');
                if (!res.ok) throw new Error('Failed to load timezones');
                
                const timezones = await res.json();
                if (!Array.isArray(timezones) || timezones.length === 0) throw new Error("Empty timezone list");

                const select = document.getElementById('timezone-select');
                select.innerHTML = '';
                
                timezones.forEach(tz => {
                    const opt = document.createElement('option');
                    opt.value = tz;
                    opt.textContent = tz;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Error loading timezones, using fallback", e);
                const select = document.getElementById('timezone-select');
                // Only populate fallback if empty
                if (select.options.length === 0) {
                    const fallbackTimezones = [
                        'Asia/Manila', 'Asia/Tokyo', 'Asia/Singapore', 'Asia/Shanghai', 
                        'America/New_York', 'Europe/London', 'UTC'
                    ];
                    select.innerHTML = '';
                    fallbackTimezones.forEach(tz => {
                        const opt = document.createElement('option');
                        opt.value = tz;
                        opt.textContent = tz; // + ' (Fallback)'
                        select.appendChild(opt);
                    });
                }
            }
        }

        function toggleTimeInputs() {
            const syncMode = document.getElementById('time-sync-mode').value;
            const tzMode = document.getElementById('timezone-mode').value;
            
            // Time Sync logic
            if (syncMode === 'auto') {
                document.getElementById('ntp-server-group').style.display = 'block';
                document.getElementById('manual-time-group').style.display = 'none';
            } else {
                document.getElementById('ntp-server-group').style.display = 'none';
                document.getElementById('manual-time-group').style.display = 'block';
            }

            // Timezone logic
            if (tzMode === 'auto') {
                document.getElementById('timezone-select-group').style.display = 'none';
            } else {
                document.getElementById('timezone-select-group').style.display = 'block';
            }
        }

        async function saveTimeSettings(e) {
            e.preventDefault();
            
            const data = {
                time_sync_mode: document.getElementById('time-sync-mode').value,
                ntp_server: [
                    document.getElementById('ntp-server-1').value.trim(),
                    document.getElementById('ntp-server-2').value.trim(),
                    document.getElementById('ntp-server-3').value.trim(),
                    document.getElementById('ntp-server-4').value.trim()
                ].filter(Boolean).join(' '),
                timezone_mode: document.getElementById('timezone-mode').value,
                timezone: document.getElementById('timezone-select').value,
                manual_datetime: document.getElementById('manual-datetime').value
            };
            
            try {
                const res = await fetch('/api/admin/system/time', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.status === 404) {
                    alert('Error: The Time Settings API was not found. Please RESTART the server to apply the latest updates.');
                    return;
                }

                const text = await res.text();
                
                if (res.ok) {
                    try {
                        // Attempt to parse JSON response
                        const json = text ? JSON.parse(text) : {};
                        alert('Time settings saved successfully. System time may update shortly.');
                        loadTimeSettings(); // Refresh to see updated time
                    } catch (parseErr) {
                        console.error('Invalid JSON response:', text);
                        alert('Settings saved, but server response was invalid.');
                    }
                } else {
                    try {
                        const err = JSON.parse(text);
                        alert('Error: ' + (err.error || text));
                    } catch (parseErr) {
                        alert('Server Error: ' + text);
                    }
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save time settings: ' + e.message);
            }
        }

        // --- Company Settings ---
        let currentCompanySettings = {
            company_name: 'CJTECH PISOWIFI',
            company_contact: '09123456789',
            company_email: 'admin@neofi.com',
            company_logo: '/neologo.png'
        };

        async function loadCompanySettings() {
            try {
                const res = await fetch('/api/admin/system/company');
                if (res.ok) {
                    const settings = await res.json();
                    currentCompanySettings = { ...currentCompanySettings, ...settings };
                    updateCompanyBrandingUI();
                }
            } catch (e) {
                console.error("Failed to load company settings", e);
            }
        }

        function updateCompanyBrandingUI() {
            // Update Print Header
            const nameEl = document.getElementById('print-company-name');
            const contactEl = document.getElementById('print-company-contact');
            const emailEl = document.getElementById('print-company-email');
            const logoEl = document.getElementById('print-company-logo');

            if (nameEl) nameEl.textContent = currentCompanySettings.company_name;
            if (contactEl) contactEl.textContent = currentCompanySettings.company_contact;
            if (emailEl) emailEl.textContent = currentCompanySettings.company_email;
            if (logoEl && currentCompanySettings.company_logo) {
                 // Add timestamp to force reload image if changed
                 logoEl.src = currentCompanySettings.company_logo + '?v=' + Date.now(); 
            }
        }

        async function openCompanySettingsModal() {
            await loadCompanySettings(); // Ensure fresh data
            const form = document.getElementById('company-settings-form');
            if (form) {
                form.elements['company_name'].value = currentCompanySettings.company_name;
                form.elements['company_contact'].value = currentCompanySettings.company_contact;
                form.elements['company_email'].value = currentCompanySettings.company_email;
                
                const preview = document.getElementById('company-logo-preview');
                if (currentCompanySettings.company_logo) {
                    preview.src = currentCompanySettings.company_logo;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }
            document.getElementById('company-settings-modal').style.display = 'flex';
        }

        function previewCompanyLogo(input) {
            const preview = document.getElementById('company-logo-preview');
            const file = input.files[0];
            if (file) {
                if (file.size > 500 * 1024) {
                    alert("File size exceeds 500KB limit.");
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function saveCompanySettings(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = {
                company_name: formData.get('company_name'),
                company_contact: formData.get('company_contact'),
                company_email: formData.get('company_email')
            };

            const fileInput = document.getElementById('company-logo-input');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(e) {
                    data.logo_base64 = e.target.result;
                    await submitCompanySettings(data);
                };
                reader.readAsDataURL(file);
            } else {
                await submitCompanySettings(data);
            }
        }

        async function submitCompanySettings(data) {
            try {
                const res = await fetch('/api/admin/system/company', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    const result = await res.json();
                    if (result.success) {
                        alert('Company settings saved successfully!');
                        document.getElementById('company-settings-modal').style.display = 'none';
                        loadCompanySettings(); // Refresh UI
                    } else {
                        alert('Failed to save settings');
                    }
                } else {
                    alert('Server error while saving settings');
                }
            } catch (e) {
                console.error(e);
                alert('Error saving settings: ' + e.message);
            }
        }

        async function loadSettingsData() {
            const res = await fetch('/api/admin/settings');
            const settings = await res.json();
            
            // Fetch Hostname
            let hostname = '';
            try {
                const hostRes = await fetch('/api/admin/system/hostname');
                const hostData = await hostRes.json();
                hostname = hostData.hostname;
            } catch(e) { console.error('Failed to load hostname', e); }

            const container = document.getElementById('settings-container');
            container.innerHTML = '';
            
            // Helper to create form group
            const createGroup = (label, input) => {
                const div = document.createElement('div');
                // Removed explicit marginBottom, handled by grid gap
                div.innerHTML = `<label style="display:block; font-weight:600; margin-bottom:0px; line-height:1.1; font-size:0.85rem; color: var(--text-muted);">${label}</label>`;
                div.appendChild(input);
                return div;
            };

            const createInput = (name, value, type='text', placeholder='') => {
                const i = document.createElement('input');
                i.id = name;
                i.name = name;
                i.value = value || '';
                i.type = type;
                i.placeholder = placeholder;
                i.autocomplete = 'off';
                i.style.width = '100%';
                i.style.padding = '3px 8px';
                i.style.border = '1px solid var(--border)';
                i.style.borderRadius = '4px';
                i.style.fontFamily = 'inherit';
                i.style.fontSize = '0.85rem';
                i.style.boxSizing = 'border-box';
                return i;
            };

            const createSelect = (name, value, options) => {
                const s = document.createElement('select');
                s.id = name;
                s.name = name;
                s.style.width = '100%';
                s.style.padding = '3px 8px';
                s.style.border = '1px solid var(--border)';
                s.style.borderRadius = '4px';
                s.style.fontFamily = 'inherit';
                s.style.fontSize = '0.85rem';
                s.style.background = 'var(--card-bg)';
                s.style.boxSizing = 'border-box';
                
                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt;
                    o.textContent = opt;
                    if (opt === value) o.selected = true;
                    s.appendChild(o);
                });
                return s;
            };

            // 0. System Hostname
            container.appendChild(createGroup('Hostname', createInput('system_hostname', hostname, 'text', 'NeoFI')));

            // 1. Vendo Selection Mode
            container.appendChild(createGroup('Vendo Selection Mode', createSelect('vendo_selection_mode', settings.vendo_selection_mode || 'auto', ['auto', 'manual'])));

            // 2. Coin Pin (Default 12)
            container.appendChild(createGroup('Coin Pin', createInput('coin_pin', settings.coin_pin || '12', 'number')));

            // 3. Coin Pin Edge (FALLING/RISING)
            container.appendChild(createGroup('Coin Pin Edge', createSelect('coin_pin_edge', settings.coin_pin_edge || 'RISING', ['FALLING', 'RISING'])));

            // 4. Bill Pin (Optional)
            container.appendChild(createGroup('Bill Pin (Optional)', createInput('bill_pin', settings.bill_pin || '19', 'number', 'GPIO Pin (Default 19)')));

            // 5. Bill Pin Edge (FALLING/RISING)
            container.appendChild(createGroup('Bill Pin Edge', createSelect('bill_pin_edge', settings.bill_pin_edge || 'FALLING', ['FALLING', 'RISING'])));

            // 6. Bill Multiplier (x 1)
            container.appendChild(createGroup('Bill Multiplier (x)', createInput('bill_multiplier', settings.bill_multiplier || '1', 'number')));

            // 7. Relay Pin (Default 11)
            container.appendChild(createGroup('Relay Pin', createInput('relay_pin', settings.relay_pin || '11', 'number')));

            // 8. Relay Pin Active (LOW/HIGH)
            container.appendChild(createGroup('Relay Pin Active', createSelect('relay_pin_active', settings.relay_pin_active || 'HIGH', ['LOW', 'HIGH'])));

            // 9. Ban Counter (10 SEC)
            const banCounterInput = createInput('ban_limit_counter', settings.ban_limit_counter || '10', 'number');
            const banCounterGroup = createGroup('Insert Attempts Ban', banCounterInput);
            container.appendChild(banCounterGroup);

            // 10. Ban Duration (1 MINUTE)
            const banDurationInput = createInput('ban_duration', settings.ban_duration || '1', 'number');
            const banDurationGroup = createGroup('Ban Duration (minutes)', banDurationInput);
            container.appendChild(banDurationGroup);

            // 11. Session Timeout (Minutes)
            const sessionTimeoutInput = createInput('session_timeout_minutes', (settings.session_timeout_minutes || '30'), 'number', 'Default 30');
            container.appendChild(createGroup('Timeout (minutes)', sessionTimeoutInput));

            const idleTimeoutInput = createInput('idle_timeout_seconds', (settings.idle_timeout_seconds || '120'), 'number', 'Default 120');
            container.appendChild(createGroup('Idle Timeout (seconds)', idleTimeoutInput));

            const keepaliveTimeoutInput = createInput('keepalive_timeout_seconds', (settings.keepalive_timeout_seconds || '300'), 'number', 'Default 300');
            container.appendChild(createGroup('Keepalive Timeout (seconds)', keepaliveTimeoutInput));
        }

        async function saveSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            // Validation
            const errors = [];
            const isPosInt = (val) => /^\d+$/.test(val) && parseInt(val) >= 0;

            // Check if we are saving Vendo Settings (indicated by presence of coin_pin)
            if ('coin_pin' in data) {
                if (!isPosInt(data.coin_pin)) errors.push("Coin Pin must be a valid positive number.");
                if (data.bill_pin && !isPosInt(data.bill_pin)) errors.push("Bill Pin must be a valid positive number.");
                if (!isPosInt(data.bill_multiplier) || parseInt(data.bill_multiplier) < 1) errors.push("Bill Multiplier must be at least 1.");
                if (!isPosInt(data.relay_pin)) errors.push("Relay Pin must be a valid positive number.");
                if (!isPosInt(data.ban_limit_counter)) errors.push("Insert Attempt Ban Counter must be a valid positive number.");
                if (!isPosInt(data.ban_duration)) errors.push("Ban Duration must be a valid positive number.");

                // Check for duplicate pins
                const pins = [data.coin_pin, data.bill_pin, data.relay_pin].filter(p => p && p.trim() !== '');
                const uniquePins = new Set(pins);
                if (pins.length !== uniquePins.size) {
                    errors.push("Duplicate GPIO pins detected. Coin, Bill, and Relay must use unique pins.");
                }

                // Hostname Validation
                if (data.system_hostname && !/^[a-zA-Z0-9-]+$/.test(data.system_hostname)) {
                    errors.push("Hostname must contain only alphanumeric characters and hyphens.");
                }
            }

            if (errors.length > 0) {
                alert("Validation Error:\n\n" + errors.join("\n"));
                return;
            }

            try {
                // 1. Save Hostname if changed
                if (data.system_hostname) {
                    try {
                         await fetch('/api/admin/system/hostname', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ hostname: data.system_hostname })
                        });
                    } catch(e) {
                        console.error("Failed to save hostname", e);
                        alert("Failed to save hostname: " + e.message);
                        return;
                    }
                    delete data.system_hostname;
                }

                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('Configuration Saved. (Note: Hostname changes require a reboot to fully take effect)');
                } else {
                    alert('Failed to save configuration');
                }
            } catch (err) {
                console.error("Save error:", err);
                alert('Error saving configuration');
            }
        }

        async function loadChatSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const settings = await res.json();
                
                // Match server logic: Enabled by default unless explicitly false
                const enabled = settings.chat_enabled !== 'false' && settings.chat_enabled !== false;
                
                const toggle = document.getElementById('chat-enabled-toggle');
                if (toggle) toggle.checked = enabled;
            } catch (e) {
                console.error("Chat settings load error", e);
            }
        }

        async function saveChatSettings(e) {
            if (e && e.type === 'submit') e.preventDefault();
            
            const toggle = document.getElementById('chat-enabled-toggle');
            const enabled = toggle ? toggle.checked : false;
            
            // Disable while saving
            if (toggle) toggle.disabled = true;

            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_enabled: enabled })
                });
                
                if (res.ok) {
                    console.log('Chat settings saved successfully');
                } else {
                    alert('Failed to save chat settings');
                    // Revert if failed
                    if (toggle) toggle.checked = !enabled;
                }
            } catch (e) {
                console.error("Chat settings save error", e);
                alert("Error saving chat settings");
                // Revert if failed
                if (toggle) toggle.checked = !enabled;
            } finally {
                if (toggle) toggle.disabled = false;
            }
        }

        function setPreviewMode(mode) {
            const frame = document.getElementById('portal-preview-frame');
            if (mode === 'mobile') {
                frame.style.width = '100%';
                frame.style.maxWidth = '375px';
                frame.style.height = '667px';
                frame.style.border = '4px solid var(--text-main)';
                frame.style.borderRadius = '12px';
            } else {
                frame.style.width = '100%';
                frame.style.maxWidth = 'none';
                frame.style.height = '667px';
                frame.style.border = '1px solid var(--border)';
                frame.style.borderRadius = '0';
            }
        }

        function getCurrentPortalConfig() {
            return {
                theme: document.getElementById('portal-theme-select').value,
                container_max_width: document.getElementById('portal-container-width').value,
                icon_size: document.getElementById('portal-icon-size').value,
                status_icon_container_size: document.getElementById('portal-status-container-size').value,
                banner_height: document.getElementById('portal-banner-height').value,
                use_default_banner: document.getElementById('portal-use-default-banner').checked,
                default_banner_file: document.getElementById('portal-default-banner-file').value,
                hide_voucher_code: document.getElementById('portal-hide-voucher-code').checked,
                banner_mode: document.querySelector('input[name="banner_mode"]:checked').value,
                slideshow_interval: document.getElementById('portal-slideshow-interval').value,
                footer_text: document.getElementById('portal-footer-text').value,
                footer_link: document.getElementById('portal-footer-link').value
            };
        }

        function updatePortalPreview(themeName) {
            const frame = document.getElementById('portal-preview-frame');
            if (frame) {
                if (themeName && !frame.src.endsWith(themeName)) {
                    frame.src = themeName;
                }
                
                const config = getCurrentPortalConfig();
                // Send message after a short delay to ensure frame is ready or if it's already loaded
                setTimeout(() => {
                    frame.contentWindow.postMessage({
                        type: 'PORTAL_PREVIEW_UPDATE',
                        config: config
                    }, '*');
                }, 100);
            }
        }

        async function loadPortalConfig() {
            try {
                // 0. Load Portal Themes
                try {
                    const themeRes = await fetch('/api/admin/portal/themes');
                    const themeData = await themeRes.json();
                    const themeSelect = document.getElementById('portal-theme-select');
                    if (themeSelect && themeData.themes) {
                        themeSelect.innerHTML = '';
                        themeData.themes.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t;
                            opt.textContent = t;
                            themeSelect.appendChild(opt);
                        });
                        // Set active theme from this response if available, or wait for config
                        if (themeData.active) {
                            themeSelect.value = themeData.active;
                        }
                        updatePortalPreview(themeSelect.value);
                    }
                } catch (e) { console.error("Failed to load themes", e); }

                // 1. Fetch available banner images (slideshow folder)
                let availableImages = [];
                try {
                    const imgRes = await fetch('/api/admin/slideshow-images');
                    if (imgRes.ok) availableImages = await imgRes.json();
                } catch (e) { console.error("Failed to load banner images", e); }

                // 2. Populate Dropdown
                const bannerSelect = document.getElementById('portal-default-banner-file');
                if (bannerSelect) {
                    const currentVal = bannerSelect.value;
                    bannerSelect.innerHTML = ''; // Clear existing

                    // Add Hardcoded Defaults
                    const defaults = [
                        { val: 'op-banner.png', label: 'Default Banner 1 (op-banner.png)' },
                        { val: 'op-banner1.png', label: 'Default Banner 2 (op-banner1.png)' }
                    ];

                    defaults.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt.val;
                        o.textContent = opt.label;
                        bannerSelect.appendChild(o);
                    });

                    // Add Slideshow Images
                    if (availableImages.length > 0) {
                        const grp = document.createElement('optgroup');
                        grp.label = "Slideshow / Uploaded Images";
                        availableImages.forEach(img => {
                            // Avoid duplicates if same name exists
                            if (img === 'op-banner.png' || img === 'op-banner1.png') return;
                            const o = document.createElement('option');
                            o.value = `slideshow/${img}`; // Path relative to public root? No, servePortalBanner handles root paths?
                            // Wait, app.js serves /op-banner.png directly.
                            // Images in slideshow folder are at /slideshow/filename.
                            // The portal needs to know how to load them.
                            // If I select "slideshow/img.jpg", the portal.html needs to set src="slideshow/img.jpg".
                            o.value = `slideshow/${img}`;
                            o.textContent = img;
                            grp.appendChild(o);
                        });
                        bannerSelect.appendChild(grp);
                    }
                }

                const res = await fetch('/api/portal/config');
                const config = await res.json();
                
                document.getElementById('portal-container-width').value = config.container_max_width || 360;
                document.getElementById('portal-icon-size').value = config.icon_size || 36;
                document.getElementById('portal-status-container-size').value = config.status_icon_container_size || 38;
                document.getElementById('portal-banner-height').value = config.banner_height || 190;
                
                // Banner Settings
                // Default to true if undefined
                document.getElementById('portal-use-default-banner').checked = config.use_default_banner !== false;
                if (config.default_banner_file) {
                    document.getElementById('portal-default-banner-file').value = config.default_banner_file;
                }
                
                // Hide Voucher Code Setting
                const hideVoucherToggle = document.getElementById('portal-hide-voucher-code');
                if (hideVoucherToggle) {
                    hideVoucherToggle.checked = config.hide_voucher_code || false;
                }

                // Ticker Settings
                const tickerEnabledToggle = document.getElementById('portal-ticker-enabled');
                if (tickerEnabledToggle) {
                    tickerEnabledToggle.checked = config.ticker_enabled || false;
                }
                const tickerTextInput = document.getElementById('portal-ticker-text');
                if (tickerTextInput) {
                    tickerTextInput.value = config.ticker_text || '';
                }

                // Banner Mode
                const mode = config.banner_mode || 'fixed';
                if (mode === 'slideshow') {
                    document.getElementById('mode-slideshow').checked = true;
                } else {
                    document.getElementById('mode-fixed').checked = true;
                }

                // Slideshow Interval
                if (config.slideshow_interval) {
                    document.getElementById('portal-slideshow-interval').value = config.slideshow_interval;
                }

                // Footer Settings
                document.getElementById('portal-footer-text').value = config.footer_text || '';
                document.getElementById('portal-footer-link').value = config.footer_link || '';

                toggleBannerMode();
                toggleBannerUpload();
                
                if (mode === 'slideshow') {
                    // Pass the already fetched images to save a call? 
                    // Or just let it fetch again (easier refactor)
                    renderSlideshowImages(availableImages);
                }

            } catch (e) {
                console.error("Failed to load portal config", e);
            }
        }

        function toggleBannerMode() {
            const isSlideshow = document.getElementById('mode-slideshow').checked;
            const fixedSettings = document.getElementById('fixed-banner-settings');
            const slideshowSettings = document.getElementById('slideshow-settings');
            
            if (isSlideshow) {
                fixedSettings.style.display = 'none';
                slideshowSettings.style.display = 'block';
                loadSlideshowImages(); // Ensure loaded
            } else {
                fixedSettings.style.display = 'contents';
                slideshowSettings.style.display = 'none';
            }
        }

        async function loadSlideshowImages() {
            try {
                const res = await fetch('/api/admin/slideshow-images');
                const images = await res.json();
                renderSlideshowImages(images);
            } catch (e) {
                console.error("Failed to load slideshow images", e);
            }
        }

        function renderSlideshowImages(images) {
            const container = document.getElementById('slideshow-list');
            container.innerHTML = '';
            
            if (!images || images.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted); width:100%; text-align:center;">No slides uploaded</div>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.style.cssText = 'position:relative; width:100px; height:60px; border:1px solid var(--border); border-radius:4px; overflow:hidden;';
                
                const imgEl = document.createElement('img');
                imgEl.src = `/slideshow/${img}`;
                imgEl.style.cssText = 'width:100%; height:100%; object-fit:cover;';
                
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.style.cssText = 'position:absolute; top:2px; right:2px; background:rgba(231, 76, 60, 0.9); color:white; border:none; border-radius:50%; width:20px; height:20px; line-height:18px; cursor:pointer; font-weight:bold; padding:0;';
                delBtn.onclick = () => deleteSlideshowImage(img);

                div.appendChild(imgEl);
                div.appendChild(delBtn);
                container.appendChild(div);
            });
        }

        async function uploadSlideshowImage() {
            const fileInput = document.getElementById('portal-slideshow-upload');
            const file = fileInput.files[0];
            if (!file) return alert('Please select an image');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                try {
                    const res = await fetch('/api/admin/upload-slideshow-image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            image: base64,
                            type: file.type
                        })
                    });
                    
                    if (res.ok) {
                        alert('Slide added successfully');
                        fileInput.value = ''; // Reset
                        loadSlideshowImages();
                    } else {
                        alert('Failed to add slide');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error uploading slide');
                }
            };
            reader.readAsDataURL(file);
        }

        async function deleteSlideshowImage(filename) {
            if (!confirm('Delete this slide?')) return;
            try {
                const res = await fetch(`/api/admin/slideshow-image/${filename}`, { method: 'DELETE' });
                if (res.ok) {
                    loadSlideshowImages();
                } else {
                    alert('Failed to delete slide');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting slide');
            }
        }

        function toggleDrawer(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            card.classList.toggle('drawer-open');
            const content = card.querySelector('.drawer-content');
            if (card.classList.contains('drawer-open')) {
                content.style.maxHeight = content.scrollHeight + "px";
                // Allow dynamic height after transition
                setTimeout(() => {
                    if (card.classList.contains('drawer-open')) {
                        content.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // Set fixed height first to allow transition
                content.style.maxHeight = content.scrollHeight + "px";
                setTimeout(() => {
                    content.style.maxHeight = null;
                }, 10);
            }
        }

        function toggleBannerUpload() {
            const useDefault = document.getElementById('portal-use-default-banner').checked;
            const uploadSection = document.getElementById('banner-upload-section');
            const selectorSection = document.getElementById('default-banner-selector');
            
            if (useDefault) {
                uploadSection.style.display = 'none';
                selectorSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'block';
                selectorSection.style.display = 'none';
            }
        }

        async function savePortalConfig(event) {
            event.preventDefault();
            const containerWidth = document.getElementById('portal-container-width').value;
            const iconSize = document.getElementById('portal-icon-size').value;
            const statusContainerSize = document.getElementById('portal-status-container-size').value;
            const bannerHeight = document.getElementById('portal-banner-height').value;
            const useDefault = document.getElementById('portal-use-default-banner').checked;
            const defaultFile = document.getElementById('portal-default-banner-file').value;
            const hideVoucherCode = document.getElementById('portal-hide-voucher-code').checked;
            const tickerEnabled = document.getElementById('portal-ticker-enabled').checked;
            const tickerText = document.getElementById('portal-ticker-text').value;
            
            // New Fields
            const bannerMode = document.querySelector('input[name="banner_mode"]:checked').value;
            const slideshowInterval = document.getElementById('portal-slideshow-interval').value;
            const footerText = document.getElementById('portal-footer-text').value;
            const footerLink = document.getElementById('portal-footer-link').value;
            const theme = document.getElementById('portal-theme-select').value;

            try {
                await fetch('/api/admin/portal-config', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        container_width: containerWidth,
                        icon_size: iconSize,
                        status_container_size: statusContainerSize,
                        banner_height: bannerHeight,
                        use_default_banner: useDefault,
                        default_banner_file: defaultFile,
                        hide_voucher_code: hideVoucherCode,
                        ticker_enabled: tickerEnabled,
                        ticker_text: tickerText,
                        banner_mode: bannerMode,
                        slideshow_interval: slideshowInterval,
                        footer_text: footerText,
                        footer_link: footerLink,
                        theme: theme
                    })
                });
                alert('Portal config saved successfully');
            } catch (e) {
                console.error('Failed to save portal config:', e);
                alert('Failed to save portal config');
            }
        }

        async function uploadPortalBanner() {
            const fileInput = document.getElementById('portal-banner-upload');
            const file = fileInput.files[0];
            if (!file) return alert('Please select a banner image');
            
            // Limit file size to 2MB
            if (file.size > 2 * 1024 * 1024) return alert('File size must be less than 2MB');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                try {
                    const res = await fetch('/api/admin/upload-banner', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            image: base64Image,
                            type: file.type
                        })
                    });
                    
                    if (res.ok) {
                        alert('Banner uploaded successfully');
                        fileInput.value = '';
                    } else {
                        alert('Failed to upload banner');
                    }
                } catch (e) {
                    console.error('Failed to upload banner:', e);
                    alert('Failed to upload banner');
                }
            };
            reader.readAsDataURL(file);
        }



        // --- Firewall / AdBlocker Logic ---
        async function loadFirewallRules() {
            try {
                const res = await fetch('/api/admin/firewall/rules');
                const rules = await res.json();
                const tbody = document.querySelector('#firewall-table tbody');
                tbody.innerHTML = '';
                
                if (rules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No active firewall rules.</td></tr>';
                    return;
                }

                rules.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold;">${r.port}</td>
                        <td><span class="badge" style="background:var(--text-muted); color:white;">${r.protocol.toUpperCase()}</span></td>
                        <td>${r.comment || '-'}</td>
                        <td style="font-size:0.85rem; color:var(--text-muted);">${new Date(r.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteFirewallRule(${r.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading firewall rules", e);
            }
        }

        function showAddRuleModal() {
            document.getElementById('firewall-rule-modal').style.display = 'flex';
        }

        async function addFirewallRule() {
            const port = document.getElementById('fw-port').value;
            const protocol = document.getElementById('fw-protocol').value;
            const comment = document.getElementById('fw-comment').value;

            if (!port) {
                alert("Port is required");
                return;
            }

            try {
                const res = await fetch('/api/admin/firewall/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ port, protocol, comment })
                });

                if (res.ok) {
                    document.getElementById('firewall-rule-modal').style.display = 'none';
                    document.getElementById('fw-port').value = '';
                    document.getElementById('fw-comment').value = '';
                    loadFirewallRules();
                    alert("Rule added successfully. Traffic on port " + port + " is now blocked.");
                } else {
                    const data = await res.json();
                    alert("Failed to add rule: " + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error("Add Rule Error", e);
                alert("Error adding rule");
            }
        }

        async function deleteFirewallRule(id) {
            if (!await showConfirm("Are you sure you want to remove this rule?")) return;

            try {
                const res = await fetch(`/api/admin/firewall/rules/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadFirewallRules();
                } else {
                    alert("Failed to delete rule");
                }
            } catch (e) {
                console.error("Delete Rule Error", e);
            }
        }

        // Voucher Management Functions
        function generateRandomBatchId() {
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let rand = '';
            for(let i=0; i<4; i++) {
                rand += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const id = 'B' + Date.now().toString(36).toUpperCase() + rand;
            const el = document.getElementById('v-batch-id');
            if(el) el.value = id;
            return id;
        }

        function openVoucherModal() {
            generateRandomBatchId();
            document.getElementById('voucher-modal').style.display = 'flex';
        }

        function closeVoucherModal() {
            document.getElementById('voucher-modal').style.display = 'none';
        }

        function toggleCustomVoucher() {
            const isRandom = document.getElementById('v-random').checked;
            const customInput = document.getElementById('v-custom');
            customInput.disabled = isRandom;
            customInput.style.opacity = isRandom ? 0.7 : 1;
        }

        // --- Voucher Bulk Actions ---
        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.voucher-select');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.voucher-select:checked');
            const btn = document.getElementById('btn-delete-selected');
            if (checkboxes.length > 0) {
                btn.style.display = 'block';
                btn.textContent = `Delete Selected (${checkboxes.length})`;
            } else {
                btn.style.display = 'none';
            }
        }

        async function deleteSelectedVouchers() {
            const checkboxes = document.querySelectorAll('.voucher-select:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) return;
            
            if (!await showConfirm(`Are you sure you want to delete ${ids.length} voucher(s)?`, true)) return;

            try {
                const res = await fetch('/api/admin/vouchers', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    alert(`Successfully deleted ${data.count} voucher(s).`);
                    loadVouchersData();
                    document.getElementById('select-all-vouchers').checked = false;
                    document.getElementById('btn-delete-selected').style.display = 'none';
                } else {
                    const errData = await res.json().catch(() => ({}));
                    alert(`Failed to delete vouchers: ${res.status} ${res.statusText} ${errData.error ? '- ' + errData.error : ''}`);
                }
            } catch (e) {
                console.error("Delete error", e);
                alert("Error deleting vouchers");
            }
        }

        async function loadVoucherBatches() {
            try {
                const res = await fetch('/api/admin/voucher-batches');
                if (res.status === 401) return;
                const batches = await res.json();
                const select = document.getElementById('voucher-batch-filter');
                if (select) {
                    const current = select.value;
                    select.innerHTML = '<option value="">All</option>';
                    batches.forEach(b => {
                        const option = document.createElement('option');
                        option.value = b.batch_id;
                        const label = `${b.batch_id} â€¢ ${b.plan_name || 'Plan'} â€¢ ${b.count} pcs â€¢ ₱${b.price || 0}`;
                        option.textContent = label;
                        select.appendChild(option);
                    });
                    if (current) {
                        select.value = current;
                    }
                }

                const tableBody = document.querySelector('#voucher-batches-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    if (batches.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="6" style="padding:15px; text-align:center;">No voucher batches found</td>';
                        tableBody.appendChild(tr);
                    } else {
                        batches.forEach(b => {
                            const tr = document.createElement('tr');
                            const createdDate = b.created_at ? new Date(b.created_at) : null;
                            const createdStr = createdDate ? createdDate.toLocaleString() : '';
                            tr.innerHTML = `
                                <td style="padding:10px;">${b.batch_id}</td>
                                <td style="padding:10px;">${createdStr}</td>
                                <td style="padding:10px;">${b.plan_name || 'Plan'}</td>
                                <td style="padding:10px;">₱${b.price || 0}</td>
                                <td style="padding:10px;">${b.count}</td>
                                <td style="padding:10px; text-align:center;">
                                    <button class="btn btn-sm btn-primary" onclick="showBatchVoucherTicketsForId('${b.batch_id}')">Show / Print</button>
                                    <button class="btn btn-sm btn-secondary" style="margin-left:5px;" onclick="exportVoucherBatch('${b.batch_id}')">CSV</button>
                                    <button class="btn btn-sm btn-danger" style="margin-left:5px;" onclick="deleteVoucherBatch('${b.batch_id}')">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    }
                }
            } catch (e) {
                console.error("Voucher batch load error", e);
            }
        }

        async function exportVoucherBatch(batchId) {
            if (!batchId) return;
            window.location.href = '/api/admin/voucher-batches/' + encodeURIComponent(batchId) + '/export';
        }

        async function deleteVoucherBatch(batchId) {
            if (!batchId) return;
            if (!confirm(`Are you sure you want to delete Batch ${batchId}? This will delete all vouchers in this batch.`)) {
                return;
            }
            try {
                const res = await fetch('/api/admin/voucher-batches/' + encodeURIComponent(batchId), {
                    method: 'DELETE'
                });
                if (res.status === 401) return location.reload();
                if (!res.ok) {
                    const data = await res.json();
                    alert(data.error || 'Failed to delete batch');
                    return;
                }
                loadVoucherBatches();
                loadVouchersData(); // Refresh main list too
            } catch (e) {
                console.error('Delete batch error', e);
                alert('Failed to delete batch');
            }
        }

        async function loadVouchersData() {
            try {
                const showUsedEl = document.getElementById('voucher-show-used');
                const includeUsed = showUsedEl && showUsedEl.checked ? '1' : '0';
                const batchSelect = document.getElementById('voucher-batch-filter');
                const batchId = batchSelect ? encodeURIComponent(batchSelect.value) : '';

                const previouslySelected = new Set(
                    Array.from(document.querySelectorAll('.voucher-select:checked')).map(cb => parseInt(cb.value, 10))
                );
                const selectAllEl = document.getElementById('select-all-vouchers');
                const selectAllWasChecked = selectAllEl ? selectAllEl.checked : false;

                const res = await fetch('/api/admin/vouchers?includeUsed=' + includeUsed + '&batchId=' + batchId);
                if (res.status === 401) return location.reload();
                const vouchers = await res.json();
                const tbody = document.querySelector('#voucher-table tbody');
                tbody.innerHTML = '';
                vouchers.forEach(v => {
                    const tr = document.createElement('tr');
                    
                    const d = Math.floor(v.duration / 86400);
                    const h = Math.floor((v.duration % 86400) / 3600);
                    const m = Math.floor((v.duration % 3600) / 60);
                    const durationStr = `${d > 0 ? d + 'd ' : ''}${h > 0 ? h + 'h ' : ''}${m}m`;

                    const status = v.is_used ? 'Used' : 'Active';
                    tr.innerHTML = `
                        <td style="padding:10px; border-bottom:1px solid var(--border);"><input type="checkbox" class="voucher-select" value="${v.id}" onclick="updateDeleteButton()"></td>
                        <td style="padding:10px; border-bottom:1px solid var(--border);">${v.code}</td>
                        <td style="padding:10px; border-bottom:1px solid var(--border);">${durationStr}</td>
                        <td style="padding:10px; border-bottom:1px solid var(--border);">${v.plan_name || 'Standard'}</td>
                        <td style="padding:10px; border-bottom:1px solid var(--border);">₱${v.price || 0}.00</td>
                        <td style="padding:10px; border-bottom:1px solid var(--border);">${status}</td>
                    `;
                    const checkbox = tr.querySelector('.voucher-select');
                    if (checkbox && previouslySelected.has(v.id)) {
                        checkbox.checked = true;
                    }
                    tbody.appendChild(tr);
                });

                if (selectAllEl) {
                    if (selectAllWasChecked) {
                        selectAllEl.checked = true;
                        const allCheckboxes = document.querySelectorAll('.voucher-select');
                        allCheckboxes.forEach(cb => cb.checked = true);
                    } else {
                        selectAllEl.checked = previouslySelected.size > 0 &&
                            vouchers.every(v => previouslySelected.has(v.id));
                    }
                }

                updateDeleteButton();
            } catch (e) {
                console.error("Voucher load error", e);
            }
        }

        async function openGeneratedVoucherModal(batchId, codes, options) {
            const modal = document.getElementById('voucher-generated-modal');
            const title = document.getElementById('voucher-generated-title');
            const body = document.getElementById('voucher-generated-body');
            if (!modal || !title || !body) return;
            const plan = options.plan_name || 'Standard';
            const price = options.price || 0;
            const durationMinutes = options.duration || 0;
            const d = Math.floor(durationMinutes / 1440);
            const h = Math.floor((durationMinutes % 1440) / 60);
            const m = durationMinutes % 60;
            const durationStr = `${d > 0 ? d + 'd ' : ''}${h > 0 ? h + 'h ' : ''}${m}m`;
            const ssidInput = document.getElementById('wifi-ssid');
            const ssid = ssidInput ? (ssidInput.value || 'NeoFi_Built-In_WiFi') : 'NeoFi_Built-In_WiFi';
            const downMbps = options.download_speed ? Math.round(options.download_speed / 1024) : 0;
            const upMbps = options.upload_speed ? Math.round(options.upload_speed / 1024) : 0;
            const loginUrl = window.location.origin + '/';
            const ipAddress = window.location.hostname;
            title.textContent = `Batch ${batchId}`;
            body.innerHTML = '';
            body.className = 'voucher-print-grid';
            codes.forEach(code => {
                const card = document.createElement('div');
                card.className = 'voucher-print-card';
                const qrId = `voucher-qr-${code}`;
                card.innerHTML = `
                    <div class="voucher-price-strip">
                        <div class="voucher-price-text">₱${price}</div>
                    </div>
                    <div class="voucher-main">
                        <div class="voucher-print-code">${code}</div>
                        <div class="voucher-meta-lines">
                            <div class="voucher-print-meta">Hotspot: ${ssid}</div>
                            <div class="voucher-print-meta">IP: ${ipAddress}</div>
                            <div class="voucher-print-meta">Plan: ${plan}</div>
                            <div class="voucher-print-meta">Duration: ${durationStr}</div>
                            <div class="voucher-print-meta">Speed: ${downMbps} Mbps / ${upMbps} Mbps</div>
                            <div class="voucher-print-meta">Login: ${loginUrl}</div>
                        </div>
                    </div>
                    <div class="voucher-qr-wrap">
                        <div class="voucher-print-qr" id="${qrId}"></div>
                    </div>
                `;
                body.appendChild(card);
                const qrContainer = card.querySelector('.voucher-print-qr');
                if (qrContainer && window.QRCode) {
                    new QRCode(qrContainer, {
                        text: code,
                        width: 56,
                        height: 56,
                        margin: 0
                    });
                }
            });
            modal.style.display = 'flex';
        }

        function printGeneratedVouchers() {
            if (document && document.body) {
                document.body.classList.add('voucher-printing');
            }
            window.print();
        }

        async function showBatchVoucherTickets() {
            try {
                const select = document.getElementById('voucher-batch-filter');
                if (!select || !select.value) {
                    alert('Please select a batch first.');
                    return;
                }
                const batchId = select.value;
                await showBatchVoucherTicketsForId(batchId);
            } catch (e) {
                console.error('Error loading batch vouchers for print', e);
                alert('Failed to load vouchers for this batch');
            }
        }

        async function showBatchVoucherTicketsForId(batchId) {
            try {
                const res = await fetch('/api/admin/vouchers?includeUsed=1&batchId=' + encodeURIComponent(batchId));
                if (res.status === 401) return location.reload();
                const vouchers = await res.json();
                if (!Array.isArray(vouchers) || vouchers.length === 0) {
                    alert('No vouchers found for this batch.');
                    return;
                }
                const first = vouchers[0];
                const options = {
                    plan_name: first.plan_name || 'Standard',
                    price: first.price || 0,
                    duration: Math.round((first.duration || 0) / 60),
                    download_speed: first.download_speed || 0,
                    upload_speed: first.upload_speed || 0
                };
                const codes = vouchers.map(v => v.code);
                openGeneratedVoucherModal(batchId, codes, options);
            } catch (e) {
                console.error('Error loading batch vouchers for print', e);
                alert('Failed to load vouchers for this batch');
            }
        }

        function closeGeneratedVoucherModal() {
            const modal = document.getElementById('voucher-generated-modal');
            if (modal) modal.style.display = 'none';
        }

        async function generateVouchers() {
            try {
                const options = {
                    batch_id: document.getElementById('v-batch-id').value,
                    count: parseInt(document.getElementById('v-qty').value),
                    duration: (parseInt(document.getElementById('v-days').value || 0) * 1440) + 
                              (parseInt(document.getElementById('v-hours').value || 0) * 60) + 
                              parseInt(document.getElementById('v-minutes').value || 0),
                    plan_name: document.getElementById('v-name').value || 'Standard',
                    price: parseFloat(document.getElementById('v-price').value) || 0,
                    download_speed: parseInt(document.getElementById('v-dl').value) * 1024, // Convert Mbps to kbps
                    upload_speed: parseInt(document.getElementById('v-ul').value) * 1024, // Convert Mbps to kbps
                    is_random: document.getElementById('v-random').checked,
                    prefix: document.getElementById('v-prefix').value,
                    length: parseInt(document.getElementById('v-length').value),
                    custom_code: document.getElementById('v-custom').value
                };

                const res = await fetch('/api/admin/vouchers/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(options)
                });

                const data = await res.json();
                if (data.success) {
                    closeVoucherModal();
                    await loadVoucherBatches();
                    const batchSelect = document.getElementById('voucher-batch-filter');
                    if (batchSelect && data.batchId) {
                        batchSelect.value = data.batchId;
                    }
                    await loadVouchersData();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (e) {
                console.error("Voucher generation error", e);
                alert("Failed to generate vouchers");
            }
        }

        async function loadInterfaces() {
            try {
                const res = await fetch('/api/admin/network-interfaces');
                if (res.status === 401) return location.reload();
                const interfaces = await res.json();
                
                const tbodyPhysical = document.querySelector('#interfaces-table-physical tbody');
                const tbodyVlan = document.querySelector('#interfaces-table-vlan tbody');
                
                if (tbodyPhysical) tbodyPhysical.innerHTML = '';
                if (tbodyVlan) tbodyVlan.innerHTML = '';
                
                if (interfaces.length === 0) {
                    if (tbodyPhysical) tbodyPhysical.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No interfaces found</td></tr>';
                    if (tbodyVlan) tbodyVlan.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No interfaces found</td></tr>';
                    return;
                }

                let hasPhysical = false;
                let hasVlan = false;

                interfaces.forEach(iface => {
                    if (iface.name === 'lo') return; // Hide loopback
                    
                    const isVlan = iface.name.includes('.') || iface.name.startsWith('vlan');
                    
                    // Status Badge
                    let statusColor = 'secondary';
                    let statusText = iface.operstate || 'Unknown';
                    if (statusText === 'UP') statusColor = 'success';
                    else if (statusText === 'DOWN') statusColor = 'danger';
                    
                    const statusBadge = `<span class="badge bg-${statusColor}">${statusText}</span>`;

                    // Speed Info
                    let speedInfo = '<span style="color:var(--text-muted);font-size:0.85rem;">N/A</span>';
                    if (iface.speed && iface.speed !== 'N/A') {
                        speedInfo = `<div style="font-weight:600;">${iface.speed}</div>`;
                        if (iface.duplex) speedInfo += `<div style="font-size:0.75rem;color:var(--text-muted);">${iface.duplex}</div>`;
                    }

                    const tr = document.createElement('tr');
                    
                    if (isVlan) {
                        // VLAN Table: Name, Status, IP, MAC, Netmask, Family
                        tr.innerHTML = `
                            <td style="font-weight:600; color: var(--text-main);">${iface.name}</td>
                            <td>${statusBadge}</td>
                            <td>${iface.ip}</td>
                            <td style="font-family:monospace;">${iface.mac}</td>
                            <td>${iface.netmask}</td>
                            <td>${iface.family}</td>
                        `;
                        if (tbodyVlan) {
                            tbodyVlan.appendChild(tr);
                            hasVlan = true;
                        }
                    } else {
                        // Physical Table: Name, Status, Speed, IP, MAC, Netmask, Family
                        tr.innerHTML = `
                            <td style="font-weight:600; color: var(--text-main);">${iface.name}</td>
                            <td>${statusBadge}</td>
                            <td>${speedInfo}</td>
                            <td>${iface.ip}</td>
                            <td style="font-family:monospace;">${iface.mac}</td>
                            <td>${iface.netmask}</td>
                            <td>${iface.family}</td>
                        `;
                        if (tbodyPhysical) {
                            tbodyPhysical.appendChild(tr);
                            hasPhysical = true;
                        }
                    }
                });

                if (!hasPhysical && tbodyPhysical) tbodyPhysical.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:10px; color:var(--text-muted);">No physical interfaces found</td></tr>';
                if (!hasVlan && tbodyVlan) tbodyVlan.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:10px; color:var(--text-muted);">No VLAN interfaces found</td></tr>';

            } catch (e) {
                console.error("Interfaces load error", e);
            }
        }

        // Init
        checkAuth();
        loadCompanySettings();

        // --- Pull to Refresh Logic (Touch & Mouse) ---
        const contentScroll = document.querySelector('.content-scroll');
        const ptr = document.getElementById('pull-to-refresh');
        const ptrIcon = ptr.querySelector('.ptr-icon');
        const ptrText = ptr.querySelector('.ptr-text');

        let startY = 0;
        let isPulling = false;
        let isRefreshing = false;

        const handleStart = (y) => {
            if (contentScroll.scrollTop === 0) {
                startY = y;
                isPulling = true;
            }
        };

        const handleMove = (y) => {
            if (!isPulling || isRefreshing) return;
            const diff = y - startY;

            if (diff > 0 && contentScroll.scrollTop === 0) {
                // Resistance
                const move = Math.min(diff * 0.5, 80);
                ptr.style.marginTop = `${move - 50}px`; // -50 is hidden
                
                if (move > 40) {
                    ptrText.textContent = 'Release to refresh';
                    ptrIcon.classList.add('rotate');
                } else {
                    ptrText.textContent = 'Pull to refresh';
                    ptrIcon.classList.remove('rotate');
                }
            } else {
                isPulling = false;
                ptr.style.marginTop = '-50px';
            }
        };

        const handleEnd = async () => {
            if (!isPulling || isRefreshing) return;
            isPulling = false;
            
            if (ptrIcon.classList.contains('rotate')) {
                isRefreshing = true;
                ptr.style.marginTop = '0px';
                ptrText.textContent = 'Reloading...';
                ptrIcon.classList.remove('rotate');
                ptrIcon.classList.add('spin');
                
                // Full page refresh as requested
                location.reload();
            } else {
                ptr.style.marginTop = '-50px';
            }
        };

        // Touch Events
        contentScroll.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientY), { passive: true });
        contentScroll.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientY), { passive: true });
        contentScroll.addEventListener('touchend', handleEnd);

        // Mouse Events
        contentScroll.addEventListener('mousedown', (e) => handleStart(e.clientY));
        contentScroll.addEventListener('mousemove', (e) => {
            if(isPulling && e.buttons === 1) handleMove(e.clientY);
            else if(isPulling) { isPulling = false; ptr.style.marginTop = '-50px'; }
        });
        contentScroll.addEventListener('mouseup', handleEnd);
        contentScroll.addEventListener('mouseleave', () => {
            if(isPulling) { isPulling = false; ptr.style.marginTop = '-50px'; }
        });

        // --- ZeroTier Integration ---
        async function loadZeroTierStatus() {
            const badge = document.getElementById('zt-status-badge');
            const infoArea = document.getElementById('zt-info-area');
            const networksList = document.getElementById('zt-networks-list');
            const installArea = document.getElementById('zt-install-area');
            const configArea = document.getElementById('zt-config-area');
            
            if (!badge) return;

            try {
                const res = await fetch('/api/admin/network/zerotier');
                const data = await res.json();

                if (!data.installed) {
                    badge.style.background = 'var(--status-expired)';
                    badge.textContent = 'Not Installed';
                    if(installArea) installArea.style.display = 'block';
                    if(configArea) configArea.style.display = 'none';
                    return;
                }

                // Installed
                if(installArea) installArea.style.display = 'none';
                if(configArea) configArea.style.display = 'block';

                // Update Status Badge
                if (data.online) {
                    badge.style.background = 'var(--gauge-6)';
                    badge.textContent = 'Online';
                } else {
                    badge.style.background = 'var(--gauge-4)';
                    badge.textContent = 'Offline';
                }

                // Update Info Area
                infoArea.style.display = 'block';
                document.getElementById('zt-version').textContent = data.version || 'Unknown';
                document.getElementById('zt-device-id').textContent = data.deviceId || 'Unknown';
                document.getElementById('zt-status-text').textContent = data.online ? 'ONLINE' : 'OFFLINE';

                // Update Networks List
                networksList.innerHTML = '';
                if (data.networks && data.networks.length > 0) {
                    data.networks.forEach(net => {
                        const row = document.createElement('div');
                        row.style.background = 'var(--bg-body)';
                        row.style.padding = '10px';
                        row.style.borderRadius = '4px';
                        row.style.marginBottom = '8px';
                        row.style.border = '1px solid var(--border)';
                        row.style.display = 'flex';
                        row.style.justifyContent = 'space-between';
                        row.style.alignItems = 'center';
                        
                        row.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color: var(--text-main);">${net.name || net.id}</div>
                                <div style="font-size:0.8rem; color: var(--text-muted);">
                                    ID: ${net.id} | Status: <span style="color:${net.status === 'OK' ? 'var(--success)' : 'var(--danger)'}">${net.status}</span>
                                </div>
                                <div style="font-size:0.8rem; color: var(--text-muted);">IP: ${net.ip || 'None'}</div>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="leaveZeroTier('${net.id}')">Leave</button>
                        `;
                        networksList.appendChild(row);
                    });
                } else {
                    networksList.innerHTML = '<div style="font-size:0.85rem; color: var(--text-muted); text-align:center; padding:10px;">Not joined to any networks</div>';
                }

            } catch (e) {
                console.error("ZeroTier status error", e);
                badge.style.background = 'var(--status-expired)';
                badge.textContent = 'Error';
            }
        }

        async function installZeroTier() {
            const btn = document.querySelector('button[onclick="installZeroTier()"]');
            const progressContainer = document.getElementById('zt-install-progress');
            const progressBar = document.getElementById('zt-install-bar');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Installing...';
            
            // Reset and show progress
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.style.backgroundColor = 'var(--secondary)'; // Reset color
            progressContainer.style.display = 'block';

            // Simulated progress animation
            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 5; // Random increment
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                }
            }, 500); // Update every 500ms

            try {
                const res = await fetch('/api/admin/network/zerotier/install', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                clearInterval(interval);
                
                if (res.ok) {
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressBar.style.backgroundColor = 'var(--gauge-6)'; // Success color
                    btn.textContent = 'Installed!';
                    
                    setTimeout(() => {
                        alert("ZeroTier installed successfully! The system may need a moment to initialize the service.");
                        loadZeroTierStatus();
                    }, 500);
                } else {
                    const err = await res.json();
                    progressBar.style.backgroundColor = 'var(--status-expired)';
                    progressBar.textContent = 'Failed';
                    alert("Installation failed: " + (err.error || "Unknown error"));
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (e) {
                clearInterval(interval);
                progressBar.style.backgroundColor = 'var(--status-expired)';
                progressBar.textContent = 'Error';
                alert("Error during installation request");
                console.error(e);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function joinZeroTier() {
            const input = document.getElementById('zt-network-id');
            const networkId = input.value.trim();
            
            if (networkId.length !== 16) {
                alert("Invalid Network ID. It must be 16 characters.");
                return;
            }

            const btn = document.querySelector('button[onclick="joinZeroTier()"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Joining...';

            try {
                const res = await fetch('/api/admin/network/zerotier/join', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ networkId })
                });

                if (res.ok) {
                    alert("Joined network! It may take a few seconds to appear.");
                    input.value = '';
                    loadZeroTierStatus();
                } else {
                    const err = await res.json();
                    alert("Failed to join: " + (err.error || "Unknown error"));
                }
            } catch (e) {
                alert("Error joining network");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function leaveZeroTier(networkId) {
            if (!await showConfirm(`Are you sure you want to leave network ${networkId}?`, true)) return;

            try {
                 const res = await fetch('/api/admin/network/zerotier/leave', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ networkId })
                });

                if (res.ok) {
                    loadZeroTierStatus();
                } else {
                    alert("Failed to leave network");
                }
            } catch (e) {
                alert("Error leaving network");
            }
        }

        // --- Network Configuration ---
        // --- Walled Garden ---
        async function loadWalledGarden() {
            try {
                const res = await fetch('/api/admin/walled-garden');
                const list = await res.json();
                
                const tbody = document.querySelector('#wg-table tbody');
                tbody.innerHTML = '';
                
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No entries found</td></tr>';
                    return;
                }

                list.forEach(item => {
                    const tr = document.createElement('tr');
                    let badgeClass = 'badge-secondary';
                    if (item.type === 'ACCEPT' || item.type === 'allow') badgeClass = 'badge-success';
                    if (item.type === 'DROP' || item.type === 'deny') badgeClass = 'badge-danger';
                    
                    tr.innerHTML = `
                        <td>${item.domain}</td>
                        <td><span class="badge ${badgeClass}">${item.type.toUpperCase()}</span></td>
                        <td>${item.address || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteWalledGarden(${item.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading walled garden:", e);
            }
        }

        async function addWalledGarden() {
            const domain = document.getElementById('wg-modal-domain').value.trim();
            const type = document.getElementById('wg-modal-type').value;
            
            if (!domain) return alert('Domain is required');
            
            try {
                const res = await fetch('/api/admin/walled-garden', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ domain, type })
                });
                
                if (res.ok) {
                    closeWalledGardenModal();
                    loadWalledGarden();
                } else {
                    const data = await res.json();
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error("Error adding entry:", e);
                alert("Failed to add entry");
            }
        }

        function openWalledGardenModal() {
            document.getElementById('wg-modal-domain').value = '';
            document.getElementById('wg-modal-type').value = 'allow';
            document.getElementById('walled-garden-modal').style.display = 'flex';
        }

        function closeWalledGardenModal() {
            document.getElementById('walled-garden-modal').style.display = 'none';
        }

        async function deleteWalledGarden(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            try {
                const res = await fetch('/api/admin/walled-garden/' + id, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    loadWalledGarden();
                } else {
                    alert('Failed to delete entry');
                }
            } catch (e) {
                console.error("Error deleting entry:", e);
            }
        }

        async function loadNetworkConfig() {
            updateWanStatus(); // Check status on load
            loadZeroTierStatus(); // Check ZeroTier status
            try {
                // Load Interfaces for Dropdown
                const resIfaces = await fetch('/api/admin/network-interfaces');
                const interfaces = await resIfaces.json();
                window.cachedInterfaces = interfaces;

                // Load VLANs
                let vlans = [];
                try {
                    const resVlans = await fetch('/api/admin/network/vlans');
                    if (resVlans.ok) {
                        vlans = await resVlans.json();
                    }
                } catch (e) {
                    console.error("Error loading VLANs:", e);
                }



                // Load Configured Bridges (Safe Load) - REMOVED redundant fetch
                // Bridges are loaded via loadBridges() later
                let bridges = []; 


                // --- Build Visual Interface Map ---
                visualInterfaceMap = {};
                let enxCounter = 1;
                
                // Sort by name to ensure consistent ordering for enx mapping
                interfaces.sort((a, b) => a.name.localeCompare(b.name));
                
                interfaces.forEach(iface => {
                    const name = iface.name;
                    if (name === 'end0') {
                        visualInterfaceMap[name] = 'eth0';
                    } else if (name.startsWith('enx')) {
                        visualInterfaceMap[name] = 'eth' + enxCounter++;
                    } else {
                        visualInterfaceMap[name] = name;
                    }
                });
                window.visualInterfaceMap = visualInterfaceMap;

                const select = document.getElementById('wan-interface');
                select.innerHTML = '<option value="" disabled>Select Interface</option>';
                
                const vlanSelect = document.getElementById('vlan-parent');
                vlanSelect.innerHTML = '<option value="" disabled selected>Select Parent Interface</option>';

                // 1. Add Physical Interfaces
                interfaces.forEach(iface => {
                    // Skip loopback
                    if (iface.name === 'lo') return;

                    const opt = document.createElement('option');
                    opt.value = iface.name;
                    // Use Visual Name
                    const visualName = visualInterfaceMap[iface.name] || iface.name;
                    opt.textContent = `${visualName} (${iface.mac || 'No MAC'})`;
                    select.appendChild(opt);
                    
                    // Also populate VLAN parent dropdown
                    const vlanOpt = opt.cloneNode(true);
                    vlanSelect.appendChild(vlanOpt);
                });
                
                const dualWan1Select = document.getElementById('dual-wan1-iface');
                const dualWan2Select = document.getElementById('dual-wan2-iface');
                if (dualWan1Select) populateInterfaceSelect(dualWan1Select, interfaces, visualInterfaceMap);
                if (dualWan2Select) populateInterfaceSelect(dualWan2Select, interfaces, visualInterfaceMap);

                // 2. Add VLAN Interfaces (to WAN dropdown only)
                if (vlans && vlans.length > 0) {
                     const group = document.createElement('optgroup');
                     group.label = "VLAN Interfaces";
                     
                     vlans.forEach(v => {
                         const parentVisual = visualInterfaceMap[v.parent] || v.parent;
                         const vlanName = `${parentVisual}.${v.vlanId}`;
                         const opt = document.createElement('option');
                         opt.value = `${v.parent}.${v.vlanId}`; // Keep real value
                         opt.textContent = `${vlanName} (VLAN ${v.vlanId})`;
                         group.appendChild(opt);
                     });
                     select.appendChild(group);
                }

                // Load Current Config
                const resConfig = await fetch('/api/admin/network/wan');
                if (resConfig.ok) {
                    const config = await resConfig.json();
                    
                    if (config.interface) {
                        let targetValue = config.interface;
                        
                        // Check if option with this value exists
                        let exists = Array.from(select.options).some(opt => opt.value === targetValue);

                        if (!exists) {
                            // Check if config matches a visual name (e.g. config 'eth0' vs real 'end0')
                            const realNameEntry = Object.entries(visualInterfaceMap).find(([real, visual]) => visual === config.interface);
                            if (realNameEntry) {
                                targetValue = realNameEntry[0]; // Use the real interface name
                                exists = true;
                            }
                        }

                        if (!exists) {
                            // Only add if truly missing (neither real name nor visual name match)
                            const opt = document.createElement('option');
                            opt.value = config.interface;
                            opt.textContent = config.interface;
                            select.appendChild(opt);
                        }
                        select.value = targetValue;
                    }
                    if (config.mode) document.getElementById('wan-mode').value = config.mode;
                    
                    // Dual WAN Config
                    if (config.dual_wan) {
                        const dw = config.dual_wan;
                        if(dw.strategy) document.getElementById('dual-strategy').value = dw.strategy;
                        
                        if(dw.wan1) {
                            if(dw.wan1.interface) document.getElementById('dual-wan1-iface').value = dw.wan1.interface;
                            if(dw.wan1.type) document.getElementById('dual-wan1-type').value = dw.wan1.type;
                            toggleDualWanFields('wan1');
                            if(dw.wan1.static) {
                                document.getElementById('dual-wan1-ip').value = dw.wan1.static.ip || '';
                                document.getElementById('dual-wan1-gateway').value = dw.wan1.static.gateway || '';
                                document.getElementById('dual-wan1-netmask').value = dw.wan1.static.netmask || '';
                                document.getElementById('dual-wan1-dns').value = dw.wan1.static.dns || '';
                            }
                            if(dw.wan1.pppoe) {
                                document.getElementById('dual-wan1-user').value = dw.wan1.pppoe.username || '';
                                document.getElementById('dual-wan1-pass').value = dw.wan1.pppoe.password || '';
                            }
                        }
                        
                        if(dw.wan2) {
                            if(dw.wan2.interface) document.getElementById('dual-wan2-iface').value = dw.wan2.interface;
                            if(dw.wan2.type) document.getElementById('dual-wan2-type').value = dw.wan2.type;
                            toggleDualWanFields('wan2');
                            if(dw.wan2.static) {
                                document.getElementById('dual-wan2-ip').value = dw.wan2.static.ip || '';
                                document.getElementById('dual-wan2-gateway').value = dw.wan2.static.gateway || '';
                                document.getElementById('dual-wan2-netmask').value = dw.wan2.static.netmask || '';
                                document.getElementById('dual-wan2-dns').value = dw.wan2.static.dns || '';
                            }
                            if(dw.wan2.pppoe) {
                                document.getElementById('dual-wan2-user').value = dw.wan2.pppoe.username || '';
                                document.getElementById('dual-wan2-pass').value = dw.wan2.pppoe.password || '';
                            }
                        }
                    }

                    // Multi WAN Config
                    if (config.multi_wan && Array.isArray(config.multi_wan)) {
                        const tbody = document.querySelector('#multi-wan-table tbody');
                        tbody.innerHTML = '';
                        config.multi_wan.forEach(wan => addMultiWanRow(wan));
                    }

                    // Static
                    if (config.static) {
                        document.getElementById('wan-ip').value = config.static.ip || '';
                        document.getElementById('wan-netmask').value = config.static.netmask || '';
                        document.getElementById('wan-gateway').value = config.static.gateway || '';
                        document.getElementById('wan-dns1').value = config.static.dns1 || '';
                        document.getElementById('wan-dns2').value = config.static.dns2 || '';
                    }

                    // PPPoE
                    if (config.pppoe) {
                        document.getElementById('pppoe-user').value = config.pppoe.username || '';
                        document.getElementById('pppoe-pass').value = config.pppoe.password || '';
                        document.getElementById('pppoe-dns1').value = config.pppoe.dns1 || '';
                        document.getElementById('pppoe-dns2').value = config.pppoe.dns2 || '';
                    }
                }
                
                toggleWanMode();

                loadBridges(); // Load Bridges

                // Populate Bridge Interface Checkboxes
                const bridgeInterfacesDiv = document.getElementById('bridge-interfaces');
                if (bridgeInterfacesDiv) {
                    bridgeInterfacesDiv.innerHTML = '';
                    interfaces.forEach(iface => {
                        // Skip loopback
                        if (iface.name === 'lo') return;
                        
                        const visualName = visualInterfaceMap[iface.name] || iface.name;
                        const wrapper = document.createElement('div');
                        wrapper.style.display = 'flex';
                        wrapper.style.alignItems = 'center';
                        wrapper.style.gap = '5px';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = iface.name;
                        checkbox.id = `br-iface-${iface.name}`;
                        checkbox.style.transform = 'scale(1.2)';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `br-iface-${iface.name}`;
                        label.textContent = visualName;
                        label.style.fontSize = '0.9rem';
                        label.style.cursor = 'pointer';
                        
                        wrapper.appendChild(checkbox);
                        wrapper.appendChild(label);
                        bridgeInterfacesDiv.appendChild(wrapper);
                    });
                }
            } catch (e) {
                console.error("Network config load error", e);
            }
        }



        // --- Bridge Functions ---
        let editingBridgeName = null;

        async function loadBridges() {
            try {
                const res = await fetch('/api/admin/network/bridges');
                let bridges = await res.json();
                
                // Ensure default bridge br0 is listed
                const defaultBridge = bridges.find(b => b.name === 'br0');
                if (!defaultBridge) {
                    bridges.unshift({
                        name: 'br0',
                        interfaces: ['eth0'], // Assumed default
                        ip: '10.0.0.1',
                        netmask: '255.255.255.0',
                        stp: true
                    });
                }

                const tbody = document.querySelector('#bridge-table tbody');
                tbody.innerHTML = '';
                
                if (bridges.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No bridges configured</td></tr>';
                    return;
                }

                bridges.forEach(b => {
                    const tr = document.createElement('tr');
                    // Handle interfaces list safely
                    const ifaceList = Array.isArray(b.interfaces) ? b.interfaces : [];
                    const members = ifaceList.map(i => visualInterfaceMap[i] || i).join(', ') || '-';
                    
                    let deleteBtn = `<button class="btn btn-sm btn-danger" onclick="removeBridge('${b.name}')">Delete</button>`;
                    let editBtn = `<button class="btn btn-sm btn-primary" style="margin-right:5px;" onclick='editBridge(${JSON.stringify(b)})'>Edit</button>`;

                    tr.innerHTML = `
                        <td style="font-weight:600;">${b.name}</td>
                        <td>${members}</td>
                        <td>${b.ip || '-'}</td>
                        <td>${b.netmask || '-'}</td>
                        <td>${b.stp ? 'Enabled' : 'Disabled'}</td>
                        <td>${editBtn}${deleteBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading Bridges", e);
            }
        }

        function openBridgeModal() {
            editingBridgeName = null;
            const titleEl = document.getElementById('bridge-modal-title');
            if(titleEl) titleEl.textContent = "Add Bridge";
            
            document.getElementById('bridge-name').value = 'br' + document.querySelectorAll('#bridge-table tbody tr').length;
            document.getElementById('bridge-name').disabled = false;
            document.getElementById('bridge-ip').value = '';
            document.getElementById('bridge-netmask').value = '255.255.255.0';
            document.getElementById('bridge-stp').checked = false;
            document.querySelectorAll('#bridge-interfaces input').forEach(cb => cb.checked = false);
            document.getElementById('bridge-modal').style.display = 'flex';
        }

        function editBridge(bridge) {
            editingBridgeName = bridge.name;
            const titleEl = document.getElementById('bridge-modal-title');
            if(titleEl) titleEl.textContent = "Edit Bridge";
            
            document.getElementById('bridge-name').value = bridge.name;
            document.getElementById('bridge-name').disabled = true; // Prevent renaming for simplicity
            document.getElementById('bridge-ip').value = bridge.ip || '';
            document.getElementById('bridge-netmask').value = bridge.netmask || '255.255.255.0';
            document.getElementById('bridge-stp').checked = !!bridge.stp;
            
            // Check interfaces
            document.querySelectorAll('#bridge-interfaces input').forEach(cb => {
                cb.checked = bridge.interfaces && bridge.interfaces.includes(cb.value);
            });
            
            document.getElementById('bridge-modal').style.display = 'flex';
        }

        async function saveBridge() {
            const bridge = {
                name: document.getElementById('bridge-name').value,
                ip: document.getElementById('bridge-ip').value,
                netmask: document.getElementById('bridge-netmask').value,
                stp: document.getElementById('bridge-stp').checked,
                interfaces: []
            };

            // Get selected interfaces
            const checkboxes = document.querySelectorAll('#bridge-interfaces input[type="checkbox"]:checked');
            bridge.interfaces = Array.from(checkboxes).map(cb => cb.value);

            if (!bridge.name) {
                alert("Bridge Name is required.");
                return;
            }

            try {
                let url = '/api/admin/network/bridges';
                let method = 'POST';
                
                if (editingBridgeName) {
                    url = `/api/admin/network/bridges/${editingBridgeName}`;
                    method = 'PUT';
                    // If we disabled name input, we don't need to check for name change here unless we want to allow it.
                    // For now, let's assume name is ID.
                }

                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(bridge)
                });
                
                if (res.ok) {
                    alert(`Bridge ${editingBridgeName ? 'updated' : 'added'} successfully.`);
                    document.getElementById('bridge-modal').style.display = 'none';
                    loadBridges();
                } else {
                    const data = await res.json();
                    alert(`Failed to ${editingBridgeName ? 'update' : 'add'} Bridge: ` + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error("Save Bridge error", e);
            }
        }

        async function removeBridge(name) {
            if(!await showConfirm("Are you sure you want to delete this Bridge?", true)) return;
            
            try {
                const res = await fetch(`/api/admin/network/bridges/${name}`, { method: 'DELETE' });
                if (res.ok) {
                    loadBridges();
                } else {
                    alert("Failed to delete Bridge.");
                }
            } catch (e) {
                console.error("Delete Bridge error", e);
            }
        }

        // Helper to populate interface dropdowns
        function populateInterfaceSelect(select, interfaces, visualMap) {
            const currentVal = select.value;
            select.innerHTML = '<option value="" disabled selected>Select Interface</option>';
            
            interfaces.forEach(iface => {
                if (iface.name === 'lo') return;
                const opt = document.createElement('option');
                opt.value = iface.name;
                const visualName = visualMap[iface.name] || iface.name;
                opt.textContent = `${visualName} (${iface.mac || 'No MAC'})`;
                select.appendChild(opt);
            });
            
            // If previous value exists in new options, re-select it
            if (currentVal) select.value = currentVal;
        }

        function toggleDualWanFields(wanPrefix) {
            const type = document.getElementById(`dual-${wanPrefix}-type`).value;
            const staticFields = document.getElementById(`dual-${wanPrefix}-static-fields`);
            const pppoeFields = document.getElementById(`dual-${wanPrefix}-pppoe-fields`);
            
            if (staticFields) staticFields.style.display = 'none';
            if (pppoeFields) pppoeFields.style.display = 'none';
            
            if (type === 'static' && staticFields) {
                staticFields.style.display = 'block';
            } else if (type === 'pppoe' && pppoeFields) {
                pppoeFields.style.display = 'block';
            }
        }

        function addMultiWanRow(data = null) {
            const tbody = document.querySelector('#multi-wan-table tbody');
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>
                    <select class="login-input multi-wan-iface" style="margin:0; min-width:120px;"></select>
                </td>
                <td>
                    <select class="login-input multi-wan-type" style="margin:0; min-width:100px;" onchange="updateMultiWanDetails(this)">
                        <option value="dynamic">Dynamic</option>
                        <option value="static">Static</option>
                        <option value="pppoe">PPPoE</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="login-input multi-wan-weight" value="1" min="1" style="margin:0; width:60px;">
                </td>
                <td class="multi-wan-details">
                    <!-- Dynamic Placeholder -->
                    <div class="mw-dynamic-group" style="color:var(--text-muted);">Auto Config</div>
                    
                    <!-- Static Fields -->
                    <div class="mw-static-group" style="display:none; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input placeholder="IP" class="login-input input-sm mw-ip" style="margin:0; font-size:0.8rem;">
                        <input placeholder="Gateway" class="login-input input-sm mw-gw" style="margin:0; font-size:0.8rem;">
                    </div>
                    
                    <!-- PPPoE Fields -->
                    <div class="mw-pppoe-group" style="display:none; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input placeholder="User" class="login-input input-sm mw-user" style="margin:0; font-size:0.8rem;">
                        <input placeholder="Pass" type="password" class="login-input input-sm mw-pass" style="margin:0; font-size:0.8rem;">
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Remove</button>
                </td>
            `;
            
            tbody.appendChild(tr);
            
            // Populate interfaces
            const select = tr.querySelector('.multi-wan-iface');
            if (window.cachedInterfaces && visualInterfaceMap) {
                populateInterfaceSelect(select, window.cachedInterfaces, visualInterfaceMap);
            }
            
            if (data) {
                // Populate data if provided
                if(data.interface) select.value = data.interface;
                if(data.type) tr.querySelector('.multi-wan-type').value = data.type;
                if(data.weight) tr.querySelector('.multi-wan-weight').value = data.weight;
                
                // Populate fields (ALWAYS, regardless of current type, to restore persistence)
                const detailsTd = tr.querySelector('.multi-wan-details');
                if (data.static) {
                    detailsTd.querySelector('.mw-ip').value = data.static.ip || '';
                    detailsTd.querySelector('.mw-gw').value = data.static.gateway || '';
                }
                if (data.pppoe) {
                    detailsTd.querySelector('.mw-user').value = data.pppoe.username || '';
                    detailsTd.querySelector('.mw-pass').value = data.pppoe.password || '';
                }

                // Update visibility
                updateMultiWanDetails(tr.querySelector('.multi-wan-type'));
            }
        }

        function updateMultiWanDetails(select) {
            const td = select.closest('tr').querySelector('.multi-wan-details');
            const type = select.value;
            
            const dynGroup = td.querySelector('.mw-dynamic-group');
            const staticGroup = td.querySelector('.mw-static-group');
            const pppoeGroup = td.querySelector('.mw-pppoe-group');
            
            // Reset
            dynGroup.style.display = 'none';
            staticGroup.style.display = 'none';
            pppoeGroup.style.display = 'none';
            
            if (type === 'dynamic') {
                dynGroup.style.display = 'block';
            } else if (type === 'static') {
                staticGroup.style.display = 'grid';
            } else if (type === 'pppoe') {
                pppoeGroup.style.display = 'grid';
            }
        }



        function toggleWanMode() {
            const mode = document.getElementById('wan-mode').value;
            
            document.querySelectorAll('.wan-mode-section').forEach(el => el.style.display = 'none');
            const target = document.getElementById('mode-' + mode);
            if(target) target.style.display = 'block';

            // Hide main interface selector for multi-interface modes
            const ifaceGroup = document.getElementById('wan-interface-group');
            if (mode === 'dual_wan' || mode === 'multi_wan') {
                ifaceGroup.style.display = 'none';
            } else {
                ifaceGroup.style.display = 'block';
            }
        }

        async function updateWanStatus() {
            const statusEl = document.getElementById('wan-status');
            const textEl = document.getElementById('wan-status-text');
            if (!statusEl || !textEl) return;
            
            try {
                textEl.textContent = 'Checking...';
                statusEl.classList.remove('status-online', 'status-offline');
                
                const response = await fetch('/api/admin/network/status');
                const data = await response.json();
                
                if (data.online) {
                    statusEl.classList.add('status-online');
                    textEl.textContent = 'Online';
                } else {
                    statusEl.classList.add('status-offline');
                    textEl.textContent = 'Offline';
                }
            } catch (e) {
                console.error('Failed to check WAN status:', e);
                statusEl.classList.add('status-offline');
                textEl.textContent = 'Offline';
            }
        }

        async function saveNetworkConfig() {
            const mode = document.getElementById('wan-mode').value;
            const config = {
                interface: document.getElementById('wan-interface').value,
                mode: mode,
                static: {
                    ip: document.getElementById('wan-ip').value,
                    netmask: document.getElementById('wan-netmask').value,
                    gateway: document.getElementById('wan-gateway').value,
                    dns1: document.getElementById('wan-dns1').value,
                    dns2: document.getElementById('wan-dns2').value
                },
                pppoe: {
                    username: document.getElementById('pppoe-user').value,
                    password: document.getElementById('pppoe-pass').value,
                    dns1: document.getElementById('pppoe-dns1').value,
                    dns2: document.getElementById('pppoe-dns2').value
                }
            };

            // Collect Dual WAN Data
            if (mode === 'dual_wan') {
                config.dual_wan = {
                    strategy: document.getElementById('dual-strategy').value,
                    wan1: {
                        interface: document.getElementById('dual-wan1-iface').value,
                        type: document.getElementById('dual-wan1-type').value,
                        static: {
                            ip: document.getElementById('dual-wan1-ip').value,
                            gateway: document.getElementById('dual-wan1-gateway').value,
                            netmask: document.getElementById('dual-wan1-netmask').value,
                            dns: document.getElementById('dual-wan1-dns').value
                        },
                        pppoe: {
                            username: document.getElementById('dual-wan1-user').value,
                            password: document.getElementById('dual-wan1-pass').value
                        }
                    },
                    wan2: {
                        interface: document.getElementById('dual-wan2-iface').value,
                        type: document.getElementById('dual-wan2-type').value,
                        static: {
                            ip: document.getElementById('dual-wan2-ip').value,
                            gateway: document.getElementById('dual-wan2-gateway').value,
                            netmask: document.getElementById('dual-wan2-netmask').value,
                            dns: document.getElementById('dual-wan2-dns').value
                        },
                        pppoe: {
                            username: document.getElementById('dual-wan2-user').value,
                            password: document.getElementById('dual-wan2-pass').value
                        }
                    }
                };

                if (!config.dual_wan.wan1.interface || !config.dual_wan.wan2.interface) {
                    alert("Please select interfaces for both WAN 1 and WAN 2.");
                    return;
                }
                if (config.dual_wan.wan1.interface === config.dual_wan.wan2.interface) {
                    alert("WAN 1 and WAN 2 cannot use the same interface.");
                    return;
                }
            }

            // Collect Multi WAN Data
            if (mode === 'multi_wan') {
                const rows = document.querySelectorAll('#multi-wan-table tbody tr');
                config.multi_wan = Array.from(rows).map(tr => {
                    const type = tr.querySelector('.multi-wan-type').value;
                    const item = {
                        interface: tr.querySelector('.multi-wan-iface').value,
                        type: type,
                        weight: tr.querySelector('.multi-wan-weight').value
                    };
                    
                    // ALWAYS collect nested data to preserve persistence
                    // Static Data
                    const staticIp = tr.querySelector('.mw-ip').value;
                    const staticGw = tr.querySelector('.mw-gw').value;
                    if (staticIp || staticGw) {
                        item.static = {
                            ip: staticIp,
                            gateway: staticGw
                        };
                    }

                    // PPPoE Data
                    const pppoeUser = tr.querySelector('.mw-user').value;
                    const pppoePass = tr.querySelector('.mw-pass').value;
                    if (pppoeUser || pppoePass) {
                        item.pppoe = {
                            username: pppoeUser,
                            password: pppoePass
                        };
                    }

                    return item;
                });

                if (config.multi_wan.length < 2) {
                    alert("Please add at least 2 WAN interfaces for load balancing.");
                    return;
                }
                if (config.multi_wan.some(w => !w.interface)) {
                    alert("Please select an interface for all WAN entries.");
                    return;
                }
            }

            if (mode !== 'dual_wan' && mode !== 'multi_wan' && !config.interface) {
                alert("Please select a WAN interface.");
                return;
            }

            try {
                const res = await fetch('/api/admin/network/wan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    alert("Network configuration saved successfully.");
                } else {
                    alert("Failed to save configuration.");
                }
            } catch (e) {
                console.error("Save error", e);
                alert("Error saving configuration.");
            }
        }

        // --- Active Codes Management ---
        let editingCodeId = null;

        let idleCountdownInterval = null;
        let serverTimeOffset = 0; // Client Time - Server Time

        function updateIdleCell(cell) {
            // Adjust current time to match Server Time
            const now = Date.now() - serverTimeOffset;
            const lastTraffic = parseInt(cell.dataset.lastTraffic);
            const idleTimeout = parseInt(cell.dataset.idleTimeout);
            const isPaused = cell.dataset.isPaused === 'true';

            if (isNaN(lastTraffic) || isNaN(idleTimeout)) {
                cell.textContent = '-';
                return;
            }

            if (isPaused) {
                cell.textContent = 'Paused';
                cell.style.color = 'orange';
                return;
            }

            const elapsed = now - lastTraffic;
            const remaining = idleTimeout - elapsed; // Can be negative
            
            if (remaining <= 0) {
                // Show actual idle time when timed out
                const idleSeconds = Math.floor(elapsed / 1000);
                cell.textContent = `Idle: ${idleSeconds}s`;
                cell.style.color = 'var(--status-expired)'; // Darker red
                cell.style.fontWeight = 'bold';
            } else {
                // Show countdown
                const seconds = Math.floor(remaining / 1000);
                cell.textContent = `${seconds}s`;
                cell.style.color = seconds < 30 ? 'var(--danger)' : 'inherit';
                cell.style.fontWeight = seconds < 30 ? 'bold' : 'normal';
            }
        }

        function startIdleCountdownUpdater() {
            if (idleCountdownInterval) return; // Already running
            
            idleCountdownInterval = setInterval(() => {
                const cells = document.querySelectorAll('.idle-countdown-cell');
                cells.forEach(updateIdleCell);
            }, 1000);
        }

        async function loadActiveCodes() {
            try {
                const res = await fetch('/api/admin/devices');
                if (!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
                
                // Sync Time with Server
                const serverTimeHeader = res.headers.get('x-server-time');
                if (serverTimeHeader) {
                    const serverTime = parseInt(serverTimeHeader);
                    if (!isNaN(serverTime)) {
                        // Calculate offset: ClientTime - ServerTime
                        serverTimeOffset = Date.now() - serverTime;
                        console.log('Time Sync: Server Time', new Date(serverTime).toLocaleTimeString(), 'Offset:', serverTimeOffset, 'ms');
                    }
                }

                const users = await res.json();
                
                if (!Array.isArray(users)) {
                    throw new Error("Invalid data format received");
                }

                const tbody = document.querySelector('#active-codes-table tbody');
                tbody.innerHTML = '';

                const filterSelect = document.getElementById('active-codes-status-filter');
                const statusFilter = filterSelect ? filterSelect.value : 'all';

                const activeUsers = users.filter(u => u.session_code || u.time_remaining > 0);

                let filteredUsers = activeUsers;
                if (statusFilter === 'online') {
                    filteredUsers = activeUsers.filter(u => u.is_connected && !u.is_paused);
                } else if (statusFilter === 'offline_paused') {
                    filteredUsers = activeUsers.filter(u => !u.is_connected || u.is_paused);
                }

                if (filteredUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">No active codes found</td></tr>';
                    return;
                }

                filteredUsers.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid var(--border)';
                    
                    const timeString = formatTime(u.time_remaining);
                    const iface = u.interface || '-';
                    const status = u.is_paused ? '<span style="color:var(--warning)">Paused</span>' : 
                                   (u.is_connected ? '<span style="color:var(--success)">Connected</span>' : '<span style="color:var(--text-muted)">Disconnected</span>');

                    // Calculate idle params
                    const parseDate = (d) => {
                        if (!d) return null;
                        if (typeof d === 'string' && !d.endsWith('Z')) return new Date(d + 'Z').getTime();
                        return new Date(d).getTime();
                    };
                    // Use ONLY Traffic for Idle Timeout (ignore ping/active) to match backend logic
                    const tTraffic = u.last_traffic_at ? parseDate(u.last_traffic_at) : 0;
                    // const tActive = u.last_active_at ? parseDate(u.last_active_at) : 0; 
                    const lastTraffic = tTraffic || Date.now();

                    const idleTimeoutMs = (u.effective_idle_timeout || 120) * 1000;
                    
                    const idleCellId = `idle-cell-${u.id}`;

                    // Traffic Stats
                    const dl = formatBytes(u.total_data_down || 0);
                    const ul = formatBytes(u.total_data_up || 0);
                    
                    const toMbps = (bytes) => ((bytes || 0) * 8 / 1000000).toFixed(2);
                    const dlSpeed = u.current_speed ? toMbps(u.current_speed.dl_speed) : '0.00';
                    const ulSpeed = u.current_speed ? toMbps(u.current_speed.ul_speed) : '0.00';

                    const totalCoins = Number(u.total_coins || 0);

                    tr.innerHTML = `
                        <td style="padding:10px; text-align:center;">
                            ${u.last_voucher_code ? `<span style="font-weight:bold; color:var(--primary);">${u.last_voucher_code}</span>` : (u.user_code || u.session_code || '-')}
                        </td>
                        <td style="padding:10px; text-align:center;">${u.mac_address}</td>
                        <td style="padding:10px; text-align:center;">${(u.ip_address || '-').replace('::ffff:', '')}</td>
                        <td style="padding:10px; text-align:center;">${iface}</td>
                        <td style="padding:10px; text-align:center;">${timeString}</td>
                        <td style="padding:10px; text-align:center;">₱${totalCoins.toFixed(2)}</td>
                        <td style="padding:10px; text-align:center;">
                            <div style="font-size:0.85rem; white-space:nowrap;">
                                <span style="color: var(--status-active);">&darr;</span> ${dl} <span style="font-weight:bold; color:var(--status-active);">(${dlSpeed} Mbps)</span>
                                &nbsp;&nbsp;
                                <span style="color: var(--info);">&uarr;</span> ${ul} <span style="font-weight:bold; color:var(--info);">(${ulSpeed} Mbps)</span>
                            </div>
                        </td>
                        <td style="padding:10px; text-align:center;" class="idle-countdown-cell" 
                            id="${idleCellId}"
                            data-last-traffic="${lastTraffic}" 
                            data-idle-timeout="${idleTimeoutMs}"
                            data-is-paused="${u.is_paused ? 'true' : 'false'}">
                            -
                        </td>
                        <td style="padding:10px; text-align:center;">${status}</td>
                        <td style="padding:10px; text-align:center;">
                            <div style="display:inline-flex; align-items:center; gap:6px; white-space:nowrap;">
                                <button class="btn btn-sm btn-primary" onclick="modifyCode('${u.id}', '${u.session_code || ''}', ${u.time_remaining}, ${u.download_speed || 5120}, ${u.upload_speed || 1024})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCode('${u.id}')">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Initialize immediately
                    const cell = tr.querySelector(`#${idleCellId}`);
                    if (cell) updateIdleCell(cell);
                });

                startIdleCountdownUpdater();

            } catch (e) {
                console.error("Error loading active codes", e);
            }
        }

        function formatTime(seconds) {
            if (seconds <= 0) return 'Expired';
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const pad = (v) => String(v).padStart(2, '0');
            if (d > 0) {
                return `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
            }
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function modifyCode(id, code, time, dl, ul) {
            editingCodeId = id;
            document.getElementById('edit-code-input').value = code === 'null' ? '' : code;
            const totalSeconds = time || 0;
            const d = Math.floor(totalSeconds / 86400);
            const h = Math.floor((totalSeconds % 86400) / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            document.getElementById('edit-days-input').value = d;
            document.getElementById('edit-hours-input').value = h;
            document.getElementById('edit-minutes-input').value = m;
            document.getElementById('edit-seconds-input').value = s;

            // Populate speeds (Kbps -> Mbps)
            const dlMbps = ((dl || 0) / 1024).toFixed(1);
            const ulMbps = ((ul || 0) / 1024).toFixed(1);
            document.getElementById('edit-download-speed').value = Number(dlMbps) || '';
            document.getElementById('edit-upload-speed').value = Number(ulMbps) || '';

            document.getElementById('active-code-modal').style.display = 'flex';
        }

        function closeActiveCodeModal() {
            document.getElementById('active-code-modal').style.display = 'none';
            editingCodeId = null;
        }

        async function saveActiveCode() {
            if (!editingCodeId) return;
            
            const code = document.getElementById('edit-code-input').value;
            const days = parseInt(document.getElementById('edit-days-input').value) || 0;
            const hours = parseInt(document.getElementById('edit-hours-input').value) || 0;
            const minutes = parseInt(document.getElementById('edit-minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('edit-seconds-input').value) || 0;
            const timeRemaining = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;

            const dlMbps = parseFloat(document.getElementById('edit-download-speed').value);
            const ulMbps = parseFloat(document.getElementById('edit-upload-speed').value);

            const payload = { 
                session_code: code, 
                time_remaining: timeRemaining 
            };

            if (!isNaN(dlMbps)) payload.download_speed = Math.floor(dlMbps * 1024);
            if (!isNaN(ulMbps)) payload.upload_speed = Math.floor(ulMbps * 1024);

            try {
                const res = await fetch(`/api/admin/devices/${editingCodeId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    closeActiveCodeModal();
                    loadActiveCodes();
                    alert('Code updated successfully');
                } else {
                    alert('Failed to update code');
                }
            } catch (e) {
                console.error('Error updating code', e);
                alert('Error updating code');
            }
        }

        async function deleteCode(id) {
            if (!await showConfirm('Are you sure you want to delete this active session? The user will be disconnected.', true)) return;

            try {
                const res = await fetch(`/api/admin/devices/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadActiveCodes();
                } else {
                    alert('Failed to delete session');
                }
            } catch (e) {
                console.error('Error deleting session', e);
            }
        }

        // --- VLAN Logic ---
        async function loadVlans() {
            try {
                const res = await fetch('/api/admin/network/vlans', { credentials: 'include' });
                const vlans = await res.json();
                const tbody = document.querySelector('#vlan-table tbody');
                if (!tbody) return;

                // Reset Select All checkbox
                const selectAll = document.getElementById('vlan-select-all');
                if (selectAll) selectAll.checked = false;
                if (typeof updateVlanDeleteButton === 'function') updateVlanDeleteButton();

                tbody.innerHTML = '';
                if (!vlans || vlans.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:15px;">No VLANs configured</td></tr>';
                    return;
                }

                vlans.forEach(vlan => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:10px; text-align: center;">
                            <input type="checkbox" class="vlan-checkbox" value="${vlan.id}" onchange="updateVlanDeleteButton()" style="cursor:pointer; width: 16px; height: 16px;">
                        </td>
                        <td style="padding:10px;">${vlan.name || '-'}</td>
                        <td style="padding:10px;">${vlan.parent}.${vlan.vlanId}</td>
                        <td style="padding:10px;">${vlan.mac || 'Auto'}</td>
                        <td style="padding:10px;">${vlan.vlanId}</td>
                        <td style="padding:10px;">
                            <button class="btn btn-sm btn-primary" style="margin-right:5px;" onclick="editVlan('${vlan.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteVlan('${vlan.id}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading VLANs:", e);
            }
        }

        function toggleVlanSelectAll(source) {
            const checkboxes = document.querySelectorAll('.vlan-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateVlanDeleteButton();
        }

        function updateVlanDeleteButton() {
            const selected = document.querySelectorAll('.vlan-checkbox:checked').length;
            const btn = document.getElementById('vlan-delete-btn');
            if (btn) {
                btn.style.display = selected > 0 ? 'inline-block' : 'none';
                btn.textContent = `Delete Selected (${selected})`;
            }
        }

        async function deleteSelectedVlans() {
            const selected = Array.from(document.querySelectorAll('.vlan-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;

            if (typeof showConfirm === 'function') {
                if (!await showConfirm(`Are you sure you want to delete ${selected.length} VLAN(s)?`, true)) return;
            } else {
                if (!confirm(`Are you sure you want to delete ${selected.length} VLAN(s)?`)) return;
            }

            if (typeof showToast === 'function') showToast(`Deleting ${selected.length} VLANs...`, 'info');

            let successCount = 0;
            let failCount = 0;

            for (const id of selected) {
                try {
                    const res = await fetch(`/api/admin/network/vlans/${id}`, { 
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (res.ok) successCount++;
                    else failCount++;
                } catch (e) {
                    console.error("Delete error:", e);
                    failCount++;
                }
            }

            if (successCount > 0) {
                if (typeof showToast === 'function') showToast(`Deleted ${successCount} VLANs successfully`, 'success');
                else alert(`Deleted ${successCount} VLANs successfully`);
                await loadVlans();
            }

            if (failCount > 0) {
                if (typeof showToast === 'function') showToast(`Failed to delete ${failCount} VLANs`, 'error');
            }
        }

        async function editVlan(vlanId) {
            try {
                // Fetch latest VLANs to get data
                const res = await fetch('/api/admin/network/vlans', { credentials: 'include' });
                const vlans = await res.json();
                const vlan = vlans.find(v => v.id === vlanId);
                
                if (!vlan) {
                    alert("VLAN not found");
                    return;
                }

                // Open modal (loads interfaces and resets fields)
                await openVlanModal();
                
                // Set to Edit Mode
                const modal = document.getElementById('vlan-modal');
                modal.dataset.mode = 'edit';
                modal.dataset.vlanId = vlanId;
                
                const titleEl = modal.querySelector('h3') || modal.querySelector('.modal-title');
                if (titleEl) titleEl.textContent = 'Edit VLAN';

                // Populate fields
                document.getElementById('vlan-name').value = vlan.name || '';
                const select = document.getElementById('vlan-parent');
                select.value = vlan.parent;
                
                document.getElementById('vlan-id').value = vlan.vlanId;
                
                // For MAC: if it exists, show it. If user wants to auto-gen new one, they check the box.
                document.getElementById('vlan-auto-mac').checked = false;
                document.getElementById('vlan-mac').value = vlan.mac || '';
                toggleVlanMacInput();
                
            } catch (e) {
                console.error("Edit VLAN error:", e);
                alert("Failed to load VLAN details");
            }
        }

        async function openVlanModal() {
            // Reset mode to create
            const modal = document.getElementById('vlan-modal');
            modal.dataset.mode = 'create';
            delete modal.dataset.vlanId;
            const titleEl = modal.querySelector('h3') || modal.querySelector('.modal-title');
            if (titleEl) titleEl.textContent = 'Add VLAN';

            // Populate parent interfaces
            try {
                const res = await fetch('/api/admin/network-interfaces', { credentials: 'include' });
                const interfaces = await res.json();
                const select = document.getElementById('vlan-parent');
                select.innerHTML = '';
                
                // Filter out existing VLANs or loopbacks if needed
                interfaces.forEach(iface => {
                     // Basic filtering: avoid lo, avoid existing vlans if possible
                     if (iface.name !== 'lo' && !iface.name.includes('.')) {
                         const opt = document.createElement('option');
                         opt.value = iface.name;
                         opt.textContent = iface.name;
                         select.appendChild(opt);
                     }
                });
            } catch(e) {
                console.error("Failed to load interfaces for VLAN modal", e);
                alert("Could not load interfaces");
                return;
            }

            // Reset fields
            document.getElementById('vlan-name').value = '';
            document.getElementById('vlan-id').value = '';
            document.getElementById('vlan-auto-mac').checked = true;
            document.getElementById('vlan-mac').value = '';
            toggleVlanMacInput();

            document.getElementById('vlan-modal').style.display = 'flex';
        }

        function handleVlanIdInput(input) {
            const nameInput = document.getElementById('vlan-name');
            const val = input.value.trim();
            
            // Only auto-fill if name is empty or already follows the pattern
            // This prevents overwriting user's custom names
            if (nameInput.value === '' || nameInput.value.startsWith('VLAN')) {
                if (!val) {
                    nameInput.value = '';
                } else if (val.includes('-')) {
                    // Range detected: Set base for batch creation
                    // saveVlan logic will append ID: "VLAN." + "30" -> "VLAN.30"
                    nameInput.value = 'VLAN.';
                } else {
                    // Single ID
                    nameInput.value = 'VLAN.' + val;
                }
            }
        }

        function toggleVlanMacInput() {
            const isAuto = document.getElementById('vlan-auto-mac').checked;
            document.getElementById('vlan-mac').disabled = isAuto;
            if (isAuto) {
                document.getElementById('vlan-mac').placeholder = "Auto Generated";
            } else {
                document.getElementById('vlan-mac').placeholder = "00:11:22:33:44:55";
            }
        }

        async function applyVlanChanges() {
            if (!confirm("Are you sure you want to apply all VLAN changes? This may restart network services.")) return;
            
            try {
                const res = await fetch('/api/admin/network/vlans/apply', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    showToast("Changes applied successfully", "success");
                    loadInterfaces();
                    loadVlans();
                } else {
                    const err = await res.json();
                    showToast("Error: " + (err.error || err.message), "error");
                }
            } catch (e) {
                console.error("Apply changes error:", e);
                showToast("Failed to apply changes", "error");
            }
        }

        async function saveVlan() {
            const name = document.getElementById('vlan-name').value.trim();
            const parent = document.getElementById('vlan-parent').value;
            const vlanIdInput = document.getElementById('vlan-id').value.trim();
            const autoMac = document.getElementById('vlan-auto-mac').checked;
            const mac = document.getElementById('vlan-mac').value;

            if (!parent || !vlanIdInput) {
                alert("Parent Interface and VLAN ID are required");
                return;
            }

            // Check if it's a range
            const isRange = vlanIdInput.includes('-');
            
            if (isRange) {
                // Batch creation mode
                const [startStr, endStr] = vlanIdInput.split('-');
                const start = parseInt(startStr);
                const end = parseInt(endStr);
                
                if (isNaN(start) || isNaN(end) || start >= end || start < 1 || end > 4094) {
                    alert("Invalid VLAN range. Please use format like '30-50' with values between 1 and 4094.");
                    return;
                }
                
                // Confirm batch creation
                const count = end - start + 1;
                if (!confirm(`Are you sure you want to create ${count} VLANs (from ${start} to ${end})?`)) return;
                
                const vlans = [];
                for (let i = start; i <= end; i++) {
                    // Smart formatting: if name ends with dot, don't add space
                    let generatedName = null;
                    if (name) {
                        generatedName = name.endsWith('.') ? `${name}${i}` : `${name} ${i}`;
                    }
                    
                    vlans.push({
                        name: generatedName,
                        parent,
                        vlanId: i,
                        autoMac: true, // Force auto MAC for batch
                        mac: null
                    });
                }
                
                try {
                    const res = await fetch('/api/admin/network/vlans/batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(vlans),
                        credentials: 'include'
                    });
                    
                    if (res.ok) {
                        const result = await res.json();
                        document.getElementById('vlan-modal').style.display = 'none';
                        loadVlans();
                        alert(`Successfully added ${result.count} VLANs.`);
                    } else {
                        const err = await res.json();
                        alert("Error: " + (err.error || err.message));
                    }
                } catch (e) {
                    console.error("Batch VLAN save error:", e);
                    alert("Failed to save VLANs");
                }
                
                return;
            }

            if (!autoMac && !mac) {
                alert("Please enter a MAC address or select Auto Generate");
                return;
            }

            const payload = {
                name,
                parent,
                vlanId: parseInt(vlanIdInput),
                autoMac,
                mac: autoMac ? null : mac
            };
            
            const modal = document.getElementById('vlan-modal');
            const mode = modal.dataset.mode || 'create';
            const id = modal.dataset.vlanId;
            
            const url = mode === 'edit' ? `/api/admin/network/vlans/${id}` : '/api/admin/network/vlans';
            const method = mode === 'edit' ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (res.ok) {
                    document.getElementById('vlan-modal').style.display = 'none';
                    loadVlans();
                    alert(mode === 'edit' ? "VLAN updated successfully" : "VLAN created successfully");
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.error || err.message));
                }
            } catch (e) {
                console.error("VLAN save error:", e);
                alert("Failed to save VLAN");
            }
        }

        async function deleteVlan(id) {
            if (!confirm("Are you sure you want to delete this VLAN?")) return;

            try {
                const res = await fetch(`/api/admin/network/vlans/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    loadVlans();
                } else {
                    alert("Failed to delete VLAN");
                }
            } catch (e) {
                console.error("VLAN delete error:", e);
            }
        }

        /* DHCP Server Logic */
        async function loadDhcp() {
            try {
                const res = await fetch('/api/admin/network/dhcp', { credentials: 'include' });
                const dhcp = await res.json();
                
                // Set bitmask
                document.getElementById('dhcp-bitmask').value = dhcp.bitmask || 19;
                
                // Populate servers table
                const tbody = document.getElementById('dhcp-table-body');
                tbody.innerHTML = '';
                
                if (!dhcp.servers || dhcp.servers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:15px;">No DHCP servers configured</td></tr>';
                } else {
                    dhcp.servers.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="padding:10px;">${s.interface}</td>
                            <td style="padding:10px;">${s.subnet}</td>
                            <td style="padding:10px;">${s.pool_start} - ${s.pool_end}</td>
                            <td style="padding:10px;">${s.netmask}</td>
                            <td style="padding:10px;">${s.lease || '12h'}</td>
                            <td style="padding:10px;">${dhcp.dns1}, ${dhcp.dns2}</td>
                            <td style="padding:10px;">
                                <button class="btn btn-sm btn-danger" onclick="removeDhcpServer('${s.interface}')">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                

                
            } catch (e) {
                console.error("Error loading DHCP:", e);
            }
        }

        async function saveDhcpSettings() {
            const bitmask = parseInt(document.getElementById('dhcp-bitmask').value);
            try {
                const res = await fetch('/api/admin/network/dhcp/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bitmask }),
                    credentials: 'include'
                });
                if (res.ok) {
                    alert("DHCP Settings saved");
                    loadDhcp();
                } else {
                    alert("Failed to save DHCP settings");
                }
            } catch (e) {
                console.error(e);
                alert("Error saving settings");
            }
        }

        async function openDhcpModal() {
            // Load interfaces for selection
            try {
                const res = await fetch('/api/admin/network-interfaces', { credentials: 'include' });
                const interfaces = await res.json();
                const select = document.getElementById('dhcp-interface-select');
                select.innerHTML = '';
                
                select.onchange = calculateNextDhcpSlot;

                const added = new Set();
                interfaces.forEach(iface => {
                    const name = iface.name;
                    // Filter unusable interfaces
                    if (name === 'lo') return;
                    if (name.startsWith('zt')) return; // ZeroTier
                    if (name.startsWith('tun')) return; // VPN Tunnels
                    if (name.startsWith('tap')) return; // VPN Taps
                    if (name.startsWith('docker')) return; // Docker
                    if (name.startsWith('veth')) return; // Docker/Container virtual eth
                    if (name.includes('ifb')) return; // Intermediate Functional Block
                    
                    if (added.has(name)) return;
                    added.add(name);

                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
                
                // Trigger calculation for first interface
                if (select.options.length > 0) {
                   calculateNextDhcpSlot();
                }
                
                document.getElementById('dhcp-modal').style.display = 'flex';
            } catch (e) {
                console.error("Error loading interfaces:", e);
                alert("Could not load interfaces");
            }
        }
        
        async function calculateNextDhcpSlot() {
             const iface = document.getElementById('dhcp-interface-select').value;
             if (!iface) return;
             
             document.getElementById('dhcp-calc-info').innerHTML = 'Calculating...';
             
             try {
                 const res = await fetch(`/api/admin/network/dhcp/next-slot?interface=${iface}`, { credentials: 'include' });
                 const data = await res.json();
                 
                 if (data.error) {
                     document.getElementById('dhcp-calc-info').innerHTML = `<span style="color:var(--danger)">${data.error}</span>`;
                     return;
                 }
                 
                 document.getElementById('dhcp-calc-info').innerHTML = `
                    <div style="color: var(--status-active); font-weight:bold;">Auto-Calculated Subnet:</div>
                    <div>Subnet: ${data.subnet}</div>
                    <div>Netmask: ${data.netmask}</div>
                    <div>Range: ${data.pool_start} - ${data.pool_end}</div>
                    <div>Gateway: ${data.gateway}</div>
                 `;
             } catch (e) {
                 document.getElementById('dhcp-calc-info').textContent = "Error calculating slot";
             }
        }

        async function addDhcpServer() {
            const iface = document.getElementById('dhcp-interface-select').value;
            const dns1 = document.getElementById('dhcp-dns1').value;
            const dns2 = document.getElementById('dhcp-dns2').value;
            
            if (!iface) return;
            
            try {
                const res = await fetch('/api/admin/network/dhcp/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: iface, dns1, dns2 }),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    document.getElementById('dhcp-modal').style.display = 'none';
                    loadDhcp();
                    alert("DHCP Server added successfully");
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.error || err.message));
                }
            } catch (e) {
                console.error(e);
                alert("Failed to add DHCP server");
            }
        }

        async function removeDhcpServer(iface) {
            if (!confirm(`Are you sure you want to remove DHCP server for ${iface}?`)) return;
            
            try {
                 const res = await fetch(`/api/admin/network/dhcp/servers/${iface}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    loadDhcp();
                } else {
                    alert("Failed to remove DHCP server");
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadLicenseInfo() {
            const statusEl = document.getElementById('lic-status');
            const hwidEl = document.getElementById('lic-hwid');
            const modelEl = document.getElementById('lic-model');
            const keyEl = document.getElementById('lic-key');
            const activatedEl = document.getElementById('lic-activated');
            const expirationEl = document.getElementById('lic-expiration');
            
            try {
                if(statusEl) statusEl.textContent = 'Loading...';
                const res = await fetch('/api/license/status');
                const data = await res.json();
                
                if(hwidEl) hwidEl.textContent = data.hwid || 'Unknown';
                if(modelEl) modelEl.textContent = data.device_model || 'Unknown';
                
                const license = data.license || {};
                
                if (data.isValid) {
                    const isTrial = license.type === 'TRIAL';
                    
                    if(statusEl) {
                        statusEl.textContent = 'Active';
                        statusEl.style.color = 'green';
                    }
                    
                    if(keyEl) keyEl.textContent = license.key || (isTrial ? 'TRIAL MODE (No Key)' : 'Hidden');
                    
                    if(activatedEl) {
                        if (license.activated_date) {
                            activatedEl.textContent = new Date(license.activated_date).toLocaleString();
                        } else if (isTrial) {
                             activatedEl.textContent = 'Trial Started';
                        } else {
                            activatedEl.textContent = 'Pre-Activated';
                        }
                    }

                    if(expirationEl) {
                        if (isTrial) {
                            expirationEl.textContent = license.expires || 'Unknown';
                        } else {
                            expirationEl.textContent = 'No Expiration';
                        }
                    }
                    
                    // Input control
                    const input = document.getElementById('license-key-input');
                    const btn = document.querySelector('#activation-form button');
                    
                    if (!isTrial) {
                        // Full license - disable input
                        if(input) input.disabled = true;
                        if(btn) {
                            btn.disabled = true;
                            btn.textContent = 'Activated';
                        }
                    } else {
                        // Trial mode - allow activation
                         if(input) input.disabled = false;
                         if(btn) {
                            btn.disabled = false;
                            btn.textContent = 'Activate';
                        }
                    }

                } else {
                    if(statusEl) {
                        statusEl.textContent = 'Inactive / Expired';
                        statusEl.style.color = 'red';
                    }
                    if(keyEl) keyEl.textContent = '---';
                    if(activatedEl) activatedEl.textContent = '---';
                    if(expirationEl) expirationEl.textContent = 'Expired';
                    
                    const input = document.getElementById('license-key-input');
                    const btn = document.querySelector('#activation-form button');
                    if(input) input.disabled = false;
                    if(btn) {
                        btn.disabled = false;
                        btn.textContent = 'Activate';
                    }
                }
            } catch (e) {
                console.error("License load error", e);
                if(statusEl) {
                    statusEl.textContent = 'Error';
                    statusEl.style.color = 'orange';
                }
            }
        }

        async function activateLicense() {
            const keyInput = document.getElementById('license-key-input');
            const key = keyInput.value.trim();
            if (!key) return alert("Please enter a license key");
            
            try {
                const btn = document.querySelector('#activation-form button');
                const originalText = btn ? btn.textContent : 'Activate';
                if(btn) {
                    btn.disabled = true;
                    btn.textContent = 'Activating...';
                }
                
                const res = await fetch('/api/license/activate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });
                
                const data = await res.json();
                
                if (data.success || data.status === 'success' || data.token) {
                    alert("License Activated Successfully!");
                    loadLicenseInfo();
                } else {
                    alert("Activation Failed: " + (data.error || data.message || 'Unknown error'));
                    if(btn) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                }
            } catch (e) {
                console.error("Activation error", e);
                alert("Error activating license");
                const btn = document.querySelector('#activation-form button');
                if(btn) btn.disabled = false;
            }
        }
    </script>

    <div id="sales-coinsout-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size:0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg);">
                Coins Out
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Device</label>
                    <div id="sales-coinsout-device" style="font-weight:600;"></div>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Total Pending Amount</label>
                    <div id="sales-coinsout-base" style="font-family:monospace;"></div>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Partner Share Percentage (%)</label>
                    <input type="number" id="sales-coinsout-percent" min="0" max="100" step="1" oninput="recalcSalesCoinsOutShare()" style="margin:0; width:100%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Partner Share Amount</label>
                    <div id="sales-coinsout-share" style="color:var(--warning); font-weight:bold;">₱0.00</div>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Coins Out Amount</label>
                    <div id="sales-coinsout-owner" style="color:var(--status-active); font-weight:bold;">₱0.00</div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-danger" onclick="closeSalesCoinsOutModal()">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="performSalesCoinsOut()">Confirm Coins Out</button>
            </div>
        </div>
    </div>

    <div id="sales-coinsout-logs-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size:0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg);">
                Sales Logs
            </div>
            <div style="padding:12px 20px; border-bottom:1px solid var(--border); font-size:0.85rem; color:var(--text-muted);">
                <span id="sales-coinsout-logs-device" style="font-weight:600;"></span>
            </div>
            <div style="padding:16px 20px; max-height:260px; overflow-y:auto;">
                <ul id="sales-coinsout-logs-list" style="list-style:none; padding:0; margin:0; font-size:0.85rem;">
                    <li style="color:var(--text-muted);">No Coins Out records</li>
                </ul>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-danger" onclick="closeSalesCoinsOutLogsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Active Code Edit Modal -->
    <div id="active-code-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:var(--card-bg); width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color:var(--text-main); display:flex; flex-direction:column; font-size: 0.9rem;">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; background:var(--card-bg);">
                Edit Active Session
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Session Code</label>
                    <input type="text" id="edit-code-input" placeholder="Enter Code" style="margin:0; width:100%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Time Remaining (d H:M:S)</label>
                    <div style="display:flex; gap:6px;">
                        <input type="number" id="edit-days-input" min="0" placeholder="Days" style="margin:0; width:25%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                        <input type="number" id="edit-hours-input" min="0" max="23" placeholder="H" style="margin:0; width:25%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                        <input type="number" id="edit-minutes-input" min="0" max="59" placeholder="M" style="margin:0; width:25%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                        <input type="number" id="edit-seconds-input" min="0" max="59" placeholder="S" style="margin:0; width:25%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                    </div>
                </div>
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Download (Mbps)</label>
                        <input type="number" id="edit-download-speed" step="0.1" min="0" placeholder="e.g. 5.0" style="margin:0; width:100%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                    </div>
                    <div style="flex:1;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Upload (Mbps)</label>
                        <input type="number" id="edit-upload-speed" step="0.1" min="0" placeholder="e.g. 1.0" style="margin:0; width:100%; padding:10px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px; box-sizing:border-box;">
                    </div>
                </div>
            </div>
            <div style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-danger" onclick="closeActiveCodeModal()">Cancel</button>
                <button class="btn btn-sm btn-success" onclick="saveActiveCode()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firewall Rule Modal -->
    <div id="firewall-rule-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content" style="background:var(--card-bg); width:95%; max-width:400px; border-radius:8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display:flex; flex-direction:column; color:var(--text-main);">
            <div class="modal-header" style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center;">
                <span>Add Firewall Rule</span>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="document.getElementById('firewall-rule-modal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <div>
                    <label class="form-label">Port to Block</label>
                    <input type="number" id="fw-port" class="form-control" placeholder="e.g. 80, 443" style="width:100%; padding:8px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px;">
                </div>
                <div>
                    <label class="form-label">Protocol</label>
                    <select id="fw-protocol" class="form-control" style="width:100%; padding:8px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px;">
                        <option value="both">TCP & UDP</option>
                        <option value="tcp">TCP Only</option>
                        <option value="udp">UDP Only</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Comment (Optional)</label>
                    <input type="text" id="fw-comment" class="form-control" placeholder="e.g. Block Ads" style="width:100%; padding:8px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); border-radius:4px;">
                </div>
            </div>
            <div class="modal-footer" style="padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('firewall-rule-modal').style.display='none'" style="background:var(--secondary); color:white; border:none; padding:8px 16px; border-radius:4px;">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="addFirewallRule()" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:4px;">Add Rule</button>
            </div>
        </div>
    </div>
    <!-- Forgot Password Modal Removed -->


    <!-- Reset Credentials Modal Removed -->

    <script>
        // --- Forgot Password Logic Removed (Moved to forgot.html) ---

    </script>
    <!-- PPPoE Server Scripts -->
    <script>
        async function loadPppoeServerConfig() {
            try {
                // Fetch interfaces first
                const ifRes = await fetch('/api/admin/network-interfaces');
                const interfaces = await ifRes.json();
                const ifSelect = document.getElementById('pppoe-server-iface');
                ifSelect.innerHTML = '<option value="br0">br0 (Default)</option>';
                interfaces.forEach(iface => {
                    if (iface.name !== 'lo' && iface.name !== 'br0') {
                        const opt = document.createElement('option');
                        opt.value = iface.name;
                        opt.textContent = `${iface.name} (${iface.ip || 'No IP'})`;
                        ifSelect.appendChild(opt);
                    }
                });

                const res = await fetch('/api/admin/pppoe/config');
                const config = await res.json();

                // Fetch System Time Settings (for NTP)
                let timeConfig = {};
                try {
                    const timeRes = await fetch('/api/admin/system/time');
                    timeConfig = await timeRes.json();
                } catch(e) { console.error("Error fetching time config:", e); }
                
                if (config.enabled !== undefined) {
                    document.getElementById('pppoe-server-enabled').checked = config.enabled;
                    document.getElementById('pppoe-server-iface').value = config.interface || 'br0';
                    document.getElementById('pppoe-server-local-ip').value = config.local_ip || '10.10.10.1';
                    document.getElementById('pppoe-server-remote-start').value = config.remote_start || '10.10.10.2';
                    document.getElementById('pppoe-server-count').value = config.remote_count || 50;
                    document.getElementById('pppoe-server-dns1').value = config.dns1 || '8.8.8.8';
                    document.getElementById('pppoe-server-dns2').value = config.dns2 || '8.8.4.4';
                    document.getElementById('pppoe-server-expired-pool').value = config.expired_pool || '172.15.10.2-172.15.10.254';
                    document.getElementById('pppoe-server-ntp').value = timeConfig.ntp_server || 'pool.ntp.org';
                }
            } catch (e) {
                console.error("Error loading PPPoE config:", e);
            }
            loadPppoeProfiles();
            loadPppoeUsers();
            startPppoeStatsRefresh();
        }

        async function savePppoeServerConfig() {
            const config = {
                enabled: document.getElementById('pppoe-server-enabled').checked,
                interface: document.getElementById('pppoe-server-iface').value,
                local_ip: document.getElementById('pppoe-server-local-ip').value,
                remote_start: document.getElementById('pppoe-server-remote-start').value,
                remote_count: parseInt(document.getElementById('pppoe-server-count').value),
                dns1: document.getElementById('pppoe-server-dns1').value,
                dns2: document.getElementById('pppoe-server-dns2').value,
                expired_pool: document.getElementById('pppoe-server-expired-pool').value
            };
            
            const ntpServer = document.getElementById('pppoe-server-ntp').value;

            try {
                // Save NTP Settings First
                if (ntpServer) {
                    await fetch('/api/admin/system/time', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            time_sync_mode: 'auto', // Enforce auto if setting NTP
                            ntp_server: ntpServer,
                            // Preserve existing or default
                            timezone_mode: 'auto', 
                            timezone: 'Asia/Manila' 
                        })
                    });
                }

                const res = await fetch('/api/admin/pppoe/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.success) {
                    alert('PPPoE Server configuration saved and server restarted (if enabled).');
                } else {
                    alert('Failed to save configuration: ' + data.error);
                }
            } catch (e) {
                alert('Error saving configuration');
            }
        }

        // --- Profile Management ---
        async function loadPppoeProfiles() {
            try {
                const res = await fetch('/api/admin/pppoe/profiles');
                const profiles = await res.json();
                const container = document.getElementById('pppoe-profiles-list');
                if (!container) return; // Guard clause in case element is missing
                container.innerHTML = '';

                if (profiles.length === 0) {
                    container.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px; color:var(--text-muted);">No profiles found</td></tr>';
                    return;
                }

                profiles.forEach(p => {
                    const tr = document.createElement('tr');
                    
                    // Convert Kbps to Mbps for display
                    const upMbps = p.rate_limit_up ? (p.rate_limit_up / 1024) : 0;
                    const downMbps = p.rate_limit_down ? (p.rate_limit_down / 1024) : 0;
                    
                    tr.innerHTML = `
                        <td style="padding: 12px 15px; font-weight:600;">${p.name}</td>
                        <td style="padding: 12px 15px; color:var(--status-active); font-weight:bold;">₱${p.price || 0}</td>
                        <td style="padding: 12px 15px; color:var(--text-muted);">&uarr; ${upMbps} Mbps / &darr; ${downMbps} Mbps</td>
                        <td style="padding: 12px 15px;">
                            <div style="display:flex; gap:5px; justify-content: center;">
                                <button class="btn btn-sm btn-primary" onclick='openPppoeProfileModal(${JSON.stringify(p)})' title="Edit" style="min-width: 60px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePppoeProfile(${p.id})" title="Delete" style="min-width: 70px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    container.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading profiles:", e);
            }
        }

        function openPppoeProfileModal(profile = null) {
            const modal = document.getElementById('pppoe-profile-modal');
            const title = document.getElementById('pppoe-profile-modal-title');
            
            if (profile) {
                title.textContent = 'Edit Plan';
                document.getElementById('pppoe-profile-id').value = profile.id;
                document.getElementById('pppoe-profile-name').value = profile.name;
                document.getElementById('pppoe-profile-price').value = profile.price || 0;
                // Convert Kbps to Mbps for input
                document.getElementById('pppoe-profile-rate-up').value = profile.rate_limit_up ? (profile.rate_limit_up / 1024) : '';
                document.getElementById('pppoe-profile-rate-down').value = profile.rate_limit_down ? (profile.rate_limit_down / 1024) : '';
            } else {
                title.textContent = 'Add Plan';
                document.getElementById('pppoe-profile-id').value = '';
                document.getElementById('pppoe-profile-name').value = '';
                document.getElementById('pppoe-profile-price').value = '';
                document.getElementById('pppoe-profile-rate-up').value = '';
                document.getElementById('pppoe-profile-rate-down').value = '';
            }
            modal.style.display = 'flex';
        }

        function closePppoeProfileModal() {
            document.getElementById('pppoe-profile-modal').style.display = 'none';
        }

        async function savePppoeProfile() {
            const id = document.getElementById('pppoe-profile-id').value;
            // Get Mbps input and convert to Kbps for storage
            const upMbps = parseFloat(document.getElementById('pppoe-profile-rate-up').value) || 0;
            const downMbps = parseFloat(document.getElementById('pppoe-profile-rate-down').value) || 0;

            const profile = {
                name: document.getElementById('pppoe-profile-name').value,
                price: parseFloat(document.getElementById('pppoe-profile-price').value) || 0,
                rate_limit_up: Math.floor(upMbps * 1024),
                rate_limit_down: Math.floor(downMbps * 1024)
            };

            if (!profile.name) return alert('Plan Name is required');

            try {
                const url = id ? `/api/admin/pppoe/profiles/${id}` : '/api/admin/pppoe/profiles';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profile)
                });
                const data = await res.json();

                if (data.success) {
                    closePppoeProfileModal();
                    loadPppoeProfiles();
                    // Reload users to update profile names if needed
                    loadPppoeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error saving profile');
            }
        }

        async function deletePppoeProfile(id) {
            if (!await showConfirm('Delete this profile? Users assigned to this profile will be set to No Profile.', true)) return;
            try {
                const res = await fetch(`/api/admin/pppoe/profiles/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadPppoeProfiles();
                    loadPppoeUsers();
                } else {
                    alert('Failed to delete profile');
                }
            } catch (e) {
                alert('Error deleting profile');
            }
        }

        // --- User Management ---
        let pppoeRefreshInterval = null;

        function startPppoeStatsRefresh() {
            if (pppoeRefreshInterval) clearInterval(pppoeRefreshInterval);
            pppoeRefreshInterval = setInterval(() => loadPppoeUsers(true), 3000);
        }

        function stopPppoeStatsRefresh() {
            if (pppoeRefreshInterval) clearInterval(pppoeRefreshInterval);
            pppoeRefreshInterval = null;
        }

        async function loadPppoeUsers(isRefresh = false) {
            try {
                const res = await fetch('/api/admin/pppoe/users');
                const users = await res.json();
                
                const allContainer = document.getElementById('pppoe-users-all-list');
                const statusTableBody = document.getElementById('pppoe-status-table-body');
                const expiredTableBody = document.getElementById('pppoe-expired-table-body');
                
                if (!isRefresh) {
                    if (allContainer) allContainer.innerHTML = '';
                    if (statusTableBody) statusTableBody.innerHTML = '';
                    if (expiredTableBody) expiredTableBody.innerHTML = '';
                }

                // Helper to create table row for management list
                const createManagementRow = (u) => {
                    const tr = document.createElement('tr');
                    
                    const expDate = u.expiration_date ? new Date(u.expiration_date).toLocaleString() : 'Never';
                    const profileName = u.profile_name || 'No Profile';
                    
                    const statusBadge = u.is_active 
                        ? '<span class="badge bg-success">Enabled</span>' 
                        : '<span class="badge bg-secondary">Disabled</span>';

                    tr.innerHTML = `
                        <td style="padding: 12px 15px;">${u.username}</td>
                        <td style="padding: 12px 15px;">${u.password || ''}</td>
                        <td style="padding: 12px 15px;">${profileName}</td>
                        <td style="padding: 12px 15px;">${expDate}</td>
                        <td style="padding: 12px 15px;">${statusBadge}</td>
                        <td style="padding: 12px 15px;">
                            <div style="display:flex; gap:5px; justify-content: center;">
                                <button class="btn btn-sm btn-primary" onclick='openPppoeUserModal(${JSON.stringify(u)})' title="Edit" style="min-width: 60px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePppoeUser(${u.id})" title="Delete" style="min-width: 70px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    return tr;
                };

                const statusVisibleIds = new Set();
                const expiredVisibleIds = new Set();

                users.forEach(u => {
                    // 1. Populate Management List (Only on full load)
                    if (allContainer && !isRefresh) {
                        allContainer.appendChild(createManagementRow(u));
                    }

                    // 2. Populate Status/Expired Table (Update if exists, else create)
                    if (statusTableBody || expiredTableBody) {
                        const now = new Date();
                        const isExpired = u.expiration_date && new Date(u.expiration_date) < now;
                        // Determine if user is connected (has IP assigned)
                        const isConnected = u.current_ip && u.current_ip !== 'N/A';
                        
                        // Determine target table
                        let targetBody = null;
                        if (isExpired) {
                            targetBody = expiredTableBody;
                            expiredVisibleIds.add(u.id);
                        } else if (isConnected) {
                            targetBody = statusTableBody;
                            statusVisibleIds.add(u.id);
                        }
                        
                        if (targetBody) {
                            // Use provided current_ip or infer online status if active and not expired
                            const isOnline = isConnected || (u.is_active && !isExpired); 
                            
                            const statusBadge = isExpired 
                                ? '<span class="badge bg-danger">Expired</span>' 
                                : (isOnline ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Offline</span>');

                            const upLimit = u.rate_limit_up ? (u.rate_limit_up / 1024).toFixed(1) + ' M' : 'Unlim';
                            const downLimit = u.rate_limit_down ? (u.rate_limit_down / 1024).toFixed(1) + ' M' : 'Unlim';
                            
                            // Live stats
                            const uptime = u.uptime || 'N/A';
                            const currentIp = u.current_ip || 'N/A';
                            const mac = u.mac_address || 'N/A';
                            const rx = u.rx ? formatBytes(u.rx) : '0 B';
                            const tx = u.tx ? formatBytes(u.tx) : '0 B';
                            const currentUp = u.current_up ? (u.current_up/1024).toFixed(1) + ' M' : '0.0 M';
                            const currentDown = u.current_down ? (u.current_down/1024).toFixed(1) + ' M' : '0.0 M';

                            const rowId = `tr-pppoe-${u.id}`;
                            let tr = document.getElementById(rowId);
                            
                            const rowHtml = `
                                <td style="padding: 12px 15px;">${u.username}</td>
                                <td style="padding: 12px 15px;">${statusBadge}</td>
                                <td style="padding: 12px 15px;">${currentIp}</td>
                                <td style="padding: 12px 15px;">${uptime}</td>
                                <td style="padding: 12px 15px;">${upLimit} / ${downLimit}</td>
                                <td style="padding: 12px 15px;">${rx}</td>
                                <td style="padding: 12px 15px;">${tx}</td>
                                <td style="padding: 12px 15px; text-align: center;">
                                    ${isExpired ? `
                                        <button class="btn btn-sm btn-success" onclick="renewPppoeUser(${u.id}, '${u.username}')" title="Renew User" style="min-width: 60px; padding: 2px 8px; font-size: 0.8rem;">
                                            <i class="fas fa-sync-alt"></i> Renew
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-warning" onclick="kickPppoeUser(${u.id}, '${u.username}')" title="Kick User" style="min-width: 60px; padding: 2px 8px; font-size: 0.8rem;">
                                            <i class="fas fa-power-off"></i> Kick
                                        </button>
                                    `}
                                </td>
                            `;

                            if (tr) {
                                if (tr.innerHTML !== rowHtml) tr.innerHTML = rowHtml; // Update only if changed
                                if (tr.parentNode !== targetBody) targetBody.appendChild(tr); // Move if needed
                            } else {
                                tr = document.createElement('tr');
                                tr.id = rowId;
                                tr.style.borderBottom = '1px solid var(--border)';
                                tr.innerHTML = rowHtml;
                                targetBody.appendChild(tr);
                            }
                        }
                    }
                });

                // Remove rows that are no longer present
                const cleanupTable = (tbody, visibleIds) => {
                    if (!tbody) return;
                    Array.from(tbody.children).forEach(child => {
                        if (child.id && child.id.startsWith('tr-pppoe-')) {
                            const id = parseInt(child.id.replace('tr-pppoe-', ''));
                            if (!visibleIds.has(id)) {
                                child.remove();
                            }
                        } else if (child.tagName === 'TR' && users.length > 0 && child.textContent.includes('No active connections')) {
                            child.remove();
                        }
                    });
                };

                cleanupTable(statusTableBody, statusVisibleIds);
                cleanupTable(expiredTableBody, expiredVisibleIds);

                // Update Counts
                const usersCountEl = document.getElementById('pppoe-users-count');
                const statusCountEl = document.getElementById('pppoe-status-count');
                const expiredCountEl = document.getElementById('pppoe-expired-count');

                if (usersCountEl) usersCountEl.textContent = users.length;
                if (statusCountEl) statusCountEl.textContent = statusVisibleIds.size;
                if (expiredCountEl) expiredCountEl.textContent = expiredVisibleIds.size;

                if (allContainer && users.length === 0 && !isRefresh) allContainer.innerHTML = '<div style="color:var(--text-muted); font-style:italic;">No users found</div>';
                if (statusTableBody && statusVisibleIds.size === 0) {
                     // Check if empty message already exists
                     if (!statusTableBody.querySelector('td[colspan="8"]')) {
                        statusTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No active connections</td></tr>';
                     }
                }

            } catch (e) {
                console.error("Error loading PPPoE users:", e);
            }
        }

        async function openPppoeUserModal(user = null) {
            const modal = document.getElementById('pppoe-user-modal');
            const title = document.getElementById('pppoe-modal-title');
            
            // Populate Profiles Dropdown
            try {
                const res = await fetch('/api/admin/pppoe/profiles');
                const profiles = await res.json();
                
                // Main Profile Dropdown
                const pSelect = document.getElementById('pppoe-modal-profile');
                pSelect.innerHTML = '<option value="">No Profile (Unlimited)</option>';
                

                profiles.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    const upMbps = p.rate_limit_up ? (p.rate_limit_up / 1024) : 0;
                    const downMbps = p.rate_limit_down ? (p.rate_limit_down / 1024) : 0;
                    opt.textContent = `${p.name} (&uarr;${upMbps}M/&darr;${downMbps}M)`;
                    
                    pSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Error loading profiles for modal", e);
            }

            if (user) {
                title.textContent = 'Edit PPPoE User';
                document.getElementById('pppoe-user-id').value = user.id;
                document.getElementById('pppoe-modal-user').value = user.username;
                document.getElementById('pppoe-modal-pass').value = user.password;
                // document.getElementById('pppoe-modal-mac').value = user.mac_address || '';
                document.getElementById('pppoe-modal-profile').value = user.profile_id || '';
                
                // Format datetime for datetime-local input (YYYY-MM-DDTHH:mm)
                let expiryVal = '';
                if (user.expiration_date) {
                    const d = new Date(user.expiration_date);
                    // Adjust to local timezone for input
                    const pad = (n) => n < 10 ? '0' + n : n;
                    expiryVal = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                }
                document.getElementById('pppoe-modal-expiry').value = expiryVal;
                
                document.getElementById('pppoe-modal-active').value = user.is_active;
            } else {
                title.textContent = 'Add PPPoE User';
                document.getElementById('pppoe-user-id').value = '';
                document.getElementById('pppoe-modal-user').value = '';
                document.getElementById('pppoe-modal-pass').value = '';
                // document.getElementById('pppoe-modal-mac').value = '';
                document.getElementById('pppoe-modal-profile').value = '';
                document.getElementById('pppoe-modal-expiry').value = '';
                document.getElementById('pppoe-modal-active').value = '1';
            }
            modal.style.display = 'flex';
        }

        function closePppoeUserModal() {
            document.getElementById('pppoe-user-modal').style.display = 'none';
        }

        async function savePppoeUser() {
            const id = document.getElementById('pppoe-user-id').value;
            const user = {
                username: document.getElementById('pppoe-modal-user').value,
                password: document.getElementById('pppoe-modal-pass').value,
                mac_address: null, // document.getElementById('pppoe-modal-mac').value || null,
                profile_id: document.getElementById('pppoe-modal-profile').value || null,
                profile_id_on_expiry: null,
                expiration_date: document.getElementById('pppoe-modal-expiry').value || null,
                is_active: parseInt(document.getElementById('pppoe-modal-active').value)
            };

            if (!user.username || !user.password) {
                alert('Username and Password are required');
                return;
            }

            try {
                const url = id ? `/api/admin/pppoe/users/${id}` : '/api/admin/pppoe/users';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(user)
                });
                const data = await res.json();

                if (data.success) {
                    closePppoeUserModal();
                    loadPppoeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error saving user');
            }
        }

        async function deletePppoeUser(id) {
            if (!await showConfirm('Are you sure you want to delete this user?', true)) return;
            try {
                const res = await fetch(`/api/admin/pppoe/users/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadPppoeUsers();
                } else {
                    alert('Failed to delete user');
                }
            } catch (e) {
                alert('Error deleting user');
            }
        }

        async function kickPppoeUser(id, username) {
            if (!await showConfirm(`Are you sure you want to kick user ${username}?`, true)) return;
            try {
                const res = await fetch('/api/admin/pppoe/kick', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) {
                    loadPppoeUsers();
                } else {
                    alert('Failed to kick user: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Error kicking user');
            }
        }

        async function renewPppoeUser(id, username) {
            if (!await showConfirm(`Are you sure you want to RENEW user ${username} for 1 month?`, false)) return;
            try {
                const res = await fetch(`/api/admin/pppoe/users/${id}/renew`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`User ${username} renewed successfully. New Expiry: ${new Date(data.user.expiration_date).toLocaleString()}`);
                    loadPppoeUsers();
                } else {
                    alert('Failed to renew user: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Error renewing user');
            }
        }
    </script>
    <!-- Walled Garden Modal -->
    <div id="walled-garden-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3 style="margin-top:0;">Add Walled Garden Entry</h3>
            
            <div class="form-group">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Domain</label>
                <input type="text" id="wg-modal-domain" class="login-input" placeholder="example.com" style="width:100%;">
                <small style="color:var(--text-muted); display:block; margin-top:5px;">Address will be automatically resolved.</small>
            </div>
            
            <div class="form-group" style="margin-top:15px;">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Type</label>
                <select id="wg-modal-type" class="login-input" style="width:100%;">
                    <option value="allow">Allow</option>
                    <option value="deny">Deny</option>
                </select>
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="closeWalledGardenModal()" style="margin-right:5px;">Close</button>
                <button class="btn btn-sm btn-primary" onclick="addWalledGarden()">Save</button>
            </div>
        </div>
    </div>



    <!-- Main Vendo Rates Modal (New) -->
    <div id="main-rates-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:600px; max-width:95%; max-height:90vh; overflow-y:auto; display:flex; flex-direction:column;">
            <h3 style="margin-top:0; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">Main Vendo Rates</h3>
            
            <div style="margin-bottom:15px; text-align:right;">
                <button class="btn btn-sm btn-primary" onclick="openRateModal()">Add New Rate</button>
            </div>

            <div class="table-container">
                <table id="rates-table" class="sales-grid-table">
                    <thead>
                        <tr>
                            <th>
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                    <span>Amount</span>
                                </span>
                            </th>
                            <th>
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                                    <span>Duration</span>
                                </span>
                            </th>
                            <th>
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20.38 8.57l-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 15.58 6.85l1.85-1.23A10 10 0 0 0 3.35 19a2 2 0 0 0 1.72 1h13.85a2 2 0 0 0 1.74-1 10 10 0 0 0-.27-10.44zM12 13a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
                                    <span>Speed (UL/DL)</span>
                                </span>
                            </th>
                            <th>
                                <span style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                    <span>Type</span>
                                </span>
                            </th>
                            <th>
                                <span style="display:inline-flex;align-items:center;gap:6px;justify-content:center;width:100%;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    <span>Action</span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('main-rates-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Main Vendo Free Time Modal (New) -->
    <div id="main-free-time-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3 style="margin-top:0; margin-bottom:15px;">Main Vendo Free Time</h3>
            
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:15px;">
                <input type="checkbox" id="main-free-enabled" style="margin-right:8px;">
                <label for="main-free-enabled" style="font-weight:600;">Enable Free Time</label>
            </div>

            <div class="form-group">
                <label style="display:block; margin-bottom:5px; font-weight:600;">Duration</label>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1;">
                        <input type="number" id="main-free-h" class="login-input" placeholder="0" min="0" style="width:100%;">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center;">Hours</div>
                    </div>
                    <div style="flex:1;">
                        <input type="number" id="main-free-m" class="login-input" placeholder="0" min="0" max="59" style="width:100%;">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center;">Minutes</div>
                    </div>
                    <div style="flex:1;">
                        <input type="number" id="main-free-s" class="login-input" placeholder="0" min="0" max="59" style="width:100%;">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center;">Seconds</div>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:600;">Speed Limit (Mbps)</label>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.8rem; color:var(--text-muted);">Download</label>
                        <input type="number" id="main-free-dl" class="login-input" placeholder="Mbps" step="0.1" min="0" style="width:100%;">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.8rem; color:var(--text-muted);">Upload</label>
                        <input type="number" id="main-free-ul" class="login-input" placeholder="Mbps" step="0.1" min="0" style="width:100%;">
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:600;">Reclaim Free Time</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="number" id="main-free-reclaim" class="login-input" placeholder="0" min="0" style="width:80px;">
                    <span style="font-size:0.9rem; color:var(--text-main);">Days (0 to disable)</span>
                </div>
                <small style="color:var(--text-muted); display:block; margin-top:2px;">Users can claim free time again after this many days.</small>
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('main-free-time-modal').style.display='none'" style="margin-right:5px;">Close</button>
                <button class="btn btn-sm btn-primary" onclick="saveMainFreeTimeConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Table Limit Logic
        function setTableLimit(select) {
            const card = select.closest('.card');
            if(!card) return;
            const table = card.querySelector('table');
            if (!table) return;
            
            const limit = select.value;
            table.dataset.limit = limit;
            applyLimit(table);
        }

        function applyLimit(table) {
            const limit = table.dataset.limit || 'all';
            const tbody = table.querySelector('tbody');
            if(!tbody) return;
            
            const rows = Array.from(tbody.children);
            const count = limit === 'all' ? rows.length : parseInt(limit);
            
            rows.forEach((row, index) => {
                if (index < count) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Observer to handle dynamic content loading
        const tableObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    const target = mutation.target;
                    if (target.tagName === 'TBODY') {
                        const table = target.closest('table');
                        if (table && table.dataset.limit) {
                            applyLimit(table);
                        }
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Attach observers to all relevant tables
            const tables = document.querySelectorAll('.table-container table, .table-responsive table');
            tables.forEach(table => {
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tableObserver.observe(tbody, { childList: true });
                }
            });
        });
    </script>
    <script>
        // Point Rates Logic
        let currentPointRates = [];

        async function loadPointRatesData() {
            try {
                const res = await fetch('/api/admin/point-rates');
                if (!res.ok) throw new Error('Failed to fetch point rates');
                const rates = await res.json();
                currentPointRates = rates;
                renderPointRatesTable(rates);
            } catch (e) {
                console.error(e);
                alert('Error loading point rates');
            }
        }

        function renderPointRatesTable(rates) {
            const tbody = document.querySelector('#point-rates-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            if (rates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No point rates configured</td></tr>';
                return;
            }

            rates.forEach(rate => {
                const tr = document.createElement('tr');
                
                // Format duration
                let durationStr = '';
                // Prefer seconds-based duration
                let totalSeconds = rate.duration;
                if (!totalSeconds && rate.minutes) totalSeconds = Math.round(rate.minutes * 60);
                totalSeconds = totalSeconds || 0;

                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;

                const parts = [];
                if (h > 0) parts.push(h + 'h');
                if (m > 0) parts.push(m + 'm');
                if (s > 0) parts.push(s + 's');
                if (parts.length === 0) parts.push('0s');
                
                durationStr = parts.join(' ');

                // Format speeds
                const up = (rate.upload_speed / 1024).toFixed(1) + ' Mbps';
                const down = (rate.download_speed / 1024).toFixed(1) + ' Mbps';

                tr.innerHTML = `
                    <td><span class="badge badge-primary">${rate.points} pts</span></td>
                    <td>${durationStr}</td>
                    <td>${up} / ${down}</td>
                    <td>${rate.is_pausable ? '<span class="badge badge-success">Flex</span>' : '<span class="badge badge-warning">Continuous</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openPointRateModal(${rate.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePointRate(${rate.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openPointRateModal(rateId = null) {
            const modal = document.getElementById('point-rate-modal');
            const title = document.getElementById('point-rate-modal-title');
            
            // Reset form
            document.getElementById('point-rate-id').value = '';
            document.getElementById('point-rate-points').value = '';
            
            document.getElementById('point-rate-h').value = '';
            document.getElementById('point-rate-m').value = '';
            document.getElementById('point-rate-s').value = '';

            document.getElementById('point-rate-down').value = '';
            document.getElementById('point-rate-up').value = '';
            document.getElementById('point-rate-type').value = '1';

            if (rateId) {
                const rate = currentPointRates.find(r => r.id === rateId);
                if (rate) {
                    title.textContent = 'Edit Point Rate';
                    document.getElementById('point-rate-id').value = rate.id;
                    document.getElementById('point-rate-points').value = rate.points;
                    
                    // Parse duration (try seconds first, then minutes fallback)
                    let totalSeconds = rate.duration;
                    if (!totalSeconds && rate.minutes) {
                        totalSeconds = Math.round(rate.minutes * 60);
                    }
                    totalSeconds = totalSeconds || 0;

                    const h = Math.floor(totalSeconds / 3600);
                    const m = Math.floor((totalSeconds % 3600) / 60);
                    const s = totalSeconds % 60;

                    document.getElementById('point-rate-h').value = h;
                    document.getElementById('point-rate-m').value = m;
                    document.getElementById('point-rate-s').value = s;

                    document.getElementById('point-rate-down').value = rate.download_speed / 1024;
                    document.getElementById('point-rate-up').value = rate.upload_speed / 1024;
                    document.getElementById('point-rate-type').value = rate.is_pausable ? '1' : '0';
                }
            } else {
                title.textContent = 'New Point Rate';
            }
            
            modal.style.display = 'flex';
        }

        async function savePointRate() {
            const id = document.getElementById('point-rate-id').value;
            const points = parseInt(document.getElementById('point-rate-points').value);
            
            const h = parseInt(document.getElementById('point-rate-h').value) || 0;
            const m = parseInt(document.getElementById('point-rate-m').value) || 0;
            const s = parseInt(document.getElementById('point-rate-s').value) || 0;
            
            const down = parseFloat(document.getElementById('point-rate-down').value);
            const up = parseFloat(document.getElementById('point-rate-up').value);
            const type = document.getElementById('point-rate-type').value;

            if (!points || (h === 0 && m === 0 && s === 0) || !down || !up) {
                alert('Please fill all fields. Duration must be greater than 0.');
                return;
            }

            // Calculate total seconds and minutes
            const totalSeconds = (h * 3600) + (m * 60) + s;
            const totalMinutes = totalSeconds / 60; // Can be float

            const payload = {
                points,
                minutes: totalMinutes, // Kept for backward compat if needed
                duration: totalSeconds, // Primary source of truth now
                download_speed: Math.round(down * 1024),
                upload_speed: Math.round(up * 1024),
                is_pausable: parseInt(type),
                description: `${points} pts for ${h}h ${m}m ${s}s`
            };
            
            if (id) payload.id = id;

            try {
                const url = '/api/admin/point-rates';
                const method = 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Failed to save rate');
                
                document.getElementById('point-rate-modal').style.display = 'none';
                loadPointRatesData();
                alert('Rate saved successfully');
            } catch (e) {
                console.error(e);
                alert('Error saving rate');
            }
        }

        async function deletePointRate(id) {
            if (!confirm('Are you sure you want to delete this rate?')) return;
            
            try {
                const res = await fetch(`/api/admin/point-rates/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete rate');
                loadPointRatesData();
            } catch (e) {
                console.error(e);
                alert('Error deleting rate');
            }
        }

    async function loadPointsEarningRate() {
        try {
            const res = await fetch('/api/admin/points-config');
            if (!res.ok) throw new Error('Failed to load points config');
            const data = await res.json();
            document.getElementById('points-earning-rate').value = data.points_earning_rate || 0;
        } catch (e) {
            console.error(e);
            showToast('Failed to load points earning rate', 'error');
        }
    }

    async function savePointsEarningRate() {
        const rate = parseFloat(document.getElementById('points-earning-rate').value);
        if (isNaN(rate) || rate < 0) {
            alert('Please enter a valid rate');
            return;
        }

        try {
            const res = await fetch('/api/admin/points-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ points_earning_rate: rate })
            });

            if (!res.ok) throw new Error('Failed to save');
            showToast('Earning rate saved successfully', 'success');
        } catch (e) {
            console.error(e);
            showToast('Error saving earning rate', 'error');
        }
    }
    </script>
    <!-- Save Template Modal -->
    <div id="save-template-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3 style="margin-top:0;">Save Portal Template</h3>
            
            <div class="form-group">
                <label style="font-weight:600; display:block; margin-bottom:5px;">Template Name</label>
                <input type="text" id="save-template-name" class="login-input" placeholder="e.g. Dark Theme V1" style="width:100%;">
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('save-template-modal').style.display='none'" style="margin-right:5px;">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="savePortalTemplate()">Save</button>
            </div>
        </div>
    </div>

    <!-- Load Template Modal -->
    <div id="load-template-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); color:var(--text-main); padding:20px; border-radius:8px; width:500px; max-width:90%; max-height:80vh; display:flex; flex-direction:column;">
            <h3 style="margin-top:0; margin-bottom:15px;">Load Portal Template</h3>
            
            <div style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:4px; margin-bottom:15px;">
                <table id="template-list-table" class="sales-grid-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div style="text-align:right;">
                <button class="btn btn-sm btn-danger" onclick="document.getElementById('load-template-modal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Portal Template Logic ---
        function openSaveTemplateModal() {
            document.getElementById('save-template-name').value = '';
            document.getElementById('save-template-modal').style.display = 'flex';
        }

        async function savePortalTemplate() {
            const name = document.getElementById('save-template-name').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            const config = getCurrentPortalConfig();
            
            try {
                const res = await fetch('/api/admin/portal-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, config })
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save template');
                
                showToast('Template saved successfully', 'success');
                document.getElementById('save-template-modal').style.display = 'none';
            } catch (e) {
                console.error(e);
                alert('Error saving template: ' + e.message);
            }
        }

        function openLoadTemplateModal() {
            document.getElementById('load-template-modal').style.display = 'flex';
            loadTemplateList();
        }

        async function loadTemplateList() {
            const tbody = document.querySelector('#template-list-table tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>';
            
            try {
                const res = await fetch('/api/admin/portal-templates');
                if (!res.ok) throw new Error('Failed to fetch templates');
                
                const templates = await res.json();
                tbody.innerHTML = '';
                
                if (templates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--text-muted);">No templates found</td></tr>';
                    return;
                }
                
                templates.forEach(t => {
                    const tr = document.createElement('tr');
                    const dateStr = new Date(t.created_at).toLocaleString();
                    
                    tr.innerHTML = `
                        <td>${t.name}</td>
                        <td style="font-size:0.85rem; color:var(--text-muted);">${dateStr}</td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-sm btn-info" onclick="loadPortalTemplate(${t.id})">Load</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePortalTemplate(${t.id})">Del</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--danger);">Error loading templates</td></tr>';
            }
        }

        async function loadPortalTemplate(id) {
            if (!confirm('This will overwrite current form values. Continue?')) return;
            
            try {
                const res = await fetch(`/api/admin/portal-templates/${id}`);
                if (!res.ok) throw new Error('Failed to fetch template details');
                
                const data = await res.json();
                const config = data.config;
                
                // Apply config to form fields
                if (config.theme) document.getElementById('portal-theme-select').value = config.theme;
                if (config.container_max_width) document.getElementById('portal-container-width').value = config.container_max_width;
                if (config.icon_size) document.getElementById('portal-icon-size').value = config.icon_size;
                if (config.status_icon_container_size) document.getElementById('portal-status-container-size').value = config.status_icon_container_size;
                if (config.banner_height) document.getElementById('portal-banner-height').value = config.banner_height;
                
                document.getElementById('portal-use-default-banner').checked = config.use_default_banner;
                if (config.default_banner_file) document.getElementById('portal-default-banner-file').value = config.default_banner_file;
                document.getElementById('portal-hide-voucher-code').checked = config.hide_voucher_code;
                
                // Banner Mode
                if (config.banner_mode) {
                    const radio = document.querySelector(`input[name="banner_mode"][value="${config.banner_mode}"]`);
                    if (radio) {
                        radio.checked = true;
                        // Trigger change event to update UI visibility
                        toggleBannerMode(); 
                    }
                }
                
                if (config.slideshow_interval) document.getElementById('portal-slideshow-interval').value = config.slideshow_interval;
                if (config.footer_text !== undefined) document.getElementById('portal-footer-text').value = config.footer_text;
                if (config.footer_link !== undefined) document.getElementById('portal-footer-link').value = config.footer_link;
                
                // Trigger preview update
                updatePortalPreview(config.theme);
                
                showToast('Template loaded. Click "Save Portal Changes" to apply changes permanently.', 'success');
                document.getElementById('load-template-modal').style.display = 'none';
            } catch (e) {
                console.error(e);
                alert('Error loading template: ' + e.message);
            }
        }

        async function deletePortalTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            try {
                const res = await fetch(`/api/admin/portal-templates/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete template');
                
                showToast('Template deleted', 'success');
                loadTemplateList(); // Refresh list
            } catch (e) {
                console.error(e);
                alert('Error deleting template: ' + e.message);
            }
        }
    </script>
    <script src="/js/admin-toast.js"></script>
</body>
</html>












